<!DOCTYPE html>
<html lang="en-US"><head><meta charset="utf-8"/><meta content="IE=Edge" http-equiv="X-UA-Compatible"/><link href="https://selwynpolit.github.io/d9book/assets/css/just-the-docs-default.css" rel="stylesheet"/> <script async="" src="https://www.googletagmanager.com/gtag/js?id=8V22RQEJ71"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '8V22RQEJ71', { 'anonymize_ip': true }); </script> <script src="https://selwynpolit.github.io/d9book/assets/js/vendor/lunr.min.js"></script> <script src="https://selwynpolit.github.io/d9book/assets/js/just-the-docs.js"></script><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://selwynpolit.github.io/d9book/assets/images/favicon.ico" rel="icon" type="image/x-icon"/><title>Nodes and Fields | Drupal Book</title><meta content="Jekyll v4.3.2" name="generator"><meta content="Nodes and Fields" property="og:title"><meta content="en_US" property="og:locale"><meta content="Drupal at your fingertips" name="description"/><meta content="Drupal at your fingertips" property="og:description"/><link href="https://selwynpolit.github.io/d9book/d9book/nodes-and-fields" rel="canonical"><meta content="https://selwynpolit.github.io/d9book/d9book/nodes-and-fields" property="og:url"/><meta content="Drupal Book" property="og:site_name"/><meta content="website" property="og:type"/><meta content="summary" name="twitter:card"/><meta content="Nodes and Fields" property="twitter:title"/> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Drupal at your fingertips","headline":"Nodes and Fields","url":"https://selwynpolit.github.io/d9book/d9book/nodes-and-fields"}</script><body> <a class="skip-to-main" href="https://selwynpolit.github.io/d9book/nodes-and-fields#main-content">Skip to main content</a> <svg class="d-none" xmlns="http://www.w3.org/2000/svg"> <symbol id="svg-link" viewbox="0 0 24 24"><title>Link</title><svg class="feather feather-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"><title>Menu</title><svg class="feather feather-menu" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"><title>Expand</title><svg class="feather feather-chevron-right" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol class="feather feather-external-link" fill="none" height="24" id="svg-external-link" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"><title>Document</title><svg class="feather feather-file" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"><title>Search</title><svg class="feather feather-search" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"> <circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewbox="0 0 16 16"><title>Copy</title><svg class="bi bi-clipboard" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path> </svg> </symbol> <symbol id="svg-copied" viewbox="0 0 16 16"><title>Copied</title><svg class="bi bi-clipboard-check-fill" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a class="site-title lh-tight" href="https://selwynpolit.github.io/d9book/"> Drupal Book </a> <a class="site-button" href="https://selwynpolit.github.io/d9book/nodes-and-fields" id="menu-button"> <svg class="icon" viewbox="0 0 24 24"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" class="site-nav" id="site-nav"><ul class="nav-list"><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/">Home</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/actions">Actions</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/attribution">Attribution</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/bq">Batch and Queue</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/blocks">Blocks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/caching">Caching</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/composer">Composer</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/config">Config</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/cron">Cron</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dates">Dates and Times</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/debugging">Debugging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/development">Development</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/drush">Drush</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/email">Email</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/entities">Entities</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/forms">Forms</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/general">General</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/off-island">Getting off the Island</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/hooks">Hooks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/learn">Learning</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/links">Links</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/logging">Logging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/menus">Menus</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/migrate">Migrate</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/modals">Modals</a><li class="nav-list-item active"><a class="nav-list-link active" href="https://selwynpolit.github.io/d9book/nodes-and-fields">Nodes and Fields</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/queries">Queries</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/redirects">Redirects</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/render">Render Arrays</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/routes">Routes</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/security">Security</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/services">Services</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/state">State</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/taxonomy">Taxonomy</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dtt">Tests</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/twig">Twig</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><ul class="nav-list"><li class="nav-list-item external"> <a class="nav-list-link external" href="https://github.com/selwynpolit/d9book/fork"> Fork me on GitHub <svg aria-labelledby="svg-external-link-title" viewbox="0 0 24 24"><use xlink:href="#svg-external-link"></use></svg> </a></li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div class="main-header" id="main-header"><div class="search"><div class="search-input-wrap"> <input aria-label="Search Drupal Book" autocomplete="off" class="search-input" id="search-input" placeholder="Search Drupal Book" tabindex="0" type="text"/> <label class="search-label" for="search-input"><svg class="search-icon" viewbox="0 0 24 24"><use xlink:href="#svg-search"></use></svg></label></div><div class="search-results" id="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a class="site-button" href="https://twitter.com/selwynpolit" rel="noopener noreferrer" target="_blank"> <img alt="Twitter logo" src="https://atuin.ru/demo/simple-icons/icons/twitter.svg" style="width: 30px; height: 30px;" title="Author in Twitter"/> </a><li class="aux-nav-list-item"> <a class="site-button" href="https://github.com/selwynpolit/d9book/tree/gh-pages" rel="noopener noreferrer" target="_blank"> <img alt="GitHub logo" src="https://atuin.ru/demo/simple-icons/icons/github.svg" style="width: 30px; height: 30px;" title="D9Book on GitHub"/> </a></li></li></ul></nav></div><div class="main-content-wrap" id="main-content-wrap"><div class="main-content" id="main-content" role="main"><h1 class="no_toc fw-500" id="nodes-and-fields"> <a aria-labelledby="nodes-and-fields" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#nodes-and-fields"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Nodes and Fields</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a aria-labelledby="table-of-contents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#table-of-contents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ul id="markdown-toc"><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-get-a-formatted-text-field" id="markdown-toc-load-a-node-and-get-a-formatted-text-field">Load a node and get a formatted text field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-numeric-field-value" id="markdown-toc-load-a-numeric-field-value">Load a numeric field value</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#set-field-values" id="markdown-toc-set-field-values">Set field values</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#get-current-page-title" id="markdown-toc-get-current-page-title">Get current page title</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#test-if-variable-is-a-node" id="markdown-toc-test-if-variable-is-a-node">Test if variable is a node</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#get-the-current-nid-node-type-and-title" id="markdown-toc-get-the-current-nid-node-type-and-title">Get the current nid, node type and title</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-current-node-id-nid" id="markdown-toc-retrieve-current-node-id-nid">Retrieve current node id (nid)</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-node-info-from-current-path" id="markdown-toc-retrieve-node-info-from-current-path">Retrieve node info from current path</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-the-current-node-and-get-its-node-id-nid-field-type" id="markdown-toc-load-the-current-node-and-get-its-node-id-nid-field-type">Load the current node and get it’s node id (nid), field, type</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-by-nid-and-get-its-title-type-and-a-field" id="markdown-toc-load-a-node-by-nid-and-get-its-title-type-and-a-field">Load a node by nid and get its title, type and a field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-the-current-node-and-get-the-nid-field-type" id="markdown-toc-load-the-current-node-and-get-the-nid-field-type">Load the current node and get the nid, field, type</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-the-user-id-uid-for-a-node" id="markdown-toc-load-the-user-id-uid-for-a-node">Load the user id (uid) for a node</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#test-if-a-field-is-empty" id="markdown-toc-test-if-a-field-is-empty">Test if a field is empty</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-update-a-field" id="markdown-toc-load-a-node-and-update-a-field">Load a node and update a field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-values-from-a-date-range-field" id="markdown-toc-load-values-from-a-date-range-field">Load values from a date range field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-multivalue-field" id="markdown-toc-load-multivalue-field">Load multivalue field</a><ul><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#iterate-through-results" id="markdown-toc-iterate-through-results">Iterate through results</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#read-a-specific-instance" id="markdown-toc-read-a-specific-instance">Read a specific instance</a></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#update-a-multivalue-field" id="markdown-toc-update-a-multivalue-field">Update a multivalue field</a><ul><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#function-to-read-and-write-multivalue-fields" id="markdown-toc-function-to-read-and-write-multivalue-fields">Function to read and write multivalue fields</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#save-multivalue-field-entity-reference-field" id="markdown-toc-save-multivalue-field-entity-reference-field">Save multivalue field, entity reference field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#update-a-multivalue-entity-reference-fields" id="markdown-toc-update-a-multivalue-entity-reference-fields">Update a multivalue entity reference fields</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#generic-multivalue-field-writer" id="markdown-toc-generic-multivalue-field-writer">Generic Multivalue field writer</a></li></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#does-this-field-exist-in-my-entity" id="markdown-toc-does-this-field-exist-in-my-entity">Does this field exist in my entity?</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#get-url-for-an-image-or-file-in-a-media-reference-field" id="markdown-toc-get-url-for-an-image-or-file-in-a-media-reference-field">Get URL for an image or file in a media reference field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-info-about-a-file-field" id="markdown-toc-retrieve-info-about-a-file-field">Retrieve info about a file field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-a-link-field" id="markdown-toc-retrieve-a-link-field">Retrieve a link field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#does-this-field-exist-in-my-entity-1" id="markdown-toc-does-this-field-exist-in-my-entity-1">Does this field exist in my entity?</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#create-a-node-and-write-it-to-the-database" id="markdown-toc-create-a-node-and-write-it-to-the-database">Create a node and write it to the database</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#create-a-node-with-an-image" id="markdown-toc-create-a-node-with-an-image">Create a node with an image</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#write-a-node-with-an-attached-file" id="markdown-toc-write-a-node-with-an-attached-file">Write a node with an attached file</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#write-a-date-or-datetime-to-a-node" id="markdown-toc-write-a-date-or-datetime-to-a-node">Write a date or datetime to a node</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#or-just-a-date-no-time" id="markdown-toc-or-just-a-date-no-time">Or just a date (no time)</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#set-field-values-1" id="markdown-toc-set-field-values-1">Set field values</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#set-an-entity-reference-field" id="markdown-toc-set-an-entity-reference-field">Set an entity reference field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#set-multivalue-fields-regular-and-entity-reference" id="markdown-toc-set-multivalue-fields-regular-and-entity-reference">Set multivalue fields (regular and entity reference)</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#clear-a-text-field" id="markdown-toc-clear-a-text-field">Clear a text field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#set-or-clear-a-body-field" id="markdown-toc-set-or-clear-a-body-field">Set or clear a body field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-retrieve-an-entity-reference-node-and-nid-target_id" id="markdown-toc-load-a-node-and-retrieve-an-entity-reference-node-and-nid-target_id">Load a node and retrieve an entity reference node and nid (target_id)</a><ul><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-multivalue-reference-field" id="markdown-toc-load-a-multivalue-reference-field">Load a multivalue reference field.</a></li></ul><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#entity-reference-nodes-and-their-fields" id="markdown-toc-entity-reference-nodes-and-their-fields">Entity reference nodes and their fields</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-the-taxonomy-terms-from-a-term-reference-field" id="markdown-toc-load-the-taxonomy-terms-from-a-term-reference-field">Load the taxonomy terms from a term reference field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-find-the-terms-referenced-in-a-paragraph-in-a-term-reference-field" id="markdown-toc-load-a-node-and-find-the-terms-referenced-in-a-paragraph-in-a-term-reference-field">Load a node and find the terms referenced in a paragraph in a term reference field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-a-url-field" id="markdown-toc-retrieve-a-url-field">Retrieve a URL field</a><ul><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#external-links" id="markdown-toc-external-links">External links</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#internal-links" id="markdown-toc-internal-links">Internal links</a></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-retrieve-a-paragraph-field" id="markdown-toc-load-a-node-and-retrieve-a-paragraph-field">Load a node and retrieve a paragraph field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#how-to-get-node-url-alias-or-taxonomy-alias-by-node-id-or-term-id" id="markdown-toc-how-to-get-node-url-alias-or-taxonomy-alias-by-node-id-or-term-id">How to get Node URL alias or Taxonomy Alias by Node id or Term ID</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#how-to-set-a-url-alias" id="markdown-toc-how-to-set-a-url-alias">How to set a URL Alias</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#get-a-nodes-menu-item-and-more" id="markdown-toc-get-a-nodes-menu-item-and-more">Get a node’s menu item and more</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#find-a-node-using-its-uuid" id="markdown-toc-find-a-node-using-its-uuid">Find a node using it’s uuid</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-node-idnid-or-taxonomy-term-id-from-a-drupal-alias-or-path" id="markdown-toc-retrieve-node-idnid-or-taxonomy-term-id-from-a-drupal-alias-or-path">Retrieve Node ID(NID) or Taxonomy term ID from a Drupal alias or path</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-all-nodes-with-a-matching-taxonomy-term" id="markdown-toc-retrieve-all-nodes-with-a-matching-taxonomy-term">Retrieve all nodes with a matching taxonomy term</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#how-to-uncache-a-particular-page-or-node" id="markdown-toc-how-to-uncache-a-particular-page-or-node">How to uncache a particular page or node</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#get-boolean-field" id="markdown-toc-get-boolean-field">Get boolean Field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-field" id="markdown-toc-date-field">Date Field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-fields" id="markdown-toc-date-fields">Date Fields</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-range-field-doesnt-display-correct-timezone" id="markdown-toc-date-range-field-doesnt-display-correct-timezone">Date Range Field doesn’t display correct timezone</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-range" id="markdown-toc-date-range">Date Range</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-range-fields-load-start-and-end-values" id="markdown-toc-date-range-fields-load-start-and-end-values">Date Range fields: Load start and end values</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-fields-load-or-save-them" id="markdown-toc-date-fields-load-or-save-them">Date Fields: Load or save them</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#comparing-drupaldatetime-values" id="markdown-toc-comparing-drupaldatetime-values">Comparing DrupalDateTime values</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-with-embedded-timezone" id="markdown-toc-date-with-embedded-timezone">Date with embedded timezone</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#has-something-expired" id="markdown-toc-has-something-expired">Has something expired?</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-or-save-drupal-date-fields" id="markdown-toc-load-or-save-drupal-date-fields">Load or save Drupal Date fields</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-node-creation-date-and-format-it" id="markdown-toc-retrieve-node-creation-date-and-format-it">Retrieve node creation date and format it</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-node-creation-or-changed-date-and-format-it" id="markdown-toc-retrieve-node-creation-or-changed-date-and-format-it">Retrieve node creation or changed date and format it</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-field-and-date-with-no-time-remove-time" id="markdown-toc-date-field-and-date-with-no-time-remove-time">Date Field and Date with no time (remove time)</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#smart-date-smart_date-load-and-format" id="markdown-toc-smart-date-smart_date-load-and-format">Smart date (smart_date) load and format</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#smart-date-smart_date-all-day" id="markdown-toc-smart-date-smart_date-all-day">Smart date (smart_date) all-day</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#smart-date-smart_date-range-of-values" id="markdown-toc-smart-date-smart_date-range-of-values">Smart date (smart_date) range of values</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#hook_node_presave-or-hook_entity_type_presave" id="markdown-toc-hook_node_presave-or-hook_entity_type_presave">hook_node_presave or hook_entity_type_presave</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#disable-caching-for-a-content-type" id="markdown-toc-disable-caching-for-a-content-type">Disable caching for a content type</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#writing-some-json-data-into-a-long-text-field" id="markdown-toc-writing-some-json-data-into-a-long-text-field">Writing some JSON data into a long text field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#create-a-node-with-an-image-1" id="markdown-toc-create-a-node-with-an-image-1">Create a node with an image</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#paragraphs" id="markdown-toc-paragraphs">Paragraphs</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-find-the-terms-referenced-in-a-paragraph-in-a-term-reference-field-1" id="markdown-toc-load-a-node-and-find-the-terms-referenced-in-a-paragraph-in-a-term-reference-field-1">Load a node and find the terms referenced in a paragraph in a term reference field</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#custom-field-formatter" id="markdown-toc-custom-field-formatter">Custom Field Formatter</a><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#puzzles" id="markdown-toc-puzzles">Puzzles</a><ul><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#what-can-i-do-with-a-call-to-first-on-an-entity-reference-field" id="markdown-toc-what-can-i-do-with-a-call-to-first-on-an-entity-reference-field">What can I do with a call to first() on an entity reference field?</a></li></ul><li><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#great-cheat-sheets" id="markdown-toc-great-cheat-sheets">Great Cheat sheets</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><p><img alt="views" src="https://api.visitor.plantree.me/visitor-badge/pv?label=views&amp;color=informational&amp;namespace=d9book&amp;key=nodes_n_fields.md"/></p><hr/><h2 id="load-a-node-and-get-a-formatted-text-field"> <a aria-labelledby="load-a-node-and-get-a-formatted-text-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-get-a-formatted-text-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load a node and get a formatted text field</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$nodeStorage</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
<span class="nv">$node</span> <span class="o">=</span> <span class="nv">$nodeStorage</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="mi">10706</span><span class="p">);</span>
<span class="nv">$body</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'body'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="nv">$body</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">body</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

<span class="c1">//after text filters have done their magic!</span>
<span class="nv">$body</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">body</span><span class="o">-&gt;</span><span class="n">processed</span><span class="p">;</span>
</code></pre></div></div><h2 id="load-a-numeric-field-value"> <a aria-labelledby="load-a-numeric-field-value" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-numeric-field-value"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load a numeric field value</h2><p>When you load a numberic field, Drupal returns a number i.e. 0 even if that field was never initialized with a value.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$accepted_votes</span> <span class="o">=</span> <span class="nv">$feedback_error_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_accepted_votes'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="c1">// Returns 0 if no value was entered into the field.</span>
</code></pre></div></div><h2 id="set-field-values"> <a aria-labelledby="set-field-values" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#set-field-values"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Set field values</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_tks_subchapter'</span><span class="p">,</span> <span class="nv">$subchapterFullStatement</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_tks_standard_type'</span><span class="p">,</span> <span class="s2">"TEKS"</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><h2 id="get-current-page-title"> <a aria-labelledby="get-current-page-title" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#get-current-page-title"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Get current page title</h2><p>Use this in a controller, to return the current page title.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$request</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">request</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$route</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nc">\Symfony\Cmf\Component\Routing\RouteObjectInterface</span><span class="o">::</span><span class="no">ROUTE_OBJECT</span><span class="p">))</span> <span class="p">{</span>
  <span class="nv">$title</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'title_resolver'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$route</span><span class="p">);}</span>
</code></pre></div></div><h2 id="test-if-variable-is-a-node"> <a aria-labelledby="test-if-variable-is-a-node" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#test-if-variable-is-a-node"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Test if variable is a node</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Is this variable a node?</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$ref</span> <span class="k">instanceof</span> <span class="nc">EntityInterface</span> <span class="o">&amp;&amp;</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="n">getEntityTypeId</span> <span class="o">===</span> <span class="s1">'node'</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// yep</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="get-the-current-nid-node-type-and-title"> <a aria-labelledby="get-the-current-nid-node-type-and-title" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#get-the-current-nid-node-type-and-title"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Get the current nid, node type and title</h2><p>Here are two ways to retrieve the current node – via the request or using the route</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">request</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
<span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
</code></pre></div></div><p>OR</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getParameter</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="k">instanceof</span> <span class="nc">\Drupal\node\NodeInterface</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// You can get nid and anything else you need from the node object.</span>
  <span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
  <span class="nv">$nodeType</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">bundle</span><span class="p">();</span>
  <span class="nv">$nodeTitle</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>If you need to use the node object in <code class="language-plaintext highlighter-rouge">hook_preprocess_page()</code> on the preview page, you need to use the <code class="language-plaintext highlighter-rouge">node_preview</code> parameter, instead of the <code class="language-plaintext highlighter-rouge">node</code> parameter:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">mymodule_preprocess_page</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$vars</span><span class="p">)</span> <span class="p">{</span>

  <span class="nv">$route_name</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getRouteName</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="nv">$route_name</span> <span class="o">==</span> <span class="s1">'entity.node.canonical'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getParameter</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">elseif</span> <span class="p">(</span><span class="nv">$route_name</span> <span class="o">==</span> <span class="s1">'entity.node.preview'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getParameter</span><span class="p">(</span><span class="s1">'node_preview'</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div><p>And from <a href="https://drupal.stackexchange.com/questions/145823/how-do-i-get-the-current-node-id">https://drupal.stackexchange.com/questions/145823/how-do-i-get-the-current-node-id</a> when you are using or creating a custom block then you have to follow this code to get current node id. Not sure if it is correct</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Cache\Cache</span><span class="p">;</span>

<span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getParameter</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="k">instanceof</span> <span class="nc">\Drupal\node\NodeInterface</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// for cache</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">getCacheTags</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//With this when your node changes your block will rebuild</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getParameter</span><span class="p">(</span><span class="s1">'node'</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//if there is node add its cachetag</span>
    <span class="k">return</span> <span class="nc">Cache</span><span class="o">::</span><span class="nf">mergeTags</span><span class="p">(</span><span class="k">parent</span><span class="o">::</span><span class="nf">getCacheTags</span><span class="p">(),</span> <span class="p">[</span><span class="s1">'node:'</span> <span class="mf">.</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()]);</span>
  <span class="p">}</span> 
  <span class="k">else</span> <span class="p">{</span>
    <span class="c1">//Return default tags instead.</span>
    <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="nf">getCacheTags</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">getCacheContexts</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//if you depend on \Drupal::routeMatch()</span>
  <span class="c1">//you must set context of this block with 'route' context tag.</span>
  <span class="c1">//Every new route this block will rebuild</span>
  <span class="k">return</span> <span class="nc">Cache</span><span class="o">::</span><span class="nf">mergeContexts</span><span class="p">(</span><span class="k">parent</span><span class="o">::</span><span class="nf">getCacheContexts</span><span class="p">(),</span> <span class="p">[</span><span class="s1">'route'</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="retrieve-current-node-id-nid"> <a aria-labelledby="retrieve-current-node-id-nid" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-current-node-id-nid"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Retrieve current node id (nid)</h2><p>If the site is currently displaying node/123, this will return a path <code class="language-plaintext highlighter-rouge">node/123</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$current_path</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'path.current'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getPath</span><span class="p">();</span>
</code></pre></div></div><p>Also</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getParameter</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="k">instanceof</span> <span class="nc">\Drupal\node\NodeInterface</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// You can get nid and anything else you need from the node object.</span>
  <span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
  <span class="nv">$nodeTitle</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">();</span>
  <span class="nv">$nodeType</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">bundle</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$nodeType</span> <span class="o">!=</span> <span class="s1">'unit'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div><h2 id="retrieve-node-info-from-current-path"> <a aria-labelledby="retrieve-node-info-from-current-path" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-node-info-from-current-path"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Retrieve node info from current path</h2><p>You don’t need to <code class="language-plaintext highlighter-rouge">load</code> the node</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getParameter</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="k">instanceof</span> <span class="nc">\Drupal\node\NodeInterface</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// You can get nid and anything else you need from the node object.</span>
  <span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'unit'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$contract_id</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_contract_id</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="nv">$facebook</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_facebook</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="load-the-current-node-and-get-its-node-id-nid-field-type"> <a aria-labelledby="load-the-current-node-and-get-its-node-id-nid-field-type" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-the-current-node-and-get-its-node-id-nid-field-type"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load the current node and get it’s node id (nid), field, type</h2><p>To grab some information from the currently displayed node, use the <code class="language-plaintext highlighter-rouge">\Drupal object::routeMatch()</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Grab current node.</span>
<span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getParameter</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="k">instanceof</span> <span class="nc">\Drupal\node\NodeInterface</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// You can get nid and anything else you need from the node object.</span>
  <span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'unit'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$v</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_footer_social_media_headin'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$v</span><span class="p">))</span> <span class="p">{</span>
      <span class="mf">...</span>
    <span class="p">}</span>
    <span class="nv">$v</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_facebook'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$v</span><span class="p">))</span> <span class="p">{</span>
      <span class="mf">...</span>
    <span class="p">}</span>
</code></pre></div></div><p>Note you can also <code class="language-plaintext highlighter-rouge">$node-&gt;get('field_facebook')-&gt;getValue()</code> which returns an array of values. This is a good way to retrieve unlimited value fields i.e. fields that have more than 1 value.</p><h2 id="load-a-node-by-nid-and-get-its-title-type-and-a-field"> <a aria-labelledby="load-a-node-by-nid-and-get-its-title-type-and-a-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-by-nid-and-get-its-title-type-and-a-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load a node by nid and get its title, type and a field</h2><p>From: <a href="https://www.drupal.org/docs/8/api/entity-api/working-with-the-entity-api">https://www.drupal.org/docs/8/api/entity-api/working-with-the-entity-api</a></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\node\Entity\Node</span><span class="p">;</span>
<span class="c1">// Using the node id = 1.</span>
<span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div><p>Or</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nv">$headline</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">();</span>

<span class="c1">// What type of node is that?</span>
<span class="nv">$type</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">();</span>

<span class="c1">// Get the url field.</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_url'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
</code></pre></div></div><p>Or</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node_storage</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
<span class="nv">$node</span> <span class="o">=</span> <span class="nv">$node_storage</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_url'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
</code></pre></div></div><p>Or</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$body</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_srp_pc_change_type</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
</code></pre></div></div><p>And multivalue fields are similar. They are loaded when you use <code class="language-plaintext highlighter-rouge">get &amp; getValue</code> or the <code class="language-plaintext highlighter-rouge">magic getter &amp; getValue</code>. You can then loop through the returned values:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$topics</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_news_topics_for_listing'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span> <span class="c1">//get.</span>
</code></pre></div></div><p>or</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$topics</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_news_topics_for_listing</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span> <span class="c1">//magic getter.</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$topics</span> <span class="k">as</span> <span class="nv">$topic</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Do something.</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="load-the-current-node-and-get-the-nid-field-type"> <a aria-labelledby="load-the-current-node-and-get-the-nid-field-type" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-the-current-node-and-get-the-nid-field-type"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load the current node and get the nid, field, type</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// For content type unit grab their facebook/instagram etc.</span>
<span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getParameter</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="k">instanceof</span> <span class="nc">\Drupal\node\NodeInterface</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// You can get nid and anything else you need from the node object.</span>
  <span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'unit'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$sm_heading</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_footer_social_media_headin'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$sm_heading</span><span class="p">))</span> <span class="p">{</span>
      <span class="mf">...</span>
    <span class="p">}</span>
    <span class="nv">$fb</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_facebook'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$fb</span><span class="p">))</span> <span class="p">{</span>
      <span class="mf">...</span>
    <span class="p">}</span>
</code></pre></div></div><p>Note you can also</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_facebook'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
</code></pre></div></div><p>Which returns an array of values.</p><h2 id="load-the-user-id-uid-for-a-node"> <a aria-labelledby="load-the-user-id-uid-for-a-node" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-the-user-id-uid-for-a-node"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load the user id (uid) for a node</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$my_node</span><span class="o">-&gt;</span><span class="nf">getOwnerId</span><span class="p">();</span>
</code></pre></div></div><p>You can call <code class="language-plaintext highlighter-rouge">$node-&gt;uid</code> but that returns an <code class="language-plaintext highlighter-rouge">EntityReferenceFieldItemList</code> with all sorts of juicy information. The user id is in there but more challenging to extract.</p><h2 id="test-if-a-field-is-empty"> <a aria-labelledby="test-if-a-field-is-empty" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#test-if-a-field-is-empty"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Test if a field is empty</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_name'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">isEmpty</span><span class="p">()</span>
</code></pre></div></div><p>For an entity field use:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$sf_contract_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$sf_contract_nid</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$sf_contract_node</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$sf_contract_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_vendor_url'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">isEmpty</span><span class="p">())</span> <span class="p">{</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$sf_contract_node</span><span class="o">-&gt;</span><span class="n">field_vendor_url</span><span class="o">-&gt;</span><span class="nf">first</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getUrl</span><span class="p">();</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="nf">getUri</span><span class="p">();</span>
    <span class="nv">$variables</span><span class="p">[</span><span class="s1">'vendor_url'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$url</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div><p>And more concisely, using a new feature of PHP 8 we can use the following:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$url</span> <span class="o">=</span> <span class="nv">$sf_contract_node</span><span class="o">?-&gt;</span><span class="n">field_vendor_url</span><span class="o">?-&gt;</span><span class="nf">first</span><span class="p">()</span><span class="o">?-&gt;</span><span class="nf">getUrl</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$url</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="nf">getUri</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="load-a-node-and-update-a-field"> <a aria-labelledby="load-a-node-and-update-a-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-update-a-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load a node and update a field</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_url'</span><span class="p">,</span> <span class="s1">'the-blahblah'</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><h2 id="load-values-from-a-date-range-field"> <a aria-labelledby="load-values-from-a-date-range-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-values-from-a-date-range-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load values from a date range field</h2><p>Start date and then end date</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_end_dates'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_end_dates'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">end_value</span>
</code></pre></div></div><h2 id="load-multivalue-field"> <a aria-labelledby="load-multivalue-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-multivalue-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load multivalue field</h2><p>Multivalue fields can be loaded with <code class="language-plaintext highlighter-rouge">get('fieldname')</code> or using a magic field getter like <code class="language-plaintext highlighter-rouge">$node-&gt;field_my_field</code>. Adding <code class="language-plaintext highlighter-rouge">-&gt;getValue()</code> to the end of either of these calls returns a simple array.</p><p>For example, a multivalue text field, this will return an array of values like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$data</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_condiment'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
<span class="c1">// returns:</span>
<span class="nv">$data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'ketchup'</span>
<span class="nv">$data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'mayo'</span>
<span class="nv">$data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'reference'</span>
</code></pre></div></div><p>However a multivalue entity reference field (including taxonomy) will return values with the <code class="language-plaintext highlighter-rouge">target_id</code> array key. e.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$data</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_event_ref'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
<span class="c1">// returns:</span>
<span class="nv">$data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'target_id'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nv">$data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'target_id'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nv">$data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">'target_id'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span>
</code></pre></div></div><h3 id="iterate-through-results"> <a aria-labelledby="iterate-through-results" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#iterate-through-results"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Iterate through results</h3><p>Using <code class="language-plaintext highlighter-rouge">$node-&gt;field_condiment</code> or <code class="language-plaintext highlighter-rouge">$node-&gt;get('field_condiment')</code> returns a <code class="language-plaintext highlighter-rouge">Drupal\Core\Field\FieldItemList</code> which is iteratable. You can loop through the results and retrieve the values like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$items</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_condiment</span><span class="p">;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$item</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span> 
  <span class="c1">// For entity reference fields use </span>
  <span class="c1">// $result_nid = $item-&gt;target_id;</span>
<span class="p">}</span>
</code></pre></div></div><p>For entity reference fields, use <code class="language-plaintext highlighter-rouge">target_id</code> rather than <code class="language-plaintext highlighter-rouge">-&gt;value</code>.</p><p>And you can check if there is a particular item in the array like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// get FieldItemList.</span>
<span class="nv">$condiments</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_condiment'</span><span class="p">);</span>
<span class="nv">$vote_number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$condiments</span><span class="p">[</span><span class="nv">$vote_number</span><span class="p">]))</span> <span class="p">{</span>
  <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$condiments</span><span class="p">[</span><span class="nv">$vote_number</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// $result is ketchup.</span>

<span class="c1">// Or the PHP 8 way:</span>

<span class="nv">$result</span><span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_condiment</span><span class="o">?-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$vote_number</span><span class="p">)</span><span class="o">?-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="c1">// OR </span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_condiment</span><span class="p">[</span><span class="nv">$vote_number</span><span class="p">]</span><span class="o">?-&gt;</span><span class="n">value</span><span class="p">;</span>
</code></pre></div></div><h3 id="read-a-specific-instance"> <a aria-labelledby="read-a-specific-instance" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#read-a-specific-instance"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Read a specific instance</h3><p>You can directly reference an item by specifying an array offset. The index key (0 or 1 below) can also be referred to as the delta.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$status</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_voting_status'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="nv">$status</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_voting_status'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

</code></pre></div></div><p>Note. If the value for delta 1 is empty, Drupal will throw a warning message <code class="language-plaintext highlighter-rouge">*Warning*: Attempt to read property "value" on null in ...</code></p><p>So rather than reading the <code class="language-plaintext highlighter-rouge">[1]-&gt;value</code> directly, you should check if there is a value using <code class="language-plaintext highlighter-rouge">isset()</code> and then, you can read the <code class="language-plaintext highlighter-rouge">-&gt;value</code>. Note. When you do the isset() test, you don’t add the <code class="language-plaintext highlighter-rouge">-&gt;value</code> at the end e.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_voting_status'</span><span class="p">)[</span><span class="nv">$vote_number</span><span class="p">]))</span> <span class="p">{</span>
  <span class="nv">$voting_status</span> <span class="o">=</span> <span class="nv">$correlation_node</span><span class="o">-&gt;</span><span class="n">field_voting_status</span><span class="p">[</span><span class="nv">$vote_number</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="update-a-multivalue-field"> <a aria-labelledby="update-a-multivalue-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#update-a-multivalue-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Update a multivalue field</h2><p>This can be a little tricky especially if you want to preserve the existing values in the field.</p><p>Here I used the <code class="language-plaintext highlighter-rouge">getValue()</code> to load all the values. This returns an array of values like:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$data</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_event_ref'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>

<span class="nv">$result0</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'value'</span><span class="p">];</span>
<span class="nv">$result1</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'value'</span><span class="p">];</span>
</code></pre></div></div><p>So to update one of them, I want to do something like this: <code class="language-plaintext highlighter-rouge">$data[1]['value']='flour';</code>.</p><p>e.g. I load up the current values, fill in the 6th <code class="language-plaintext highlighter-rouge">[5]</code>item and save them. This preserves the existing values in positions <code class="language-plaintext highlighter-rouge">[0]</code>through <code class="language-plaintext highlighter-rouge">[4]</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$values</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_voting_status'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
<span class="nv">$values</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="s1">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'incomplete'</span><span class="p">;</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_srp_voting_status'</span><span class="p">,</span> <span class="nv">$values</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><h3 id="function-to-read-and-write-multivalue-fields"> <a aria-labelledby="function-to-read-and-write-multivalue-fields" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#function-to-read-and-write-multivalue-fields"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Function to read and write multivalue fields</h3><p>Here is a function which reads and writes multivalue fields safely. You pass it the <code class="language-plaintext highlighter-rouge">$node-&gt;field_name</code>, the index (vote_number) etc. and then it builds and returns an array formatted for updating the field data. It can also update the array if you pass in a value.</p><p>It could probably be genericized further.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">getMultivalueFieldArrayOfValues</span><span class="p">(</span><span class="nv">$values_field_data</span><span class="p">,</span> <span class="nv">$vote_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$new_value</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> <span class="nv">$field_type</span> <span class="o">=</span> <span class="s1">'value'</span><span class="p">,</span> <span class="nv">$default_value</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$values_array</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">foreach</span><span class="p">(</span><span class="nv">$values_field_data</span> <span class="k">as</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$values_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="nv">$field_type</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
    <span class="p">];</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$new_value</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//CHECK FOR PREVIOUS VALUES. IF THEY DO NOT EXIST SET TO NEW VALUE</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;=</span><span class="nv">$vote_number</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$values_array</span><span class="p">[</span><span class="nv">$i</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$default_value</span><span class="p">))</span> <span class="p">{</span>
          <span class="nv">$values_array</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$default_value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nv">$values_array</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$new_value</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$values_array</span><span class="p">[</span><span class="nv">$vote_number</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nv">$values_array</span><span class="p">[</span><span class="nv">$vote_number</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nv">$field_type</span> <span class="o">=&gt;</span> <span class="nv">$new_value</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nv">$values_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span><span class="nv">$field_type</span> <span class="o">=&gt;</span> <span class="nv">$new_value</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$values_array</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Example of using the above function for reading data and then writing the data without using it:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Retrieve current field values for correlation narrative/activity status fields</span>

<span class="nv">$activity_status</span> <span class="o">=</span> <span class="s1">'accepted'</span><span class="p">;</span>
<span class="nv">$activity_statuses</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_activity_status</span><span class="p">;</span>
<span class="nv">$activity_status_values</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nf">getMultivalueFieldArrayOfValues</span><span class="p">(</span><span class="nv">$activity_statuses</span><span class="p">);</span>
<span class="nv">$activity_status_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$activity_status</span><span class="p">;</span>

<span class="nv">$narrative_status</span> <span class="o">=</span> <span class="s1">'accepted'</span><span class="p">;</span>
<span class="nv">$narrative_statuses</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_narrative_status</span><span class="p">;</span>
<span class="nv">$narrative_status_values</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nf">getMultivalueFieldArrayOfValues</span><span class="p">(</span><span class="nv">$narrative_statuses</span><span class="p">);</span>
<span class="nv">$narrative_status_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$narrative_status</span><span class="p">;</span>

<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_narrative_status'</span><span class="p">,</span> <span class="nv">$narrative_status_values</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_activity_status'</span><span class="p">,</span> <span class="nv">$activity_status_values</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><h3 id="save-multivalue-field-entity-reference-field"> <a aria-labelledby="save-multivalue-field-entity-reference-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#save-multivalue-field-entity-reference-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Save multivalue field, entity reference field</h3><p>When you really care which delta/index/offset, you can specify that offset. It’s a bit confusing how exactly it works. For text or numeric fields, it works like you’d expect. You can just specify the offset. For entity reference fields, you have to do some fiddling. Don’t use <code class="language-plaintext highlighter-rouge">$node-&gt;set()</code> as this overwrites everything in the field, rather use the magic field setter variable and specify the offset.</p><p>Here <code class="language-plaintext highlighter-rouge">$vote_number</code> represents the index so if <code class="language-plaintext highlighter-rouge">$vote_number</code> = 0, this write the first item in the multivalue field. If <code class="language-plaintext highlighter-rouge">$vote_number</code> = 1, then write the second item, and so on.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$citation_node</span><span class="o">-&gt;</span><span class="n">field_srp_voting_status</span><span class="p">[</span><span class="nv">$vote_number</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'incomplete'</span><span class="p">;</span>
</code></pre></div></div><p>Be cautions, you might think this would work but it <em>doesn't</em></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$program_node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_srp_team_ref'</span><span class="p">,</span> <span class="p">[</span><span class="nv">$vote_number</span> <span class="o">=&gt;</span> <span class="mi">1234</span><span class="p">;</span>
</code></pre></div></div><p>If you are going to write index 2 and there is a possibility that there isn’t an index 0 and 1, you need something like this (in <code class="language-plaintext highlighter-rouge">protected function correlationSanityCheckFix(Node $correlation_node)</code>):</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$narrative_status</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$correlation_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_narrative_status'</span><span class="p">)[</span><span class="nv">$vote_number</span><span class="p">]))</span> <span class="p">{</span>
  <span class="nv">$narrative_status</span> <span class="o">=</span> <span class="nv">$correlation_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_narrative_status'</span><span class="p">)[</span><span class="nv">$vote_number</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$narrative_status</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// Grab all the statuses and add mine.</span>
  <span class="nv">$statuses</span> <span class="o">=</span> <span class="nv">$correlation_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_narrative_status'</span><span class="p">);</span>
  <span class="nv">$new_statuses</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$statuses</span> <span class="k">as</span> <span class="nv">$status</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$new_statuses</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$status</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nv">$new_statuses</span><span class="p">[</span><span class="nv">$vote_number</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'incomplete'</span><span class="p">;</span>
  <span class="nv">$correlation_node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_narrative_status'</span><span class="p">,</span> <span class="nv">$new_statuses</span><span class="p">);</span>
  <span class="nv">$save_correlation</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="update-a-multivalue-entity-reference-fields"> <a aria-labelledby="update-a-multivalue-entity-reference-fields" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#update-a-multivalue-entity-reference-fields"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Update a multivalue entity reference fields</h3><p>When writing multivalue entity reference fields, you have to load up the previous values, build an array of <code class="language-plaintext highlighter-rouge">target_ids</code> (node ids) and then write them all in one pass with a <code class="language-plaintext highlighter-rouge">$node-&gt;set()</code> method.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$teams</span> <span class="o">=</span> <span class="nv">$new_program_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_srp_team_ref'</span><span class="p">);</span>
<span class="nv">$new_teams</span> <span class="o">=</span> <span class="p">[];</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$teams</span> <span class="k">as</span> <span class="nv">$team</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$new_teams</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$team</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$new_teams</span><span class="p">[</span><span class="nv">$new_program_vote_number</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$team_id</span><span class="p">;</span>
<span class="nv">$new_program_node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_srp_team_ref'</span><span class="p">,</span> <span class="nv">$new_teams</span><span class="p">);</span>
</code></pre></div></div><h3 id="generic-multivalue-field-writer"> <a aria-labelledby="generic-multivalue-field-writer" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#generic-multivalue-field-writer"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Generic Multivalue field writer</h3><p>Here is a generic function that knows how to write values in a “sane” way.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cd">/**
   * Smart multi value field setter.
   *
   * Example calls:
   *
   * Set the index 2 to incomplete, keep old values:
   *  smartMultiValueFieldSetter($node, 'field_srp_voting_status', 'incomplete', 2);
   *
   *  Set the index 1 to incomplete, overwrite the old values to 'placeholder'
   *   smartMultiValueFieldSetter($node, 'field_srp_voting_status', 'incomplete', 1, 'placeholder', TRUE);
   *
   *
   * @param \Drupal\node\Entity\Node $node
   *   Node.
   * @param string $field_name
   *   Field name.
   * @param string $value
   *   Value to be put in $node-&gt;field[$index]-&gt;value.
   * @param int $index
   *   The delta i.e. $node-&gt;field[$index]
   * @param string $default_value
   *   The default values that will be written into the previous indexes.
   * @param bool $overwrite_old_values
   *   TRUE to ignore previous index values and overwrite them with $default_value.
   */</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">smartMultiValueFieldSetter</span><span class="p">(</span><span class="kt">Node</span> <span class="nv">$node</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$field_name</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$value</span><span class="p">,</span> <span class="kt">int</span> <span class="nv">$index</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$default_value</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="kt">bool</span> <span class="nv">$overwrite_old_values</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$old_values</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>

    <span class="c1">// Grab old values and put them into $new_values array.</span>

    <span class="nv">$field_type</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getFieldDefinition</span><span class="p">()</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$field_type</span> <span class="o">==</span> <span class="s1">'entity_reference'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$old_values</span> <span class="k">as</span> <span class="nv">$key</span><span class="o">=&gt;</span><span class="nv">$old_value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$new_values</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$old_values</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nv">$new_values</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$old_values</span> <span class="k">as</span> <span class="nv">$old_value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$new_values</span><span class="p">[][</span><span class="s2">"value"</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$old_value</span><span class="p">[</span><span class="s2">"value"</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Ignore what was in the old values and put my new default value in.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$overwrite_old_values</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$index</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$new_values</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$default_value</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Pad missing items.</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nv">$index</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$new_values</span><span class="p">[</span><span class="nv">$i</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$field_type</span> <span class="o">==</span> <span class="s1">'entity_reference'</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$new_values</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$default_value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nv">$new_values</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$default_value</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$field_type</span> <span class="o">==</span> <span class="s1">'entity_reference'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$new_values</span><span class="p">[</span><span class="nv">$index</span><span class="p">][</span><span class="s1">'target_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nv">$new_values</span><span class="p">[</span><span class="nv">$index</span><span class="p">][</span><span class="s2">"value"</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Trim off extras from testing.</span>
    <span class="c1">// TODO: this isn't trimming correctly for entity ref fields.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$new_values</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">$index</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$chunk</span> <span class="o">=</span> <span class="nb">array_chunk</span><span class="p">(</span><span class="nv">$new_values</span><span class="p">,</span> <span class="nv">$index</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
      <span class="nv">$new_values</span> <span class="o">=</span> <span class="nv">$chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">,</span> <span class="nv">$new_values</span><span class="p">);</span>
  <span class="p">}</span>

</code></pre></div></div><p>Here is an example of using the above function to write values to the field_condiment which is a multivalue text field.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span>

<span class="c1">// Write to index 0, 1, 2.</span>
<span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="s1">'field_condiment'</span><span class="p">,</span> <span class="s1">'ketchup'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="s1">'field_condiment'</span><span class="p">,</span> <span class="s1">'mayo'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="s1">'field_condiment'</span><span class="p">,</span> <span class="s1">'mustard'</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>


<span class="c1">// Write into index position 2 and pad the previous values with "dummy".</span>
<span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="s1">'field_condiment'</span><span class="p">,</span> <span class="s1">'mustard'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'dummy'</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>

<span class="c1">// Write into index position 1 and pad position 0 with "dummy", and remove the contents of index 2.</span>
<span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="s1">'field_condiment'</span><span class="p">,</span> <span class="s1">'ketchup'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'dummy'</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><p>Here is a complete function from the controller <code class="language-plaintext highlighter-rouge">GeneralController.php</code>. There are a wide variety of calls to <code class="language-plaintext highlighter-rouge">smartMultiValueFieldSetter()</code> showing it’s use with multivalue text and entity-reference fields (including a taxonomy field):</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="k">function</span> <span class="n">multiTest</span><span class="p">()</span> <span class="p">{</span>

    <span class="nv">$str</span> <span class="o">=</span> <span class="s1">'&lt;h2&gt;Results&lt;/h2&gt;'</span><span class="p">;</span>

    <span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span>

    <span class="c1">// Write to index 0, 1, 2.</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="s1">'field_condiment'</span><span class="p">,</span> <span class="s1">'ketchup'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="s1">'field_condiment'</span><span class="p">,</span> <span class="s1">'mayo'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="s1">'field_condiment'</span><span class="p">,</span> <span class="s1">'mustard'</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="c1">//$node-&gt;save();</span>

    <span class="nv">$field_name</span> <span class="o">=</span> <span class="s1">'field_condiment'</span><span class="p">;</span>
    <span class="nv">$field_type</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getFieldDefinition</span><span class="p">()</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">();</span>

    <span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br/&gt;&lt;strong&gt;Field:&lt;/strong&gt; "</span> <span class="mf">.</span> <span class="nv">$field_name</span><span class="p">;</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">",  type: "</span> <span class="mf">.</span> <span class="nv">$field_type</span><span class="p">;</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br/&gt;&lt;strong&gt;Values: &lt;/strong&gt;"</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$contents</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">', '</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="s1">'field_condiment'</span><span class="p">,</span> <span class="s1">'mustard'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'dummy'</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">);</span>
    <span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br/&gt;&lt;strong&gt;Values: &lt;/strong&gt;"</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$contents</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">', '</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="s1">'field_condiment'</span><span class="p">,</span> <span class="s1">'ketchup'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'dummy'</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">);</span>
    <span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br/&gt;&lt;strong&gt;Values: &lt;/strong&gt;"</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$contents</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">', '</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$field_name</span> <span class="o">=</span> <span class="s1">'field_event'</span><span class="p">;</span>
    <span class="nv">$field_type</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getFieldDefinition</span><span class="p">()</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">();</span>
    <span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="c1">//kint($contents);</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br/&gt;&lt;strong&gt;Field:&lt;/strong&gt; "</span> <span class="mf">.</span> <span class="nv">$field_name</span><span class="p">;</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">", type: "</span> <span class="mf">.</span> <span class="nv">$field_type</span><span class="p">;</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br/&gt;&lt;strong&gt;Values: &lt;/strong&gt;"</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$contents</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">'target_id'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">', '</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 17, 18</span>
    <span class="c1">//14, 18, 19</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$field_name</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$field_name</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$field_name</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br/&gt;&lt;strong&gt;Values: &lt;/strong&gt;"</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$contents</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">'target_id'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">', '</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$field_name</span> <span class="o">=</span> <span class="s1">'field_category'</span><span class="p">;</span>
    <span class="nv">$field_type</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getFieldDefinition</span><span class="p">()</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">();</span>
    <span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="c1">//kint($contents);</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br/&gt;&lt;strong&gt;Field:&lt;/strong&gt; "</span> <span class="mf">.</span> <span class="nv">$field_name</span><span class="p">;</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">", type: "</span> <span class="mf">.</span> <span class="nv">$field_type</span><span class="p">;</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br/&gt;&lt;strong&gt;Values: &lt;/strong&gt;"</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$contents</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">'target_id'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">', '</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 3, 2, 1</span>
    <span class="c1">// 1, 2, 3.</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$field_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$field_name</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">smartMultiValueFieldSetter</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$field_name</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="c1">//kint($contents);</span>
    <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br/&gt;&lt;strong&gt;Values: &lt;/strong&gt;"</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$contents</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$str</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">'target_id'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">', '</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Multivalue Text Field.</span>
    <span class="nv">$field_name</span> <span class="o">=</span> <span class="s1">'field_condiment'</span><span class="p">;</span>
    <span class="c1">// Returns FieldItemList.</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">);</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_condiment</span><span class="p">;</span>
    <span class="c1">// Returns simple array.</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_condiment</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>

    <span class="c1">// Multivalue entity reference field.</span>
    <span class="nv">$field_name</span> <span class="o">=</span> <span class="s1">'field_event'</span><span class="p">;</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_event</span><span class="p">;</span>

    <span class="c1">// Multivalue taxonomy entity reference field.</span>
    <span class="nv">$field_name</span> <span class="o">=</span> <span class="s1">'field_category'</span><span class="p">;</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$field_name</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="c1">// Yes, you can use a variable for a magic field getter!</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nv">$field_name</span><span class="p">;</span>

    <span class="c1">// Loop thru results.</span>
    <span class="nv">$items</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_condiment</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$x</span> <span class="o">=</span> <span class="nv">$item</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// get array of results.</span>
    <span class="nv">$condiments</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_condiment'</span><span class="p">);</span>
    <span class="nv">$vote_number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$condiments</span><span class="p">[</span><span class="nv">$vote_number</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$condiments</span><span class="p">[</span><span class="nv">$vote_number</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_condiment'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_condiment'</span><span class="p">)[</span><span class="mi">5</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_condiment'</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_condiment'</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$render_array</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$str</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$render_array</span><span class="p">;</span>
  <span class="p">}</span>

</code></pre></div></div><h2 id="does-this-field-exist-in-my-entity"> <a aria-labelledby="does-this-field-exist-in-my-entity" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#does-this-field-exist-in-my-entity"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Does this field exist in my entity?</h2><p>To check if a field exists in a node.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">hasField</span><span class="p">(</span><span class="s1">'abc'</span><span class="p">);</span>
</code></pre></div></div><p>e.g. Here we load a field <code class="language-plaintext highlighter-rouge">field_library_media</code> from a node, grab it’s target id (which we happen to know is a media entity.). We load the media entity and check if there is a field called field_media_document. This rather convoluted example is used to get the file size of the file in the media field.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\media\Entity\Media</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\file\Entity\File</span><span class="p">;</span>

<span class="nv">$media_id</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_library_media</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$media_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$media_item</span> <span class="o">=</span> <span class="nc">Media</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$media_id</span><span class="p">);</span>
  <span class="c1">// Get the file.</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$media_item</span><span class="o">-&gt;</span><span class="nf">hasField</span><span class="p">(</span><span class="s1">'field_media_document'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$file_id</span> <span class="o">=</span> <span class="nv">$media_item</span><span class="o">-&gt;</span><span class="n">field_media_document</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'target_id'</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$file_id</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$file</span> <span class="o">=</span> <span class="nc">File</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$file_id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Get file size.</span>
      <span class="nv">$file_size</span> <span class="o">=</span> <span class="nf">format_size</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">getSize</span><span class="p">());</span>
      <span class="c1">// Set file size variable.</span>
      <span class="nv">$variables</span><span class="p">[</span><span class="s1">'file_size'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$file_size</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="get-url-for-an-image-or-file-in-a-media-reference-field"> <a aria-labelledby="get-url-for-an-image-or-file-in-a-media-reference-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#get-url-for-an-image-or-file-in-a-media-reference-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Get URL for an image or file in a media reference field</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$nid</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_banner_image</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
  <span class="nv">$media</span> <span class="o">=</span> <span class="nc">Media</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
  <span class="c1">//Not always correct</span>
  <span class="c1">//$fid = $media-&gt;field_media_image-&gt;target_id;</span>
  <span class="c1">//Better way:</span>
  <span class="nv">$fid</span> <span class="o">=</span> <span class="nv">$media</span><span class="o">-&gt;</span><span class="nf">getSource</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getSourceFieldValue</span><span class="p">(</span><span class="nv">$media</span><span class="p">);</span>
  <span class="nv">$file</span> <span class="o">=</span> <span class="nc">File</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$fid</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">getFileUri</span><span class="p">();</span><span class="c1">//uri e.g. public://2020-12/atom.jpg</span>
            
    <span class="nv">$media_url</span> <span class="o">=</span> <span class="nf">file_create_url</span><span class="p">(</span><span class="nv">$uri</span><span class="p">);</span> <span class="c1">//Full URL of uploaded image. </span>
    <span class="c1">//E.g. https://dir.ddev.site/sites/default/files/2020-12/atom.jpg</span>
  <span class="p">}</span>
  <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addMessage</span><span class="p">(</span><span class="s2">"field_banner image url is </span><span class="nv">$media_url</span><span class="s2">"</span><span class="p">);</span>
  <span class="nv">$variables</span><span class="p">[</span><span class="s1">'program_area_banner_image_url'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$media_url</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>You can get relative or absolute paths using one of these</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$file</span> <span class="o">=</span> <span class="nc">File</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$fid</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">getFileUri</span><span class="p">();</span> <span class="c1">//returns drupal filename e.g. public://2020-12/atom.jpg</span>

  <span class="nv">$file_url</span> <span class="o">=</span> <span class="nf">file_create_url</span><span class="p">(</span><span class="nv">$uri</span><span class="p">);</span> <span class="c1">//returns absolute file url e.g. https://...file.jpg</span>

<span class="c1">//also</span>
  <span class="nv">$absolute_file_url</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">createFileUrl</span><span class="p">(</span><span class="kc">FALSE</span><span class="p">);</span> <span class="c1">//returns absolute file path (url)</span>

  <span class="nv">$relative_file_url</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">createFileUrl</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">);</span> <span class="c1">//returns relative file path (url)</span>
</code></pre></div></div><h2 id="retrieve-info-about-a-file-field"> <a aria-labelledby="retrieve-info-about-a-file-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-info-about-a-file-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Retrieve info about a file field</h2><p>Here we have a file field called <code class="language-plaintext highlighter-rouge">field_materials_file</code> that we loaded from a paragraph. Looking in <code class="language-plaintext highlighter-rouge">core/modules/file/src/Entity/File.php</code> we can see a series of useful functions like <code class="language-plaintext highlighter-rouge">getFileName()</code>, <code class="language-plaintext highlighter-rouge">getFileUri()</code>,<code class="language-plaintext highlighter-rouge">getSize()</code>, <code class="language-plaintext highlighter-rouge">getCreatedTime()</code>. To use these, we have to append <code class="language-plaintext highlighter-rouge">-&gt;entity</code> after the field as shown below</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$file</span> <span class="o">=</span> <span class="nv">$para</span><span class="o">-&gt;</span><span class="n">field_materials_file</span><span class="p">;</span>
<span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="nf">getFileName</span><span class="p">();</span>     
<span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="nf">getFileUri</span><span class="p">();</span>
</code></pre></div></div><p>Since <code class="language-plaintext highlighter-rouge">File</code> is an entity, we can also look in <code class="language-plaintext highlighter-rouge">EntityBase.php</code> to find more useful functions like <code class="language-plaintext highlighter-rouge">id()</code>, <code class="language-plaintext highlighter-rouge">label()</code>, <code class="language-plaintext highlighter-rouge">bundle()</code>.</p><h2 id="retrieve-a-link-field"> <a aria-labelledby="retrieve-a-link-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-a-link-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Retrieve a link field</h2><p>Here we have a link field: field_link which we load and get a valid uri from it using:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$link</span> <span class="o">=</span> <span class="nv">$para</span><span class="o">-&gt;</span><span class="n">field_link</span><span class="p">;</span>
<span class="nv">$link_uri</span> <span class="o">=</span> <span class="nv">$para</span><span class="o">-&gt;</span><span class="n">field_link</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">;</span>
</code></pre></div></div><p>Or</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$current_url</span> <span class="o">=</span> <span class="nv">$correction</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_link'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">;</span>
</code></pre></div></div><p>Or</p><p>In a <code class="language-plaintext highlighter-rouge">.module</code> file, <code class="language-plaintext highlighter-rouge">first()</code> returns a <code class="language-plaintext highlighter-rouge">Drupal\link\Plugin\FieldType\LinkItem</code></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nv">$sf_contract</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$vendor_url</span> <span class="o">=</span> <span class="nv">$sf_contract</span><span class="o">-&gt;</span><span class="n">field_vendor_url</span><span class="o">-&gt;</span><span class="nf">first</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$vendor_url</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// this works too: $vendor_url = $vendor_url-&gt;uri; </span>
    <span class="nv">$vendor_url</span> <span class="o">=</span> <span class="nv">$vendor_url</span><span class="o">-&gt;</span><span class="nf">getUrl</span><span class="p">();</span>  <span class="c1">// returns a Drupal\Core\Url.</span>
    <span class="nv">$vendor_url</span> <span class="o">=</span> <span class="nv">$vendor_url</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">();</span>
    <span class="nf">_add_single_metatag</span><span class="p">(</span><span class="s2">"vendor_url"</span><span class="p">,</span> <span class="nv">$vendor_url</span><span class="p">,</span> <span class="nv">$variables</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div><p>Leaving off the -<code class="language-plaintext highlighter-rouge">&gt;first()</code> (like this) returns a <code class="language-plaintext highlighter-rouge">Drupal\Core\Field\FieldItemList</code> which is a list of fields so you then would have to pull out the first field and extract the uri out of that.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$vendor_url</span> <span class="o">=</span> <span class="nv">$sf_contract</span><span class="o">-&gt;</span><span class="n">field_vendor_url</span><span class="p">;</span>
</code></pre></div></div><h2 id="does-this-field-exist-in-my-entity-1"> <a aria-labelledby="does-this-field-exist-in-my-entity-1" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#does-this-field-exist-in-my-entity-1"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Does this field exist in my entity?</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">hasField</span><span class="p">(</span><span class="s1">'abc'</span><span class="p">);</span>
</code></pre></div></div><p>e.g. Here we load a field <code class="language-plaintext highlighter-rouge">field_library_media</code> from a node, grab it’s target id (which we happen to know is a media entity.). We load the media entity and check if there is a field called field_media_document. This rather convoluted example is used to get the file size of the file in the media field.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$media_id</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_library_media</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$media_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$media_item</span> <span class="o">=</span> <span class="nc">Media</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$media_id</span><span class="p">);</span>
  <span class="c1">// Get the file.</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$media_item</span><span class="o">-&gt;</span><span class="nf">hasField</span><span class="p">(</span><span class="s1">'field_media_document'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$file_id</span> <span class="o">=</span> <span class="nv">$media_item</span><span class="o">-&gt;</span><span class="n">field_media_document</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'target_id'</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$file_id</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$file</span> <span class="o">=</span> <span class="nc">File</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$file_id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Get file size.</span>
      <span class="nv">$file_size</span> <span class="o">=</span> <span class="nf">format_size</span><span class="p">(</span><span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">getSize</span><span class="p">());</span>
      <span class="c1">// Set file size variable.</span>
      <span class="nv">$variables</span><span class="p">[</span><span class="s1">'file_size'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$file_size</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="create-a-node-and-write-it-to-the-database"> <a aria-labelledby="create-a-node-and-write-it-to-the-database" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#create-a-node-and-write-it-to-the-database"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Create a node and write it to the database</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">\Drupal\node\Entity\Node</span><span class="p">;</span>
<span class="c1">// Create node object.</span>
<span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">create</span><span class="p">([</span>
  <span class="s1">'type'</span>        <span class="o">=&gt;</span> <span class="s1">'article'</span><span class="p">,</span>
  <span class="s1">'title'</span>       <span class="o">=&gt;</span> <span class="s1">'Druplicon test'</span><span class="p">,</span>
<span class="p">]);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><h2 id="create-a-node-with-an-image"> <a aria-labelledby="create-a-node-with-an-image" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#create-a-node-with-an-image"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Create a node with an image</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">\Drupal\node\Entity\Node</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">\Drupal\file\Entity\File</span><span class="p">;</span>

  <span class="c1">// Create file object from remote URL.</span>
  <span class="nv">$data</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'https://www.drupal.org/files/druplicon.small_.png'</span><span class="p">);</span>
  <span class="nv">$file</span> <span class="o">=</span> <span class="nf">file_save_data</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">'public://druplicon.png'</span><span class="p">,</span> <span class="no">FILE_EXISTS_REPLACE</span><span class="p">);</span>

  <span class="c1">// Create node object with attached file.</span>
  <span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">create</span><span class="p">([</span>
    <span class="s1">'type'</span>        <span class="o">=&gt;</span> <span class="s1">'article'</span><span class="p">,</span>
    <span class="s1">'title'</span>       <span class="o">=&gt;</span> <span class="s1">'Druplicon test'</span><span class="p">,</span>
    <span class="s1">'field_image'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'target_id'</span> <span class="o">=&gt;</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">(),</span>
      <span class="s1">'alt'</span> <span class="o">=&gt;</span> <span class="s1">'Hello world'</span><span class="p">,</span>
      <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Goodbye world'</span>
    <span class="p">],</span>
  <span class="p">]);</span>
  <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><h2 id="write-a-node-with-an-attached-file"> <a aria-labelledby="write-a-node-with-an-attached-file" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#write-a-node-with-an-attached-file"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Write a node with an attached file</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">\Drupal\node\Entity\Node</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">\Drupal\file\Entity\File</span><span class="p">;</span>

  <span class="c1">// Create file object from remote URL.</span>
  <span class="nv">$data</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'https://www.drupal.org/files/druplicon.small_.png'</span><span class="p">);</span>
  <span class="nv">$file</span> <span class="o">=</span> <span class="nf">file_save_data</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">'public://druplicon.png'</span><span class="p">,</span> <span class="no">FILE_EXISTS_REPLACE</span><span class="p">);</span>

  <span class="c1">// Create node object with attached file.</span>
  <span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">create</span><span class="p">([</span>
    <span class="s1">'type'</span>        <span class="o">=&gt;</span> <span class="s1">'article'</span><span class="p">,</span>
    <span class="s1">'title'</span>       <span class="o">=&gt;</span> <span class="s1">'Druplicon test'</span><span class="p">,</span>
    <span class="s1">'field_image'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'target_id'</span> <span class="o">=&gt;</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">(),</span>
      <span class="s1">'alt'</span> <span class="o">=&gt;</span> <span class="s1">'Hello world'</span><span class="p">,</span>
      <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Goodbye world'</span>
    <span class="p">],</span>
  <span class="p">]);</span>
  <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><p>To populate the fields of an entity you can either use the <code class="language-plaintext highlighter-rouge">$entity-&gt;set($key, $value)</code> method on the entity object or pass a <code class="language-plaintext highlighter-rouge">key=&gt;value</code> array to the entity constructor. As such:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$foo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Foo</span><span class="p">([</span>
  <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'bar'</span><span class="p">,</span>
  <span class="s1">'baz'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
  <span class="s1">'multi_value'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'first'</span><span class="p">,</span>
    <span class="s1">'second'</span><span class="p">,</span>
    <span class="s1">'third'</span><span class="p">,</span>
  <span class="p">]</span>
<span class="p">]);</span>
</code></pre></div></div><h2 id="write-a-date-or-datetime-to-a-node"> <a aria-labelledby="write-a-date-or-datetime-to-a-node" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#write-a-date-or-datetime-to-a-node"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Write a date or datetime to a node</h2><p>note the <code class="language-plaintext highlighter-rouge">[]</code> array stuff is optional</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//DateTime:</span>
<span class="nv">$dateTime</span> <span class="o">=</span> <span class="nc">\DateTime</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">,</span><span class="s1">'2000-01-30'</span><span class="p">);</span>
<span class="nv">$newDateTimeString</span> <span class="o">=</span> <span class="nv">$dateTime</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d\TH:i:s'</span><span class="p">);</span>

<span class="c1">// Create node object</span>
<span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">create</span><span class="p">([</span>
  <span class="s1">'type'</span>        <span class="o">=&gt;</span> <span class="s1">'workshop'</span><span class="p">,</span>
  <span class="s1">'title'</span>       <span class="o">=&gt;</span> <span class="s1">'selwyn test'</span> <span class="mf">.</span> <span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="nb">random_int</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">200</span><span class="p">),</span>
  <span class="s1">'field_workshop_start_date'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'2017-12-05'</span><span class="p">,],</span>   <span class="c1">//date only</span>
  <span class="s1">'field_workshop_end_date'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$newDateTimeString</span><span class="p">,],</span> <span class="c1">//DateTime</span>
</code></pre></div></div><h2 id="or-just-a-date-no-time"> <a aria-labelledby="or-just-a-date-no-time" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#or-just-a-date-no-time"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Or just a date (no time)</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$dateTime</span> <span class="o">=</span> <span class="nc">\DateTime</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">,</span><span class="s1">'2000-01-30'</span><span class="p">);</span>
<span class="nv">$newDateString</span> <span class="o">=</span> <span class="nv">$dateTime</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">);</span>
<span class="mf">...</span>
  <span class="s1">'field_workshop_other_date'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$newDateString</span><span class="p">,],</span>
</code></pre></div></div><h2 id="set-field-values-1"> <a aria-labelledby="set-field-values-1" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#set-field-values-1"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Set field values</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_tks_subchapter'</span><span class="p">,</span> <span class="nv">$subchapterFullStatement</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_tks_standard_type'</span><span class="p">,</span> <span class="s2">"TEKS"</span><span class="p">);</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><p>And the shortened version (from <a href="https://gorannikolovski.com/blog/various-ways-updating-field-values-drupal-8-and-9">https://gorannikolovski.com/blog/various-ways-updating-field-values-drupal-8-and-9</a> )</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_tks_subchapter</span> <span class="o">=</span> <span class="nv">$subchapterFullStatement</span><span class="p">;</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_tks_standard_type</span> <span class="o">=</span> <span class="err">“</span><span class="no">TEKS</span><span class="s2">";
</span><span class="nv">$node-&gt;save</span><span class="s2">();
</span></code></pre></div></div><p>Also</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_tks_subchapter</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="nv">$subchapterFullStatement</span><span class="p">;</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_tks_standard_type</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="err">“</span><span class="no">TEKS</span><span class="s2">";
</span><span class="nv">$node-&gt;save</span><span class="s2">();
</span></code></pre></div></div><h2 id="set-an-entity-reference-field"> <a aria-labelledby="set-an-entity-reference-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#set-an-entity-reference-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Set an entity reference field</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//That is the node id.</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_name</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span> 

<span class="c1">// You can assign an entity object.</span>
<span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_name'</span><span class="p">,</span> <span class="nv">$another_entity</span><span class="p">);</span>

<span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_tks_standard_type</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="err">“</span><span class="no">TEKS</span><span class="s2">";
</span><span class="nv">$node-&gt;save</span><span class="s2">();
</span></code></pre></div></div><h2 id="set-multivalue-fields-regular-and-entity-reference"> <a aria-labelledby="set-multivalue-fields-regular-and-entity-reference" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#set-multivalue-fields-regular-and-entity-reference"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Set multivalue fields (regular and entity reference)</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//The multivalue fields are no different. You just have to use arrays. So, instead of this:</span>
<span class="nv">$entity</span><span class="o">-&gt;</span><span class="n">field_name_muti</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">];</span> 
<span class="nv">$entity</span><span class="o">-&gt;</span><span class="n">field_name_multi</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="nv">$entity</span><span class="o">-&gt;</span><span class="n">field_name_multi</span><span class="o">-&gt;</span><span class="n">target_id</span> <span class="o">=</span> <span class="p">[</span><span class="nv">$another_entity1</span><span class="p">,</span> <span class="nv">$another_entity2</span><span class="p">,</span> <span class="nv">$another_entity3</span><span class="p">]</span>

<span class="c1">// You can use this:</span>

<span class="nv">$entity</span><span class="o">-&gt;</span><span class="n">field_name_muti</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">];</span> 
<span class="nv">$entity</span><span class="o">-&gt;</span><span class="n">field_name_multi</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="nv">$entity</span><span class="o">-&gt;</span><span class="n">field_name_multi</span> <span class="o">=</span> <span class="p">[</span><span class="nv">$another_entity1</span><span class="p">,</span> <span class="nv">$another_entity2</span><span class="p">,</span> <span class="nv">$another_entity3</span><span class="p">]</span>
</code></pre></div></div><p>Also if you just want to update a specific one, specify the delta like this</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$expectation_node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_name_multi'</span><span class="p">,[</span><span class="mi">0</span> <span class="o">=&gt;</span>  <span class="s1">'foo'</span><span class="p">]);</span>
<span class="nv">$expectation_node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_name_multi'</span><span class="p">,[</span><span class="mi">1</span> <span class="o">=&gt;</span>  <span class="s1">'bar'</span><span class="p">]);</span>
</code></pre></div></div><p>Or with variables...</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$expectation_node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_srp_teacher_voting_status'</span><span class="p">,[</span><span class="nv">$current_vote_number</span> <span class="o">=&gt;</span>  <span class="nv">$voting_status</span><span class="p">]);</span>
</code></pre></div></div><h2 id="clear-a-text-field"> <a aria-labelledby="clear-a-text-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#clear-a-text-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Clear a text field</h2><p>Single text field</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_subtitle'</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">);</span>
</code></pre></div></div><h2 id="set-or-clear-a-body-field"> <a aria-labelledby="set-or-clear-a-body-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#set-or-clear-a-body-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Set or clear a body field</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'body'</span><span class="p">,</span> <span class="p">[</span>
  <span class="s1">'summary'</span> <span class="o">=&gt;</span> <span class="nv">$summary</span><span class="p">,</span>
  <span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="nv">$body</span><span class="p">,</span>
  <span class="s1">'format'</span> <span class="o">=&gt;</span> <span class="s1">'links_bullets_headings_and_images'</span><span class="p">,</span>
<span class="p">]);</span>
</code></pre></div></div><p>To empty a body field, use this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this_node</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="nv">$this_node</span><span class="o">-&gt;</span><span class="n">language</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
</code></pre></div></div><h2 id="load-a-node-and-retrieve-an-entity-reference-node-and-nid-target_id"> <a aria-labelledby="load-a-node-and-retrieve-an-entity-reference-node-and-nid-target_id" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-retrieve-an-entity-reference-node-and-nid-target_id"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load a node and retrieve an entity reference node and nid (target_id)</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node_storage</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
<span class="nv">$node</span> <span class="o">=</span> <span class="nv">$node_storage</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nv">$nid</span><span class="p">);</span>
<span class="c1">//Same</span>
<span class="nv">$ref_nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_sf_contract_ref'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
<span class="c1">//or</span>
<span class="nv">$ref_nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_sf_contract_ref</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
</code></pre></div></div><h3 id="load-a-multivalue-reference-field"> <a aria-labelledby="load-a-multivalue-reference-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-multivalue-reference-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load a multivalue reference field.</h3><p>Here node 35 has a <code class="language-plaintext highlighter-rouge">field_event</code> (multivalue entity reference field) with several values. This code shows how to retrieve the first one, get it’s nid and it’s title:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span>
<span class="c1">// Get an array of nodes.</span>
<span class="nv">$node_array</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_event'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">referencedEntities</span><span class="p">();</span>
<span class="c1">// Pop one off with reset.</span>
<span class="nv">$ref_node</span> <span class="o">=</span> <span class="nb">reset</span><span class="p">(</span><span class="nv">$node_array</span><span class="p">);</span>
<span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$ref_node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
<span class="nv">$title</span> <span class="o">=</span> <span class="nv">$ref_node</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">();</span>

</code></pre></div></div><p>As <code class="language-plaintext highlighter-rouge">$ref_node</code> is a node object, you retrieve any field value with <code class="language-plaintext highlighter-rouge">get()</code> e.g. <code class="language-plaintext highlighter-rouge">$val = $ref_node-&gt;get('field_status')-&gt;value;</code></p><p>You can also loop thru the referenced entities with:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="nv">$node_array</span> <span class="k">as</span> <span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="entity-reference-nodes-and-their-fields"> <a aria-labelledby="entity-reference-nodes-and-their-fields" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#entity-reference-nodes-and-their-fields"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Entity reference nodes and their fields</h2><p>You can look at the referenced node’s fields but you have to be aware of how you set the display mode.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_my_entity_reference</span> <span class="k">as</span> <span class="nv">$reference</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// if you chose "Entity ID" as the display mode for the entity reference field,</span>
  <span class="c1">// the target_id is the ONLY value you will have access to</span>
  <span class="k">echo</span> <span class="nv">$reference</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>    <span class="c1">// 1 (a node's nid)</span>

  <span class="c1">// if you chose "Rendered Entity" as the display mode, you'll be able to </span>
  <span class="c1">// access the rest of the node's data.</span>
  <span class="k">echo</span> <span class="nv">$reference</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">title</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>    <span class="c1">// "Moby Dick"</span>
<span class="p">}</span>
</code></pre></div></div><p>Often, you’ve just loaded the node with <code class="language-plaintext highlighter-rouge">Node::load()</code> so you have a node object and refer to reference fields like:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$vendor_url</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_sf_contract_ref</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">field_vendor_url</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
</code></pre></div></div><h2 id="load-the-taxonomy-terms-from-a-term-reference-field"> <a aria-labelledby="load-the-taxonomy-terms-from-a-term-reference-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-the-taxonomy-terms-from-a-term-reference-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load the taxonomy terms from a term reference field</h2><p>The referencedEntities returns an array of term objects, so no need to <code class="language-plaintext highlighter-rouge">load()</code> them separately.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$topics</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_ref_tax'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">referencedEntities</span><span class="p">();</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$topics</span> <span class="k">as</span> <span class="nv">$topic</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$term_name</span> <span class="o">=</span> <span class="nv">$topic</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="load-a-node-and-find-the-terms-referenced-in-a-paragraph-in-a-term-reference-field"> <a aria-labelledby="load-a-node-and-find-the-terms-referenced-in-a-paragraph-in-a-term-reference-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-find-the-terms-referenced-in-a-paragraph-in-a-term-reference-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load a node and find the terms referenced in a paragraph in a term reference field</h2><p>Here we loop thru all the instances of my paragraph reference and grab the term in the paragraph.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_my_para'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">referencedEntities</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$ent</span><span class="p">){</span>
  <span class="nv">$term</span> <span class="o">=</span> <span class="nv">$ent</span><span class="o">-&gt;</span><span class="nv">$field_in_paragraph</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
  <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$term</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">();</span>
  <span class="nb">print_r</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="retrieve-a-url-field"> <a aria-labelledby="retrieve-a-url-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-a-url-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Retrieve a URL field</h2><h3 id="external-links"> <a aria-labelledby="external-links" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#external-links"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> External links</h3><p>You can get the URL (for external links) and then just the text part. Note this doesn’t work for internal links. Note also this slightly convoluted example has a reference field field_sf_contract_ref which has a link to another entity and the <code class="language-plaintext highlighter-rouge">field_vendor_url-&gt;first()-&gt;getUrl()</code> is the important part. Also note, this is a single-value field (not a multivalue field – so the <code class="language-plaintext highlighter-rouge">first()</code> call is a little disturbing)</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$vendor_url</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_sf_contract_ref</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">field_vendor_url</span><span class="o">-&gt;</span><span class="nf">first</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getUrl</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$vendor_url</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$vendor_url</span> <span class="o">=</span> <span class="nv">$vendor_url</span><span class="o">-&gt;</span><span class="nf">getUri</span><span class="p">();</span>
  <span class="c1">//OR</span>
  <span class="nv">$vendor_url</span> <span class="o">=</span> <span class="nv">$vendor_url</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>A slightly simpler example from <code class="language-plaintext highlighter-rouge">modules/custom/tea_teks/modules/tea_teks_srp/src/Form/SrpAddEditCitationForm.php</code></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$citation_link</span> <span class="o">=</span> <span class="nv">$citation</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_link'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$citation_link</span><span class="o">-&gt;</span><span class="nf">isEmpty</span><span class="p">())</span> <span class="p">{</span>
  <span class="nv">$citation_link</span> <span class="o">=</span> <span class="nv">$citation</span><span class="o">-&gt;</span><span class="n">field_link</span><span class="o">-&gt;</span><span class="nf">first</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getUrl</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="internal-links"> <a aria-labelledby="internal-links" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#internal-links"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Internal links</h3><p>For internal links, use <code class="language-plaintext highlighter-rouge">getUrl()</code>for the URL and <code class="language-plaintext highlighter-rouge">-&gt;title</code> for the title.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$instructions_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$order_type_instructions_nid</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$instructions_node</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$order_link</span> <span class="o">=</span> <span class="nv">$instructions_node</span><span class="o">-&gt;</span><span class="n">field_link</span><span class="o">-&gt;</span><span class="nf">first</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$order_link</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$order_link</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">;</span>
    <span class="nv">$variables</span><span class="p">[</span><span class="s1">'order_link_title'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$order_link</span><span class="o">-&gt;</span><span class="n">title</span><span class="p">;</span>
    <span class="nv">$order_url</span> <span class="o">=</span> <span class="nv">$order_link</span><span class="o">-&gt;</span><span class="nf">getUrl</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$order_url</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$variables</span><span class="p">[</span><span class="s1">'order_type_link'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$order_url</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="load-a-node-and-retrieve-a-paragraph-field"> <a aria-labelledby="load-a-node-and-retrieve-a-paragraph-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-retrieve-a-paragraph-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load a node and retrieve a paragraph field</h2><p>Because paragraphs and nodes are both entities, the pattern is the same. You load the entity (node or paragraph) and then simply reference the field name e.g. <code class="language-plaintext highlighter-rouge">myentity-&gt;field_blah</code></p><p>From /Users/selwyn/Sites/inside-mathematics/themes/custom/danaprime/danaprime.theme</p><p>These are a little different from regular fields. Generally you want to get their target_id which will tell you the pid or paragraph id. Here are two different ways to load a video_collection_node and go to retrieve a field <code class="language-plaintext highlighter-rouge">field_related_lessons</code> which holds paragraphs of type <code class="language-plaintext highlighter-rouge">related_lessons</code></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$video_collection_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$video_collection_nid</span><span class="p">);</span>

<span class="c1">//This gives you a bunch of \Drupal\entity_reference_revisions\EntityReferenceRevisionsFieldItemList items</span>
<span class="nv">$lessons</span> <span class="o">=</span> <span class="nv">$video_collection_node</span><span class="o">-&gt;</span><span class="n">field_related_lessons</span><span class="p">;</span>
<span class="c1">//or</span>
<span class="nv">$lessons</span> <span class="o">=</span> <span class="nv">$video_collection_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_related_lessons'</span><span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$lessons</span> <span class="k">as</span> <span class="nv">$lesson</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$paragraph_revision_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$lesson</span><span class="o">-&gt;</span><span class="n">target_revision_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">Paragraphs</span> <span class="kn">use</span> <span class="n">the</span> <span class="n">contributed</span> <span class="nc">Entity</span> <span class="nc">Reference</span> <span class="nc">Revisions</span> <span class="n">module</span> <span class="n">to</span> <span class="n">reference</span>
<span class="n">paragraphs</span> <span class="k">and</span> <span class="n">it</span> <span class="n">is</span> <span class="n">very</span> <span class="n">important</span> <span class="n">to</span> <span class="kn">use</span> <span class="n">the</span> <span class="sb">`target_revision_id`</span> <span class="n">property</span>
<span class="n">when</span> <span class="n">referencing</span> <span class="n">paragraphs</span><span class="mf">.</span> <span class="nc">Alternatively</span><span class="p">,</span> <span class="n">the</span> <span class="sb">`entity`</span> <span class="n">computed</span> <span class="n">property</span> <span class="n">can</span>
<span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">retrieve</span> <span class="n">the</span> <span class="n">paragraph</span> <span class="n">entity</span> <span class="n">itself</span><span class="mf">.</span>

<span class="k">OR</span>

<span class="c1">//This gives you an array of arrays [['target_id' =&gt; '348','target_revision_id' =&gt; '348'],['target_id' =&gt; '349','target_revision_id' =&gt; '349'] ]</span>
<span class="nv">$lessons</span> <span class="o">=</span> <span class="nv">$video_collection_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_related_lessons'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$lessons</span> <span class="k">as</span> <span class="nv">$lesson</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$paragraph_revision_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$lesson</span><span class="p">[</span><span class="s1">'target_revision_id'</span><span class="p">];</span>
<span class="p">}</span>

<span class="nc">Collecting</span> <span class="n">them</span> <span class="n">like</span> <span class="n">this</span> <span class="n">is</span> <span class="n">only</span> <span class="n">an</span> <span class="n">example</span><span class="p">,</span> <span class="k">while</span> <span class="n">the</span> <span class="sb">`loadMultiple`</span> <span class="n">method</span>
<span class="n">exists</span> <span class="n">on</span> <span class="n">entity</span> <span class="n">storage</span> <span class="n">objects</span><span class="p">,</span> <span class="n">there</span> <span class="n">is</span> <span class="n">no</span> <span class="sb">`loadMultipleRevisions`</span> <span class="n">method</span><span class="mf">.</span>

<span class="no">EH</span><span class="o">!</span>

<span class="c1">// This gives you null! - don't do this.</span>
<span class="nv">$lessons</span> <span class="o">=</span> <span class="nv">$video_collection_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_related_lessons'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
</code></pre></div></div><p>Note. <code class="language-plaintext highlighter-rouge">getValue()</code> here will get you the nid buried in a result array of arrays like <code class="language-plaintext highlighter-rouge">result[0]['target_revision_id']</code> - quicker to just grab <code class="language-plaintext highlighter-rouge">-&gt;target_revision_id</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
## Load a node and grab a paragraph field to find the nid in an entity reference field

From
/Users/selwyn/Sites/inside-mathematics/themes/custom/danaprime/danaprime.theme -
Continuing from above, I load a node, grab it's field
`field_related_lessons` which holds paragraphs of type `related_lessons`
and grab it's field `field_lesson.` That field has a target_id which is
the nid for the entity reference field. Phew! 

```php
//Grab the related lessons from the collection.
$video_collection_node = Node::load($video_collection_nid);
$lessons = $video_collection_node-&gt;field_related_lessons;
$storage = \Drupal::entityTypeManager()-&gt;getStorage('paragraph');
foreach ($lessons as $lesson) {
  //Load each paragraph and get the nids from them.
  $paragraph = $lesson-&gt;entity;
  $related_lessons_nid = $paragraph-&gt;field_lesson-&gt;target_id;
  $related_lessons_nids[] = $related_lessons_nid;
}

//This should have an array of nids for video_details.
$variables['related_lessons_pids'] = $pids;
$variables['related_lessons_nids'] = $related_lessons_nids;
</code></pre></div></div><h2 id="how-to-get-node-url-alias-or-taxonomy-alias-by-node-id-or-term-id"> <a aria-labelledby="how-to-get-node-url-alias-or-taxonomy-alias-by-node-id-or-term-id" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#how-to-get-node-url-alias-or-taxonomy-alias-by-node-id-or-term-id"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> How to get Node URL alias or Taxonomy Alias by Node id or Term ID</h2><p>Drupal 8 uses <code class="language-plaintext highlighter-rouge">Url</code> objects to easily generate and manipulate paths. The easiest way is to load the entity and convert it to a URL object:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>
<span class="nv">$url_object</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">toUrl</span><span class="p">();</span>
</code></pre></div></div><p>This now can be converted to a string</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$href</span> <span class="o">=</span> <span class="nv">$url_object</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">();</span>
</code></pre></div></div><p>If an absolute URL is needed, that’s easy too:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$href</span> <span class="o">=</span> <span class="nv">$url_object</span><span class="o">-&gt;</span><span class="nf">setAbsolute</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">();</span>
</code></pre></div></div><p>This will return a path in the form <code class="language-plaintext highlighter-rouge">node/123</code></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$current_path</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'path.current'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getPath</span><span class="p">();</span>
</code></pre></div></div><h2 id="how-to-set-a-url-alias"> <a aria-labelledby="how-to-set-a-url-alias" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#how-to-set-a-url-alias"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> How to set a URL Alias</h2><p>Since Drupal 9, url aliases are entities so:</p><p>From: /Users/selwyn/Sites/dir/web/modules/custom/dir/dir.module</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node_path</span> <span class="o">=</span> <span class="s2">"/node/</span><span class="nv">$nid</span><span class="s2">"</span><span class="p">;</span>
<span class="nv">$new_url</span> <span class="o">=</span> <span class="nv">$parent_url_alias</span> <span class="mf">.</span> <span class="nv">$url_alias</span><span class="p">;</span>

<span class="cd">/** @var \Drupal\path_alias\PathAliasInterface $path_alias */</span>
<span class="nv">$path_alias</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'path_alias'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
  <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="nv">$node_path</span><span class="p">,</span>
  <span class="s1">'alias'</span> <span class="o">=&gt;</span> <span class="nv">$new_url</span><span class="p">,</span>
  <span class="s1">'langcode'</span> <span class="o">=&gt;</span> <span class="s1">'en'</span><span class="p">,</span>
<span class="p">]);</span>
<span class="nv">$path_alias</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><h2 id="get-a-nodes-menu-item-and-more"> <a aria-labelledby="get-a-nodes-menu-item-and-more" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#get-a-nodes-menu-item-and-more"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Get a node’s menu item and more</h2><p>Here we get the current route’s menu item using it’s nid, reset the link off the array and we can extract the URL and other exciting things. Mostly you want to check its children, parents etc. Here we grab it’s URL..</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/** @var \Drupal\Core\Menu\MenuLinkManagerInterface $menu_link_manager */</span>
<span class="nv">$menu_link_manager</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'plugin.manager.menu.link'</span><span class="p">);</span>
<span class="nv">$links</span> <span class="o">=</span> <span class="nv">$menu_link_manager</span><span class="o">-&gt;</span><span class="nf">loadLinksByRoute</span><span class="p">(</span><span class="s1">'entity.node.canonical'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'node'</span> <span class="o">=&gt;</span> <span class="nv">$nid</span><span class="p">]);</span>
<span class="nv">$link</span> <span class="o">=</span> <span class="nb">reset</span><span class="p">(</span><span class="nv">$links</span><span class="p">);</span>
<span class="nv">$urlobject</span> <span class="o">=</span> <span class="nv">$link</span><span class="o">-&gt;</span><span class="nf">getUrlObject</span><span class="p">();</span>
<span class="nv">$url_string</span> <span class="o">=</span> <span class="nv">$urlobject</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">();</span>
<span class="nv">$x</span> <span class="o">=</span> <span class="nv">$link</span><span class="o">-&gt;</span><span class="nf">getParent</span><span class="p">();</span> <span class="c1">//get the parent menu item GUID.</span>
<span class="nv">$y</span> <span class="o">=</span> <span class="nv">$link</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">();</span> <span class="c1">// get the title of the menu item.</span>

<span class="nv">$menu_name</span> <span class="o">=</span> <span class="nv">$link</span><span class="o">-&gt;</span><span class="nf">getMenuName</span><span class="p">();</span> <span class="c1">// get the menu name e.g. "main"</span>
</code></pre></div></div><h2 id="find-a-node-using-its-uuid"> <a aria-labelledby="find-a-node-using-its-uuid" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#find-a-node-using-its-uuid"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Find a node using it’s uuid</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Tries to get node for given uuid if it exists.
 *
 * @param string $uuid
 *   UUID to search for existing node.
 *
 * @return \Drupal\Core\Entity\EntityInterface[]|null
 *   Node object or NULL.
 *
 * @throws \Drupal\Component\Plugin\Exception\InvalidPluginDefinitionException
 * @throws \Drupal\Component\Plugin\Exception\PluginNotFoundException
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">getExistingUpdateNode</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$uuid</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nv">$existing_node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span>
      <span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">loadByProperties</span><span class="p">([</span><span class="s1">'uuid'</span> <span class="o">=&gt;</span> <span class="nv">$uuid</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nv">$existing_node</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">RequestException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">watchdog_exception</span><span class="p">(</span><span class="s1">'ncs_infoconnect'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">NULL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="retrieve-node-idnid-or-taxonomy-term-id-from-a-drupal-alias-or-path"> <a aria-labelledby="retrieve-node-idnid-or-taxonomy-term-id-from-a-drupal-alias-or-path" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-node-idnid-or-taxonomy-term-id-from-a-drupal-alias-or-path"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Retrieve Node ID(NID) or Taxonomy term ID from a Drupal alias or path</h2><p>If alias-path does not exist, it will return the same argumented string.</p><p>The first example will work for the node, second for the taxonomy and third for the users. For Drupal 8.8.0 and later use <strong>path_alias.manager</strong></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Node</span>
<span class="nv">$path</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'path.alias_manager'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getPathByAlias</span><span class="p">(</span><span class="s1">'/alias-path'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/node\/(\d+)/'</span><span class="p">,</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span>
    <span class="nv">$nodeID</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="c1">//Taxonomy term</span>
<span class="nv">$path</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'path.alias_manager'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getPathByAlias</span><span class="p">(</span><span class="s1">'/alias-path'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/taxonomy\/term\/(\d+)/'</span><span class="p">,</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span> 
  <span class="p">{</span>
    <span class="nv">$termID</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>

<span class="c1">//User</span>
<span class="nv">$path</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'path.alias_manager'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getPathByAlias</span><span class="p">(</span><span class="s1">'/alias-path'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/user\/(\d+)/'</span><span class="p">,</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span> 
  <span class="p">{</span>
    <span class="nv">$userID</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
</code></pre></div></div><h2 id="retrieve-all-nodes-with-a-matching-taxonomy-term"> <a aria-labelledby="retrieve-all-nodes-with-a-matching-taxonomy-term" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-all-nodes-with-a-matching-taxonomy-term"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Retrieve all nodes with a matching taxonomy term</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$nodes</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">loadByProperties</span><span class="p">([</span>
  <span class="s1">'field_tags'</span> <span class="o">=&gt;</span> <span class="nv">$term_id</span><span class="p">,</span>
<span class="p">]);</span>

<span class="c1">## Load first 5 nodes that have a matching taxonomy term</span>


<span class="sb">``</span><span class="err">`</span><span class="n">php</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">loadFirstOpinion</span><span class="p">(</span><span class="nv">$term_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$storage</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
  <span class="nv">$query</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityQuery</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'opinion'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_category'</span><span class="p">,</span> <span class="nv">$term_id</span><span class="p">,</span> <span class="s1">'='</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
  <span class="nv">$nids</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
  <span class="nv">$nodes</span> <span class="o">=</span> <span class="nv">$storage</span><span class="o">-&gt;</span><span class="nf">loadMultiple</span><span class="p">(</span><span class="nv">$nids</span><span class="p">);</span>

  <span class="nv">$ra</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$nodes</span> <span class="k">as</span> <span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$ra</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'markup'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;p&gt;'</span> <span class="mf">.</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">(),</span>
    <span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$ra</span><span class="p">;</span>
</code></pre></div></div><h2 id="how-to-uncache-a-particular-page-or-node"> <a aria-labelledby="how-to-uncache-a-particular-page-or-node" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#how-to-uncache-a-particular-page-or-node"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> How to uncache a particular page or node</h2><p>This will cause Drupal to rebuild the page internally, but won’t stop browsers or CDN’s from caching.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'page_cache_kill_switch'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">trigger</span><span class="p">();</span>
</code></pre></div></div><p>You can use this statement in node_preprocess, controller, etc.</p><p>You will need a custom module to implement setting max-age to 0 like this. In a <code class="language-plaintext highlighter-rouge">.module</code> file:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Entity\EntityInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Entity\Display\EntityViewDisplayInterface</span><span class="p">;</span>

<span class="k">function</span> <span class="n">drt_node_view_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$build</span><span class="p">,</span> <span class="kt">EntityInterface</span> <span class="nv">$entity</span><span class="p">,</span> <span class="kt">EntityViewDisplayInterface</span> <span class="nv">$display</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$bundle</span> <span class="o">=</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">bundle</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$bundle</span> <span class="o">==</span> <span class="s1">'search_home'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'#cache'</span><span class="p">][</span><span class="s1">'max-age'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'page_cache_kill_switch'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">trigger</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div><p>Note. The above custom module is called drt. You would use your own module name instead of drt when naming the function.</p><h2 id="get-boolean-field"> <a aria-labelledby="get-boolean-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#get-boolean-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Get boolean Field</h2><p>Boolean fields show up as 0 or 1 so a simple test using if <code class="language-plaintext highlighter-rouge">$val</code> will return true for yes/on and false for no/off.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$val</span> <span class="o">=</span> <span class="nv">$contract_node</span><span class="o">-&gt;</span><span class="n">field_erate_certification</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$erate_certification</span> <span class="o">=</span> <span class="s2">"Yes"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="date-field"> <a aria-labelledby="date-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Date Field</h2><p>Date fields in Drupal are stored in UTC date strings. When you load them, you have some options. Probably grabbing the field-&gt;date is the best so you can use all the goodness of the DrupalDateTime class. If you need to do calculations involving unix timestamps, then -&gt;getTimestamp is useful although DrupalDateTime can do all kinds of calculations too.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$end_date</span> <span class="o">=</span> <span class="nv">$contract_node</span><span class="o">-&gt;</span><span class="n">field_contract_end_date</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="nv">$end_date</span> <span class="o">=</span> <span class="nv">$contract_node</span><span class="o">-&gt;</span><span class="n">field_contract_end_date</span><span class="o">-&gt;</span><span class="n">date</span><span class="o">-&gt;</span><span class="nf">getTimestamp</span><span class="p">();</span>
<span class="nv">$end_date</span> <span class="o">=</span> <span class="nv">$contract_node</span><span class="o">-&gt;</span><span class="n">field_contract_end_date</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">;</span>
<span class="nv">$formatted_date</span> <span class="o">=</span> <span class="nv">$end_date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'m/d/y'</span><span class="p">);</span>

<span class="n">field_contract_end_date</span> <span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span> <span class="c1">//returns whatever the string is e.g. 2024-08-31</span>
<span class="n">field_contract_end_date</span><span class="o">-&gt;</span><span class="n">date</span><span class="o">-&gt;</span><span class="nf">getTimestamp</span><span class="p">();</span> <span class="c1">// returns unix timestamp e.g. 1725105600</span>
<span class="n">field_contract_end_date</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">;</span> <span class="c1">// returns a DrupalDateTime object with all it's goodness</span>

<span class="nv">$formatted_date</span> <span class="o">=</span> <span class="nv">$end_date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'m/d/y'</span><span class="p">);</span> <span class="c1">//Format the date nicely for output</span>
</code></pre></div></div><p>From <a href="https://drupal.stackexchange.com/questions/252333/how-to-get-formatted-date-string-from-a-datetimeitem-object">https://drupal.stackexchange.com/questions/252333/how-to-get-formatted-date-string-from-a-datetimeitem-object</a></p><p>A date field has two properties, </p><ul><li><p>value to store the date in UTC and </p><li><p>date, a computed field returning a DrupalDateTime object, on which you can use the methods getTimestamp() or format():</p></li></li></ul><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// get unix timestamp</span>
<span class="nv">$timestamp</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_date</span><span class="o">-&gt;</span><span class="n">date</span><span class="o">-&gt;</span><span class="nf">getTimestamp</span><span class="p">();</span>
<span class="c1">// get a formatted date</span>
<span class="nv">$date_formatted</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_date</span><span class="o">-&gt;</span><span class="n">date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">);</span>
</code></pre></div></div><h2 id="date-fields"> <a aria-labelledby="date-fields" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-fields"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Date Fields</h2><blockquote><p>See also Queries: “Query the creation date (among other things) using entityQuery”</p></blockquote><p>These are stored in the Drupal database as varchar 20 strings.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$d</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="s2">"m/d/Y"</span><span class="p">,</span><span class="nv">$timestamp</span><span class="p">);</span>
</code></pre></div></div><p>printing this date will return: 08/16/2018</p><p>From https://www.drupal.org/node/1834108</p><p>There is a DrupalDateTime object which is used like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$date</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromDateTime</span><span class="p">(</span><span class="nv">$datetime</span><span class="p">);</span>
<span class="nv">$date</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromArray</span><span class="p">(</span><span class="nv">$array</span><span class="p">);</span>
<span class="nv">$date</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromTimestamp</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">);</span>
<span class="nv">$date</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="nv">$format</span><span class="p">,</span> <span class="nv">$time</span><span class="p">);</span>
</code></pre></div></div><p>e.g. to create a <code class="language-plaintext highlighter-rouge">DrupalDateTime</code></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$format</span> <span class="o">=</span> <span class="s1">'Y-m-d H:i'</span><span class="p">;</span>
<span class="nv">$start_date</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="nv">$format</span><span class="p">,</span> <span class="err">“</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">01</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="s2">");
</span></code></pre></div></div><p>In the database the created and changed fields use a unix timestamp. e.g look in node_field_revision</p><p>This is an int 11 field in the db with a value like 1525302749 (Note. Negative values are dates before 1970 or epoch which require some slightly special magic)</p><p>If you add a Date field to a content type, it’s data looks like 2019-05-15T21:32:00 (varchar 20)</p><p>See the next item below for how to query the created and changed fields and also the fun you have to go through to query date fields.</p><p>When writing Drupal dates to the database, you need to go thru some machinations. Here are some details explain the timezone.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$date_string</span> <span class="o">=</span> <span class="s2">"2020-08-24T15:28:04+00:00"</span><span class="p">;</span>
<span class="nv">$tz</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">currentUser</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getTimezone</span><span class="p">();</span>
<span class="c1">// specify timezone as "America/Chicago"</span>
<span class="nv">$given</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\Drupal\Core\Datetime\DrupalDateTime</span><span class="p">(</span><span class="nv">$date_string</span><span class="p">,</span> <span class="nv">$tz</span><span class="p">);</span>
<span class="c1">// specify timezone as "UTC"</span>
<span class="nv">$given</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\Drupal\Core\Datetime\DrupalDateTime</span><span class="p">(</span><span class="nv">$date_string</span><span class="p">,</span> <span class="s2">"UTC"</span><span class="p">);</span>
<span class="c1">// specify UTC as the timezone</span>
<span class="nv">$given</span><span class="o">-&gt;</span><span class="nf">setTimezone</span><span class="p">(</span><span class="k">new</span> <span class="nc">\DateTimeZone</span><span class="p">(</span><span class="s2">"UTC"</span><span class="p">));</span>
<span class="c1">// The date string appears adjusted to UTC</span>
<span class="nv">$newstring</span> <span class="o">=</span> <span class="nv">$given</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s2">"Y-m-d\Th:i:s"</span><span class="p">);</span>
</code></pre></div></div><h2 id="date-range-field-doesnt-display-correct-timezone"> <a aria-labelledby="date-range-field-doesnt-display-correct-timezone" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-range-field-doesnt-display-correct-timezone"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Date Range Field doesn’t display correct timezone</h2><p>If you use a date range field in your content type and try to display the time part in a template, Drupal will cleverly display the UTC version (<em>not</em> your current timezone version) so the time will be off by potentially ~6 hours.</p><p>Using the field field_event_date, here is the twig template code to display the date. You’d expect it to show the correct timezone</p><div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{{</span> <span class="nv">node.field_event_date.0.value</span><span class="o">|</span><span class="nf">date</span><span class="p">(</span><span class="s1">'g:ia'</span><span class="p">)</span> <span class="cp">}}</span> - <span class="cp">{{</span> <span class="nv">node.field_event_date.0.end_value</span><span class="o">|</span><span class="nf">date</span><span class="p">(</span><span class="s1">'g:ia'</span><span class="p">)</span> <span class="cp">}}</span>
</code></pre></div></div><p>If you simply used <code class="language-plaintext highlighter-rouge">{{ content }}</code> all fields are displayed correctly – timezone is correct.</p><p>If you use <code class="language-plaintext highlighter-rouge">{{ content.field_date_start }}</code> – timezone show correctly also</p><p>But I want to grab the time only to display separately from the date and put this in the twig template:</p><div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{{</span> <span class="nv">node.field_date_start.value</span><span class="o">|</span><span class="nf">date</span><span class="p">(</span><span class="s2">"g:ia"</span><span class="p">)</span> <span class="cp">}}</span>
</code></pre></div></div><p>It fails.</p><p>From</p><p>The solution is to create a variable in the template_preprocess_node. Append ‘UTC’ to the datetime string and make a timestamp so you get the UTC time (which matches what is in the Drupal DB.). Grab the user’s timezone for conversion purposes. Use the Drupal date.formatter service to format a timestamp (using the timezone) and you are good to go.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">txglobal_preprocess_node</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$variables</span><span class="p">)</span> <span class="p">{</span>
<span class="mf">..</span>

  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nv">$node_type</span> <span class="o">==</span> <span class="s1">'event'</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

    <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$variables</span><span class="p">[</span><span class="s1">'node'</span><span class="p">];</span>
    <span class="nv">$timezone</span> <span class="o">=</span> <span class="nf">drupal_get_user_timezone</span><span class="p">();</span>
    <span class="nv">$formatter</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'date.formatter'</span><span class="p">);</span>

    <span class="nv">$dates</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_event_date'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>

    <span class="nv">$date_start</span> <span class="o">=</span> <span class="nv">$dates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'value'</span><span class="p">];</span>
    <span class="nv">$time</span> <span class="o">=</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$date_start</span><span class="mf">.</span><span class="s1">' UTC'</span><span class="p">);</span>
    <span class="nv">$start_time</span> <span class="o">=</span> <span class="nv">$formatter</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="nv">$time</span><span class="p">,</span> <span class="s1">'custom'</span><span class="p">,</span> <span class="s1">'g:ia'</span><span class="p">,</span> <span class="nv">$timezone</span><span class="p">);</span>
<span class="c1">//    $start_time = date("g:ia", $time);</span>

    <span class="nv">$date_end</span> <span class="o">=</span> <span class="nv">$dates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'end_value'</span><span class="p">];</span>
    <span class="nv">$time</span> <span class="o">=</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$date_end</span><span class="mf">.</span><span class="s1">' UTC'</span><span class="p">);</span>
    <span class="nv">$end_time</span> <span class="o">=</span> <span class="nv">$formatter</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="nv">$time</span><span class="p">,</span> <span class="s1">'custom'</span><span class="p">,</span> <span class="s1">'g:ia'</span><span class="p">,</span> <span class="nv">$timezone</span><span class="p">);</span>

<span class="c1">//    $date_start = new DateTime($date_start);</span>
<span class="c1">//    $timestamp_start = $date_start-&gt;getTimestamp();</span>
<span class="c1">//    $start_time = $formatter-&gt;format($timestamp_start, 'custom', 'g:ia', $timezone);</span>
<span class="c1">//    $end_time = $formatter-&gt;format($date_end, 'custom', 'g:ia', $timezone);</span>

    <span class="nv">$variables</span><span class="p">[</span><span class="s1">'start_time'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$start_time</span><span class="p">;</span>
    <span class="nv">$variables</span><span class="p">[</span><span class="s1">'end_time'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$end_time</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div><p>and then in the template, use</p><p>` - `</p><p>Interestingly, if you use the <a href="https://www.drupal.org/project/smart_date">smart_date module</a>, you might use this version. Notice that dates are already stored as timestamps so you don’t have to first convert them.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span> <span class="nv">$node_type</span> <span class="o">==</span> <span class="s1">'event'</span> <span class="o">&amp;&amp;</span> <span class="nv">$view_mode</span> <span class="o">==</span> <span class="s1">'default'</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nv">$timezone</span> <span class="o">=</span> <span class="nf">drupal_get_user_timezone</span><span class="p">();</span>
  <span class="nv">$formatter</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'date.formatter'</span><span class="p">);</span>

  <span class="nv">$d</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_smart_event_date'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
  <span class="nv">$d0s</span> <span class="o">=</span> <span class="nv">$d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"value"</span><span class="p">];</span> <span class="c1">//first date start time</span>
  <span class="nv">$d0e</span> <span class="o">=</span> <span class="nv">$d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"end_value"</span><span class="p">];</span> <span class="c1">//first date end time</span>
  <span class="nv">$start_time</span> <span class="o">=</span> <span class="nv">$formatter</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="nv">$d0s</span><span class="p">,</span> <span class="s1">'custom'</span><span class="p">,</span> <span class="s1">'g:ia'</span><span class="p">);</span>
  <span class="nv">$end_time</span> <span class="o">=</span> <span class="nv">$formatter</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="nv">$d0e</span><span class="p">,</span> <span class="s1">'custom'</span><span class="p">,</span> <span class="s1">'g:ia'</span><span class="p">,</span> <span class="nv">$timezone</span><span class="p">);</span>
  <span class="nv">$variables</span><span class="p">[</span><span class="s1">'start_time'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$start_time</span><span class="p">;</span>
  <span class="nv">$variables</span><span class="p">[</span><span class="s1">'end_time'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$end_time</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="date-range"> <a aria-labelledby="date-range" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-range"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Date Range</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// formatted start date</span>
<span class="nv">$start_date_formatted</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_date</span><span class="o">-&gt;</span><span class="n">start_date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">);</span>
<span class="c1">// formatted end date</span>
<span class="nv">$end_date_formatted</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_date</span><span class="o">-&gt;</span><span class="n">end_date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">);</span>
</code></pre></div></div><h2 id="date-range-fields-load-start-and-end-values"> <a aria-labelledby="date-range-fields-load-start-and-end-values" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-range-fields-load-start-and-end-values"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Date Range fields: Load start and end values</h2><p>Start date and end date.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_end_dates'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span>
<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_end_dates'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">end_value</span>
</code></pre></div></div><h2 id="date-fields-load-or-save-them"> <a aria-labelledby="date-fields-load-or-save-them" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-fields-load-or-save-them"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Date Fields: Load or save them</h2><p>Because date fields in Drupal are stored in strings, when you use <code class="language-plaintext highlighter-rouge">get()</code> or <code class="language-plaintext highlighter-rouge">set()</code>, they are still strings.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_end_dates'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span>

<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_cn_end_date'</span><span class="p">,</span> <span class="nv">$end_date</span><span class="p">);</span>
</code></pre></div></div><p>If you want to manipulate them, convert them to DrupalDateTime objects, then convert them back to strings</p><p>Creating a new <code class="language-plaintext highlighter-rouge">DrupalDateTime</code> object is done like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Datetime\DrupalDateTime</span><span class="p">;</span>

<span class="nv">$date</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s1">'j-M-Y'</span><span class="p">,</span> <span class="s1">'20-Jul-2019'</span><span class="p">);</span>

<span class="nv">$date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DrupalDateTime</span><span class="p">(</span><span class="s1">'now'</span><span class="p">);</span>  <span class="c1">// grab current dateTime using NON static</span>
<span class="nv">$date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'l, F j, Y - H:i'</span><span class="p">);</span> <span class="c1">// format it </span>
<span class="c1">// prints out nicely formatted version: Tue, Jul 16, 2019 - 11:34:am</span>

<span class="nv">$date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DrupalDateTime</span><span class="p">(</span><span class="s1">'now'</span><span class="p">);</span>  <span class="c1">// grab current dateTime</span>
<span class="c1">// Or print $date-&gt;format('d-m-Y: H:i A');</span>
<span class="c1">// prints out: 16-07-2019: 11:43 AM</span>
</code></pre></div></div><p>How about with timezones?</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DrupalDateTime</span><span class="p">();</span>
<span class="nv">$date</span><span class="o">-&gt;</span><span class="nf">setTimezone</span><span class="p">(</span><span class="k">new</span> <span class="nc">\DateTimeZone</span><span class="p">(</span><span class="s1">'America/Chicago'</span><span class="p">));</span>
<span class="k">print</span> <span class="nv">$date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'m/d/Y g:i a'</span><span class="p">);</span>
<span class="c1">// The above prints current time for given Timezone</span>
<span class="c1">// prints : 07/16/2019 10:59 am</span>

<span class="c1">// Another variations of the above except it takes specific date and UTC zone</span>
<span class="nv">$date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DrupalDateTime</span><span class="p">(</span><span class="s1">'2019-07-31 11:30:00'</span><span class="p">,</span> <span class="s1">'UTC'</span><span class="p">);</span>
<span class="nv">$date</span><span class="o">-&gt;</span><span class="nf">setTimezone</span><span class="p">(</span><span class="k">new</span> <span class="nc">\DateTimeZone</span><span class="p">(</span><span class="s1">'America/Chicago'</span><span class="p">));</span>
<span class="k">print</span> <span class="nv">$date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'m/d/Y g:i a'</span><span class="p">);</span>
<span class="c1">// prints 07/31/2019 6:30 am</span>
</code></pre></div></div><p>The code below shows adding <code class="language-plaintext highlighter-rouge">$days</code> (an integer) to the date value retrieved from the field: field_cn_start_date.</p><p>Don’t forget to add the use statement.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Datetime\DrupalDateTime</span><span class="p">;</span>


<span class="nv">$start_date_val</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_date'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="nv">$days</span> <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_suspension_length'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

<span class="c1">//$end_date = DrupalDateTime::createFromFormat('Y-m-d H:i:s', $start_date_val . " 00:00:00");</span>
<span class="nv">$end_date</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">,</span> <span class="nv">$start_date_val</span> <span class="p">);</span>
<span class="nv">$end_date</span><span class="o">-&gt;</span><span class="nf">modify</span><span class="p">(</span><span class="s2">"+</span><span class="nv">$days</span><span class="s2"> days"</span><span class="p">);</span>
<span class="nv">$end_date</span> <span class="o">=</span> <span class="nv">$end_date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s2">"Y-m-d"</span><span class="p">);</span>

<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_cn_end_date'</span><span class="p">,</span> <span class="nv">$end_date</span><span class="p">);</span>
</code></pre></div></div><h2 id="comparing-drupaldatetime-values"> <a aria-labelledby="comparing-drupaldatetime-values" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#comparing-drupaldatetime-values"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Comparing DrupalDateTime values</h2><p><code class="language-plaintext highlighter-rouge">DrupalDateTimes</code> are derived from DateTimePlus which are wrappers for PHP <code class="language-plaintext highlighter-rouge">DateTime</code> class. So you can use that functionality to do comparisons</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">date_default_timezone_set</span><span class="p">(</span><span class="s1">'Europe/London'</span><span class="p">);</span>

<span class="nv">$d1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DateTime</span><span class="p">(</span><span class="s1">'2008-08-03 14:52:10'</span><span class="p">);</span>
<span class="nv">$d2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DateTime</span><span class="p">(</span><span class="s1">'2008-01-03 11:11:10'</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$d1</span> <span class="o">==</span> <span class="nv">$d2</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$d1</span> <span class="o">&gt;</span> <span class="nv">$d2</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$d1</span> <span class="o">&lt;</span> <span class="nv">$d2</span><span class="p">);</span>
</code></pre></div></div><p>outputs:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bool(false)
bool(true)
bool(false)
</code></pre></div></div><h2 id="date-with-embedded-timezone"> <a aria-labelledby="date-with-embedded-timezone" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-with-embedded-timezone"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Date with embedded timezone</h2><p>Here you have a date string with an embedded timezone so you can make it into a <code class="language-plaintext highlighter-rouge">DrupalDateTime</code> and then format it into a usable string you can store in the db.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Datetime\DrupalDateTime</span><span class="p">;</span>

<span class="nv">$date_string</span> <span class="o">=</span> <span class="s2">"2020-08-24T15:28:04+00:00"</span><span class="p">;</span>
<span class="nv">$given</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DrupalDateTime</span><span class="p">(</span><span class="nv">$date_string</span><span class="p">);</span>
<span class="nv">$newstring</span> <span class="o">=</span> <span class="nv">$given</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s2">"Y-m-d\Th:i:s"</span><span class="p">);</span>
</code></pre></div></div><h2 id="has-something-expired"> <a aria-labelledby="has-something-expired" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#has-something-expired"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Has something expired?</h2><p>Checking to see if the expiration_date has passed. The <code class="language-plaintext highlighter-rouge">field_expiration_date</code> is a standard Drupal date field in the sf_resellers content type.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$source_node</span> <span class="o">=</span> <span class="nv">$node_storage</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nv">$nid</span><span class="p">);</span>

<span class="nv">$expiration_date</span> <span class="o">=</span> <span class="nv">$source_node</span><span class="o">-&gt;</span><span class="n">field_expiration_date</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

<span class="c1">// Use expiration date to un-publish expired resellers to hide them.</span>
<span class="nv">$status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$expiration_date</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$expirationDate</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">,</span> <span class="nv">$expiration_date</span><span class="p">);</span>
  <span class="nv">$now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DrupalDateTime</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$expiration_date</span> <span class="o">&lt;</span> <span class="nv">$now</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>TODO: date fields are stored in UTC. Need to factor in timezone.</p><h2 id="load-or-save-drupal-date-fields"> <a aria-labelledby="load-or-save-drupal-date-fields" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-or-save-drupal-date-fields"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load or save Drupal Date fields</h2><p>Date fields in Drupal are stored in strings</p><p>If you want to load them, just <code class="language-plaintext highlighter-rouge">get()</code>, as below and to save them, use <code class="language-plaintext highlighter-rouge">set</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_end_dates'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span>

<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_cn_end_date'</span><span class="p">,</span> <span class="nv">$end_date</span><span class="p">);</span>
</code></pre></div></div><p>If you want to manipulate them, convert them to <code class="language-plaintext highlighter-rouge">DrupalDateTime</code> objects, then convert them back to strings like this. $days here is an int and we are adding that to the date value. Don’t forget to add the use statement.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Datetime\DrupalDateTime</span><span class="p">;</span>


<span class="nv">$start_date_val</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_date'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="nv">$days</span> <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_suspension_length'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

<span class="c1">//  $end_date = DrupalDateTime::createFromFormat('Y-m-d H:i:s', $start_date_val . " 00:00:00");</span>
<span class="nv">$end_date</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">,</span> <span class="nv">$start_date_val</span> <span class="p">);</span>
<span class="nv">$end_date</span><span class="o">-&gt;</span><span class="nf">modify</span><span class="p">(</span><span class="s2">"+</span><span class="nv">$days</span><span class="s2"> days"</span><span class="p">);</span>
<span class="nv">$end_date</span> <span class="o">=</span> <span class="nv">$end_date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s2">"Y-m-d"</span><span class="p">);</span>

<span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_cn_end_date'</span><span class="p">,</span> <span class="nv">$end_date</span><span class="p">);</span>
</code></pre></div></div><p>Here you have a slightly funny date string, you make it into a <code class="language-plaintext highlighter-rouge">DrupalDateTime</code> and then format it into a usable string you can store in the database.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Datetime\DrupalDateTime</span><span class="p">;</span>

<span class="nv">$date_string</span> <span class="o">=</span> <span class="s2">"2020-08-24T15:28:04+00:00"</span><span class="p">;</span>
<span class="nv">$given</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\Drupal\Core\Datetime\DrupalDateTime</span><span class="p">(</span><span class="nv">$date_string</span><span class="p">);</span>
<span class="nv">$newstring</span> <span class="o">=</span> <span class="nv">$given</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s2">"Y-m-d\Th:i:s"</span><span class="p">);</span>
</code></pre></div></div><h2 id="retrieve-node-creation-date-and-format-it"> <a aria-labelledby="retrieve-node-creation-date-and-format-it" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-node-creation-date-and-format-it"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Retrieve node creation date and format it</h2><p>Here I query the database for a node and return a string version of the date. It probably makes more sense to return the date and do the formatting at the theme level. Note. This will handle epoch dates before 1970.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Datetime\DrupalDateTime</span><span class="p">;</span>


  <span class="k">protected</span> <span class="k">function</span> <span class="n">loadFirstOpinionYear</span><span class="p">(</span><span class="nv">$term_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$storage</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
    <span class="nv">$query</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityQuery</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'opinion'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_category'</span><span class="p">,</span> <span class="nv">$term_id</span><span class="p">,</span> <span class="s1">'='</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nb">sort</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'ASC'</span><span class="p">)</span> <span class="c1">//DESC</span>
      <span class="o">-&gt;</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nv">$nids</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$nids</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$storage</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nb">reset</span><span class="p">(</span><span class="nv">$nids</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="nv">$time</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'created'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

    <span class="nv">$d</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DrupalDateTime</span><span class="p">(</span><span class="s2">"@</span><span class="nv">$time</span><span class="s2">"</span><span class="p">);</span> <span class="c1">//can use either this</span>
    <span class="nv">$d</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\DateTime</span><span class="p">(</span><span class="s2">"@</span><span class="nv">$time</span><span class="s2">"</span><span class="p">);</span>      <span class="c1">// or this..</span>

    <span class="nv">$str</span> <span class="o">=</span> <span class="nv">$d</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$str</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div><h2 id="retrieve-node-creation-or-changed-date-and-format-it"> <a aria-labelledby="retrieve-node-creation-or-changed-date-and-format-it" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#retrieve-node-creation-or-changed-date-and-format-it"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Retrieve node creation or changed date and format it</h2><p>Both created and changed are stored as Unix epoch timestamps the node_field_data table. Here I query the database for a node and return a string version of the date. Note. This will handle epoch dates before 1970.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Datetime\DrupalDateTime</span><span class="p">;</span>

  <span class="k">protected</span> <span class="k">function</span> <span class="n">loadFirstOpinionYear</span><span class="p">(</span><span class="nv">$term_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$storage</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
    <span class="nv">$query</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityQuery</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'opinion'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_category'</span><span class="p">,</span> <span class="nv">$term_id</span><span class="p">,</span> <span class="s1">'='</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nb">sort</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'ASC'</span><span class="p">)</span> <span class="c1">//DESC</span>
      <span class="o">-&gt;</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nv">$nids</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$nids</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$storage</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nb">reset</span><span class="p">(</span><span class="nv">$nids</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="nv">$time</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'created'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

    <span class="nv">$d</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DrupalDateTime</span><span class="p">(</span><span class="s2">"@</span><span class="nv">$time</span><span class="s2">"</span><span class="p">);</span> <span class="c1">//can use either this</span>
    <span class="nv">$d</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\DateTime</span><span class="p">(</span><span class="s2">"@</span><span class="nv">$time</span><span class="s2">"</span><span class="p">);</span> <span class="c1">// or this..</span>

    <span class="nv">$str</span> <span class="o">=</span> <span class="nv">$d</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$str</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div><h2 id="date-field-and-date-with-no-time-remove-time"> <a aria-labelledby="date-field-and-date-with-no-time-remove-time" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#date-field-and-date-with-no-time-remove-time"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Date Field and Date with no time (remove time)</h2><p>Use the setTime() function to remove the time part of a datetime so we can make comparisons of just the date.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">ogg_mods_cn_form_validate</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$start_date</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'field_cn_start_date'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$start_date</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$start_date</span> <span class="o">=</span> <span class="nv">$start_date</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'value'</span><span class="p">];</span>
      <span class="nv">$start_date</span><span class="o">-&gt;</span><span class="nf">setTime</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nv">$now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Drupal\Core\Datetime\DrupalDateTime</span><span class="p">();</span>
      <span class="nv">$now</span><span class="o">-&gt;</span><span class="nf">modify</span><span class="p">(</span><span class="s2">"-2 days"</span><span class="p">);</span>
      <span class="nv">$now</span><span class="o">-&gt;</span><span class="nf">setTime</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

      <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addMessage</span><span class="p">(</span><span class="s2">"Start date = </span><span class="nv">$start_date</span><span class="s2">"</span><span class="p">);</span>
      <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addMessage</span><span class="p">(</span><span class="s2">"Now date - 2 days = </span><span class="nv">$now</span><span class="s2">"</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nv">$start_date</span> <span class="o">&lt;</span> <span class="nv">$now</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setErrorByName</span><span class="p">(</span><span class="s1">'edit-field-cn-start-date-0-value-date'</span><span class="p">,</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'The starting date is more than 2 days in the past. Please select a later date'</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="smart-date-smart_date-load-and-format"> <a aria-labelledby="smart-date-smart_date-load-and-format" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#smart-date-smart_date-load-and-format"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Smart date (smart_date) load and format</h2><p>Load the smart date field and use the drupal date formatting service. Smart date fields are always stored as unix timestamp values e.g. 1608566400 which need conversion for human consumption.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$start</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_when</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="nv">$formatter</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'date.formatter'</span><span class="p">);</span>
<span class="nv">$start_time</span> <span class="o">=</span> <span class="nv">$formatter</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="nv">$start</span><span class="p">,</span> <span class="s1">'custom'</span><span class="p">,</span> <span class="s1">'m/d/Y g:ia'</span><span class="p">);</span> <span class="c1">//12/21/2020 10:00 am</span>

<span class="nc">Alternatively</span><span class="p">,</span> <span class="n">you</span> <span class="n">could</span> <span class="n">load</span> <span class="n">it</span><span class="p">,</span> <span class="n">create</span> <span class="n">a</span> <span class="sb">`DrupalDateTime`</span> <span class="k">and</span> <span class="n">then</span>
<span class="n">format</span> <span class="n">it</span>

<span class="sb">``</span><span class="err">`</span><span class="n">php</span>
<span class="nv">$start</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_when</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="nv">$dt</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromTimestamp</span><span class="p">(</span><span class="nv">$start</span><span class="p">);</span>
<span class="nv">$start_date</span> <span class="o">=</span> <span class="nv">$dt</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'m/d/y'</span><span class="p">);</span> <span class="c1">//returns 12/21/20</span>
<span class="nv">$start_time</span> <span class="o">=</span> <span class="nv">$dt</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'g:ia'</span><span class="p">);</span> <span class="c1">// returns 10:00am</span>
</code></pre></div></div><h2 id="smart-date-smart_date-all-day"> <a aria-labelledby="smart-date-smart_date-all-day" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#smart-date-smart_date-all-day"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Smart date (smart_date) all-day</h2><p>To check if a smart date is set to all day, check the duration. If it is 1439, that means all day.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$start_ts</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_when</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<span class="nv">$start_dt</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromTimestamp</span><span class="p">(</span><span class="nv">$start_ts</span><span class="p">);</span>
<span class="nv">$start_date</span> <span class="o">=</span> <span class="nv">$start_dt</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'m/d/Y'</span><span class="p">);</span>
<span class="nv">$duration</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_when</span><span class="o">-&gt;</span><span class="n">duration</span><span class="p">;</span>  <span class="c1">//1439 = all day</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$duration</span> <span class="o">==</span> <span class="mi">1439</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$start_time</span> <span class="o">=</span> <span class="s2">"all day"</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="nv">$start_time</span> <span class="o">=</span> <span class="nv">$start_dt</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'g:ia'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="smart-date-smart_date-range-of-values"> <a aria-labelledby="smart-date-smart_date-range-of-values" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#smart-date-smart_date-range-of-values"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Smart date (smart_date) range of values</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Event start date.</span>
<span class="nv">$whens</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_when'</span><span class="p">);</span> <span class="c1">//produces SmartDateFieldItemList</span>

<span class="c1">// Each $when is a \Drupal\smart_date\Plugin\Field\FieldType\SmartDateItem</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$whens</span> <span class="k">as</span> <span class="nv">$when</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$when</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
  <span class="nv">$end</span> <span class="o">=</span> <span class="nv">$when</span><span class="o">-&gt;</span><span class="n">end_value</span><span class="p">;</span>
  <span class="nv">$duration</span> <span class="o">=</span> <span class="nv">$when</span><span class="o">-&gt;</span><span class="n">duration</span><span class="p">;</span>  <span class="c1">//1439 = all day</span>
  <span class="nv">$tz</span> <span class="o">=</span> <span class="nv">$when</span><span class="o">-&gt;</span><span class="n">timezone</span><span class="p">;</span>  <span class="c1">//"" means default. Uses America/Chicago type format.</span>
<span class="p">}</span>
</code></pre></div></div><p>You can also peek into the repeating rule and repeating rule index. These are in the <code class="language-plaintext highlighter-rouge">smart_date_rule</code> table and I believe the index identifies which item is in the <code class="language-plaintext highlighter-rouge">instances</code> column.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$rrule</span> <span class="o">=</span> <span class="nv">$when</span><span class="o">-&gt;</span><span class="n">rrule</span><span class="p">;</span>
<span class="nv">$rrule_index</span> <span class="o">=</span> <span class="nv">$when</span><span class="o">-&gt;</span><span class="n">rrule_index</span><span class="p">;</span>
</code></pre></div></div><h2 id="hook_node_presave-or-hook_entity_type_presave"> <a aria-labelledby="hook_node_presave-or-hook_entity_type_presave" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#hook_node_presave-or-hook_entity_type_presave"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> hook_node_presave or hook_entity_type_presave</h2><p>When you want to fiddle with a node as it is being saved, use <code class="language-plaintext highlighter-rouge">hook_node_presave()</code></p><p>Note there is some good date arithmetic here</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Implements hook_ENTITY_TYPE_presave().
 */</span>
<span class="k">function</span> <span class="n">ogg_mods_node_presave</span><span class="p">(</span><span class="kt">NodeInterface</span> <span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nb">getType</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'catastrophe_notice'</span><span class="o">:</span>
      <span class="nv">$end_date</span> <span class="o">=</span> <span class="kc">NULL</span> <span class="o">!=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_end_dates'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">end_value</span> <span class="o">?</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_end_dates'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">end_value</span> <span class="o">:</span> <span class="s1">'n/a'</span><span class="p">;</span>
      <span class="nv">$govt_body</span> <span class="o">=</span> <span class="kc">NULL</span> <span class="o">!=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_cn_governmental_body</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">?</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">field_cn_governmental_body</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">:</span> <span class="s1">'Unnamed Government Body'</span><span class="p">;</span>
      <span class="nv">$start_date_val</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_date'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

      <span class="nv">$accountProxy</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">currentUser</span><span class="p">();</span>
      <span class="nv">$account</span> <span class="o">=</span> <span class="nv">$accountProxy</span><span class="o">-&gt;</span><span class="nf">getAccount</span><span class="p">();</span>
      <span class="c1">// Anonymous users automatically fill out the end_date.</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">hasPermission</span><span class="p">(</span><span class="s1">'administer catastrophe notice'</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$days</span> <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_suspension_length'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

        <span class="nv">$end_date</span> <span class="o">=</span> <span class="nc">DrupalDateTime</span><span class="o">::</span><span class="nf">createFromFormat</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">,</span> <span class="nv">$start_date_val</span><span class="p">);</span>
        <span class="nv">$end_date</span><span class="o">-&gt;</span><span class="nf">modify</span><span class="p">(</span><span class="s2">"+</span><span class="nv">$days</span><span class="s2"> days"</span><span class="p">);</span>
        <span class="nv">$end_date</span> <span class="o">=</span> <span class="nv">$end_date</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s2">"Y-m-d"</span><span class="p">);</span>
        <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_cn_end_date'</span><span class="p">,</span> <span class="nv">$end_date</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Always reset the title.</span>
      <span class="nv">$title</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$govt_body</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">" - </span><span class="nv">$start_date_val</span><span class="s2">"</span><span class="p">;</span>
      <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">setTitle</span><span class="p">(</span><span class="nv">$title</span><span class="p">);</span>

      <span class="cm">/*
       *  Fill in Initial start and end dates if this is an extension of
       * a previously submitted notice.
       */</span>
      <span class="nv">$extension</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_extension'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$extension</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$previous_notice_nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_original_notice'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
        <span class="nv">$previous_notice</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$previous_notice_nid</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$previous_notice</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$initial_start</span> <span class="o">=</span> <span class="nv">$previous_notice</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_start_date'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
          <span class="nv">$initial_end</span> <span class="o">=</span> <span class="nv">$previous_notice</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_cn_end_date'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
          <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_cn_initial_start_date'</span><span class="p">,</span> <span class="nv">$initial_start</span><span class="p">);</span>
          <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_cn_initial_end_date'</span><span class="p">,</span> <span class="nv">$initial_end</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="disable-caching-for-a-content-type"> <a aria-labelledby="disable-caching-for-a-content-type" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#disable-caching-for-a-content-type"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Disable caching for a content type</h2><p>If someone tries to view a node of content type <code class="language-plaintext highlighter-rouge">search_home</code> (entity of bundle <code class="language-plaintext highlighter-rouge">search_home</code>) caching is disabled and Drupal and the browser will always re-render the page. This is necessary for a page that is retrieving data from a third party source and you almost always expect it to be different. It wouldn’t work for a search page to show results from a previous search.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Entity\EntityInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Entity\Display\EntityViewDisplayInterface</span><span class="p">;</span>
  

<span class="kn">use</span> <span class="nc">Drupal\Core\Entity\EntityInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Entity\Display\EntityViewDisplayInterface</span><span class="p">;</span>

<span class="cd">/**
 * Implements hook_ENTITY_TYPE_view_alter().
 */</span>
<span class="k">function</span> <span class="n">dir_node_view_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$build</span><span class="p">,</span> <span class="kt">EntityInterface</span> <span class="nv">$entity</span><span class="p">,</span> <span class="kt">EntityViewDisplayInterface</span> <span class="nv">$display</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$bundle</span> <span class="o">=</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">bundle</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$bundle</span> <span class="o">==</span> <span class="s1">'search_home'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'#cache'</span><span class="p">][</span><span class="s1">'max-age'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'page_cache_kill_switch'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">trigger</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>In the API docs ( <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Entity%21entity.api.php/function/hook_ENTITY_TYPE_view_alter/9.2.x">https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Entity%21entity.api.php/function/hook_ENTITY_TYPE_view_alter/9.2.x</a> ) They have an example where they check the view mode and dynamically add a field to the node. There is also a post_render callback function added to do some more magic. To implement, you’d have to replace ENTITY_TYPE with your entity type such as node. See below:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">hook_ENTITY_TYPE_view_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$build</span><span class="p">,</span> <span class="kt">Drupal</span><span class="nc">\Core\Entity\EntityInterface</span> <span class="nv">$entity</span><span class="p">,</span> <span class="nc">\Drupal\Core\Entity\Display\EntityViewDisplayInterface</span> <span class="nv">$display</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$build</span><span class="p">[</span><span class="s1">'#view_mode'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'full'</span> <span class="o">&amp;&amp;</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$build</span><span class="p">[</span><span class="s1">'an_additional_field'</span><span class="p">]))</span> <span class="p">{</span>

    <span class="c1">// Change its weight.</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'an_additional_field'</span><span class="p">][</span><span class="s1">'#weight'</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">;</span>

    <span class="c1">// Add a #post_render callback to act on the rendered HTML of the entity.</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'#post_render'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'my_module_node_post_render'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="writing-some-json-data-into-a-long-text-field"> <a aria-labelledby="writing-some-json-data-into-a-long-text-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#writing-some-json-data-into-a-long-text-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Writing some JSON data into a long text field</h2><p>It is sometimes useful to store JSON data into a long text field. I’ve used it for storing formatted status information about a complex process.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$aggregate_values</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'citation_status'</span> <span class="o">=&gt;</span> <span class="nv">$citation_status</span><span class="p">,</span>
  <span class="s1">'accepted_votes'</span> <span class="o">=&gt;</span> <span class="nv">$accepted_votes</span><span class="p">,</span>
  <span class="s1">'rejected_votes'</span> <span class="o">=&gt;</span> <span class="nv">$rejected_votes</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$aggregate_data</span> <span class="o">=</span> <span class="nc">Json</span><span class="o">::</span><span class="nf">encode</span><span class="p">(</span><span class="nv">$aggregate_values</span><span class="p">);</span>
<span class="nv">$citation_node</span><span class="o">-&gt;</span><span class="n">field_srp_agg_data_json</span><span class="p">[</span><span class="nv">$vote_number</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$aggregate_data</span><span class="p">;</span>
<span class="nv">$citation_node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><p>The JSON data is written into a multivalue long text field using the $vote_number index. So if $vote_number is 0, this will be the first value. If it is 1, then this will be written into the second value. This is what it looks like in Drupal on a node edit screen.</p><p><img alt="Screenshot of JSON data in long text field" src="https://selwynpolit.github.io/d9book/assets/images/json_long_text.png"/></p><h2 id="create-a-node-with-an-image-1"> <a aria-labelledby="create-a-node-with-an-image-1" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#create-a-node-with-an-image-1"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Create a node with an image</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">\Drupal\node\Entity\Node</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">\Drupal\file\Entity\File</span><span class="p">;</span>

  <span class="c1">// Create file object from remote URL.</span>
  <span class="nv">$data</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'https://www.drupal.org/files/druplicon.small_.png'</span><span class="p">);</span>
  <span class="nv">$file</span> <span class="o">=</span> <span class="nf">file_save_data</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="s1">'public://druplicon.png'</span><span class="p">,</span> <span class="no">FILE_EXISTS_REPLACE</span><span class="p">);</span>

  <span class="c1">// Create node object with attached file.</span>
  <span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">create</span><span class="p">([</span>
    <span class="s1">'type'</span>        <span class="o">=&gt;</span> <span class="s1">'article'</span><span class="p">,</span>
    <span class="s1">'title'</span>       <span class="o">=&gt;</span> <span class="s1">'Druplicon test'</span><span class="p">,</span>
    <span class="s1">'field_image'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'target_id'</span> <span class="o">=&gt;</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">(),</span>
      <span class="s1">'alt'</span> <span class="o">=&gt;</span> <span class="s1">'Hello world'</span><span class="p">,</span>
      <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Goodbye world'</span>
    <span class="p">],</span>
  <span class="p">]);</span>
  <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><h2 id="paragraphs"> <a aria-labelledby="paragraphs" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#paragraphs"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Paragraphs</h2><p>Paragraphs are those special things that allow you to blend a couple of field together e.g. count and unit of measure so you can store values like 5 kilograms or 7 years etc. Often they are used like nodes where you define the fields and fill them with data that get displayed on the screen for things like carousels or events.</p><h2 id="load-a-node-and-find-the-terms-referenced-in-a-paragraph-in-a-term-reference-field-1"> <a aria-labelledby="load-a-node-and-find-the-terms-referenced-in-a-paragraph-in-a-term-reference-field-1" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#load-a-node-and-find-the-terms-referenced-in-a-paragraph-in-a-term-reference-field-1"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load a node and find the terms referenced in a paragraph in a term reference field</h2><p>Here we loop thru all the instances of my paragraph reference and grab the term in the paragraph.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\taxonomy\Entity\Term</span><span class="p">;</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_my_para'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">referencedEntities</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$ent</span><span class="p">){</span>
  <span class="nv">$term</span> <span class="o">=</span> <span class="nc">Term</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$ent</span><span class="o">-&gt;</span><span class="nv">$field_in_paragraph</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>
  <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$term</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">();</span>
  <span class="nb">print_r</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="custom-field-formatter"> <a aria-labelledby="custom-field-formatter" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#custom-field-formatter"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Custom Field Formatter</h2><p>Custom field formatters can be used in display modes or in views. These are very powerful.</p><p>Some basic info is available at <a href="https://www.drupal.org/docs/8/creating-custom-modules/create-a-custom-field-formatter">https://www.drupal.org/docs/8/creating-custom-modules/create-a-custom-field-formatter</a></p><p>This example is a custom formatter that takes a value from a field (in this case a uuid) and builds a url which essentially retrieves an image (via an API call.) It looks for some config info (in the node display mode for the node, or in the views setup for the usage in a view.).</p><p>For the node called infofeed, the config data is stored in an entity called core.entity_view_display.node.infofeed.default</p><p>For a view called infofeeds, the config data is stored in a config entity called views.view.infofeeds.</p><p>(You can find them by browsing thru the config table and looking for your info in the data field i.e. in sequel pro, look for data like %image_width% )</p><p>It is pretty reasonable that the custom field formatter will require some configuration, so this means we will need a module/config/schema/module.schema.yml file</p><p>So at /Users/selwyn/Sites/ncs/docroot/modules/custom/ncs_infoconnect/config/schema/ncs_infoconnect.schema.yml we have the following file which defines a config_entity called NCS Thumbnail settings and specifically two integer values for image_width and image height. I use these to specify the size of the thumbnail I generate:</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Schema for configuring NCS thumbnail formatter.</span>

<span class="na">field.formatter.settings.ncs_thumbnail</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">config_entity</span>
  <span class="na">label</span><span class="pi">:</span> <span class="s1">'</span><span class="s">NCS</span><span class="nv"> </span><span class="s">thumbnail</span><span class="nv"> </span><span class="s">settings'</span>
  <span class="na">mapping</span><span class="pi">:</span>
    <span class="na">image_width</span><span class="pi">:</span>
      <span class="na">label</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Image</span><span class="nv"> </span><span class="s">width'</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">integer</span>
    <span class="na">image_height</span><span class="pi">:</span>
      <span class="na">label</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Image</span><span class="nv"> </span><span class="s">Height'</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">integer</span>
</code></pre></div></div><p>I create the <code class="language-plaintext highlighter-rouge">fieldformatter</code> as a fairly unexciting plugin at /Users/selwyn/Sites/ncs/docroot/modules/custom/ncs_infoconnect/src/Plugin/Field/FieldFormatter/NcsThumbnailFormatter.php</p><p>The annotation shows what will be seen in Drupal when configuring the formatter.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\ncs_infoconnect\Plugin\Field\FieldFormatter</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Field\FormatterBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Field\FieldItemListInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Form\FormStateInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Site\Settings</span><span class="p">;</span>

<span class="cd">/**
 * Plugin implementation of the 'ncs_thumbnail' formatter.
 *
 * @FieldFormatter(
 *   id = "ncs_thumbnail",
 *   label = @Translation("NCS Thumbnail"),
 *   field_types = {
 *     "string"
 *   }
 * )
 */</span>
<span class="kd">class</span> <span class="nc">NcsThumbnailFormatter</span> <span class="kd">extends</span> <span class="nc">FormatterBase</span> <span class="p">{</span>
</code></pre></div></div><p>I override the <code class="language-plaintext highlighter-rouge">settingsSummary()</code> which is mostly informative, and <code class="language-plaintext highlighter-rouge">viewElements()</code> which has the meat of the plugin. In <code class="language-plaintext highlighter-rouge">viewElements()</code>, we loop thru the items (i.e. the values coming in from the field) and build an image_uri, jam each one into a render element and return the bunch.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">settingsSummary</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$summary</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$summary</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Specify size of the thumbnail to display.'</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$summary</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">viewElements</span><span class="p">(</span><span class="kt">FieldItemListInterface</span> <span class="nv">$items</span><span class="p">,</span> <span class="nv">$langcode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$elements</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$markup</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
    <span class="nv">$width</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getSetting</span><span class="p">(</span><span class="s1">'image_width'</span><span class="p">);</span>
    <span class="nv">$height</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getSetting</span><span class="p">(</span><span class="s1">'image_height'</span><span class="p">);</span>
    <span class="nv">$ncs_auth_settings</span> <span class="o">=</span> <span class="nc">Settings</span><span class="o">::</span><span class="nf">get</span><span class="p">(</span><span class="s1">'ncs_api_auth'</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="nv">$base_url</span> <span class="o">=</span> <span class="nv">$ncs_auth_settings</span><span class="p">[</span><span class="s1">'default'</span><span class="p">][</span><span class="s1">'imageserver'</span><span class="p">];</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$items</span> <span class="k">as</span> <span class="nv">$delta</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$image_uri</span> <span class="o">=</span> <span class="nv">$base_url</span> <span class="mf">.</span> <span class="s2">"/?uuid="</span> <span class="mf">.</span> <span class="nv">$item</span><span class="o">-&gt;</span><span class="n">value</span> <span class="mf">.</span> <span class="s2">"&amp;function=original&amp;type=thumbnail"</span><span class="p">;</span>
      <span class="nv">$markup</span> <span class="o">=</span> <span class="s1">'&lt;img src="'</span> <span class="mf">.</span> <span class="nv">$image_uri</span> <span class="mf">.</span> <span class="s1">'" width="'</span> <span class="mf">.</span> <span class="nv">$width</span> <span class="mf">.</span> <span class="s1">'" height="'</span> <span class="mf">.</span> <span class="nv">$height</span> <span class="mf">.</span> <span class="s1">'"&gt;'</span><span class="p">;</span>

      <span class="c1">// Render each element as markup.</span>
      <span class="nv">$elements</span><span class="p">[</span><span class="nv">$delta</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$markup</span><span class="p">,</span>
      <span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$elements</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div><p>Note. Retrieving the config settings for a particular situation happens with a call to <code class="language-plaintext highlighter-rouge">getSetting()</code> as in:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$width</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getSetting</span><span class="p">(</span><span class="s1">'image_width'</span><span class="p">);</span>
<span class="nv">$height</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getSetting</span><span class="p">(</span><span class="s1">'image_height'</span><span class="p">);</span>
</code></pre></div></div><p>To use this we need to edit the display for the <code class="language-plaintext highlighter-rouge">infofeed</code> content type, make sure we have the image_uuid field displayed (i.e. not disabled) for Format, select NCS Thumbnail, click the gear to the right to specify the thumbnail size and save. Displaying nodes will then include the thumbnails.</p><p>You can do the same with a view: Add the field, specify the formatter (and dimensions) and the thumbnail will appear.</p><h2 id="puzzles"> <a aria-labelledby="puzzles" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#puzzles"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Puzzles</h2><h3 id="what-can-i-do-with-a-call-to-first-on-an-entity-reference-field"> <a aria-labelledby="what-can-i-do-with-a-call-to-first-on-an-entity-reference-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#what-can-i-do-with-a-call-to-first-on-an-entity-reference-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> What can I do with a call to first() on an entity reference field?</h3><p>After loading a node, I want to see the value in an entity reference field. I can call referencedEntities to pull out it’s values and loop thru them – I get Nodes in that instance.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$refs</span> <span class="o">=</span> <span class="nv">$node_to_update</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_sf_account_ref'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">referencedEntities</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$refs</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$ref</span> <span class="o">=</span> <span class="nb">reset</span><span class="p">(</span><span class="nv">$refs</span><span class="p">);</span>
  <span class="nv">$node_to_update_sf_account_nid</span> <span class="o">=</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
</code></pre></div></div><p>However, if I call <code class="language-plaintext highlighter-rouge">-&gt;first()</code>, I get an <code class="language-plaintext highlighter-rouge">EntityReferenceItem</code>. I’m curious how I could use this – would I want to?</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$refs</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_sf_dir_contact_ref'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">first</span><span class="p">();</span>  <span class="c1">//returns an EntityReferenceItem.</span>
</code></pre></div></div><h2 id="great-cheat-sheets"> <a aria-labelledby="great-cheat-sheets" class="anchor-heading" href="https://selwynpolit.github.io/d9book/nodes-and-fields#great-cheat-sheets"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Great Cheat sheets</h2><p>Various ways of updating field values in Drupal 8 and 9</p><p><a href="https://gorannikolovski.com/blog/various-ways-updating-field-values-drupal-8-and-9">https://gorannikolovski.com/blog/various-ways-updating-field-values-drupal-8-and-9</a></p><p>Entity query cheat sheet:</p><p><a href="https://www.metaltoad.com/blog/drupal-8-entity-api-cheat-sheet">https://www.metaltoad.com/blog/drupal-8-entity-api-cheat-sheet</a></p><p>Drupal entity API cheat sheet</p><p><a href="https://drupalsun.com/zhilevan/2018/07/21/drupal-entity-api-cheat-sheet">https://drupalsun.com/zhilevan/2018/07/21/drupal-entity-api-cheat-sheet</a></p><hr/> <script async="" crossorigin="anonymous" data-category="Q&amp;A" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMjY2NDE4" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="selwynpolit/d9book" data-repo-id="MDEwOlJlcG9zaXRvcnkzMjUxNTQ1Nzg=" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js"> </script><hr/><footer><p><a href="https://selwynpolit.github.io/d9book/nodes-and-fields#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0"><span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"> <a href="http://www.selwynpolit.github.io/d9book" property="dct:title" rel="cc:attributionURL">Drupal at your fingertips</a> by <a href="http://www.drupal.org/u/selwynpolit" property="cc:attributionName" rel="cc:attributionURL dct:creator">Selwyn Polit</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="license noopener noreferrer" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" style="height:16px!important;vertical-align:text-bottom;"/> <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" style="height:16px!important;vertical-align:text-bottom;"/> </a></span></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0 mr-2"> Page last modified: <span class="d-inline-block">Jun 20 2023</span>.</p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/selwynpolit/d9book/tree/gh-pages/book/nodes_n_fields.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
</body></link></meta></meta></meta></head></html>