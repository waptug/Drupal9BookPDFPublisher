<!DOCTYPE html>
<html lang="en-US"><head><meta charset="utf-8"/><meta content="IE=Edge" http-equiv="X-UA-Compatible"/><link href="https://selwynpolit.github.io/d9book/assets/css/just-the-docs-default.css" rel="stylesheet"/> <script async="" src="https://www.googletagmanager.com/gtag/js?id=8V22RQEJ71"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '8V22RQEJ71', { 'anonymize_ip': true }); </script> <script src="https://selwynpolit.github.io/d9book/assets/js/vendor/lunr.min.js"></script> <script src="https://selwynpolit.github.io/d9book/assets/js/just-the-docs.js"></script><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://selwynpolit.github.io/d9book/assets/images/favicon.ico" rel="icon" type="image/x-icon"/><title>Blocks | Drupal Book</title><meta content="Jekyll v4.3.2" name="generator"><meta content="Blocks" property="og:title"><meta content="en_US" property="og:locale"><meta content="Drupal at your fingertips" name="description"/><meta content="Drupal at your fingertips" property="og:description"/><link href="https://selwynpolit.github.io/d9book/d9book/blocks" rel="canonical"><meta content="https://selwynpolit.github.io/d9book/d9book/blocks" property="og:url"/><meta content="Drupal Book" property="og:site_name"/><meta content="website" property="og:type"/><meta content="summary" name="twitter:card"/><meta content="Blocks" property="twitter:title"/> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Drupal at your fingertips","headline":"Blocks","url":"https://selwynpolit.github.io/d9book/d9book/blocks"}</script><body> <a class="skip-to-main" href="https://selwynpolit.github.io/d9book/blocks#main-content">Skip to main content</a> <svg class="d-none" xmlns="http://www.w3.org/2000/svg"> <symbol id="svg-link" viewbox="0 0 24 24"><title>Link</title><svg class="feather feather-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"><title>Menu</title><svg class="feather feather-menu" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"><title>Expand</title><svg class="feather feather-chevron-right" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol class="feather feather-external-link" fill="none" height="24" id="svg-external-link" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"><title>Document</title><svg class="feather feather-file" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"><title>Search</title><svg class="feather feather-search" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"> <circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewbox="0 0 16 16"><title>Copy</title><svg class="bi bi-clipboard" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path> </svg> </symbol> <symbol id="svg-copied" viewbox="0 0 16 16"><title>Copied</title><svg class="bi bi-clipboard-check-fill" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a class="site-title lh-tight" href="https://selwynpolit.github.io/d9book/"> Drupal Book </a> <a class="site-button" href="https://selwynpolit.github.io/d9book/blocks" id="menu-button"> <svg class="icon" viewbox="0 0 24 24"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" class="site-nav" id="site-nav"><ul class="nav-list"><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/">Home</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/actions">Actions</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/attribution">Attribution</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/bq">Batch and Queue</a><li class="nav-list-item active"><a class="nav-list-link active" href="https://selwynpolit.github.io/d9book/blocks">Blocks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/caching">Caching</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/composer">Composer</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/config">Config</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/cron">Cron</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dates">Dates and Times</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/debugging">Debugging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/development">Development</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/drush">Drush</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/email">Email</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/entities">Entities</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/forms">Forms</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/general">General</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/off-island">Getting off the Island</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/hooks">Hooks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/learn">Learning</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/links">Links</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/logging">Logging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/menus">Menus</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/migrate">Migrate</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/modals">Modals</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/nodes-and-fields">Nodes and Fields</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/queries">Queries</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/redirects">Redirects</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/render">Render Arrays</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/routes">Routes</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/security">Security</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/services">Services</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/state">State</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/taxonomy">Taxonomy</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dtt">Tests</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/twig">Twig</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><ul class="nav-list"><li class="nav-list-item external"> <a class="nav-list-link external" href="https://github.com/selwynpolit/d9book/fork"> Fork me on GitHub <svg aria-labelledby="svg-external-link-title" viewbox="0 0 24 24"><use xlink:href="#svg-external-link"></use></svg> </a></li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div class="main-header" id="main-header"><div class="search"><div class="search-input-wrap"> <input aria-label="Search Drupal Book" autocomplete="off" class="search-input" id="search-input" placeholder="Search Drupal Book" tabindex="0" type="text"/> <label class="search-label" for="search-input"><svg class="search-icon" viewbox="0 0 24 24"><use xlink:href="#svg-search"></use></svg></label></div><div class="search-results" id="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a class="site-button" href="https://twitter.com/selwynpolit" rel="noopener noreferrer" target="_blank"> <img alt="Twitter logo" src="https://atuin.ru/demo/simple-icons/icons/twitter.svg" style="width: 30px; height: 30px;" title="Author in Twitter"/> </a><li class="aux-nav-list-item"> <a class="site-button" href="https://github.com/selwynpolit/d9book/tree/gh-pages" rel="noopener noreferrer" target="_blank"> <img alt="GitHub logo" src="https://atuin.ru/demo/simple-icons/icons/github.svg" style="width: 30px; height: 30px;" title="D9Book on GitHub"/> </a></li></li></ul></nav></div><div class="main-content-wrap" id="main-content-wrap"><div class="main-content" id="main-content" role="main"><h1 class="no_toc fw-500" id="blocks"> <a aria-labelledby="blocks" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#blocks"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Blocks</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a aria-labelledby="table-of-contents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#table-of-contents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ul id="markdown-toc"><li><a href="https://selwynpolit.github.io/d9book/blocks#create-a-block-with-drush-generate" id="markdown-toc-create-a-block-with-drush-generate">Create a block with Drush generate</a><li><a href="https://selwynpolit.github.io/d9book/blocks#anatomy-of-a-custom-block-with-dependency-injection" id="markdown-toc-anatomy-of-a-custom-block-with-dependency-injection">Anatomy of a custom block with dependency injection</a><li><a href="https://selwynpolit.github.io/d9book/blocks#create-a-block-with-an-entityquery" id="markdown-toc-create-a-block-with-an-entityquery">Create a block with an entityQuery</a><li><a href="https://selwynpolit.github.io/d9book/blocks#create-a-block-with-a-corresponding-config-form" id="markdown-toc-create-a-block-with-a-corresponding-config-form">Create a Block with a corresponding config form</a><ul><li><a href="https://selwynpolit.github.io/d9book/blocks#the-config-form-definition" id="markdown-toc-the-config-form-definition">The config form definition</a><li><a href="https://selwynpolit.github.io/d9book/blocks#the-routingyml-file" id="markdown-toc-the-routingyml-file">The routing.yml file</a><li><a href="https://selwynpolit.github.io/d9book/blocks#the-block-definition" id="markdown-toc-the-block-definition">The Block definition</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/blocks#modify-a-block-with-hook_block_view_alter-or-hook_block_build_alter" id="markdown-toc-modify-a-block-with-hook_block_view_alter-or-hook_block_build_alter">Modify a block with hook_block_view_alter or hook_block_build_alter</a><li><a href="https://selwynpolit.github.io/d9book/blocks#disable-caching-in-a-block" id="markdown-toc-disable-caching-in-a-block">Disable caching in a block</a><li><a href="https://selwynpolit.github.io/d9book/blocks#add-a-configuration-form-to-your-block" id="markdown-toc-add-a-configuration-form-to-your-block">Add a configuration form to your block</a><li><a href="https://selwynpolit.github.io/d9book/blocks#block-display-not-updating-after-changing-block-content" id="markdown-toc-block-display-not-updating-after-changing-block-content">Block display not updating after changing block content</a><li><a href="https://selwynpolit.github.io/d9book/blocks#block-permission-blockaccess" id="markdown-toc-block-permission-blockaccess">Block Permission (blockAccess)</a><ul><li><a href="https://selwynpolit.github.io/d9book/blocks#blocks-shouldnt-talk-to-the-router-noderoutecontext-and-friends-should" id="markdown-toc-blocks-shouldnt-talk-to-the-router-noderoutecontext-and-friends-should">Blocks shouldn’t talk to the router, NodeRouteContext and friends should</a><li><a href="https://selwynpolit.github.io/d9book/blocks#values-returned-by-blockaccess" id="markdown-toc-values-returned-by-blockaccess">Values returned by blockAccess()</a></li></li></ul></li></li></li></li></li></li></li></li></li></ul><p><img alt="views" src="https://api.visitor.plantree.me/visitor-badge/pv?label=views&amp;color=informational&amp;namespace=d9book&amp;key=blocks.md"/></p><hr/><p>Blocks are plugins, which are reusable pieces of code following design patterns. Plugins are also used to define views arguments, field formatters, field widgets, etc. The source files for blocks are found in each module’s <code class="language-plaintext highlighter-rouge">/src/Plugin</code> directory.</p><p class="text-center"><img alt="Location of block source files" src="https://selwynpolit.github.io/d9book/assets/images/image-block-location.png"/></p><blockquote class="more_link"><ul><li><p><a href="https://www.drupal.org/docs/drupal-apis/plugin-api/plugin-api-overview&gt;">Plugin API overview</a></p><li><p><a href="https://www.drupal.org/docs/8/api/plugin-api/annotations-based-plugins">Annotations-based plugins</a></p></li></li></ul></blockquote><h2 id="create-a-block-with-drush-generate"> <a aria-labelledby="create-a-block-with-drush-generate" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#create-a-block-with-drush-generate"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Create a block with Drush generate</h2><p>Use Drush’s code generation ability to quickly generate the code you need to create your own custom block.</p><p>First generate a module if you don’t have one. Here we generate a module called Block Module with a machine name: block_module.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>drush generate module

Welcome to module generator!

<span class="nt">------------------------------------------------------------</span>

Module name <span class="se">\[</span>Web<span class="se">\]</span>:

➤ Block Module

Module machine name <span class="se">\[</span>block_module<span class="se">\]</span>:

➤

Module description <span class="se">\[</span>Provides additional functionality <span class="k">for </span>the site.<span class="se">\]</span>:

➤ Custom module to explore Drupal blocks

Package <span class="se">\[</span>Custom<span class="se">\]</span>:

➤

Dependencies <span class="o">(</span>comma separated<span class="o">)</span>:

➤

Would you like to create module file? <span class="se">\[</span>No<span class="se">\]</span>:

➤ <span class="nb">yes

</span>Would you like to create <span class="nb">install </span>file? <span class="se">\[</span>No<span class="se">\]</span>:

➤

Would you like to create libraries.yml file? <span class="se">\[</span>No<span class="se">\]</span>:

➤

Would you like to create permissions.yml file? <span class="se">\[</span>No<span class="se">\]</span>:

➤

Would you like to create event subscriber? <span class="se">\[</span>No<span class="se">\]</span>:

➤

Would you like to create block plugin? <span class="se">\[</span>No<span class="se">\]</span>:

➤

Would you like to create a controller? <span class="se">\[</span>No<span class="se">\]</span>:

➤

Would you like to create settings form? <span class="se">\[</span>No<span class="se">\]</span>:

➤

The following directories and files have been created or updated:

<span class="nt">----------------------------------------------------------</span>

•
/Users/selwyn/Sites/ddev93/web/modules/custom/block_module/block_module.info.yml

•
/Users/selwyn/Sites/ddev93/web/modules/custom/block_module/block_module.module
</code></pre></div></div><p>Use <code class="language-plaintext highlighter-rouge">drush generate</code> to create the code for a block. Specify the module name (e.g. block_module) so Drush knows where to put the block code. We also must give the block an admin label, plugin ID, and class.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>drush generate block

Welcome to block generator!

<span class="nt">----------------------------------------------------------</span>

Module machine name <span class="se">\[</span>web<span class="se">\]</span>:

➤ block_module

Block admin label <span class="se">\[</span>Example<span class="se">\]</span>:

➤ Block Module Example

Plugin ID <span class="se">\[</span>block_module_block_module_example<span class="se">\]</span>:

➤

Plugin class <span class="se">\[</span>BlockModuleExampleBlock<span class="se">\]</span>:

➤

Block category <span class="se">\[</span>Custom<span class="se">\]</span>:

➤

Make the block configurable? <span class="se">\[</span>No<span class="se">\]</span>:

➤

Would you like to inject dependencies? <span class="se">\[</span>No<span class="se">\]</span>:

➤

Create access callback? <span class="se">\[</span>No<span class="se">\]</span>:

➤

The following directories and files have been created or updated:

<span class="nt">----------------------------------------------------------</span>

•
/Users/selwyn/Sites/ddev93/web/modules/block_module/src/Plugin/Block/BlockModuleExampleBlock.php
</code></pre></div></div><p>This generates a file at <code class="language-plaintext highlighter-rouge">web/modules/custom/block_module/src/Plugin/Block/BlockModuleExampleBlock.php</code> that looks like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\block_module\Plugin\Block</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Block\BlockBase</span><span class="p">;</span>

<span class="cd">/**
 * Provides a block module example block.
 *
 * @Block(
 *   id = "block_module_block_module_example",
 *   admin_label = @Translation("Block Module Example"),
 *   category = @Translation("Custom")
 * )
 */</span>
<span class="kd">class</span> <span class="nc">BlockModuleExampleBlock</span> <span class="kd">extends</span> <span class="nc">BlockBase</span> <span class="p">{</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'It works!'</span><span class="p">),</span>
    <span class="p">];</span>
    <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><p>Enable the module with:</p><p><code class="language-plaintext highlighter-rouge">ddev drush en block_module</code></p><p>clear the cache with:</p><p><code class="language-plaintext highlighter-rouge">ddev drush cr</code></p><p>In Drupal, navigate to /admin/structure/block and place the block ("block module example") in the content area. See the diagram below on how to place the block in the content area.</p><p><img alt="Graphical user interface, table Description automatically generated" src="https://selwynpolit.github.io/d9book/assets/images/image2.png"/></p><p><img alt="Graphical user interface Description automatically generated" src="https://selwynpolit.github.io/d9book/assets/images/image3.png"/></p><p>You may have to clear the Drupal cache again to get the new block to show up in the list. After clicking “Place block,” a “Configure block” screen appears. You can safely just click “Save block.”</p><p><img alt="Graphical user interface, application Description automatically generated" src="https://selwynpolit.github.io/d9book/assets/images/image4.png"/></p><p>Navigate back to the home page of the site and you’ll see your block appearing. Screenshot below:</p><p><img alt="Graphical user interface, text, application, email Description automatically generated" src="https://selwynpolit.github.io/d9book/assets/images/image5.png"/></p><p>You can safely remove the block via the block layout page, choose “remove” from the dropdown next to your “Block Module Example”</p><p><img alt="Remove block" src="https://selwynpolit.github.io/d9book/assets/images/image6.png"/></p><h2 id="anatomy-of-a-custom-block-with-dependency-injection"> <a aria-labelledby="anatomy-of-a-custom-block-with-dependency-injection" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#anatomy-of-a-custom-block-with-dependency-injection"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Anatomy of a custom block with dependency injection</h2><p>The block class PHP file is usually in <code class="language-plaintext highlighter-rouge">\&lt;Drupal web root\&gt;/modules/custom/mymodule/src/Plugin/Block</code>.</p><p>e.g. <code class="language-plaintext highlighter-rouge">dev1/web/modules/custom/image_gallery/src/Plugin/Block/ImageGalleryBlock.php</code></p><p>or</p><p><code class="language-plaintext highlighter-rouge">dev1/web/modules/contrib/examples/block_example/src/Plugin/Block/ExampleConfigurableTextBlock.php</code></p><p>Specify namespace:</p><p><code class="language-plaintext highlighter-rouge">namespace Drupal\abc_wea\Plugin\Block;</code></p><p>Blocks always extend BlockBase but can also implement other interfaces… see below.</p><p><code class="language-plaintext highlighter-rouge">Class ImageGalleryBlock extends BlockBase</code></p><p>If you want to use Dependency Injection, implement: <code class="language-plaintext highlighter-rouge">ContainerFactoryPluginInterface</code></p><p>e.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ImageGalleryBlock</span> <span class="kd">extends</span> <span class="nc">BlockBase</span> <span class="kd">implements</span>
<span class="nc">ContainerFactoryPluginInterface</span> <span class="p">{</span>
</code></pre></div></div><p>Be sure to include:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Plugin\ContainerFactoryPluginInterface</span><span class="p">;</span>
</code></pre></div></div><p>And for annotation translation:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Annotation\Translation</span><span class="p">;</span>
</code></pre></div></div><p>You can annotate like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Hello World Salutation block.
 *
 * @Block(
 *   id = "hello_world_salutation_block",
 *   admin_label = @Translation("Hello world salutation"),
 *   category = @Translation("Custom")
 * )
 */</span>
</code></pre></div></div><p>Or like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Provides an image gallery block.
 *
 * @Block(
 *   id = "ig_product_image_gallery",
 *   admin_label = @Translation("Product Image Gallery"),
 *   category = @Translation("Image Display"),
 *   context = {
 *     "node" = @ContextDefinition(
 *       "entity:node",
 *       label = @Translation("Current Node")
 *     )
 *   }
 * )
 */</span>
</code></pre></div></div><p>In most cases you will implement ContainerFactoryPluginInterface. Plugins require this for dependency injection. So don’t forget:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Plugin\ContainerFactoryPluginInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">HelloWorldSalutationBlock</span> <span class="kd">extends</span> <span class="nc">BlockBase</span> <span class="kd">implements</span> <span class="nc">ContainerFactoryPluginInterface</span> <span class="p">{</span>
</code></pre></div></div><p>If you want dependency injection, you will need a create() function.</p><p>This will call the constructor (to do lazy loading) and call the container to <code class="language-plaintext highlighter-rouge">-&gt;get()</code> the service you need. In the example below <code class="language-plaintext highlighter-rouge">$container-&gt;get('hello_world.salutation')</code> does the trick. <code class="language-plaintext highlighter-rouge">return new static()</code> calls your class constructor.</p><p>Be sure to add your service to the list of parameters in the constructor: <code class="language-plaintext highlighter-rouge">$container-&gt;get('hello_world.salutation')</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span>
    <span class="nv">$configuration</span><span class="p">,</span>
    <span class="nv">$plugin_id</span><span class="p">,</span>
    <span class="nv">$plugin_definition</span><span class="p">,</span>
    <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'hello_world.salutation'</span><span class="p">)</span>
  <span class="p">);</span> 
<span class="p">}</span>
</code></pre></div></div><p>Here are your <code class="language-plaintext highlighter-rouge">__constructor()</code> and a <code class="language-plaintext highlighter-rouge">build()</code> functions. See the 4th param – <code class="language-plaintext highlighter-rouge">HelloWorldSalutationService $salutation</code> – that’s the injected service.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Construct.
 *
 * @param array $configuration
 *   A configuration array containing information about the plugin instance.
 * @param string $plugin_id
 *   The plugin_id for the plugin instance.
 * @param string $plugin_definition
 *   The plugin implementation definition.
 * @param \Drupal\hello_world\HelloWorldSalutation $salutation
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">,</span> <span class="kt">HelloWorldSalutationService</span> <span class="nv">$salutation</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">(</span><span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">salutation</span> <span class="o">=</span> <span class="nv">$salutation</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span>
    <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">salutation</span><span class="o">-&gt;</span><span class="nf">getSalutation</span><span class="p">(),</span>
  <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div><p>TODO: NEED A BETTER EXAMPLE OF A D.I. BLOCK HERE especially showing a build()</p><h2 id="create-a-block-with-an-entityquery"> <a aria-labelledby="create-a-block-with-an-entityquery" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#create-a-block-with-an-entityquery"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Create a block with an entityQuery</h2><p>You often need to query some data from Drupal and display it in a block.</p><p>Here is a simple block that loads all published content of type “page” and renders the titles. You could sort them by creation date by adding this to the <code class="language-plaintext highlighter-rouge">$query</code> variable: <code class="language-plaintext highlighter-rouge">-&gt;sort('created' , 'DESC');</code></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">Drupal\opinions_module\Plugin\Block</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Block\BlockBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Annotation\Translation</span><span class="p">;</span>

<span class="cd">/**
 * Provides OpinionLanding Block.
 *
 * @Block(
 *   id = "opinion_landing",
 *   admin_label = @Translation("Opinion landing block"),
 *   )
 *
 * @package Drupal\oag_opinions\Plugin\Block
 */</span>
<span class="kd">class</span> <span class="nc">OpinionLanding</span> <span class="kd">extends</span> <span class="nc">BlockBase</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>

    <span class="nv">$entity_type</span> <span class="o">=</span> <span class="s1">'node'</span><span class="p">;</span>
    <span class="nv">$storage</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="nv">$entity_type</span><span class="p">);</span>
    <span class="nv">$query</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityQuery</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'page'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
    <span class="nv">$nids</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
    <span class="nv">$nodes</span> <span class="o">=</span> <span class="nv">$storage</span><span class="o">-&gt;</span><span class="nf">loadMultiple</span><span class="p">(</span><span class="nv">$nids</span><span class="p">);</span>

    <span class="nv">$render_array</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$nodes</span> <span class="k">as</span> <span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$render_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'markup'</span><span class="p">,</span>
        <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;p&gt;'</span> <span class="mf">.</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">(),</span>
      <span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$render_array</span><span class="p">;</span>
</code></pre></div></div><h2 id="create-a-block-with-a-corresponding-config-form"> <a aria-labelledby="create-a-block-with-a-corresponding-config-form" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#create-a-block-with-a-corresponding-config-form"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Create a Block with a corresponding config form</h2><p>Here is an example which includes a block and a corresponding config form that controls what is displayed in the block. The block can be placed using the Block Layout system in Drupal at /admin/structure/block (shown below) or via twig in a template file.</p><p><img alt="Block layout system" src="https://selwynpolit.github.io/d9book/assets/images/image7.png"/></p><h3 id="the-config-form-definition"> <a aria-labelledby="the-config-form-definition" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#the-config-form-definition"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> The config form definition</h3><p>The config form is defined in <code class="language-plaintext highlighter-rouge">docroot/modules/custom/quick_pivot/src/Form/QuickPivotConfigForm.php</code> with a class which extends ConfigFormBase because this form is there for configuring its block:</p><p><code class="language-plaintext highlighter-rouge">class QuickPivotConfigForm extends ConfigFormBase {</code></p><p>In the class are the <code class="language-plaintext highlighter-rouge">getFormId()</code>, <code class="language-plaintext highlighter-rouge">getEditableConfigName()</code>, <code class="language-plaintext highlighter-rouge">buildForm()</code> and <code class="language-plaintext highlighter-rouge">submitForm()</code> functions which are all pretty straightforward.</p><h3 id="the-routingyml-file"> <a aria-labelledby="the-routingyml-file" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#the-routingyml-file"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> The routing.yml file</h3><p>Then in <code class="language-plaintext highlighter-rouge">docroot/modules/custom/quick_pivot/quick_pivot.routing.yml</code> we specify the route where we invoke the form.</p><p>Besides the quick_pivot.info.yml (module info) file, that should be all you need to make the config for the block.</p><h3 id="the-block-definition"> <a aria-labelledby="the-block-definition" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#the-block-definition"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> The Block definition</h3><p>Now for the block that users see (also the one that pops up in the block configuration) in <code class="language-plaintext highlighter-rouge">docroot/modules/custom/quick_pivot/src/Plugin/Block/QuickPivotSubscribeBlock.php</code></p><p>We define the block with its annotation:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Provides a cart block.
 *
 * @Block(
 *   id = "quick_pivot_subscribe_block",
 *   admin_label = @Translation("QuickPivot Subscribe Block"),
 *   category = @Translation("QuickPivot Subscribe")
 * )
 */</span>
<span class="kd">class</span> <span class="nc">QuickPivotSubscribeBlock</span> <span class="kd">extends</span> <span class="nc">BlockBase</span> <span class="kd">implements</span> <span class="nc">ContainerFactoryPluginInterface</span> <span class="p">{</span>
</code></pre></div></div><p>It implements <code class="language-plaintext highlighter-rouge">ContainerFactoryPluginInterface</code> to allow dependency injection. This is critical for plugins or blocks. More at https://chromatichq.com/blog/dependency-injection-drupal-8-plugins. All this interface defines is the <code class="language-plaintext highlighter-rouge">create()</code> method. Because we are using dependency injection, we need both a <code class="language-plaintext highlighter-rouge">create()</code> and a <code class="language-plaintext highlighter-rouge">__constructor()</code>.</p><p>Here is the <code class="language-plaintext highlighter-rouge">create()</code></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span>
    <span class="nv">$configuration</span><span class="p">,</span>
    <span class="nv">$plugin_id</span><span class="p">,</span>
    <span class="nv">$plugin_definition</span><span class="p">,</span>
    <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'config.factory'</span><span class="p">),</span>
    <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'form_builder'</span><span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is the constructor:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">,</span> <span class="kt">ConfigFactoryInterface</span> <span class="nv">$config_factory</span><span class="p">,</span> <span class="kt">FormBuilderInterface</span> <span class="nv">$form_builder</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">(</span><span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">);</span>

  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">configFactory</span> <span class="o">=</span> <span class="nv">$config_factory</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">formBuilder</span> <span class="o">=</span> <span class="nv">$form_builder</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>And finally the <code class="language-plaintext highlighter-rouge">build()</code> method:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">formBuilder</span><span class="o">-&gt;</span><span class="nf">getForm</span><span class="p">(</span><span class="s1">'Drupal\quick_pivot\Form\QuickPivotSubscribeForm'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is the docroot/modules/custom/quick_pivot/src/Form/QuickPivotSubscribeForm.php:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\quick_pivot\Form</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Form\FormBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Form\FormStateInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Form\FormBuilderInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\AjaxResponse</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\ReplaceCommand</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\CssCommand</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\HtmlCommand</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\AppendCommand</span><span class="p">;</span>
<span class="kn">use</span> <span class="nf">Drupal\quick_pivot</span><span class="nc">\QuickPivotApiInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\DependencyInjection\ContainerInterface</span><span class="p">;</span>

<span class="cd">/**
 * Provides a form for users to subscribe to QuickPivot.
 */</span>
<span class="kd">class</span> <span class="nc">QuickPivotSubscribeForm</span> <span class="kd">extends</span> <span class="nc">FormBase</span> <span class="p">{</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">getFormId</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'quick_pivot_subscribe_form'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'#id'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'quick-pivot-subscribe-form'</span><span class="p">;</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'#cache'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'max-age'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">];</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'#attributes'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'autocomplete'</span> <span class="o">=&gt;</span> <span class="s1">'off'</span><span class="p">];</span>

    <span class="nv">$form</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span>
      <span class="s1">'#id'</span> <span class="o">=&gt;</span> <span class="s1">'quick-pivot-email'</span><span class="p">,</span>
      <span class="s1">'#placeholder'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Email address'</span><span class="p">),</span>
      <span class="s1">'#attributes'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'class'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'edit-quick-pivot-email'</span><span class="p">]],</span>
      <span class="s1">'#prefix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;div class="subscriber-email-msg"&gt;'</span><span class="p">,</span>
      <span class="s1">'#suffix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">,</span>
    <span class="p">];</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'subscribe_submit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
      <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Sign Up'</span><span class="p">),</span>
      <span class="s1">'#name'</span> <span class="o">=&gt;</span> <span class="s1">'quick_pivot_subscribe_form_submit_button'</span><span class="p">,</span>
      <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="s1">'Drupal\quick_pivot\Form\QuickPivotSubscribeForm::quickPivotAjaxSubmit'</span><span class="p">,</span>
        <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="s1">'quick-pivot-subscribe-form'</span><span class="p">,</span>
        <span class="s1">'progress'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'throbber'</span><span class="p">,</span> <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="kc">NULL</span><span class="p">],</span>
      <span class="p">],</span>
    <span class="p">];</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'markup'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;div id="quick-pivot-message-area"&gt;&lt;/div&gt;'</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">validateForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>

  <span class="p">}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">submitForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>

  <span class="p">}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">quickPivotAjaxSubmit</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$validate</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">;</span>
    <span class="nv">$email</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'email'</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">filter_var</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="no">FILTER_VALIDATE_EMAIL</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$message</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Please enter a valid email address.'</span><span class="p">);</span>
      <span class="nv">$validate</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
      <span class="nv">$css_border</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'border'</span> <span class="o">=&gt;</span> <span class="s1">'1px solid red'</span><span class="p">];</span>
      <span class="nv">$css_color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'color'</span> <span class="o">=&gt;</span> <span class="s1">'red'</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$validate</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$css_border</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'border'</span> <span class="o">=&gt;</span> <span class="s1">'1px solid green'</span><span class="p">];</span>
      <span class="nv">$css_color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'color'</span> <span class="o">=&gt;</span> <span class="s1">'green'</span><span class="p">];</span>
      <span class="nv">$response</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'quick_pivot.api'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">subscribeEmail</span><span class="p">(</span><span class="nv">$email</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nb">reset</span><span class="p">(</span><span class="nv">$response</span><span class="p">),</span> <span class="s1">'Success'</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$message</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Thank you for signing up. Your subscription has been activated.'</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$message</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Your subscription could not be processed.'</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AjaxResponse</span><span class="p">();</span>

    <span class="nv">$quick_pivot_form</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">formBuilder</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">rebuildForm</span><span class="p">(</span><span class="s1">'quick_pivot_subscribe_form'</span><span class="p">,</span> <span class="nv">$form_state</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$validate</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$quick_pivot_form</span><span class="p">[</span><span class="s1">'email'</span><span class="p">][</span><span class="s1">'#value'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
      <span class="nv">$quick_pivot_form</span><span class="p">[</span><span class="s1">'email'</span><span class="p">][</span><span class="s1">'#placeholder'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Email address'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">ReplaceCommand</span><span class="p">(</span><span class="s1">'#quick-pivot-subscribe-form'</span><span class="p">,</span> <span class="nv">$quick_pivot_form</span><span class="p">));</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">CssCommand</span><span class="p">(</span><span class="s1">'#edit-quick-pivot-email'</span><span class="p">,</span> <span class="nv">$css_border</span><span class="p">));</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">HtmlCommand</span><span class="p">(</span><span class="s1">'#quick-pivot-message-area'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">));</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">CssCommand</span><span class="p">(</span><span class="s1">'#quick-pivot-message-area'</span><span class="p">,</span> <span class="nv">$css_color</span><span class="p">));</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div><p>Here is the entire QuickPivotConfigForm.php file:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\quick_pivot\Form</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Form\FormStateInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Form\ConfigFormBase</span><span class="p">;</span>

<span class="cd">/**
 * Configure Websphere settings for this site.
 */</span>
<span class="kd">class</span> <span class="nc">QuickPivotConfigForm</span> <span class="kd">extends</span> <span class="nc">ConfigFormBase</span> <span class="p">{</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">getFormId</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'quick_pivot_settings'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">protected</span> <span class="k">function</span> <span class="n">getEditableConfigNames</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">'quick_pivot.settings'</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$config</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">config</span><span class="p">(</span><span class="s1">'quick_pivot.settings'</span><span class="p">);</span>

    <span class="nv">$form</span><span class="p">[</span><span class="s1">'quick_pivot_settings'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'details'</span><span class="p">,</span>
      <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Quick Pivot API Settings'</span><span class="p">),</span>
      <span class="s1">'#open'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
      <span class="s1">'#weight'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="nv">$form</span><span class="p">[</span><span class="s1">'quick_pivot_settings'</span><span class="p">][</span><span class="s1">'api_end_point'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span>
      <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'API End point'</span><span class="p">),</span>
      <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s2">"Enter the API end point URL."</span><span class="p">),</span>
      <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'quick_pivot_settings.api_end_point'</span><span class="p">),</span>
      <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
      <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="nv">$form</span><span class="p">[</span><span class="s1">'quick_pivot_settings'</span><span class="p">][</span><span class="s1">'user_guid'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span>
      <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'User GUID'</span><span class="p">),</span>
      <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s2">"SOAP API User GUID"</span><span class="p">),</span>
      <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'quick_pivot_settings.user_guid'</span><span class="p">),</span>
      <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
      <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="nv">$form</span><span class="p">[</span><span class="s1">'quick_pivot_settings'</span><span class="p">][</span><span class="s1">'account'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span>
      <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Account'</span><span class="p">),</span>
      <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s2">"SOAP API Account"</span><span class="p">),</span>
      <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'quick_pivot_settings.account'</span><span class="p">),</span>
      <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
      <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="nv">$form</span><span class="p">[</span><span class="s1">'quick_pivot_settings'</span><span class="p">][</span><span class="s1">'sender'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span>
      <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Sender'</span><span class="p">),</span>
      <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s2">"SOAP API Sender"</span><span class="p">),</span>
      <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'quick_pivot_settings.sender'</span><span class="p">),</span>
      <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
      <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="nf">buildForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="nv">$form_state</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">submitForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">config</span><span class="p">(</span><span class="s1">'quick_pivot.settings'</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'quick_pivot_settings.api_end_point'</span><span class="p">,</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'api_end_point'</span><span class="p">))</span>
        <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'quick_pivot_settings.user_guid'</span><span class="p">,</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'user_guid'</span><span class="p">))</span>
        <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'quick_pivot_settings.account'</span><span class="p">,</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'account'</span><span class="p">))</span>
        <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'quick_pivot_settings.sender'</span><span class="p">,</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'sender'</span><span class="p">))</span>
        <span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>

    <span class="k">parent</span><span class="o">::</span><span class="nf">submitForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="nv">$form_state</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><p>And the QuickPivotSubscribeBlock.php:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\quick_pivot\Plugin\Block</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Block\BlockBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\DependencyInjection\ContainerInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Config\ConfigFactoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Plugin\ContainerFactoryPluginInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Form\FormBuilderInterface</span><span class="p">;</span>

<span class="cd">/**
 * Provides a cart block.
 *
 * @Block(
 *   id = "quick_pivot_subscribe_block",
 *   admin_label = @Translation("QuickPivot Subscribe Block"),
 *   category = @Translation("QuickPivot Subscribe")
 * )
 */</span>
<span class="kd">class</span> <span class="nc">QuickPivotSubscribeBlock</span> <span class="kd">extends</span> <span class="nc">BlockBase</span> <span class="kd">implements</span> <span class="nc">ContainerFactoryPluginInterface</span> <span class="p">{</span>

  <span class="cd">/**
   * The configuration factory.
   *
   * @var \Drupal\Core\Config\ConfigFactoryInterface
   */</span>
  <span class="k">protected</span> <span class="nv">$configFactory</span><span class="p">;</span>

  <span class="cd">/**
   * The form builder.
   *
   * @var \Drupal\Core\Form\FormBuilderInterface
   */</span>
  <span class="k">protected</span> <span class="nv">$formBuilder</span><span class="p">;</span>

  <span class="cd">/**
   * Constructor for the QuickPivot subscribe block.
   *
   * @param array $configuration
   *   The block configuration.
   * @param string $plugin_id
   *   The plugin_id for the plugin instance.
   * @param mixed $plugin_definition
   *   The plugin implementation definition.
   * @param \Drupal\Core\Config\ConfigFactoryInterface $config_factory
   *   The configuration factory.
   * @param \Drupal\Core\Form\FormBuilderInterface $form_builder
   *   The form builder.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">,</span> <span class="kt">ConfigFactoryInterface</span> <span class="nv">$config_factory</span><span class="p">,</span> <span class="kt">FormBuilderInterface</span> <span class="nv">$form_builder</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">(</span><span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">configFactory</span> <span class="o">=</span> <span class="nv">$config_factory</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">formBuilder</span> <span class="o">=</span> <span class="nv">$form_builder</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span>
      <span class="nv">$configuration</span><span class="p">,</span>
      <span class="nv">$plugin_id</span><span class="p">,</span>
      <span class="nv">$plugin_definition</span><span class="p">,</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'config.factory'</span><span class="p">),</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'form_builder'</span><span class="p">)</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="cd">/**
   * Builds the cart block.
   *
   * @return array
   *   A render array.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">formBuilder</span><span class="o">-&gt;</span><span class="nf">getForm</span><span class="p">(</span><span class="s1">'Drupal\quick_pivot\Form\QuickPivotSubscribeForm'</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><p>And here is the routing file: <code class="language-plaintext highlighter-rouge">docroot/modules/custom/quick_pivot/quick_pivot.routing.yml</code></p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">quick_pivot.config</span><span class="pi">:</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/admin/config/quick_pivot/settings'</span>
  <span class="na">defaults</span><span class="pi">:</span>
    <span class="na">_form</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Drupal\quick_pivot\Form\QuickPivotConfigForm'</span>
    <span class="na">_title</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Quick</span><span class="nv"> </span><span class="s">Pivot</span><span class="nv"> </span><span class="s">Settings'</span>
  <span class="na">requirements</span><span class="pi">:</span>
    <span class="na">_permission</span><span class="pi">:</span> <span class="s1">'</span><span class="s">administer</span><span class="nv"> </span><span class="s">site</span><span class="nv"> </span><span class="s">configuration'</span>
</code></pre></div></div><p>And for the icing, We also specify a menu item so users can access the configuration form via the menu system at <code class="language-plaintext highlighter-rouge">docroot/modules/custom/quick_pivot/quick_pivot.links.menu.yml</code>.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">quick_pivot.config</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s1">'</span><span class="s">QuickPivot</span><span class="nv"> </span><span class="s">API</span><span class="nv"> </span><span class="s">settings'</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Configure</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">QuickPivot</span><span class="nv"> </span><span class="s">API</span><span class="nv"> </span><span class="s">Settings.'</span>
  <span class="na">parent</span><span class="pi">:</span> <span class="s">system.admin_config_services</span>
  <span class="na">route_name</span><span class="pi">:</span> <span class="s">quick_pivot.config</span>
  <span class="na">weight</span><span class="pi">:</span> <span class="m">1</span>
</code></pre></div></div><h2 id="modify-a-block-with-hook_block_view_alter-or-hook_block_build_alter"> <a aria-labelledby="modify-a-block-with-hook_block_view_alter-or-hook_block_build_alter" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#modify-a-block-with-hook_block_view_alter-or-hook_block_build_alter"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Modify a block with hook_block_view_alter or hook_block_build_alter</h2><p>Some drupal hooks only run inside a contributed modules and some only inside a theme and some both.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">themename_preprocess_block</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$variables</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$variables</span><span class="p">[</span><span class="s1">'plugin_id'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'entity_browser_block:department_info'</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$variables</span><span class="p">[</span><span class="s1">'#attached'</span><span class="p">][</span><span class="s1">'library'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'drupal/libraryname'</span><span class="p">;</span> 
    <span class="p">}</span>
</code></pre></div></div><p>What’s described below could potentially be done on a theme preprocess for the block.</p><p>If you need to modify a block, you can supposedly use <code class="language-plaintext highlighter-rouge">hook_block_view_alter</code> or <code class="language-plaintext highlighter-rouge">hook_block_build_alter</code>, although I haven’t been able to make this work… hmm.</p><p>There is a comment that may be worth exploring at https://api.drupal.org/api/drupal/core%21modules%21block%21block.api.php/function/hook_block_view_alter/8.2.x.</p><p>To alter the block content you must add a <code class="language-plaintext highlighter-rouge">#pre_render</code> in the <code class="language-plaintext highlighter-rouge">hook_block_view_alter</code> hook.</p><p>In <a href="https://drupal.stackexchange.com/a/215948">https://drupal.stackexchange.com/a/215948</a> there is an example which fills in the <code class="language-plaintext highlighter-rouge">$build['#pre_render'][]</code> array with a string.</p><p>In an example on that stackexchange site, this function is provided:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">yourmodule_block_view_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$build</span><span class="p">,</span> <span class="nc">\Drupal\Core\Block\BlockPluginInterface</span> <span class="nv">$block</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$block</span><span class="o">-&gt;</span><span class="nf">getBaseId</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'system_powered_by_block'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'#pre_render'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'_yourmodule_block_poweredby_prerender'</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div><p>I think this is the version I tried:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Implements hook_block_build_alter().
 */</span>
<span class="k">function</span> <span class="n">plug_academy_core_block_build_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$build</span><span class="p">,</span> <span class="nc">\Drupal\Core\Block\BlockPluginInterface</span> <span class="nv">$block</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$block</span><span class="o">-&gt;</span><span class="nf">getPluginId</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'system_menu_block:account'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'#cache'</span><span class="p">][</span><span class="s1">'contexts'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'url'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="c1">//  else if ($block-&gt;getBaseId() === 'block_content') {</span>
<span class="c1">//    if ($block-&gt;label() === "Home Page Alert") {</span>
<span class="c1">//      $build['content'] = '&lt;p&gt;New content built here!&lt;/p&gt;';</span>
<span class="c1">//</span>
<span class="c1">//    }</span>
<span class="c1">//  }</span>
<span class="p">}</span>
</code></pre></div></div><p>And I discovered an example from a project where the <code class="language-plaintext highlighter-rouge">$build['#pre_render'][]</code> array is populated with a function. I’m not sure what that function did – presumably returned some text to be rendered.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Implements hook_block_view_alter().
 */</span>
<span class="k">function</span> <span class="n">pega_academy_core_block_view_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$build</span><span class="p">,</span> <span class="nc">\Drupal\Core\Block\BlockPluginInterface</span> <span class="nv">$block</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$block</span><span class="o">-&gt;</span><span class="nf">getBaseId</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'block_content'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$block</span><span class="o">-&gt;</span><span class="nf">label</span><span class="p">()</span> <span class="o">===</span> <span class="s2">"Home Page Alert"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$build</span><span class="p">[</span><span class="s1">'#pre_render'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'Drupal\pega_academy_core\Controller\DashboardController::home_page_alert_prerender'</span><span class="p">;</span>
<span class="c1">//      $build['content'] = '&lt;p&gt;New content built here!&lt;/p&gt;';</span>

    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="disable-caching-in-a-block"> <a aria-labelledby="disable-caching-in-a-block" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#disable-caching-in-a-block"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Disable caching in a block</h2><p>From <code class="language-plaintext highlighter-rouge">docroot/modules/custom/websphere_commerce/modules/cart/src/Plugin/Block/CartSummary.php</code>:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">getCacheMaxAge</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="add-a-configuration-form-to-your-block"> <a aria-labelledby="add-a-configuration-form-to-your-block" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#add-a-configuration-form-to-your-block"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Add a configuration form to your block</h2><p>Making a block configurable means it has a form where you can specify its settings, e.g., the configuration form for the menu block module allows you to specify menu levels. Ignore this if your block does not need any configuration.</p><p>To make your block configurable, override 3 methods from BlockBase.</p><ol><li><p>defaultConfiguration</p><li><p>blockForm</p><li><p>blockSubmit</p></li></li></li></ol><p>Here <code class="language-plaintext highlighter-rouge">defaultConfiguration()</code> returns a block_count of 5.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">defaultConfiguration</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// By default, the block will display 5 thumbnails.</span>
  <span class="k">return</span> <span class="p">[</span>
    <span class="s1">'block_count'</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
  <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">blockForm()</code> is used to create a configuration form:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">blockForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'block_count'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
    <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Number of product images in block'</span><span class="p">),</span>
    <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">configuration</span><span class="p">[</span><span class="s1">'block_count'</span><span class="p">],</span>
    <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="nb">array_combine</span><span class="p">(</span><span class="nv">$range</span><span class="p">,</span> <span class="nv">$range</span><span class="p">),</span>
  <span class="p">];</span>
  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div><p>And <code class="language-plaintext highlighter-rouge">blockSubmit()</code> handles the submission of the config form. You don’t need to save anything. The data is saved automatically into the Drupal config system. You just specify a configuration key like <code class="language-plaintext highlighter-rouge">$this-&gt;configuration['block_count']</code> and the rest is handled for you.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">blockSubmit</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">configuration</span><span class="p">[</span><span class="s1">'block_count'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'block_count'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">build()</code> method does all the work of building a render array to display whatever your block wants to display. Here is an example of a build() function.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$build</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getContextValue</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>

  <span class="c1">// Determine if we are on a page that points to a product.</span>
  <span class="nv">$product</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getProduct</span><span class="p">(</span><span class="nv">$node</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Retrieve the product images</span>
    <span class="nv">$image_data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">productManagerService</span><span class="o">-&gt;</span><span class="nf">retrieveProductImages</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
    <span class="nv">$block_count</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">configuration</span><span class="p">[</span><span class="s1">'block_count'</span><span class="p">];</span>
    <span class="nv">$item_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'list'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#theme'</span> <span class="o">=&gt;</span> <span class="s1">'item_list'</span><span class="p">,</span>
      <span class="s1">'#items'</span> <span class="o">=&gt;</span> <span class="p">[],</span>
    <span class="p">];</span>

    <span class="nv">$build</span><span class="p">[</span><span class="s1">'list'</span><span class="p">][</span><span class="s1">'#items'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'markup'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'There were no product images to display.'</span><span class="p">)</span>
    <span class="p">];</span>

    <span class="k">while</span> <span class="p">(</span><span class="nv">$item_count</span> <span class="o">&lt;</span> <span class="nv">$block_count</span> <span class="o">&amp;&amp;</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$image_data</span><span class="p">[</span><span class="nv">$item_count</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nv">$file</span> <span class="o">=</span> <span class="nc">File</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$image_data</span><span class="p">[</span><span class="nv">$item_count</span><span class="p">][</span><span class="s1">'target_id'</span><span class="p">]);</span>
      <span class="nv">$link_text</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'#theme'</span> <span class="o">=&gt;</span> <span class="s1">'image_style'</span><span class="p">,</span>
        <span class="s1">'#uri'</span> <span class="o">=&gt;</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">getFileUri</span><span class="p">(),</span>
        <span class="s1">'#style_name'</span> <span class="o">=&gt;</span> <span class="s1">'product_thumbnail'</span><span class="p">,</span>
        <span class="s1">'#alt'</span> <span class="o">=&gt;</span> <span class="nv">$image_data</span><span class="p">[</span><span class="nv">$item_count</span><span class="p">][</span><span class="s1">'alt'</span><span class="p">],</span>
      <span class="p">];</span>

      <span class="c1">// Modal dialog</span>
      <span class="c1">// see https://www.drupal.org/node/2488192 for more on modals</span>
      <span class="nv">$options</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'attributes'</span> <span class="o">=&gt;</span> <span class="p">[</span>
          <span class="s1">'class'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'use-ajax'</span><span class="p">,</span>
          <span class="p">],</span>
          <span class="s1">'data-dialog-type'</span> <span class="o">=&gt;</span> <span class="s1">'modal'</span><span class="p">,</span>
          <span class="s1">'data-dialog-options'</span> <span class="o">=&gt;</span> <span class="nc">Json</span><span class="o">::</span><span class="nf">encode</span><span class="p">([</span>
            <span class="s1">'width'</span> <span class="o">=&gt;</span> <span class="mi">700</span><span class="p">,</span>
          <span class="p">]),</span>
        <span class="p">],</span>
      <span class="p">];</span>
      <span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromRoute</span><span class="p">(</span><span class="s1">'abc_prg.display_product_image'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'node'</span> <span class="o">=&gt;</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="n">nid</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="s1">'delta'</span> <span class="o">=&gt;</span> <span class="nv">$item_count</span><span class="p">]);</span>
      <span class="nv">$url</span><span class="o">-&gt;</span><span class="nf">setOptions</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
      <span class="nv">$build</span><span class="p">[</span><span class="s1">'list'</span><span class="p">][</span><span class="s1">'#items'</span><span class="p">][</span><span class="nv">$item_count</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'markup'</span><span class="p">,</span>
        <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nc">Link</span><span class="o">::</span><span class="nf">fromTextAndUrl</span><span class="p">(</span><span class="nv">$link_text</span><span class="p">,</span> <span class="nv">$url</span><span class="p">)</span>
          <span class="o">-&gt;</span><span class="nf">toString</span><span class="p">(),</span>
      <span class="p">];</span>
      <span class="nv">$item_count</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'#attached'</span><span class="p">][</span><span class="s1">'library'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'core/drupal.dialog.ajax'</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>One last item. Configuration expects a schema for things being saved. Here we create a <module_name>.schema.yml in <module_name>/config/schema and it looks like:</module_name></module_name></p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

<span class="c1"># Schema for the configuration files for my module.</span>

<span class="na">block.settings.alchemy_block</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">block_settings</span>
  <span class="na">label</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Alchemy</span><span class="nv"> </span><span class="s">block'</span>
  <span class="na">mapping</span><span class="pi">:</span>
    <span class="na">block_count</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">integer</span>
      <span class="na">label</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Block</span><span class="nv"> </span><span class="s">count'</span>
</code></pre></div></div><h2 id="block-display-not-updating-after-changing-block-content"> <a aria-labelledby="block-display-not-updating-after-changing-block-content" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#block-display-not-updating-after-changing-block-content"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Block display not updating after changing block content</h2><p>From <a href="https://www.youtube.com/watch?v=QCZe2K13bd0&amp;list=PLgfWMnl57dv5KmHaK4AngrQAryjO_ylaM&amp;t=0s&amp;index=16">Nedcamp video on caching by Kelly Lucas, November 2018</a></p><p>In a twig template, if you just want to render one or more fields (instead of the entire node), Drupal may not be aware if the content has changed, and will sometimes show old cached content. To resolve this, define a view mode and call <code class="language-plaintext highlighter-rouge">content | render</code> and assign the result to a variable like this:</p><div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set blah = content|render
</code></pre></div></div><p>Be sure to surround the above code with curly brace and percentage sign delimeters. Unfortunately these don’t always render correctly in this document so I’ve had to remove them for now.</p><p>Adding this render call will cause Drupal to render the content for that node, which will cause a check of the caches and make sure the most current content is rendered.</p><p>Then add your fields:</p><div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  {content.field_one}  etc.
</code></pre></div></div><h2 id="block-permission-blockaccess"> <a aria-labelledby="block-permission-blockaccess" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#block-permission-blockaccess"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Block Permission (blockAccess)</h2><p>This code is taken from the Drupal core user_login_block (UserLoginBlock.php). It allows access to the block if the user is logged out and is not on the login or logout page. The access is cached based on the current route name and the user’s current role being anonymous. If these are not passed, the access returned is forbidden and the block is not built.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Access\AccessResult</span><span class="p">;</span>

<span class="nv">$account</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">currentUser</span><span class="p">();</span>


<span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">blockAccess</span><span class="p">(</span><span class="kt">AccountInterface</span> <span class="nv">$account</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$route_name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">routeMatch</span><span class="o">-&gt;</span><span class="nf">getRouteName</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">isAnonymous</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$route_name</span><span class="p">,</span> <span class="p">[</span><span class="s1">'user.login'</span><span class="p">,</span> <span class="s1">'user.logout'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">allowed</span><span class="p">()</span>
      <span class="o">-&gt;</span><span class="nf">addCacheContexts</span><span class="p">([</span><span class="s1">'route.name'</span><span class="p">,</span> <span class="s1">'user.roles:anonymous'</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">forbidden</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>Another example from the Drupal core Copyright.php file:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// $account comes from</span>
<span class="nv">$account</span> <span class="o">=</span> <span class="err">\</span><span class="nc">\Drupal</span><span class="o">::</span><span class="nf">currentUser</span><span class="p">();</span>

<span class="c1">//Get the route.</span>
<span class="nv">$route_name</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getRouteName</span><span class="p">();</span>

<span class="c1">// not on the user login and logout pages</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$route_name</span><span class="p">,</span> <span class="p">[</span><span class="s1">'user.login'</span><span class="p">,</span> <span class="s1">'user.logout'</span><span class="p">]))</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">allowed</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">//Authenticated user</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">isAuthenticated</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">allowed</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">//Anonymous user.</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">isAnonymous</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">forbidden</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="blocks-shouldnt-talk-to-the-router-noderoutecontext-and-friends-should"> <a aria-labelledby="blocks-shouldnt-talk-to-the-router-noderoutecontext-and-friends-should" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#blocks-shouldnt-talk-to-the-router-noderoutecontext-and-friends-should"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Blocks shouldn’t talk to the router, NodeRouteContext and friends should</h3><p>While it is possible for blocks to talk to the router, you can’t always count that they will be on a meaningful route i.e. are they being displayed on a node? So we should use context definition in the block annotation like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Provides a 'Node Context Test' block.
 *
 * @Block(
 *   id = "node_block_test_context",
 *   label = @Translation("Node Context Test"),
 *   context_definitions = {
 *     "node" = @ContextDefinition("entity:node", label = @Translation("Node"))
 *   }
 * )
 */</span>
</code></pre></div></div><p>This causes the block to be available only on various node pages (view, edit etc.). This can be changed:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">*</span>   <span class="n">context_definitions</span> <span class="o">=</span> <span class="p">{</span>
 <span class="o">*</span>     <span class="s2">"node"</span> <span class="o">=</span> <span class="o">@</span><span class="nf">ContextDefinition</span><span class="p">(</span><span class="s2">"entity:node"</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="o">@</span><span class="nf">Translation</span><span class="p">(</span><span class="s2">"Node"</span><span class="p">),</span>
 <span class="o">*</span>       <span class="n">required</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
 <span class="o">*</span>   <span class="p">}</span>
</code></pre></div></div><p>The order of named options passed to ContextDefinition after the first argument does not matter.</p><p>Then in the block we check to make sure the user is viewing a node and that the user has <code class="language-plaintext highlighter-rouge">view rsvplist</code> permission. See the code below:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">protected</span> <span class="k">function</span> <span class="n">blockAccess</span><span class="p">(</span><span class="kt">AccountInterface</span> <span class="nv">$account</span><span class="p">)</span> <span class="p">{</span>
    <span class="cd">/** @var \Drupal\Core\Plugin\Context\Context $node */</span>
    <span class="nv">$cacheContext</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getContext</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
    <span class="cd">/** @var \Drupal\Core\Entity\Plugin\DataType\EntityAdapter $data */</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$cacheContext</span><span class="o">-&gt;</span><span class="nf">getContextData</span><span class="p">();</span>
    <span class="cd">/** @var \Drupal\node\NodeInterface $node */</span>
    <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$nid</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// See rsvp.permissions.yml for the permission string.</span>
        <span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">allowedIfHasPermission</span><span class="p">(</span><span class="nv">$account</span><span class="p">,</span> <span class="s1">'view rsvplist'</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">forbidden</span><span class="p">();</span>
  <span class="p">}</span>

</code></pre></div></div><p>More at https://drupal.stackexchange.com/questions/145823/how-do-i-get-the-current-node-id/314152#314152</p><p>Note. While this practice is not recommended, the RSVP module does have an example of a block talking to the router i.e. <code class="language-plaintext highlighter-rouge">\Drupal::routeMatch()</code> - see <a href="https://git.drupalcode.org/project/rsvp_module/-/blob/1.0.x/src/Plugin/Block/RSVPBlock.php">https://git.drupalcode.org/project/rsvp_module/-/blob/1.0.x/src/Plugin/Block/RSVPBlock.php</a> where the <code class="language-plaintext highlighter-rouge">blockAccess()</code> function grabs the <code class="language-plaintext highlighter-rouge">node</code> parameter and acts on it.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">blockAccess</span><span class="p">(</span><span class="kt">AccountInterface</span> <span class="nv">$account</span><span class="p">)</span> <span class="p">{</span>
    <span class="cd">/** @var \Drupal\node\Entity\Node $node */</span>
    <span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getParameter</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
    <span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">nid</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="cd">/** @var \Drupal\rsvp_module\EnablerService $enabler */</span>
    <span class="nv">$enabler</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'rsvp_module.enabler'</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$nid</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nv">$enabler</span><span class="o">-&gt;</span><span class="nf">isEnabled</span><span class="p">(</span><span class="nv">$node</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">allowedIfHasPermission</span><span class="p">(</span><span class="nv">$account</span><span class="p">,</span> <span class="s1">'view rsvp_module'</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">forbidden</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div></div><h3 id="values-returned-by-blockaccess"> <a aria-labelledby="values-returned-by-blockaccess" class="anchor-heading" href="https://selwynpolit.github.io/d9book/blocks#values-returned-by-blockaccess"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Values returned by blockAccess()</h3><p>Some options that can be returned from blockAccess() are:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">forbidden</span><span class="p">();</span>
<span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">allowed</span><span class="p">();</span>
<span class="k">return</span> <span class="nc">AccessResult</span><span class="o">::</span><span class="nf">allowedIf</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">);</span>
</code></pre></div></div><hr/> <script async="" crossorigin="anonymous" data-category="Q&amp;A" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMjY2NDE4" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="selwynpolit/d9book" data-repo-id="MDEwOlJlcG9zaXRvcnkzMjUxNTQ1Nzg=" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js"> </script><hr/><footer><p><a href="https://selwynpolit.github.io/d9book/blocks#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0"><span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"> <a href="http://www.selwynpolit.github.io/d9book" property="dct:title" rel="cc:attributionURL">Drupal at your fingertips</a> by <a href="http://www.drupal.org/u/selwynpolit" property="cc:attributionName" rel="cc:attributionURL dct:creator">Selwyn Polit</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="license noopener noreferrer" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" style="height:16px!important;vertical-align:text-bottom;"/> <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" style="height:16px!important;vertical-align:text-bottom;"/> </a></span></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0 mr-2"> Page last modified: <span class="d-inline-block">Apr 13 2023</span>.</p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/selwynpolit/d9book/tree/gh-pages/book/blocks.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
</body></link></meta></meta></meta></head></html>