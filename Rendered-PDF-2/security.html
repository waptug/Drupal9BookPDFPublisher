<!DOCTYPE html>
<html lang="en-US"><head><meta charset="utf-8"/><meta content="IE=Edge" http-equiv="X-UA-Compatible"/><link href="https://selwynpolit.github.io/d9book/assets/css/just-the-docs-default.css" rel="stylesheet"/> <script async="" src="https://www.googletagmanager.com/gtag/js?id=8V22RQEJ71"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '8V22RQEJ71', { 'anonymize_ip': true }); </script> <script src="https://selwynpolit.github.io/d9book/assets/js/vendor/lunr.min.js"></script> <script src="https://selwynpolit.github.io/d9book/assets/js/just-the-docs.js"></script><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://selwynpolit.github.io/d9book/assets/images/favicon.ico" rel="icon" type="image/x-icon"/><title>Security | Drupal Book</title><meta content="Jekyll v4.3.2" name="generator"><meta content="Security" property="og:title"><meta content="en_US" property="og:locale"><meta content="Drupal at your fingertips" name="description"/><meta content="Drupal at your fingertips" property="og:description"/><link href="https://selwynpolit.github.io/d9book/d9book/security" rel="canonical"><meta content="https://selwynpolit.github.io/d9book/d9book/security" property="og:url"/><meta content="Drupal Book" property="og:site_name"/><meta content="website" property="og:type"/><meta content="summary" name="twitter:card"/><meta content="Security" property="twitter:title"/> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Drupal at your fingertips","headline":"Security","url":"https://selwynpolit.github.io/d9book/d9book/security"}</script><body> <a class="skip-to-main" href="https://selwynpolit.github.io/d9book/security#main-content">Skip to main content</a> <svg class="d-none" xmlns="http://www.w3.org/2000/svg"> <symbol id="svg-link" viewbox="0 0 24 24"><title>Link</title><svg class="feather feather-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"><title>Menu</title><svg class="feather feather-menu" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"><title>Expand</title><svg class="feather feather-chevron-right" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol class="feather feather-external-link" fill="none" height="24" id="svg-external-link" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"><title>Document</title><svg class="feather feather-file" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"><title>Search</title><svg class="feather feather-search" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"> <circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewbox="0 0 16 16"><title>Copy</title><svg class="bi bi-clipboard" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path> </svg> </symbol> <symbol id="svg-copied" viewbox="0 0 16 16"><title>Copied</title><svg class="bi bi-clipboard-check-fill" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a class="site-title lh-tight" href="https://selwynpolit.github.io/d9book/"> Drupal Book </a> <a class="site-button" href="https://selwynpolit.github.io/d9book/security" id="menu-button"> <svg class="icon" viewbox="0 0 24 24"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" class="site-nav" id="site-nav"><ul class="nav-list"><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/">Home</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/actions">Actions</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/attribution">Attribution</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/bq">Batch and Queue</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/blocks">Blocks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/caching">Caching</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/composer">Composer</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/config">Config</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/cron">Cron</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dates">Dates and Times</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/debugging">Debugging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/development">Development</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/drush">Drush</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/email">Email</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/entities">Entities</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/forms">Forms</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/general">General</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/off-island">Getting off the Island</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/hooks">Hooks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/learn">Learning</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/links">Links</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/logging">Logging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/menus">Menus</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/migrate">Migrate</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/modals">Modals</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/nodes-and-fields">Nodes and Fields</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/queries">Queries</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/redirects">Redirects</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/render">Render Arrays</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/routes">Routes</a><li class="nav-list-item active"><a class="nav-list-link active" href="https://selwynpolit.github.io/d9book/security">Security</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/services">Services</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/state">State</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/taxonomy">Taxonomy</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dtt">Tests</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/twig">Twig</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><ul class="nav-list"><li class="nav-list-item external"> <a class="nav-list-link external" href="https://github.com/selwynpolit/d9book/fork"> Fork me on GitHub <svg aria-labelledby="svg-external-link-title" viewbox="0 0 24 24"><use xlink:href="#svg-external-link"></use></svg> </a></li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div class="main-header" id="main-header"><div class="search"><div class="search-input-wrap"> <input aria-label="Search Drupal Book" autocomplete="off" class="search-input" id="search-input" placeholder="Search Drupal Book" tabindex="0" type="text"/> <label class="search-label" for="search-input"><svg class="search-icon" viewbox="0 0 24 24"><use xlink:href="#svg-search"></use></svg></label></div><div class="search-results" id="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a class="site-button" href="https://twitter.com/selwynpolit" rel="noopener noreferrer" target="_blank"> <img alt="Twitter logo" src="https://atuin.ru/demo/simple-icons/icons/twitter.svg" style="width: 30px; height: 30px;" title="Author in Twitter"/> </a><li class="aux-nav-list-item"> <a class="site-button" href="https://github.com/selwynpolit/d9book/tree/gh-pages" rel="noopener noreferrer" target="_blank"> <img alt="GitHub logo" src="https://atuin.ru/demo/simple-icons/icons/github.svg" style="width: 30px; height: 30px;" title="D9Book on GitHub"/> </a></li></li></ul></nav></div><div class="main-content-wrap" id="main-content-wrap"><div class="main-content" id="main-content" role="main"><h1 class="no_toc fw-500" id="security"> <a aria-labelledby="security" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#security"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Security</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a aria-labelledby="table-of-contents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#table-of-contents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ul id="markdown-toc"><li><a href="https://selwynpolit.github.io/d9book/security#overview" id="markdown-toc-overview">Overview</a><li><a href="https://selwynpolit.github.io/d9book/security#sanitizing-on-output-to-avoid-cross-site-scripting-xss-attacks" id="markdown-toc-sanitizing-on-output-to-avoid-cross-site-scripting-xss-attacks">Sanitizing on output to avoid Cross Site Scripting (XSS) attacks</a><li><a href="https://selwynpolit.github.io/d9book/security#htaccess-magic" id="markdown-toc-htaccess-magic">.htaccess magic</a><ul><li><a href="https://selwynpolit.github.io/d9book/security#disallowing-access-to-users-coming-from-a-domain" id="markdown-toc-disallowing-access-to-users-coming-from-a-domain">Disallowing access to users coming from a domain</a><li><a href="https://selwynpolit.github.io/d9book/security#blocking-core-drupal-pages" id="markdown-toc-blocking-core-drupal-pages">Blocking core Drupal pages</a><li><a href="https://selwynpolit.github.io/d9book/security#blocking-file-resources-from-all-but-a-handful-of-sites" id="markdown-toc-blocking-file-resources-from-all-but-a-handful-of-sites">Blocking file resources from all but a handful of sites</a><li><a href="https://selwynpolit.github.io/d9book/security#time-based-blocks" id="markdown-toc-time-based-blocks">Time-based blocks</a><li><a href="https://selwynpolit.github.io/d9book/security#blocking-http-commands" id="markdown-toc-blocking-http-commands">Blocking HTTP commands</a><li><a href="https://selwynpolit.github.io/d9book/security#block-specific-user-agents" id="markdown-toc-block-specific-user-agents">Block specific user agents</a><li><a href="https://selwynpolit.github.io/d9book/security#block-traffic-from-robot-crawlers" id="markdown-toc-block-traffic-from-robot-crawlers">Block traffic from robot crawlers</a><li><a href="https://selwynpolit.github.io/d9book/security#blocking-hotlinks" id="markdown-toc-blocking-hotlinks">Blocking hotlinks</a></li></li></li></li></li></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/security#reviewing-server-logs" id="markdown-toc-reviewing-server-logs">Reviewing Server logs</a><ul><li><a href="https://selwynpolit.github.io/d9book/security#find-the-most-frequent-ip-addresses" id="markdown-toc-find-the-most-frequent-ip-addresses">Find the most frequent IP addresses</a><li><a href="https://selwynpolit.github.io/d9book/security#find-the-most-frequent-user-agents" id="markdown-toc-find-the-most-frequent-user-agents">Find the most frequent User Agents</a><li><a href="https://selwynpolit.github.io/d9book/security#find-the-most-frequent-urls-visited-on-your-site" id="markdown-toc-find-the-most-frequent-urls-visited-on-your-site">Find the most frequent URLs visited on your site</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/security#general-overview-of-harding-your-drupal-site" id="markdown-toc-general-overview-of-harding-your-drupal-site">General overview of harding your Drupal site</a><li><a href="https://selwynpolit.github.io/d9book/security#api-functions-best-practices" id="markdown-toc-api-functions-best-practices">API functions best practices</a><li><a href="https://selwynpolit.github.io/d9book/security#checkplain" id="markdown-toc-checkplain">checkPlain</a><li><a href="https://selwynpolit.github.io/d9book/security#htmlescape" id="markdown-toc-htmlescape">Html::escape</a><li><a href="https://selwynpolit.github.io/d9book/security#drupalcheckplain" id="markdown-toc-drupalcheckplain">Drupal.checkPlain()</a><li><a href="https://selwynpolit.github.io/d9book/security#use-the-database-abstraction-layer-to-avoid-sql-injection-attacks" id="markdown-toc-use-the-database-abstraction-layer-to-avoid-sql-injection-attacks">Use the database abstraction layer to avoid SQL injection attacks</a><li><a href="https://selwynpolit.github.io/d9book/security#csrf-access-checking" id="markdown-toc-csrf-access-checking">CSRF access checking</a><li><a href="https://selwynpolit.github.io/d9book/security#exampleroutingyml" id="markdown-toc-exampleroutingyml">example.routing.yml</a><ul><li><a href="https://selwynpolit.github.io/d9book/security#resources" id="markdown-toc-resources">Resources</a></li></ul></li></li></li></li></li></li></li></li></li></li></li></li></ul><p><img alt="views" src="https://api.visitor.plantree.me/visitor-badge/pv?label=views&amp;color=informational&amp;namespace=d9book&amp;key=security.md"/></p><hr/><h2 id="overview"> <a aria-labelledby="overview" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#overview"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Overview</h2><p>Drupal is a highly secure platform mostly due to the tireless efforts of the <a href="https://www.drupal.org/drupal-security-team">security team</a>.</p><h2 id="sanitizing-on-output-to-avoid-cross-site-scripting-xss-attacks"> <a aria-labelledby="sanitizing-on-output-to-avoid-cross-site-scripting-xss-attacks" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#sanitizing-on-output-to-avoid-cross-site-scripting-xss-attacks"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Sanitizing on output to avoid Cross Site Scripting (XSS) attacks</h2><p>The Twig theme engine now auto escapes everything by default. That means, every string printed from a Twig template (e.g. anything between ``) gets automatically sanitized if no filters are used.</p><p><a href="https://www.drupal.org/node/2357633">See Filters - Modifying Variables In Twig Templates</a> for the Twig filters available in Drupal. Notably, watch out for the “raw” filter, which does not escape output. Only use this when you are certain the data is trusted.</p><p>When rendering attributes in Twig, make sure that you wrap them with double or single quotes. For example, class="{{ class }}" is safe while class={{ class }} is not safe.</p><p>In order to take advantage of Twig’s automatic escaping (and avoid safe markup being escaped) ideally all HTML should be outputted from Twig templates.</p><h2 id="htaccess-magic"> <a aria-labelledby="htaccess-magic" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#htaccess-magic"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> .htaccess magic</h2><h3 id="disallowing-access-to-users-coming-from-a-domain"> <a aria-labelledby="disallowing-access-to-users-coming-from-a-domain" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#disallowing-access-to-users-coming-from-a-domain"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Disallowing access to users coming from a domain</h3><p>Requests from specific domains can be blocked by adding the following to <code class="language-plaintext highlighter-rouge">.htaccess</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RewriteCond %{HTTP_REFERER} domain-name\.com [NC] 
RewriteRule .* - [F]
</code></pre></div></div><p>For multiple domains, use something similar to the following:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RewriteCond %{HTTP_REFERER} domain-one\.com [NC,OR] 
RewriteCond %{HTTP_REFERER} domain-two\.com RewriteRule .* - [F]
</code></pre></div></div><h3 id="blocking-core-drupal-pages"> <a aria-labelledby="blocking-core-drupal-pages" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#blocking-core-drupal-pages"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Blocking core Drupal pages</h3><p>Files such as CHANGELOG.txt can be used to quickly identify security vulnerabilities in your Drupal installation to a malicious script or user. While there are a number of ways to identify the version of Drupal that you are running, one quick addition to your .htaccess file can make it slightly le obvious.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Various alias rules 
Redirect 404 /CHANGELOG.txt 
Redirect 404 /COPYRIGHT.txt 
Redirect 404 /cron.php 
Redirect 404 /INSTALL.mysql.txt 
Redirect 404 /INSTALL.pgsql.txt 
Redirect 404 /INSTALL.sqlite.txt 
Redirect 404 /INSTALL.txt 
Redirect 404 /install.php 
Redirect 404 /LICENSE.txt 
Redirect 404 /MAINTAINERS.txt 
Redirect 404 /PATCHES.txt 
Redirect 404 /README.txt 
Redirect 404 /update.php 
Redirect 404 /UPGRADE.txt 
Redirect 404 /web.config
</code></pre></div></div><h3 id="blocking-file-resources-from-all-but-a-handful-of-sites"> <a aria-labelledby="blocking-file-resources-from-all-but-a-handful-of-sites" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#blocking-file-resources-from-all-but-a-handful-of-sites"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Blocking file resources from all but a handful of sites</h3><p>You may want to keep a specific directory from being accessed by the general public, unless it’s being pulled by a particular website. This example shows blocks requests to the /sites/default/files directory unless the request comes from www?, prod-kb, or the kb subdomains of example.com.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RewriteCond %{REQUEST_URI} ^/sites/default/files 
RewriteCond %{HTTP_REFERER} !^http://prod-kb.example.com [NC] 
RewriteCond %{HTTP_REFERER} !^http://kb.example.com [NC] 
RewriteCond %{HTTP_REFERER} !^http://(www.)?example.com [NC] RewriteRule .* - [F]
</code></pre></div></div><h3 id="time-based-blocks"> <a aria-labelledby="time-based-blocks" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#time-based-blocks"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Time-based blocks</h3><p>If you are only allowed to expose your website for a specific time period, you can do that. This condition and rule blocks access until 4 PM.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RewriteCond %{TIME_HOUR} ^16$
RewriteRule ^.*$ - [F,L]
</code></pre></div></div><h3 id="blocking-http-commands"> <a aria-labelledby="blocking-http-commands" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#blocking-http-commands"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Blocking HTTP commands</h3><p>You may not want to allow certain types of commands to be proceed by your site.</p><p>This blocks any HTTP request that is not a GET or a POST request.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RewriteCond %{REQUEST_METHOD} !^(GET|POST) 
RewriteRule .* - [F]
</code></pre></div></div><h3 id="block-specific-user-agents"> <a aria-labelledby="block-specific-user-agents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#block-specific-user-agents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Block specific user agents</h3><p>If your website is the victim of a DDoS attack, and you want to block a group of IP addresses using the same User Agent, the following code may be helpful. Replace the UserAgent with the name of the agent you want to block:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RewriteCond %{HTTP_USER_AGENT} UserAgent 
RewriteRule .* - [F,L]
</code></pre></div></div><p>You can also block more than one User Agent at a time with the <code class="language-plaintext highlighter-rouge">[OR]</code> (‘or next condition’) flag, and the <code class="language-plaintext highlighter-rouge">[NC]</code> (‘no case’) flag renders the string case insensitive. Here are some examples of some user-agents with properly escaped regexes:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RewriteCond %{HTTP_USER_AGENT} Baiduspider [NC,OR] 
RewriteCond %{HTTP_USER_AGENT} HTTrack [NC,OR] 
RewriteCond %{HTTP_USER_AGENT} Yandex [NC,OR] 
RewriteCond %{HTTP_USER_AGENT} Scrapy [NC,OR] 
RewriteCond %{HTTP_USER_AGENT} Mozilla/5\.0\ \(compatible;\ Yahoo [NC,OR] 
RewriteCond %{HTTP_USER_AGENT} AppleNewsBot [NC,OR] 
RewriteCond %{HTTP_USER_AGENT} Googlebot [NC,OR] 
RewriteCond %{HTTP_USER_AGENT} Mozilla/5\.0\ \(compatible;\ YandexBot [NC] 
RewriteRule .* - [F,L]
Important
</code></pre></div></div><p>Properly escape characters inside your regex (regular expressions) to avoid website errors.</p><p><code class="language-plaintext highlighter-rouge">HTTP_USER_AGENT</code> can use regex as an argument. As seen in the example above, many User Agents will require regex due to the complexity of their name. Rather than creating the rule manually, websites such as <a href="https://www.regex-escape.com/regex-escaping-online.php">https://www.regex-escape.com/regex-escaping-online.php</a> can help construct a properly-escaped regex quickly.</p><p><strong>How to test that the block is working</strong></p><p>Test that the site is responding:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "host:www.url_you_are_testing.url http://localhost/
</code></pre></div></div><p>Test that the user-agent (Pcore as an example) is indeed blocked:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "host:www.url_you_are_testing.url" -H "user-agent:Pcore-HTTP/v0.25.0" http://localhost.com/
</code></pre></div></div><h3 id="block-traffic-from-robot-crawlers"> <a aria-labelledby="block-traffic-from-robot-crawlers" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#block-traffic-from-robot-crawlers"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Block traffic from robot crawlers</h3><p>While a robot crawler may not technically be an attack, some crawlers can cause real problems. You can use this when the robots do not obey the robots.txt file, or if you need an immediate block, because robots.txt is generally not fetched immediately by crawlers.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RewriteCond %\{HTTP_REFERER\} ^$
RewriteCond %\{HTTP_USER_AGENT\} "&lt;exact_name_for_the_bot&gt;"
RewriteRule ^(.*)$ - [F,L]
</code></pre></div></div><h3 id="blocking-hotlinks"> <a aria-labelledby="blocking-hotlinks" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#blocking-hotlinks"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Blocking hotlinks</h3><p>The last thing most website owners want is other websites stealing their content, or worse - hotlinking to their images and stealing their bandwidth. Here s a simple bit of code that prevents it-modify domain.com to your domain name:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^http://(www\.)?domain.com/ .*$ NC
RewriteRule \.(gif|jpg|swf|flv|png)$ /feed/ R=302,L
</code></pre></div></div><h2 id="reviewing-server-logs"> <a aria-labelledby="reviewing-server-logs" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#reviewing-server-logs"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Reviewing Server logs</h2><h3 id="find-the-most-frequent-ip-addresses"> <a aria-labelledby="find-the-most-frequent-ip-addresses" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#find-the-most-frequent-ip-addresses"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Find the most frequent IP addresses</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk '{print $1}' access.log| sort | uniq -c | sort -nr| head
</code></pre></div></div><h3 id="find-the-most-frequent-user-agents"> <a aria-labelledby="find-the-most-frequent-user-agents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#find-the-most-frequent-user-agents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Find the most frequent User Agents</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk -F\" '{print $6}' access.log | sort | uniq -c | sort -nr | head
</code></pre></div></div><h3 id="find-the-most-frequent-urls-visited-on-your-site"> <a aria-labelledby="find-the-most-frequent-urls-visited-on-your-site" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#find-the-most-frequent-urls-visited-on-your-site"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Find the most frequent URLs visited on your site</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>awk -F\" '{print $2}' access.log| awk -F? '{print $1}' | sort | uniq -c | sort -nr | head
</code></pre></div></div><p>This query strips the variables (anything after a question mark in your URL).</p><p><a href="https://acquia.my.site.com/s/article/360013350193-Analyzing-Your-Traffic">Read more on Acquia.com</a></p><h2 id="general-overview-of-harding-your-drupal-site"> <a aria-labelledby="general-overview-of-harding-your-drupal-site" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#general-overview-of-harding-your-drupal-site"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> General overview of harding your Drupal site</h2><p><a href="https://acquia.my.site.com/s/article/360041130414-Harden-Drupal-sites-against-security-threats">from Acquia.com</a></p><p><strong>Ensure up-to-date backups are safe and secure</strong></p><ul><li>Initiate a production database backup<li>Download a copy of recent database backups, and keep updated copies offsite<li>If possible, also take backups of the file system</li></li></li></ul><p><strong>Ensure Drupal Core and Installed Modules are up to date</strong> Drupal Core updates often contain security patches. Outdated, unmaintained modules often contain known security vulnerabilities.</p><ul><li>Look for projects and modules covered by the Drupal Security Advisories<li>Remove obsolete and unused modules<li>Check for available updates under the Drupal admin console, or by using drush or composer.</li></li></li></ul><p><strong>Perform a user audit</strong></p><ul><li>Ensure permissions are restricted and implemented correctly<li>Remove any old or unneeded admin or privileged accounts</li></li></ul><p>If a breach has occurred or internal threat, an attacker or internal threat may have added user(s) to retain access.</p><ul><li>Check for any new or unexpected user accounts</li></ul><p><strong>Password Checks</strong></p><p>Bad passwords are the most common cause of site compromise.</p><ul><li>Ensure strong password requirements are enforced. A community contributed module that offers this functionality is Password Policy.<li>Perform a check for bad passwords. A community contributed module that offers this functionality is <a href="https://www.drupal.org/project/drop_the_ripper">Drop the Ripper</a></li></li></ul><p><strong>2-Factor Authentication</strong></p><ul><li>Enforce 2-factor authentication (especially for admin and/or privileged accounts) to mitigate the threat of compromised passwords.<li><p><strong>Review Site Functionality</strong></p><li>Check that file uploads are restricted to intended file extension type (e.g. Do not allow .html uploads for an image)<li>Ensure any sensitive data files are uploaded to secure directories only (e.g. Do not place personal data ( PII ) such as CVs or job applications in public ‘files’ directories)<li>Review controls on web forms</li></li></li></li></li></ul><p>Attackers will often target forms that generate outbound emails ( e.g. “refer a friend” or “contact-us” )</p><p>Try to keep messages generated from forms generic Ensure CAPTCHA controls are used to prevent abuse</p><p><strong>Web Application Firewall ( WAF )</strong></p><p>If a WAF is not already in place, Acquia strongly recommend implementing one.</p><p><a href="https://docs.acquia.com/guide/edge/">Acquia Cloud Edge Protect</a> is Acquia’s WAF offering.</p><p>Edge Protect provides advanced security controls to restrict and block attacker traffic before it reaches the application stack. Common attack methods are identified and blocked automatically. WAFs are extremely effective in mitigating (D)DOS attacks.</p><h2 id="api-functions-best-practices"> <a aria-labelledby="api-functions-best-practices" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#api-functions-best-practices"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> API functions best practices</h2><p>From <a href="https://www.drupal.org/docs/8/security/drupal-8-sanitizing-output">Writing secure code for Drupal</a></p><ul><li>Use <a href="https://api.drupal.org/api/function/t">t()</a> and <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21StringTranslation%21TranslationInterface.php/function/TranslationInterface%3A%3AformatPlural/8.2.x">\Drupal::translation()-&gt;formatPlural()</a> with placeholders to construct safe, translatable strings. (See <a href="https://www.drupal.org/docs/8/api/translation-api/overview">Translation API overview</a> for more details.)<li>Use <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Component%21Utility%21Html.php/function/Html%3A%3Aescape/8.2.x">Html::escape()</a> for plain text.<li>Use <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Component%21Utility%21Xss.php/function/Xss%3A%3Afilter/8">Xss::filter()</a> for text that should allow some HTML tags.<li>Use <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Component%21Utility%21Xss.php/function/Xss%3A%3AfilterAdmin/10">Xss::filterAdmin()</a> for text entered by admin users that should allow most HTML.<li>Use <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Component%21Utility%21UrlHelper.php/function/UrlHelper%3A%3AstripDangerousProtocols/9">UrlHelper::stripDangerousProtocols()</a> or <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Component%21Utility%21UrlHelper.php/function/UrlHelper%3A%3AfilterBadProtocol/9">UrlHelper::filterBadProtocol()</a> for checking URLs - the former can be used in conjunction with <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Component%21Utility%21SafeMarkup.php/function/SafeMarkup%3A%3Aformat/8.9.x">SafeMarkup::format()</a> - Oops, SafeMarkup was removed from Drupal 9. Rather use <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Component%21Render%21FormattableMarkup.php/class/FormattableMarkup/10">FormattableMarkup</a></li></li></li></li></li></ul><p>Strings sanitized by <code class="language-plaintext highlighter-rouge">t()</code>, <code class="language-plaintext highlighter-rouge">Html::escape()</code>, <code class="language-plaintext highlighter-rouge">Xss::filter()</code> or <code class="language-plaintext highlighter-rouge">Xss::filterAdmin()</code> are automatically marked safe, as are markup strings created from render arrays via <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Render%21Renderer.php/class/Renderer/8.4.x">Renderer</a>.</p><p>While it can also sanitize text, it’s almost never correct to use <a href="https://api.drupal.org/api/drupal/core%21modules%21filter%21filter.module/function/check_markup/8">check_markup</a> in a theme or module except in the context of something like a text area with an associated text format.</p><h2 id="checkplain"> <a aria-labelledby="checkplain" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#checkplain"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> checkPlain</h2><p>This is from the file web/modules/custom/rsvp/src/Controller/ReportController.php</p><p>Here we pass <code class="language-plaintext highlighter-rouge">SafeMarkup::checkPlain</code>` to array_map to call it on each entry in the array. The entry array looks like:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$entry</span><span class="p">[</span><span class="err">‘</span><span class="n">name</span><span class="err">’</span><span class="p">]</span><span class="o">=</span><span class="err">”</span><span class="n">fred</span><span class="err">”</span><span class="p">,</span> 
<span class="nv">$entry</span><span class="p">[</span><span class="err">‘</span><span class="n">email</span><span class="err">’</span><span class="p">]</span><span class="o">=</span><span class="s2">"fred@bloggs.com"</span>
</code></pre></div></div><p>$rows = array_map(‘Drupal\Component\Utility\SafeMarkup::checkPlain’, $entry);</p><p>Here is the whole function.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$rows</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getAllRSVPs</span><span class="p">();</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$rows</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Sanitize each entry.</span>
  <span class="nv">$rows_array</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'Drupal\Component\Utility\SafeMarkup::checkPlain'</span><span class="p">,</span> <span class="nv">$row</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="htmlescape"> <a aria-labelledby="htmlescape" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#htmlescape"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Html::escape</h2><p>If you have html like this: <code class="language-plaintext highlighter-rouge">&lt;script&gt;alert(2)&lt;/script&gt;</code> which will be output as a mess with these sorts of characters: <code class="language-plaintext highlighter-rouge">&amp;amp;, &amp;lt;</code> etc. use Html::escape to avoid this.</p><p>$rows_array[] = array_map(‘Drupal\Component\Utility\Html::escape’, $row);</p><h2 id="drupalcheckplain"> <a aria-labelledby="drupalcheckplain" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#drupalcheckplain"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Drupal.checkPlain()</h2><p>It is best practice to use the server to sanitize text, but there may be situations where you need to lean on the client (browser) to provide additional or temporary sanitization, such as an HTML element that updates on the client side as the user enters text.</p><p>These examples are for use cases of outputting text to the DOM. If you’re sending text to the server, such as when making an API call, you should review Back End practices.</p><p>You can use <code class="language-plaintext highlighter-rouge">Drupal.checkPlain()</code>` to escape basic characters and prevent malicious elements being introduced into the DOM, avoiding some basic Clickjacking techniques.</p><p>Bad Practice:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">rawInputText</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#form-input</span><span class="dl">'</span><span class="p">).</span><span class="nf">text</span><span class="p">();</span>
</code></pre></div></div><p>Good Practice:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">rawInputText</span>     <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#form-input</span><span class="dl">'</span><span class="p">).</span><span class="nf">text</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">escapedInputText</span> <span class="o">=</span> <span class="nx">Drupal</span><span class="p">.</span><span class="nf">checkPlain</span><span class="p">(</span><span class="nx">rawInputText</span><span class="p">);</span>
</code></pre></div></div><h2 id="use-the-database-abstraction-layer-to-avoid-sql-injection-attacks"> <a aria-labelledby="use-the-database-abstraction-layer-to-avoid-sql-injection-attacks" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#use-the-database-abstraction-layer-to-avoid-sql-injection-attacks"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Use the database abstraction layer to avoid SQL injection attacks</h2><p>Bad practice: Never concatenate data directly into SQL queries.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">\Database</span><span class="o">::</span><span class="nf">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s1">'SELECT foo FROM {table} t WHERE t.name = '</span><span class="mf">.</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]);</span>
</code></pre></div></div><p>Good Practice:</p><p>Use proper argument substitution. The database layer works on top of PHP PDO, and uses an array of named placeholders:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">\Database</span><span class="o">::</span><span class="nf">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s1">'SELECT foo FROM {table} t WHERE t.name = :name'</span><span class="p">,</span> <span class="p">[</span><span class="s1">':name'</span> <span class="o">=&gt;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]]);</span>
</code></pre></div></div><p>For a variable number of argument, use an array of arguments or use the select() method. See examples of each below:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$users</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'joe'</span><span class="p">,</span> <span class="s1">'poe'</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]];</span>
<span class="nc">\Database</span><span class="o">::</span><span class="nf">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="s1">'SELECT f.bar FROM {foo} f WHERE f.bar IN (:users[])'</span><span class="p">,</span>  <span class="p">[</span><span class="s1">':users[]'</span> <span class="o">=&gt;</span> <span class="nv">$users</span><span class="p">]);</span>
</code></pre></div></div><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$users</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'joe'</span><span class="p">,</span> <span class="s1">'poe'</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]];</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nc">\Database</span><span class="o">::</span><span class="nf">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">select</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'f'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">fields</span><span class="p">(</span><span class="s1">'f'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'bar'</span><span class="p">])</span>
  <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'f.bar'</span><span class="p">,</span> <span class="nv">$users</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div><p>When forming a LIKE query, make sure that you escape condition values to ensure they don’t contain wildcard characters like <code class="language-plaintext highlighter-rouge">"%"</code>`:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">db_select</span><span class="p">(</span><span class="s1">'table'</span><span class="p">,</span> <span class="s1">'t'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'t.field'</span><span class="p">,</span> <span class="s1">'%_'</span> <span class="mf">.</span> <span class="nf">db_like</span><span class="p">(</span><span class="nv">$user</span><span class="p">),</span> <span class="s1">'LIKE'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div><p>Make sure that users cannot provide any operator to a query’s condition. For example, this is unsafe:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">db_select</span><span class="p">(</span><span class="s1">'table'</span><span class="p">,</span> <span class="s1">'t'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'t.field'</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$user_input</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div><p>Instead, set a list of allowed operators and only allow users to use those.</p><p><code class="language-plaintext highlighter-rouge">db_query</code>, <code class="language-plaintext highlighter-rouge">db_select</code>, and <code class="language-plaintext highlighter-rouge">db_like</code> were deprecated and removed from Drupal 9 - instead you should use a database connection object and call the query, select, and <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Database%21Connection.php/function/Connection%3A%3AescapeLike/9">escapeLike</a> methods on it (the parameters are the same).</p><h2 id="csrf-access-checking"> <a aria-labelledby="csrf-access-checking" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#csrf-access-checking"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> CSRF access checking</h2><p>CSRF (Cross-Site Request Forgery) protection is now integrated into the routing access system and should be used for any URLs that perform actions or operations that do not use a form callback. In previous versions of Drupal, it was necessary to add a generated token as a query parameter to a URL and check this token manually in either the callback or the access callback. Now you can simply use the ‘_csrf_token’ requirement on a route definition. Doing so will automatically add a token to the query string, and this token will be checked for you.</p><h1 id="exampleroutingyml"> <a aria-labelledby="exampleroutingyml" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#exampleroutingyml"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> example.routing.yml</h1><p>example:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/example'</span>
  <span class="na">defaults</span><span class="pi">:</span>
    <span class="na">_controller</span><span class="pi">:</span> <span class="s1">'</span><span class="s">\Drupal\example\Controller\ExampleController::content'</span>
  <span class="na">requirements</span><span class="pi">:</span>
    <span class="na">_csrf_token</span><span class="pi">:</span> <span class="s1">'</span><span class="s">TRUE'</span>
</code></pre></div></div><p>Note that, in order for the token to be added, the link must be generated using the <code class="language-plaintext highlighter-rouge">url_generator</code> service via route name rather than as a manually constructed path.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromRoute</span><span class="p">(</span>
  <span class="s1">'node_test.report'</span><span class="p">,</span>
  <span class="p">[</span><span class="s1">'node'</span> <span class="o">=&gt;</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()],</span>
  <span class="p">[</span><span class="s1">'query'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'token'</span> <span class="o">=&gt;</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'csrf_token'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s2">"node/</span><span class="si">{</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()</span><span class="si">}</span><span class="s2">/report"</span><span class="p">)</span>
  <span class="p">]]);</span>
</code></pre></div></div><p><a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Access%21CsrfTokenGenerator.php/function/CsrfTokenGenerator%3A%3Aget/9.0.x">See API reference: CsrfTokenGenerator::get</a></p><p>To validate token manually (e.g. without adding <code class="language-plaintext highlighter-rouge">_csrf_token: 'TRUE'</code> to your <code class="language-plaintext highlighter-rouge">mymodule.routing.yml</code> file) at the route destination you can use the token and value used for generating it.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Validate $token from GET parameter.</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'csrf_token'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">validate</span><span class="p">(</span><span class="nv">$token</span><span class="p">,</span> <span class="s2">"node/</span><span class="si">{</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()</span><span class="si">}</span><span class="s2">/report"</span><span class="p">);</span>
</code></pre></div></div><p>Note. regarding anonymous users. Currently the <code class="language-plaintext highlighter-rouge">_csrf_token</code> check fails for users without an active session, which includes most anonymous users. See: <a href="https://www.drupal.org/project/drupal/issues/2730351">#2730351: CSRF check always fails for users without a session</a></p><h2 id="resources"> <a aria-labelledby="resources" class="anchor-heading" href="https://selwynpolit.github.io/d9book/security#resources"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Resources</h2><ul><li><a href="https://www.drupal.org/docs/develop/security">Security on Drupal.org</a><li><a href="https://acquia.my.site.com/s/article/360005210634-Blocking-access-using-rewrites">Blocking access using rewrites (Acquia.com)</a><li><a href="https://docs.acquia.com/cloud-platform/manage/htaccess/">.htaccess documentation (Acquia.com)</a><li><a href="https://www.drupal.org/docs/8/core/modules/ban/overview">Ban module in Drupal core overview for blocking IP addresses (Acquia.com)</a><li><a href="https://www.drupal.org/project/advban">Advanced Ban module</a><li><a href="https://docs.acquia.com/cloud-platform/arch/security/restrict/">Restricting website access (Acquia.com)</a><li><a href="https://www.drupal.org/docs/8/security/drupal-8-sanitizing-output">Writing secure code for Drupal from Drupal.org update August 2022</a><li><a href="https://www.drupal.org/node/2357633">Twig Filters - Modifying Variables In Twig Templates</a><li><a href="https://www.drupal.org/docs/8/api/translation-api/overview">Translation API overview on Drupal.org updated August 2022</a><li><a href="https://www.drupal.org/docs/8/api/routing-system/access-checking-on-routes/csrf-access-checking">CSRF access checking on Drupal.org updated March 2023</a></li></li></li></li></li></li></li></li></li></li></ul><hr/> <script async="" crossorigin="anonymous" data-category="Q&amp;A" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMjY2NDE4" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="selwynpolit/d9book" data-repo-id="MDEwOlJlcG9zaXRvcnkzMjUxNTQ1Nzg=" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js"> </script><hr/><footer><p><a href="https://selwynpolit.github.io/d9book/security#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0"><span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"> <a href="http://www.selwynpolit.github.io/d9book" property="dct:title" rel="cc:attributionURL">Drupal at your fingertips</a> by <a href="http://www.drupal.org/u/selwynpolit" property="cc:attributionName" rel="cc:attributionURL dct:creator">Selwyn Polit</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="license noopener noreferrer" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" style="height:16px!important;vertical-align:text-bottom;"/> <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" style="height:16px!important;vertical-align:text-bottom;"/> </a></span></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0 mr-2"> Page last modified: <span class="d-inline-block">Jul 31 2023</span>.</p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/selwynpolit/d9book/tree/gh-pages/book/security.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
</body></link></meta></meta></meta></head></html>