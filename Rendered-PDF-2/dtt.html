<!DOCTYPE html>
<html lang="en-US"><head><meta charset="utf-8"/><meta content="IE=Edge" http-equiv="X-UA-Compatible"/><link href="https://selwynpolit.github.io/d9book/assets/css/just-the-docs-default.css" rel="stylesheet"/> <script async="" src="https://www.googletagmanager.com/gtag/js?id=8V22RQEJ71"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '8V22RQEJ71', { 'anonymize_ip': true }); </script> <script src="https://selwynpolit.github.io/d9book/assets/js/vendor/lunr.min.js"></script> <script src="https://selwynpolit.github.io/d9book/assets/js/just-the-docs.js"></script><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://selwynpolit.github.io/d9book/assets/images/favicon.ico" rel="icon" type="image/x-icon"/><title>Tests | Drupal Book</title><meta content="Jekyll v4.3.2" name="generator"><meta content="Tests" property="og:title"><meta content="en_US" property="og:locale"><meta content="Drupal at your fingertips" name="description"/><meta content="Drupal at your fingertips" property="og:description"/><link href="https://selwynpolit.github.io/d9book/d9book/dtt" rel="canonical"><meta content="https://selwynpolit.github.io/d9book/d9book/dtt" property="og:url"/><meta content="Drupal Book" property="og:site_name"/><meta content="website" property="og:type"/><meta content="summary" name="twitter:card"/><meta content="Tests" property="twitter:title"/> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Drupal at your fingertips","headline":"Tests","url":"https://selwynpolit.github.io/d9book/d9book/dtt"}</script><body> <a class="skip-to-main" href="https://selwynpolit.github.io/d9book/dtt#main-content">Skip to main content</a> <svg class="d-none" xmlns="http://www.w3.org/2000/svg"> <symbol id="svg-link" viewbox="0 0 24 24"><title>Link</title><svg class="feather feather-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"><title>Menu</title><svg class="feather feather-menu" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"><title>Expand</title><svg class="feather feather-chevron-right" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol class="feather feather-external-link" fill="none" height="24" id="svg-external-link" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"><title>Document</title><svg class="feather feather-file" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"><title>Search</title><svg class="feather feather-search" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"> <circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewbox="0 0 16 16"><title>Copy</title><svg class="bi bi-clipboard" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path> </svg> </symbol> <symbol id="svg-copied" viewbox="0 0 16 16"><title>Copied</title><svg class="bi bi-clipboard-check-fill" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a class="site-title lh-tight" href="https://selwynpolit.github.io/d9book/"> Drupal Book </a> <a class="site-button" href="https://selwynpolit.github.io/d9book/dtt" id="menu-button"> <svg class="icon" viewbox="0 0 24 24"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" class="site-nav" id="site-nav"><ul class="nav-list"><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/">Home</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/actions">Actions</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/attribution">Attribution</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/bq">Batch and Queue</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/blocks">Blocks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/caching">Caching</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/composer">Composer</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/config">Config</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/cron">Cron</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dates">Dates and Times</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/debugging">Debugging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/development">Development</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/drush">Drush</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/email">Email</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/entities">Entities</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/forms">Forms</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/general">General</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/off-island">Getting off the Island</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/hooks">Hooks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/learn">Learning</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/links">Links</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/logging">Logging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/menus">Menus</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/migrate">Migrate</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/modals">Modals</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/nodes-and-fields">Nodes and Fields</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/queries">Queries</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/redirects">Redirects</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/render">Render Arrays</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/routes">Routes</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/security">Security</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/services">Services</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/state">State</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/taxonomy">Taxonomy</a><li class="nav-list-item active"><a class="nav-list-link active" href="https://selwynpolit.github.io/d9book/dtt">Tests</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/twig">Twig</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><ul class="nav-list"><li class="nav-list-item external"> <a class="nav-list-link external" href="https://github.com/selwynpolit/d9book/fork"> Fork me on GitHub <svg aria-labelledby="svg-external-link-title" viewbox="0 0 24 24"><use xlink:href="#svg-external-link"></use></svg> </a></li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div class="main-header" id="main-header"><div class="search"><div class="search-input-wrap"> <input aria-label="Search Drupal Book" autocomplete="off" class="search-input" id="search-input" placeholder="Search Drupal Book" tabindex="0" type="text"/> <label class="search-label" for="search-input"><svg class="search-icon" viewbox="0 0 24 24"><use xlink:href="#svg-search"></use></svg></label></div><div class="search-results" id="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a class="site-button" href="https://twitter.com/selwynpolit" rel="noopener noreferrer" target="_blank"> <img alt="Twitter logo" src="https://atuin.ru/demo/simple-icons/icons/twitter.svg" style="width: 30px; height: 30px;" title="Author in Twitter"/> </a><li class="aux-nav-list-item"> <a class="site-button" href="https://github.com/selwynpolit/d9book/tree/gh-pages" rel="noopener noreferrer" target="_blank"> <img alt="GitHub logo" src="https://atuin.ru/demo/simple-icons/icons/github.svg" style="width: 30px; height: 30px;" title="D9Book on GitHub"/> </a></li></li></ul></nav></div><div class="main-content-wrap" id="main-content-wrap"><div class="main-content" id="main-content" role="main"><h1 class="no_toc fw-500" id="phpunit-and-drupal-test-traits"> <a aria-labelledby="phpunit-and-drupal-test-traits" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#phpunit-and-drupal-test-traits"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> PHPUnit and Drupal Test Traits</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a aria-labelledby="table-of-contents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#table-of-contents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ul id="markdown-toc"><li><a href="https://selwynpolit.github.io/d9book/dtt#overview" id="markdown-toc-overview">Overview</a><li><a href="https://selwynpolit.github.io/d9book/dtt#location-of-phpunit-tests" id="markdown-toc-location-of-phpunit-tests">Location of PHPUnit Tests</a><li><a href="https://selwynpolit.github.io/d9book/dtt#output-files-from-running-phpunit" id="markdown-toc-output-files-from-running-phpunit">Output files from running phpunit</a><li><a href="https://selwynpolit.github.io/d9book/dtt#setup-phpunit-tests" id="markdown-toc-setup-phpunit-tests">Setup PHPUnit tests</a><li><a href="https://selwynpolit.github.io/d9book/dtt#running-phpunit-tests-in-the-ddev-container" id="markdown-toc-running-phpunit-tests-in-the-ddev-container">Running PHPUnit tests in the DDEV container</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#run-phpunit-test-in-ddev-from-the-host" id="markdown-toc-run-phpunit-test-in-ddev-from-the-host">Run PHPUnit test in DDEV from the host</a><li><a href="https://selwynpolit.github.io/d9book/dtt#run-phpunit-test-on-the-host" id="markdown-toc-run-phpunit-test-on-the-host">Run PHPUnit test on the host</a></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/dtt#generate-a-unit-test-with-drush" id="markdown-toc-generate-a-unit-test-with-drush">Generate a unit test with drush</a><li><a href="https://selwynpolit.github.io/d9book/dtt#my-first-phpunit-test" id="markdown-toc-my-first-phpunit-test">My first PHPUnit test</a><li><a href="https://selwynpolit.github.io/d9book/dtt#drupal-test-traits-overview" id="markdown-toc-drupal-test-traits-overview">Drupal Test Traits Overview</a><li><a href="https://selwynpolit.github.io/d9book/dtt#installsetup-drupal-test-traits" id="markdown-toc-installsetup-drupal-test-traits">Install/setup Drupal Test Traits</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#what-about-testing-browser-interaction" id="markdown-toc-what-about-testing-browser-interaction">What about testing browser interaction?</a></li></ul><li><a href="https://selwynpolit.github.io/d9book/dtt#my-first-dtt-tests" id="markdown-toc-my-first-dtt-tests">My first DTT tests</a><li><a href="https://selwynpolit.github.io/d9book/dtt#running-dtt-tests" id="markdown-toc-running-dtt-tests">Running DTT tests</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#run-tests-on-the-host" id="markdown-toc-run-tests-on-the-host">Run tests on the host</a><li><a href="https://selwynpolit.github.io/d9book/dtt#run-tests-in-a-specific-file" id="markdown-toc-run-tests-in-a-specific-file">Run tests in a specific file</a><li><a href="https://selwynpolit.github.io/d9book/dtt#run-a-specific-test-in-a-file" id="markdown-toc-run-a-specific-test-in-a-file">Run a specific test in a file</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/dtt#logging-test-output" id="markdown-toc-logging-test-output">Logging Test Output</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#capture-every-page-loaded" id="markdown-toc-capture-every-page-loaded">Capture every page loaded</a><li><a href="https://selwynpolit.github.io/d9book/dtt#capture-an-html-page" id="markdown-toc-capture-an-html-page">Capture an HTML page</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#example-of-capturing-a-page" id="markdown-toc-example-of-capturing-a-page">Example of capturing a page</a><li><a href="https://selwynpolit.github.io/d9book/dtt#screenshot-using-existingsiteselenium2drivertest" id="markdown-toc-screenshot-using-existingsiteselenium2drivertest">Screenshot using ExistingSiteSelenium2DriverTest</a></li></li></ul></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/dtt#writing-dtt-tests" id="markdown-toc-writing-dtt-tests">Writing DTT Tests</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#test-locations" id="markdown-toc-test-locations">Test locations</a><li><a href="https://selwynpolit.github.io/d9book/dtt#generate-dtt-tests-with-drush" id="markdown-toc-generate-dtt-tests-with-drush">Generate DTT tests with drush</a><li><a href="https://selwynpolit.github.io/d9book/dtt#example-tests" id="markdown-toc-example-tests">Example tests</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#exampletestphp-creating-user-term-article" id="markdown-toc-exampletestphp-creating-user-term-article">ExampleTest.php creating user term, article</a><li><a href="https://selwynpolit.github.io/d9book/dtt#votingpagetest" id="markdown-toc-votingpagetest">VotingPageTest</a><li><a href="https://selwynpolit.github.io/d9book/dtt#examplelogintestphp" id="markdown-toc-examplelogintestphp">ExampleLoginTest.php</a><li><a href="https://selwynpolit.github.io/d9book/dtt#selenium2drivertest" id="markdown-toc-selenium2drivertest">Selenium2DriverTest</a></li></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/dtt#login-to-your-site" id="markdown-toc-login-to-your-site">Login to your site</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#create-a-new-user-and-login-as-that-user" id="markdown-toc-create-a-new-user-and-login-as-that-user">Create a new user and login as that user:</a><li><a href="https://selwynpolit.github.io/d9book/dtt#create-an-admin-user" id="markdown-toc-create-an-admin-user">Create an admin user</a><li><a href="https://selwynpolit.github.io/d9book/dtt#login-as-an-existing-user" id="markdown-toc-login-as-an-existing-user">Login as an existing user</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/dtt#fill-out-a-form" id="markdown-toc-fill-out-a-form">Fill out a form</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#parameter-gotcha" id="markdown-toc-parameter-gotcha">Parameter gotcha</a></li></ul><li><a href="https://selwynpolit.github.io/d9book/dtt#data-provider" id="markdown-toc-data-provider">Data Provider</a><li><a href="https://selwynpolit.github.io/d9book/dtt#fill-a-queue-and-run-a-trait" id="markdown-toc-fill-a-queue-and-run-a-trait">Fill a queue and run a trait</a></li></li></li></li></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/dtt#mink" id="markdown-toc-mink">Mink</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#checking-page-return-code" id="markdown-toc-checking-page-return-code">Checking page return code</a><li><a href="https://selwynpolit.github.io/d9book/dtt#grab-the-text-from-the-page" id="markdown-toc-grab-the-text-from-the-page">Grab the text from the page</a><li><a href="https://selwynpolit.github.io/d9book/dtt#current-url" id="markdown-toc-current-url">Current URL</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/dtt#load-and-parse-a-csv-file" id="markdown-toc-load-and-parse-a-csv-file">Load and parse a CSV file</a><li><a href="https://selwynpolit.github.io/d9book/dtt#adding-dtt-to-an-existing-site" id="markdown-toc-adding-dtt-to-an-existing-site">Adding DTT to an existing site</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#install-dtt-and-dev-requirements-with" id="markdown-toc-install-dtt-and-dev-requirements-with">Install DTT and dev requirements with:</a><li><a href="https://selwynpolit.github.io/d9book/dtt#create-phpunitxml-file" id="markdown-toc-create-phpunitxml-file">Create phpunit.xml file</a><li><a href="https://selwynpolit.github.io/d9book/dtt#create-bootstrap-fastphp" id="markdown-toc-create-bootstrap-fastphp">Create bootstrap-fast.php</a><li><a href="https://selwynpolit.github.io/d9book/dtt#add-phpunitresultcache-file-to-gitignore" id="markdown-toc-add-phpunitresultcache-file-to-gitignore">Add .phpunit.result.cache file to .gitignore</a><li><a href="https://selwynpolit.github.io/d9book/dtt#remove-dtt-and-core-dev" id="markdown-toc-remove-dtt-and-core-dev">Remove DTT and core-dev</a><li><a href="https://selwynpolit.github.io/d9book/dtt#hide-deprecation-notices" id="markdown-toc-hide-deprecation-notices">Hide deprecation notices</a></li></li></li></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/dtt#troubleshooting-dtt-tests" id="markdown-toc-troubleshooting-dtt-tests">Troubleshooting DTT Tests</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#which-test" id="markdown-toc-which-test">Which test?</a><li><a href="https://selwynpolit.github.io/d9book/dtt#polyfillasserttrait-not-found" id="markdown-toc-polyfillasserttrait-not-found">PolyfillAssertTrait not found</a><li><a href="https://selwynpolit.github.io/d9book/dtt#class-not-found-errors" id="markdown-toc-class-not-found-errors">Class not found errors</a><li><a href="https://selwynpolit.github.io/d9book/dtt#var_dump-echo-print" id="markdown-toc-var_dump-echo-print">var_dump, echo, print</a></li></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/dtt#using-xdebug-and-phpstorm-to-debug-dtt-scripts" id="markdown-toc-using-xdebug-and-phpstorm-to-debug-dtt-scripts">Using Xdebug and PHPStorm to debug DTT scripts</a><li><a href="https://selwynpolit.github.io/d9book/dtt#resources" id="markdown-toc-resources">Resources</a><ul><li><a href="https://selwynpolit.github.io/d9book/dtt#general" id="markdown-toc-general">General</a><li><a href="https://selwynpolit.github.io/d9book/dtt#documentation" id="markdown-toc-documentation">Documentation</a><li><a href="https://selwynpolit.github.io/d9book/dtt#testing-setup" id="markdown-toc-testing-setup">Testing setup</a><li><a href="https://selwynpolit.github.io/d9book/dtt#mocking" id="markdown-toc-mocking">Mocking</a></li></li></li></li></ul></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><p><img alt="views" src="https://api.visitor.plantree.me/visitor-badge/pv?label=views&amp;color=informational&amp;namespace=d9book&amp;key=dtt.md"/></p><hr/><h2 id="overview"> <a aria-labelledby="overview" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#overview"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Overview</h2><p>Tests are written as PHP classes. These are executed in the terminal (or optionally from within PhpStorm). Each test consists of code with calls to various assert functions to test if an expected result matches an actual result. So if a function should return true, you will usually assertTrue($return_value) or if a unit returns 5, you will assertEquals(5, $return_value).</p><p>E.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">self</span><span class="o">::</span><span class="nf">assertTrue</span><span class="p">(</span><span class="nv">$return_value</span><span class="p">);</span>
</code></pre></div></div><p>from <a href="https://phpunit.readthedocs.io/en/9.5/writing-tests-for-phpunit.html">https://phpunit.readthedocs.io/en/9.5/writing-tests-for-phpunit.html</a></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> 
<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">use</span> <span class="nc">PHPUnit\Framework\TestCase</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">StackTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testPushAndPop</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$stack</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$stack</span><span class="p">));</span>

        <span class="nb">array_push</span><span class="p">(</span><span class="nv">$stack</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="nv">$stack</span><span class="p">[</span><span class="nb">count</span><span class="p">(</span><span class="nv">$stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$stack</span><span class="p">));</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$stack</span><span class="p">));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$stack</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>In a Drupal context, there are 4 types of tests. From <a href="https://www.drupal.org/docs/automated-testing/types-of-tests">https://www.drupal.org/docs/automated-testing/types-of-tests</a> :</p><ul><li><p>Unit: PHPUnit-based tests with minimal dependencies. Base class: Drupal\Tests\UnitTestCase class. They must be clean plain PHP.</p><li><p>Kernel: PHPUnit-based tests with a bootstrapped kernel, and a minimal number of extensions enabled. Base class: Drupal\KernelTests\KernelTestBase class. More at <a href="https://www.drupal.org/docs/automated-testing/phpunit-in-drupal/kerneltestbase">https://www.drupal.org/docs/automated-testing/phpunit-in-drupal/kerneltestbase</a></p><li><p>Functional: PHPUnit-based tests with a full booted Drupal instance. Base class: Drupal\Tests\BrowserTestBase.</p><li><p>FunctionalJavascript: PHPUnit-based tests that use Webdriver to perform tests of Javascript and Ajax functionality in the browser. Base class: Drupal\FunctionalJavascriptTests\WebDriverTestBase.</p></li></li></li></li></ul><p>In addition, the Drupal project has some tests for JavaScript, written in JavaScript, that use the <a href="https://www.drupal.org/docs/testing/javascript-testing-using-nightwatch">Nightwatch framework</a>.</p><p>Drupal Test Traits (DTT) adds 2 more types of tests:</p><ul><li><p>ExistingSite which use the Drupal API and existing site. Base class: weitzman\DrupalTestTraits\ExistingSiteBase</p><li><p>ExistingSiteJavascript for testing Javacript or AJAX using Selenium and Chromedriver. Base class: weitzman\DrupalTestTraits\ExistingSiteSelenium2DriverTestBase</p></li></li></ul><p>There are many examples of tests in core and contributed modules.</p><p>e.g. in docroot/modules/contrib/admin_toolbar/tests/src/Functional/ there are 3 functional tests: AdminToolbarAdminMenuTest.php, AdminToolbarAlterTest.php and AdminToolbarToolsSortTest.php</p><p>Every time a PHPUnit test is run, a fresh Drupal database and files are created. This guarantees that any existing data won't taint your test's outcomes. DTT bypasses this process and uses the existing site although it can clean up anything that is created in the test.</p><h1 id="location-of-phpunit-tests"> <a aria-labelledby="location-of-phpunit-tests" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#location-of-phpunit-tests"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Location of PHPUnit Tests</h1><p>Tests are always in the tests folder of modules. They are often in different folders e.g. tests/src/Unit, tests/src/Functional, tests/src/FunctionalJavascript</p><p>For core they are in web/core/modules (or docroot/core/modules) e.g. in the action module, the directory structure looks like this:</p><p><img alt="Phpunit Test Location" src="https://selwynpolit.github.io/d9book/assets/images/phpunit-test-location.png"/></p><h1 id="output-files-from-running-phpunit"> <a aria-labelledby="output-files-from-running-phpunit" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#output-files-from-running-phpunit"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Output files from running phpunit</h1><p>Depending on where you specified the output for your files in the phpunit.xml file e.g. in web/core/phpunit.xml I specified this path. Below you will see a bunch of directories (probably one for each run of the tests) in sites/simpletest/nnnnn</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Example BROWSERTEST_OUTPUT_DIRECTORY value: /path/to/webroot/sites/simpletest/browser_output --&gt;</span>
<span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"BROWSERTEST_OUTPUT_DIRECTORY"</span> <span class="na">value=</span><span class="s">"/var/www/html/simpletest/browser_output"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p><img alt="Test output location" src="https://selwynpolit.github.io/d9book/assets/images/test-output.png"/></p><p>If you don’t need to view the reports from your tests, you can safely delete these directories as well as the html files shown below.</p><p>At the same level is a browser_output directory which has some html files which reference the directories above:</p><p><img alt="Browser Ouput1" src="https://selwynpolit.github.io/d9book/assets/images/browser-output1.png"/></p><p>While tests are running, I noticed that files appear in the /simpletest/browser_output folder at the topmost level of the project. They go away when the tests complete..</p><p><img alt="Browser Output2" src="https://selwynpolit.github.io/d9book/assets/images/browser-output2.png"/></p><h1 id="setup-phpunit-tests"> <a aria-labelledby="setup-phpunit-tests" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#setup-phpunit-tests"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Setup PHPUnit tests</h1><p>Using Drupal version 9.4.5 let’s get PHPunit tests running inside the ddev containers (not on the host machine).</p><p>To get started with phpunit, follow instructions at <a href="https://www.drupal.org/docs/automated-testing/phpunit-in-drupal/running-phpunit-tests">https://www.drupal.org/docs/automated-testing/phpunit-in-drupal/running-phpunit-tests</a> (I updated this for ddev on 8-29-22)</p><p>Another useful reference is the web/core/tests/README.md that comes with Drupal.</p><p>If you installed using the drupal/recommended-project Composer template, development, you will need some dependencies which can be installed by requiring drupal/core-dev as a dependency in your project.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require drupal/core-dev --dev --update-with-all-dependencies
</code></pre></div></div><p>Install phpunit using:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require phpunit/phpunit
</code></pre></div></div><p>Also you might need prophecy for mocking:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require --dev phpspec/prophecy-phpunit:^2
</code></pre></div></div><p>You need a <code class="language-plaintext highlighter-rouge">web/core/phpunit.xml</code> so copy the one at <code class="language-plaintext highlighter-rouge">web/core/phpunit.xml.dist</code>.</p><p>Change the <code class="language-plaintext highlighter-rouge">SIMPLETEST_BASE_URL</code>, <code class="language-plaintext highlighter-rouge">SIMPLETEST_DB</code> AND <code class="language-plaintext highlighter-rouge">BROWSERTEST_OUTPUT_DIRECTORY</code> variables as shown below</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;php&gt;</span>
    <span class="c">&lt;!-- Set error reporting to E_ALL. --&gt;</span>
    <span class="nt">&lt;ini</span> <span class="na">name=</span><span class="s">"error_reporting"</span> <span class="na">value=</span><span class="s">"32767"</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- Do not limit the amount of memory tests take to run. --&gt;</span>
    <span class="nt">&lt;ini</span> <span class="na">name=</span><span class="s">"memory_limit"</span> <span class="na">value=</span><span class="s">"-1"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"SIMPLETEST_BASE_URL"</span> <span class="na">value=</span><span class="s">"http://localhost"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"SIMPLETEST_DB"</span> <span class="na">value=</span><span class="s">"mysql://db:db@db/db"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"BROWSERTEST_OUTPUT_DIRECTORY"</span> <span class="na">value=</span><span class="s">"/var/www/html/simpletest/browser_output"</span><span class="nt">/&gt;</span>

</code></pre></div></div><p>Refer to <a href="https://mglaman.dev/blog/running-drupals-phpunit-test-suites-ddev">https://mglaman.dev/blog/running-drupals-phpunit-test-suites-ddev</a> for more info on using ddev describe to get suitable values for those variables</p><p>From web/core/tests/README.md</p><p>Copy the core/phpunit.xml.dist file to phpunit.xml, and place it somewhere convenient (inside the core directory may not be the best spot, since that directory may be managed by Composer or Git). You can use the -c option on the command line to tell PHPUnit where this file is (use the full path).</p><p>Settings to change in this file:</p><ul><li><p><code class="language-plaintext highlighter-rouge">SIMPLETEST_BASE_URL</code>: The URL of your site</p><li><p><code class="language-plaintext highlighter-rouge">SIMPLETEST_DB</code>: The URL of your Drupal database</p><li><p>The<code class="language-plaintext highlighter-rouge"> bootstrap attribute</code> of the top-level phpunit tag, to take into account the location of the file</p><li><p><code class="language-plaintext highlighter-rouge">BROWSERTEST_OUTPUT_DIRECTORY</code>: Set to sites/simpletest/browser_output; you will also want to uncomment the printerClass attribute of the top-level phpunit tag.</p></li></li></li></li></ul><h1 id="running-phpunit-tests-in-the-ddev-container"> <a aria-labelledby="running-phpunit-tests-in-the-ddev-container" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#running-phpunit-tests-in-the-ddev-container"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Running PHPUnit tests in the DDEV container</h1><p>This will run the unit tests included with the action module</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ddev ssh
$ cd web
../vendor/bin/phpunit -c core core/modules/action
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">-c</code> is a reference to the phpunit configuration file called phpunit.xml.</p><p>Another example test you could run is the book module:</p><p>You could also run <code class="language-plaintext highlighter-rouge">../vendor/bin/phpunit -c core core/modules/book</code> for a different set of tests. These tests are for the book module and take a very LONG time. (~30 minutes)</p><p>When running the tests for the action module, you should see:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PHPUnit 9.5.23 #StandWithUkraine

Warning:       Your XML configuration validates against a deprecated schema.
Suggestion:    Migrate your XML configuration using "--migrate-configuration"!

Testing /var/www/html/web/core/modules/action
....S..                                                             
7 / 7 (100%)

Time: 03:25.204, Memory: 8.00 MB

OK, but incomplete, skipped, or risky tests!
Tests: 7, Assertions: 229, Skipped: 1.

HTML output was generated
http://localhost/sites/simpletest/browser_output/Drupal_Tests_action_Functional_ActionListTest-1-51362070.html
http://localhost/sites/simpletest/browser_output/Drupal_Tests_action_Functional_ActionListTest-2-51362070.html
http://localhost/sites/simpletest/browser_output/Drupal_Tests_action_Functional_ActionListTest-3-51362070.html
http://localhost/sites/simpletest/browser_output/Drupal_Tests_action_Functional_ActionListTest-4-51362070.html
http://localhost/sites/simpletest/browser_output/Drupal_Tests_action_Functional_ActionUninstallTest-1-80829434.html
</code></pre></div></div><p>Note in the output: .…S.., periods mean success, S means skipped, I means ignored, E means error.</p><p>You can choose to skip(S) or ignore(I) tests during development. This is done to speed up test runs or if you are mid-development and want to only run specific tests. Also these can be conditional such as when you only want a certain test to run if a condition is met e.g. a driver is present.</p><p>More details at https://phpunit.readthedocs.io/en/9.5/textui.html</p><h2 id="run-phpunit-test-in-ddev-from-the-host"> <a aria-labelledby="run-phpunit-test-in-ddev-from-the-host" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#run-phpunit-test-in-ddev-from-the-host"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Run PHPUnit test in DDEV from the host</h2><p>You can also run the test in the containers from the host with:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ddev exec ./vendor/bin/phpunit -c web/core web/core/modules/action
</code></pre></div></div><h2 id="run-phpunit-test-on-the-host"> <a aria-labelledby="run-phpunit-test-on-the-host" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#run-phpunit-test-on-the-host"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Run PHPUnit test on the host</h2><p>If you have installed PHP on your host computer, you should also be able to run Phpunit tests there with:</p><p>From the very top of the project:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vendor/bin/phpunit -c web/core web/core/modules/action
</code></pre></div></div><h1 id="generate-a-unit-test-with-drush"> <a aria-labelledby="generate-a-unit-test-with-drush" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#generate-a-unit-test-with-drush"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Generate a unit test with drush</h1><p>You can use drush to generate a module e.g. drush gen module. (Just follow the prompts). Once you have a module, use drush gen test:unit for your module. Note. You need drush 11 for this.</p><p>Here is a generated file at modules/custom/tea_teks_voting/tests/src/Unit/ExampleTest.php with the following contents. It does not contain a real test; just a shell of a test which can run.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\Tests\tea_teks_voting\Unit</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Tests\UnitTestCase</span><span class="p">;</span>

<span class="cd">/**
 * Test description.
 *
 * @group tea_teks_voting
 */</span>
<span class="kd">class</span> <span class="nc">ExampleTest</span> <span class="kd">extends</span> <span class="nc">UnitTestCase</span> <span class="p">{</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
    <span class="k">parent</span><span class="o">::</span><span class="nf">setUp</span><span class="p">();</span>
    <span class="c1">// @todo Mock required classes here.</span>
  <span class="p">}</span>

  <span class="cd">/**
   * Tests something.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">testSomething</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">assertTrue</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">,</span> <span class="s1">'This is TRUE!'</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><p>Drush wrote the test file in <code class="language-plaintext highlighter-rouge">modules/custom/tea_teks_voting/tests/src/Unit/ExampleTest.php</code></p><p><img alt="Generated test location" src="https://selwynpolit.github.io/d9book/assets/images/generated-test.png"/></p><p>To run this test use</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ drush ssh

selwyn@ddev92-web:/var/www/html \$ vendor/bin/phpunit -c web/core/
web/modules/custom/tea_teks_voting/
</code></pre></div></div><p>You should see the following output:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PHPUnit 9.5.23 #StandWithUkraine

Warning:       Your XML configuration validates against a deprecated schema.
Suggestion:    Migrate your XML configuration using "--migrate-configuration"!

Testing /var/www/html/web/modules/custom/tea_teks_voting
.                                                                   1 / 1 (100%)

Time: 00:00.058, Memory: 4.00 MB

OK (1 test, 1 assertion)
</code></pre></div></div><p>Note. It does expect the file web/core/phpunit.xml to exist and be configured correctly. See setup above for details.</p><h1 id="my-first-phpunit-test"> <a aria-labelledby="my-first-phpunit-test" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#my-first-phpunit-test"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> My first PHPUnit test</h1><p>This is my test of a class I wrote called Requirements. It does require some Drupal to be bootstrapped, so it can’t be a unit test. It must be a functional test and therefor in the <code class="language-plaintext highlighter-rouge">modules/custom/tea_teks_requirements/tests/src/Functional</code> directory.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\Tests\tea_teks_requirements\Unit</span><span class="p">;</span>

<span class="c1">//use PHPUnit\Framework\TestCase;</span>
<span class="kn">use</span> <span class="nc">Drupal\Tests\UnitTestCase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nf">Drupal\tea_teks_requirements</span><span class="nc">\Requirements</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">RequirementsTest</span> <span class="kd">extends</span> <span class="nc">UnitTestCase</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">testEmptyRequirements</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Requirements</span><span class="p">();</span>
    <span class="nv">$empty</span> <span class="o">=</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="nf">isEmpty</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertFalse</span><span class="p">(</span><span class="nv">$empty</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>The module must be enabled.</p><p>Copy web/core/phpunit.xml.dist to web/core/phpunit.xml</p><p>Edit the following lines of the file to look something like this:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"SIMPLETEST_BASE_URL"</span> <span class="na">value=</span><span class="s">"http://localhost"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"SIMPLETEST_DB"</span> <span class="na">value=</span><span class="s">"mysql://db:db@db/db"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"BROWSERTEST_OUTPUT_DIRECTORY"</span> <span class="na">value=</span><span class="s">"/var/www/html/simpletest/browser_output"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p>Run the test with</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ddev ssh

$ cd web

$ ../vendor/bin/phpunit -c core modules/custom/tea_teks_voting
</code></pre></div></div><p>You will see this output:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PHPUnit 9.5.23 #StandWithUkraine

Warning:       Your XML configuration validates against a deprecated schema.
Suggestion:    Migrate your XML configuration using "--migrate-configuration"!

Testing /var/www/html/web/modules/custom/tea_teks_voting
.                                                                   
1 / 1 (100%)

Time: 00:00.055, Memory: 4.00 MB

OK (1 test, 1 assertion)
</code></pre></div></div><p>Note. The OK means it worked.</p><h1 id="drupal-test-traits-overview"> <a aria-labelledby="drupal-test-traits-overview" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#drupal-test-traits-overview"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Drupal Test Traits Overview</h1><p>Drupal Test Traits is for testing Drupal sites that have content (versus Phpunit tests which start Drupal up, create an empty database and are consequently slower).</p><p>From <a href="https://gitlab.com/weitzman/drupal-test-traits">https://gitlab.com/weitzman/drupal-test-traits</a>:</p><blockquote><p><a href="http://behat.org">Behat</a> is great for facilitating conversations between business managers and developers. Those are useful conversations, but many organizations simply can't or won't converse via Gherkin. When you are on the hook for product quality and not conversations, this is a testing approach for you.</p><p>Before Drupal Test Traits, this framework was impossible to use without wiping the site’s database after each test. DTT lets you keep your database and still test using the features of Drupal’s BrowserTestBase and friends. See <a href="https://gitlab.com/weitzman/drupal-test-traits/blob/1.0.0-beta.1/src/DrupalTrait.php#L44-83">DrupalTrait::setUp()</a> for details (the bootstrap is inspired by <a href="https://www.drush.org/">Drush</a>).</p></blockquote><ul><li>Blog: [Introducing Drupal Test<blockquote><p>Traits](https://medium.com/massgovdigital/introducing-drupal-test-traits-9fe09e84384c)</p></blockquote><li>Blog: [Introducing Drupal Test Traits: Drupal extension for testing<blockquote><p>existing sites](https://www.previousnext.com.au/blog/introducing-drupal-testing-traits-drupal-extension-testing-existing-sites)</p></blockquote><li>Video: [Drupalcon presentation - Introducing Drupal Test<blockquote><p>Traits](https://www.tag1consulting.com/blog/introducing-drupal-test-traits).</p></blockquote><li>Repo: <a href="https://gitlab.com/weitzman/drupal-test-traits">https://gitlab.com/weitzman/drupal-test-traits</a></li></li></li></li></ul><blockquote><p>DTT also supports <a href="https://gitlab.com/weitzman/drupal-test-traits/blob/master/tests/ExampleSelenium2DriverTest.php">testing through a real browser using headless Chrome</a> or Selenium. So, testing client-side interactions like autocomplete, #states, viewports, and drag/drop is easy.</p><p>Like Drupal core, <a href="https://gitlab.com/weitzman/drupal-test-traits#debugging-tests">DTT can save HTML snapshots for each URL that it navigates to</a>. These files are very useful when debugging test failures.</p></blockquote><h1 id="installsetup-drupal-test-traits"> <a aria-labelledby="installsetup-drupal-test-traits" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#installsetup-drupal-test-traits"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Install/setup Drupal Test Traits</h1><p>TLDR; You will need Drupal test traits installed with composer, possibly <code class="language-plaintext highlighter-rouge">drupal/core-dev</code> (also a composer install), a <code class="language-plaintext highlighter-rouge">/phpunit.xml</code> file, and a <code class="language-plaintext highlighter-rouge">/scripts/bootstrap-fast.php</code>. Add <code class="language-plaintext highlighter-rouge">weitzman/logintrait</code> with composer for adding users and logging in to your site. Finally for AJAX testing add a <code class="language-plaintext highlighter-rouge">docker-compose.testing.yaml</code> and using composer add <code class="language-plaintext highlighter-rouge">behat/mink-selenium2-driver</code>.</p><p>The details are as follows:</p><ol><li>Install DTT. At the time of this writing the 1.6 version was out but there is a 2.x dev branch. Moshe recommends using that so use the following command to install it:</li></ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require --dev weitzman/drupal-test-traits:^2
</code></pre></div></div><ol><li>Install the dev requirements with:</li></ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require drupal/core-dev --dev --update-with-all-dependencies
</code></pre></div></div><p>If you skip the <code class="language-plaintext highlighter-rouge">drupal/core-dev</code> step, you will see errors when you try to run the tests like this:</p><blockquote><p>selwyn@tea3-web:/var/www/html$ ./vendor/bin/phpunit --bootstrap=./vendor/weitzman/drupal-test-traits/src/bootstrap-fast.php ./docroot/modules/custom/tea_teks/modules/tea_teks_requirements/tests/src/ExistingSite/RequirementsCreationTest.php</p><p>PHP Fatal error: Trait "Symfony\Bridge\PhpUnit\Legacy\PolyfillAssertTrait" not found in /var/www/html/docroot/sites/simpletest/Assert.php on line 91</p><p>Fatal error: Trait "Symfony\Bridge\PhpUnit\Legacy\PolyfillAssertTrait" not found in /var/www/html/docroot/sites/simpletest/Assert.php on line 91</p></blockquote><ol><li><p>Create a <code class="language-plaintext highlighter-rouge">phpunit.xml</code> file. I put <code class="language-plaintext highlighter-rouge">phpunit.xml</code> in the root of the project (not docroot or web.) See example file contents below.</p><li><p>Create a <code class="language-plaintext highlighter-rouge">bootstrap-fast.php</code>. I put <code class="language-plaintext highlighter-rouge">bootstrap-fast.php</code> in the /scripts (also in the root of the project). This file is included in DTT at <code class="language-plaintext highlighter-rouge">vendor/weitzman/drupal-test-traits/src/bootstrap-fast.php</code>.</p><li><p>Add a .ddev/docker-compose.testing.yaml (don’t accidentally type docker-compose<strong>R</strong> as Ddev won't create that container and you'll be left puzzled.</p><li><p>Install the mink-selenium2 driver with:\</p></li></li></li></li></ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require 'behat/mink-selenium2-driver' --dev
</code></pre></div></div><ol><li>Install login traits with:</li></ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require weitzman/logintrait
</code></pre></div></div><p>Here are the <code class="language-plaintext highlighter-rouge">/phpunit.xml</code> file contents. Note the location of the <code class="language-plaintext highlighter-rouge">bootstrap-fast.php</code>:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="c">&lt;!-- Copy the samples below into your own phpunit.xml file.--&gt;</span>

<span class="c">&lt;!-- Using this project's bootstrap file allows tests in `ExistingSite`,
    `ExistingSiteSelenium2DriverTest`, and `ExistingSiteWebDriverTest`
     to run alongside core's test types. --&gt;</span>

<span class="c">&lt;!-- If you use the default `bootstrap-fast.php` and get 'class not
     found' errors while running tests, head over to
     https://gitlab.com/weitzman/drupal-test-traits/-/blob/master/src/bootstrap-fast.php
     for explanation on how to register those classes.
--&gt;</span>
<span class="c">&lt;!--&lt;phpunit bootstrap="vendor/weitzman/drupal-test-traits/src/bootstrap-fast.php"&gt;--&gt;</span>
<span class="nt">&lt;phpunit</span> <span class="na">bootstrap=</span><span class="s">"scripts/bootstrap-fast.php"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;php&gt;</span>
<span class="c">&lt;!--    &lt;env name="DTT_BASE_URL" value="https://ddev92.ddev.site"/&gt;--&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_BASE_URL"</span> <span class="na">value=</span><span class="s">"http://localhost"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_API_URL"</span> <span class="na">value=</span><span class="s">"http://localhost:9222"</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- &lt;env name="DTT_MINK_DRIVER_ARGS" value='["chrome", { "chromeOptions" : { "w3c": false } }, "http://localhost:4444/wd/hub"]'/&gt; --&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_MINK_DRIVER_ARGS"</span> <span class="na">value=</span><span class="s">'["firefox", null, "http://localhost:4444/wd/hub"]'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_API_OPTIONS"</span> <span class="na">value=</span><span class="s">'{"socketTimeout": 360, "domWaitTimeout": 3600000}'</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- Example BROWSERTEST_OUTPUT_DIRECTORY value: /tmp
         Specify a temporary directory for storing debug images and html documents.
         These artifacts get copied to /sites/simpletest/browser_output by BrowserTestBase. --&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"BROWSERTEST_OUTPUT_DIRECTORY"</span> <span class="na">value=</span><span class="s">""</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- To disable deprecation testing completely uncomment the next line. --&gt;</span>
    <span class="c">&lt;!--&lt;env name="SYMFONY_DEPRECATIONS_HELPER" value="disabled"/&gt;--&gt;</span>
    <span class="c">&lt;!-- Specify the default directory screenshots should be placed. --&gt;</span>
    <span class="c">&lt;!--&lt;env name="DTT_SCREENSHOT_REPORT_DIRECTORY" value=""/&gt;--&gt;</span>
    <span class="c">&lt;!-- Specify the default directory page captures should be placed.
        When using the \Drupal\Tests\Listeners\HtmlOutputPrinter printerClass this will default to
        /sites/simpletest/browser_output. If using another printer such as teamcity this must be defined.
        --&gt;</span>
    <span class="c">&lt;!--&lt;env name="DTT_HTML_OUTPUT_DIRECTORY" value=""/&gt;--&gt;</span>
  <span class="nt">&lt;/php&gt;</span>

  <span class="nt">&lt;testsuites&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"unit"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;directory&gt;</span>./web/modules/custom/*/tests/src/Unit<span class="nt">&lt;/directory&gt;</span>
      <span class="c">&lt;!--&lt;directory&gt;./web/profiles/custom/*/tests/src/Unit&lt;/directory&gt;--&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"kernel"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;directory&gt;</span>./web/modules/custom/*/tests/src/Kernel<span class="nt">&lt;/directory&gt;</span>
      <span class="c">&lt;!--&lt;directory&gt;./web/profiles/custom/*/tests/src/Kernel&lt;/directory&gt;--&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"existing-site"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- Assumes tests are namespaced as \Drupal\Tests\custom_foo\ExistingSite. --&gt;</span>
      <span class="nt">&lt;directory&gt;</span>./web/modules/custom/*/tests/src/ExistingSite<span class="nt">&lt;/directory&gt;</span>
      <span class="c">&lt;!--&lt;directory&gt;./web/profiles/custom/*/tests/src/ExistingSite&lt;/directory&gt;--&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"existing-site-javascript"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- Assumes tests are namespaced as \Drupal\Tests\custom_foo\ExistingSiteJavascript. --&gt;</span>
      <span class="nt">&lt;directory&gt;</span>./web/modules/custom/*/tests/src/ExistingSiteJavascript<span class="nt">&lt;/directory&gt;</span>
      <span class="c">&lt;!--&lt;directory&gt;./web/profiles/custom/*/tests/src/ExistingSiteJavascript&lt;/directory&gt;--&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
  <span class="nt">&lt;/testsuites&gt;</span>
<span class="nt">&lt;/phpunit&gt;</span>
</code></pre></div></div><p>Here are the /scripts/bootstrap-fast.php contents from vendor/weitzman/drupal-test-traits/src/bootstrap-fast.php:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="cd">/**
 * @file
 *   A bootstrap file for `phpunit` test runner.
 *
 * This bootstrap file from DTT is fast and customizable.
 *
 * If you get 'class not found' errors while running tests, you should copy this
 * file to a location inside your code-base --such as `/scripts`. Then add the
 * missing namespaces to the bottom of the copied field. Specify your custom
 * `bootstrap-fast.php` file as the bootstrap in `phpunit.xml`.
 *
 * Alternatively, use the bootstrap.php file, in this same directory, which is
 * slower but registers all the namespaces that Drupal tests expect.
 */</span>

<span class="kn">use</span> <span class="nc">Drupal\TestTools\PhpUnitCompatibility\PhpUnit8\ClassWriter</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">weitzman\DrupalTestTraits\AddPsr4</span><span class="p">;</span>

<span class="k">list</span><span class="p">(</span><span class="nv">$finder</span><span class="p">,</span> <span class="nv">$class_loader</span><span class="p">)</span> <span class="o">=</span> <span class="nc">AddPsr4</span><span class="o">::</span><span class="nf">add</span><span class="p">();</span>
<span class="nv">$root</span> <span class="o">=</span> <span class="nv">$finder</span><span class="o">-&gt;</span><span class="nf">getDrupalRoot</span><span class="p">();</span>

<span class="c1">// So that test cases may be simultaneously compatible with multiple major versions of PHPUnit.</span>
<span class="nv">$class_loader</span><span class="o">-&gt;</span><span class="nf">addPsr4</span><span class="p">(</span><span class="s1">'Drupal\TestTools\\'</span><span class="p">,</span> <span class="s2">"</span><span class="nv">$root</span><span class="s2">/core/tests"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">class_exists</span><span class="p">(</span><span class="s1">'Drupal\TestTools\PhpUnitCompatibility\PhpUnit8\ClassWriter'</span><span class="p">))</span> <span class="p">{</span>
  <span class="nc">ClassWriter</span><span class="o">::</span><span class="nf">mutateTestBase</span><span class="p">(</span><span class="nv">$class_loader</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Register more namespaces, as needed.</span>
<span class="c1"># $class_loader-&gt;addPsr4('Drupal\Tests\my_module\\', "$root/modules/custom/my_module/tests/src");</span>
</code></pre></div></div><p>Here is the docker-compose.testing.yaml from <a href="https://www.drupal.org/u/mstrelan">Michael Strelan on drupal.org</a>. Once you add this and restart DDEV, you will be able to do AJAX and Javascript testing of DTT tests. Note this is a “just works” situation as Michael puts it. Note that if you have this file in place, you don’t need to provide all the <code class="language-plaintext highlighter-rouge">env</code> values in the <code class="language-plaintext highlighter-rouge">phpunit.xml</code> above.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.6'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">links</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">chromedriver:$DDEV_HOSTNAME</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">SYMFONY_DEPRECATIONS_HELPER</span><span class="pi">:</span> <span class="s">weak</span>
      <span class="na">SIMPLETEST_DB_MYSQL</span><span class="pi">:</span> <span class="nl">&amp;simpletest_db_mysql</span> <span class="s">mysql://db:db@db:3306/db</span>
      <span class="na">SIMPLETEST_DB_SQLITE</span><span class="pi">:</span> <span class="nl">&amp;simpletest_db_sqlite</span> <span class="s">sqlite://tmp/sites/simpletest/simpletest.db</span>
      <span class="na">SIMPLETEST_DB</span><span class="pi">:</span> <span class="nv">*simpletest_db_sqlite</span>
      <span class="na">SIMPLETEST_BASE_URL</span><span class="pi">:</span> <span class="nl">&amp;base_url</span> <span class="s">http://${DDEV_HOSTNAME}</span>
      <span class="na">MINK_DRIVER_ARGS_WEBDRIVER</span><span class="pi">:</span> <span class="nl">&amp;mink_driver_args</span> <span class="s1">'</span><span class="s">["chrome",</span><span class="nv"> </span><span class="s">{"browserName":"chrome","goog:chromeOptions":{"args":["--disable-gpu","--headless",</span><span class="nv"> </span><span class="s">"--no-sandbox",</span><span class="nv"> </span><span class="s">"--disable-dev-shm-usage"],</span><span class="nv"> </span><span class="s">"w3c":</span><span class="nv"> </span><span class="s">false}},</span><span class="nv"> </span><span class="s">"http://chromedriver:9515"]'</span>
      <span class="na">BROWSERTEST_OUTPUT_DIRECTORY</span><span class="pi">:</span> <span class="s">/var/www/html/web/sites/simpletest/browser_output</span>
      <span class="na">BROWSERTEST_OUTPUT_BASE_URL</span><span class="pi">:</span> <span class="s">${DDEV_PRIMARY_URL}</span>
      <span class="na">DTT_BASE_URL</span><span class="pi">:</span> <span class="nv">*base_url</span>
      <span class="na">DTT_MINK_DRIVER_ARGS</span><span class="pi">:</span> <span class="nv">*mink_driver_args</span>

  <span class="na">chromedriver</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span>  <span class="s">drupalci/webdriver-chromedriver:production</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">ddev-${DDEV_SITENAME}-chromedriver</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">com.ddev.site-name</span><span class="pi">:</span> <span class="s">${DDEV_SITENAME}</span>
      <span class="na">com.ddev.approot</span><span class="pi">:</span> <span class="s">$DDEV_APPROOT</span>
    <span class="na">external_links</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">ddev-router:${DDEV_SITENAME}.${DDEV_TLD}</span>
    <span class="na">networks</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">default</span><span class="pi">,</span> <span class="nv">ddev_default</span><span class="pi">]</span>
</code></pre></div></div><h2 id="what-about-testing-browser-interaction"> <a aria-labelledby="what-about-testing-browser-interaction" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#what-about-testing-browser-interaction"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> What about testing browser interaction?</h2><p>Without the docker-compose.testing.yaml, you can only run the most basic DTT tests such as <a href="https://gitlab.com/weitzman/drupal-test-traits/-/blob/master/tests/ExampleTest.php">ExampleTest.php</a>.</p><p>The lack of a headless Chrome container, will cause the <a href="https://gitlab.com/weitzman/drupal-test-traits/-/blob/master/tests/ExampleWebDriverTest.php">ExampleWebDriverTest</a>.php and <a href="https://gitlab.com/weitzman/drupal-test-traits/blob/master/tests/ExampleSelenium2DriverTest.php">ExampleSeleniumDriverTest.php</a> to fail with errors like this when you try to run tests:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error: Class "DMore\ChromeDriver\ChromeDriver\" not found
</code></pre></div></div><p>Using <code class="language-plaintext highlighter-rouge">behat/mink-selenium2-driver</code>, you can run DTT against Chrome, Firefox or Edge (in WebDriver mode.) This setup also allows us to run Drupal core JS testing using Nightwatch. Although DTT supports browser testing using headless Chrome or Selenium. This facility is deprecated.</p><p>From <a href="https://gitlab.com/weitzman/drupal-test-traits">https://gitlab.com/weitzman/drupal-test-traits</a>:</p><blockquote><p>(deprecated) <strong>ExistingSiteWebDriverTest</strong>. See <a href="file:////weitzman/drupal-test-traits/-/blob/master/tests/ExampleWebDriverTest.php">ExampleWebDriverTest.php</a>. These tests make use of a headless Chrome browser but using <a href="https://packagist.org/packages/dmore/chrome-mink-driver">Chrome's Debugger Protocol</a>. They are suited to testing Ajax and similar client side interactions. These tests run slower than ExistingSite. To use this test type you need to composer require 'dmore/chrome-mink-driver' --dev. Tests of this type should be placed in tests/src/ExistingSiteJavascript. Contrary to its name, this test type does not use the WebDriver protocol at all.</p></blockquote><h1 id="my-first-dtt-tests"> <a aria-labelledby="my-first-dtt-tests" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#my-first-dtt-tests"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> My first DTT tests</h1><p>Tests must be in the ExistingSite directory and be namespaced as <code class="language-plaintext highlighter-rouge">Drupal\Tests\module_name\ExistingSite</code>.</p><p>Create <code class="language-plaintext highlighter-rouge">modules/custom/tea_teks_requirements/tests/src/ExistingSite/RequirementsCreationTest.php</code> with the following contents. This has 2 tests. Notice that we can use Drupal API calls just like when we write modules. This test is provided as an example of a simple test so you can see what they look like in real life.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\Tests\tea_teks_requirements\ExistingSite</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\node\Entity\Node</span><span class="p">;</span>
<span class="kn">use</span> <span class="nf">Drupal\tea_teks_requirements</span><span class="nc">\Requirements</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">weitzman\DrupalTestTraits\ExistingSiteBase</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">RequirementsCreationTest</span> <span class="kd">extends</span> <span class="nc">ExistingSiteBase</span> <span class="p">{</span>


  <span class="k">public</span> <span class="k">function</span> <span class="n">testEmptyRequirements</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Requirements</span><span class="p">();</span>
    <span class="nv">$empty</span> <span class="o">=</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="nf">isEmpty</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertTrue</span><span class="p">(</span><span class="nv">$empty</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">testLoadingRequirementsFromStandard</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$teks_standard_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
    <span class="nv">$r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Requirements</span><span class="p">(</span><span class="nv">$teks_standard_node</span><span class="p">);</span>
    <span class="nv">$empty</span> <span class="o">=</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="nf">isEmpty</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertFalse</span><span class="p">(</span><span class="nv">$empty</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><p>Run it with:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ddev ssh

$ vendor/bin/phpunit --bootstrap=./vendor/weitzman/drupal-test-traits/src/bootstrap-fast.php ./web/modules/custom/tea_teks_requirements/tests/src/ExistingSite/RequirementsCreationTest.php
</code></pre></div></div><p>The output looks something like this:</p><blockquote><p>PHPUnit 9.5.23 #StandWithUkraine</p><p>.. 2 / 2 (100%)</p><p>Time: 00:01.338, Memory: 16.00 MB</p><p>OK (2 tests, 2 assertions)</p></blockquote><p>Along with a boatload of deprecation notices. (Note. we can hide these with <code class="language-plaintext highlighter-rouge">&lt;env name="SYMFONY_DEPRECATIONS_HELPER" value="disabled"/&gt;</code> in the <code class="language-plaintext highlighter-rouge">&lt;php&gt;</code> section of the <code class="language-plaintext highlighter-rouge">phpunit.xml</code> file):</p><blockquote><p>Remaining direct deprecation notices (3)</p><p>1x: The "Symfony\Component\HttpFoundation\File\MimeType\MimeTypeGuesser" class is deprecated since Symfony 4.3, use "Symfony\Component\Mime\MimeTypes" instead.</p><p>1x in RequirementsCreationTest::setUp from Drupal\Tests\tea_teks_requirements\ExistingSite</p><p>1x: The "Symfony\Component\HttpFoundation\File\MimeType\FileBinaryMimeTypeGuesser" class is deprecated since Symfony 4.3, use "Symfony\Component\Mime\FileBinaryMimeTypeGuesser" instead.</p><p>1x in RequirementsCreationTest::setUp from Drupal\Tests\tea_teks_requirements\ExistingSite</p><p>1x: The "Symfony\Component\HttpFoundation\File\MimeType\FileinfoMimeTypeGuesser" class is deprecated since Symfony 4.3, use "Symfony\Component\Mime\FileinfoMimeTypeGuesser" instead.</p><p>1x in RequirementsCreationTest::setUp from Drupal\Tests\tea_teks_requirements\ExistingSite</p><p>Remaining indirect deprecation notices (2)</p><p>1x: Return type of GuzzleHttp\Cookie\CookieJar::count() should either be compatible with Countable::count(): int, or the #[\ReturnTypeWillChange] attribute should be used to temporarily suppress the notice</p><p>1x in RequirementsCreationTest::setUp from Drupal\Tests\tea_teks_requirements\ExistingSite</p><p>1x: Return type of GuzzleHttp\Cookie\CookieJar::getIterator() should either be compatible with IteratorAggregate::getIterator(): Traversable, or the #[\ReturnTypeWillChange] attribute should be used to temporarily suppress the notice</p><p>1x in RequirementsCreationTest::setUp from Drupal\Tests\tea_teks_requirements\ExistingSite</p></blockquote><h1 id="running-dtt-tests"> <a aria-labelledby="running-dtt-tests" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#running-dtt-tests"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Running DTT tests</h1><p>To run all the tests in the <code class="language-plaintext highlighter-rouge">modules/custom/tea_teks_requirements</code> directory, use the following:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ddev ssh

$ vendor/bin/phpunit --bootstrap=./vendor/weitzman/drupal-test-traits/src/bootstrap-fast.php modules/custom/tea_teks_requirements
</code></pre></div></div><p>The output for a successful run looks like this:</p><blockquote><p>PHPUnit 9.5.23 #StandWithUkraine</p><p>. 1 / 1 (100%)</p><p>Time: 00:07.798, Memory: 20.00 MB</p><p>OK (1 test, 7 assertions)</p></blockquote><p>Along with a boatload of deprecation notices. (Note. we can hide these with <code class="language-plaintext highlighter-rouge">&lt;env name="SYMFONY_DEPRECATIONS_HELPER" value="disabled"/&gt;</code> in the <code class="language-plaintext highlighter-rouge">&lt;php&gt;</code> section of the <code class="language-plaintext highlighter-rouge">phpunit.xml</code> file)</p><blockquote><p>Remaining direct deprecation notices (3)</p><p>1x: The "Symfony\Component\HttpFoundation\File\MimeType\MimeTypeGuesser" class is deprecated since Symfony 4.3, use "Symfony\Component\Mime\MimeTypes" instead.</p><p>1x in ExampleTest::setUp from Drupal\Tests\tea_teks_requirements\ExistingSite</p><p>1x: The "Symfony\Component\HttpFoundation\File\MimeType\FileBinaryMimeTypeGuesser" class is deprecated since Symfony 4.3, use "Symfony\Component\Mime\FileBinaryMimeTypeGuesser" instead.</p><p>1x in ExampleTest::setUp from Drupal\Tests\tea_teks_requirements\ExistingSite</p><p>1x: The "Symfony\Component\HttpFoundation\File\MimeType\FileinfoMimeTypeGuesser" class is deprecated since Symfony 4.3, use "Symfony\Component\Mime\FileinfoMimeTypeGuesser" instead.</p><p>1x in ExampleTest::setUp from Drupal\Tests\tea_teks_requirements\ExistingSite</p><p>Remaining indirect deprecation notices (3)</p><p>1x: Return type of GuzzleHttp\Cookie\CookieJar::count() should either be compatible with Countable::count(): int, or the #[\ReturnTypeWillChange] attribute should be used to temporarily suppress the notice</p><p>1x in ExampleTest::setUp from Drupal\Tests\tea_teks_requirements\ExistingSite</p><p>1x: Return type of GuzzleHttp\Cookie\CookieJar::getIterator() should either be compatible with IteratorAggregate::getIterator(): Traversable, or the #[\ReturnTypeWillChange] attribute should be used to temporarily suppress the notice</p><p>1x in ExampleTest::setUp from Drupal\Tests\tea_teks_requirements\ExistingSite</p><p>1x: "Symfony\Component\DomCrawler\Crawler::text()" will normalize whitespaces by default in Symfony 5.0, set the second "$normalizeWhitespace" argument to false to retrieve the non-normalized version of the text.</p><p>1x in ExampleTest::testLlama from Drupal\Tests\tea_teks_requirements\ExistingSite</p></blockquote><p>Once you’ve set up your <code class="language-plaintext highlighter-rouge">bootstrap-fast.php</code> file in <code class="language-plaintext highlighter-rouge">/scripts</code>, you can specify it in the <code class="language-plaintext highlighter-rouge">phpunit.xml</code> as</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;phpunit</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"http://schema.phpunit.de/4.1/phpunit.xsd"</span>
         <span class="na">backupGlobals=</span><span class="s">"false"</span>
         <span class="na">colors=</span><span class="s">"true"</span>
         <span class="na">bootstrap=</span><span class="s">"scripts/bootstrap-fast.php"</span>
         <span class="na">verbose=</span><span class="s">"true"</span>
        <span class="nt">&gt;</span>
</code></pre></div></div><p>Then you don’t need to pass it as a parameter. So running the test can look like this. Note no more reference to <code class="language-plaintext highlighter-rouge">--bootstrap</code> on the command line:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phpunit ./docroot/modules/custom/tea_teks/modules/tea_teks_voting/Tests/src/ExistingSite/RequirementsCreationTest.php
</code></pre></div></div><p>Or more simply:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vendor/bin/phpunit  docroot/modules/custom/tea_teks/modules/tea_teks_voting/Tests/src/ExistingSite/RequirementsCreationTest.php
</code></pre></div></div><p>Also note you can specify the <code class="language-plaintext highlighter-rouge">phpunit.xml</code> file with -c parameter.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./vendor/bin/phpunit -c ./phpunit.xml  ./docroot/modules/custom/tea_teks/modules/tea_teks_voting/Tests/src/ExistingSite/RequirementsCreationTest.php
</code></pre></div></div><h2 id="run-tests-on-the-host"> <a aria-labelledby="run-tests-on-the-host" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#run-tests-on-the-host"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Run tests on the host</h2><p>You can use the same commands that you run in the DDEV containers if you have php 8.1 installed and running. They will run faster on the host. e.g.:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vendor/bin/phpunit docroot/modules/custom/tea_teks/modules/tea_teks_voting/tests/src/ExistingSite/TeamTest.php
</code></pre></div></div><p>Note. You can specify the location of <code class="language-plaintext highlighter-rouge">bootstrap-fast.php</code> in your <code class="language-plaintext highlighter-rouge">/phpunit.xml</code>. This file is found at <code class="language-plaintext highlighter-rouge">vendor/weitzman/drupal-test-traits/src/bootstrap-fast.php</code>. Here a copy of <code class="language-plaintext highlighter-rouge">bootstrap-fast.php</code> is in the <code class="language-plaintext highlighter-rouge">/scripts</code> directory:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="nt">&lt;phpunit</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"http://schema.phpunit.de/4.1/phpunit.xsd"</span>
         <span class="na">backupGlobals=</span><span class="s">"false"</span>
         <span class="na">colors=</span><span class="s">"true"</span>
         <span class="na">bootstrap=</span><span class="s">"scripts/bootstrap-fast.php"</span>
         <span class="na">verbose=</span><span class="s">"true"</span>
        <span class="nt">&gt;</span>
</code></pre></div></div><p>The source for bootstrap-fast.php is:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="cd">/**
 * @file
 *   A bootstrap file for `phpunit` test runner.
 *
 * This bootstrap file from DTT is fast and customizable.
 *
 * If you get 'class not found' errors while running tests, you should copy this
 * file to a location inside your code-base --such as `/scripts`. Then add the
 * missing namespaces to the bottom of the copied field. Specify your custom
 * `bootstrap-fast.php` file as the bootstrap in `phpunit.xml`.
 *
 * Alternatively, use the bootstrap.php file, in this same directory, which is
 * slower but registers all the namespaces that Drupal tests expect.
 */</span>

<span class="kn">use</span> <span class="nc">Drupal\TestTools\PhpUnitCompatibility\PhpUnit8\ClassWriter</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">weitzman\DrupalTestTraits\AddPsr4</span><span class="p">;</span>

<span class="k">list</span><span class="p">(</span><span class="nv">$finder</span><span class="p">,</span> <span class="nv">$class_loader</span><span class="p">)</span> <span class="o">=</span> <span class="nc">AddPsr4</span><span class="o">::</span><span class="nf">add</span><span class="p">();</span>
<span class="nv">$root</span> <span class="o">=</span> <span class="nv">$finder</span><span class="o">-&gt;</span><span class="nf">getDrupalRoot</span><span class="p">();</span>

<span class="c1">// So that test cases may be simultaneously compatible with multiple major versions of PHPUnit.</span>
<span class="nv">$class_loader</span><span class="o">-&gt;</span><span class="nf">addPsr4</span><span class="p">(</span><span class="s1">'Drupal\TestTools\\'</span><span class="p">,</span> <span class="s2">"</span><span class="nv">$root</span><span class="s2">/core/tests"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">class_exists</span><span class="p">(</span><span class="s1">'Drupal\TestTools\PhpUnitCompatibility\PhpUnit8\ClassWriter'</span><span class="p">))</span> <span class="p">{</span>
  <span class="nc">ClassWriter</span><span class="o">::</span><span class="nf">mutateTestBase</span><span class="p">(</span><span class="nv">$class_loader</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Register more namespaces, as needed.</span>
<span class="c1"># $class_loader-&gt;addPsr4('Drupal\Tests\my_module\\', "$root/modules/custom/my_module/tests/src");</span>
</code></pre></div></div><h2 id="run-tests-in-a-specific-file"> <a aria-labelledby="run-tests-in-a-specific-file" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#run-tests-in-a-specific-file"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Run tests in a specific file</h2><p>You can be specific and only run all tests in a particular test file e.g.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vendor/bin/phpunit web/modules/custom/tea_teks_requirements/tests/src/ExistingSite/ExampleTest.php
</code></pre></div></div><p>Here is an example where the location of the bootstrap file is specified with --bootstrap:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./vendor/bin/phpunit --bootstrap=./vendor/weitzman/drupal-test-traits/src/bootstrap-fast.php ./web/modules/custom/tea_teks_requirements/tests/src/ExistingSite/ExampleTest.php
</code></pre></div></div><h2 id="run-a-specific-test-in-a-file"> <a aria-labelledby="run-a-specific-test-in-a-file" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#run-a-specific-test-in-a-file"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Run a specific test in a file</h2><p>You can run a test that is called ‘testVoter1Vote’ in the VotingPageTest.php file with the following command. Note. If you have another test that starts with testVoter1Vote e.g. testVoter1VoteBlah, that test will be run also.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vendor/bin/phpunit --filter testVoter1Vote docroot/modules/custom/tea_teks/modules/tea_teks_voting/tests/src/ExistingSite/VotingPageTest.php
</code></pre></div></div><h1 id="logging-test-output"> <a aria-labelledby="logging-test-output" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#logging-test-output"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Logging Test Output</h1><p>PhpUnit can do all sorts of logging.</p><h2 id="capture-every-page-loaded"> <a aria-labelledby="capture-every-page-loaded" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#capture-every-page-loaded"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Capture every page loaded</h2><p>For debugging, capturing all HTML requests can be useful.</p><p>At <a href="https://gitlab.com/weitzman/drupal-test-traits#debugging-tests">https://gitlab.com/weitzman/drupal-test-traits#debugging-tests</a> Moshe suggests:</p><p>• All HTML requests can be logged. To do so, add BROWSERTEST_OUTPUT_DIRECTORY=/tmp and --printer '\\Drupal\\Tests\\Listeners\\HtmlOutputPrinter' to the phpunit call. To disable deprecation notices, include SYMFONY_DEPRECATIONS_HELPER=disabled. Alternatively, you can specify these in your phpunit.xml (<a href="file:////weitzman/drupal-test-traits/-/blob/2.x/docs/phpunit.xml">example phpunit.xml</a>).</p><p>To add the printerclass to the phpunit.html see the printerClass line below:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="nt">&lt;phpunit</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"http://schema.phpunit.de/4.1/phpunit.xsd"</span>
         <span class="na">backupGlobals=</span><span class="s">"false"</span>
         <span class="na">colors=</span><span class="s">"true"</span>
         <span class="na">bootstrap=</span><span class="s">"scripts/bootstrap-fast.php"</span>
         <span class="na">verbose=</span><span class="s">"true"</span>
         <span class="na">printerClass=</span><span class="s">"\Drupal\Tests\Listeners\HtmlOutputPrinter"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;php&gt;</span>
</code></pre></div></div><p>Putting this in the <code class="language-plaintext highlighter-rouge">&lt;php&gt;</code> section of the file causes all html requests to be output to <code class="language-plaintext highlighter-rouge">/sites/simpletest/browser_output</code>. I tried specifying a different directory with but it had no effect. Use this with caution (or only for debugging if you don't want to fill up hard drives.)</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"BROWSERTEST_OUTPUT_DIRECTORY"</span> <span class="na">value=</span><span class="s">"/tmp"</span><span class="nt">/&gt;</span> 
</code></pre></div></div><p>See the entire &lt;php&gt; section below:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;php&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_BASE_URL"</span> <span class="na">value=</span><span class="s">"http://tea.ddev.site"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_API_URL"</span> <span class="na">value=</span><span class="s">"http://chrome:9222"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_MINK_DRIVER_ARGS"</span> <span class="na">value=</span><span class="s">'["chrome", {"browserName":"chrome","chromeOptions":{"args":["--disable-gpu","--headless", "--no-sandbox"]}}, "http://chromedriver:9515"]'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_API_OPTIONS"</span> <span class="na">value=</span><span class="s">'{"socketTimeout": 360, "domWaitTimeout": 3600000}'</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!-- Example BROWSERTEST_OUTPUT_DIRECTORY value: /tmp
       Specify a temporary directory for storing debug images and html documents.
       These artifacts get copied to /sites/simpletest/browser_output by BrowserTestBase. --&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"BROWSERTEST_OUTPUT_DIRECTORY"</span> <span class="na">value=</span><span class="s">"/tmp"</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!-- To disable deprecation testing completely uncomment the next line. --&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"SYMFONY_DEPRECATIONS_HELPER"</span> <span class="na">value=</span><span class="s">"disabled"</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!-- Specify the default directory screenshots should be placed. --&gt;</span>
  <span class="c">&lt;!--&lt;env name="DTT_SCREENSHOT_REPORT_DIRECTORY" value=""/&gt;--&gt;</span>
  <span class="c">&lt;!-- Specify the default directory page captures should be placed.
      When using the \Drupal\Tests\Listeners\HtmlOutputPrinter printerClass this will default to
      /sites/simpletest/browser_output. If using another printer such as teamcity this must be defined.
      --&gt;</span>
  <span class="c">&lt;!--&lt;env name="DTT_HTML_OUTPUT_DIRECTORY" value=""/&gt;--&gt;</span>
<span class="nt">&lt;/php&gt;</span>
</code></pre></div></div><h2 id="capture-an-html-page"> <a aria-labelledby="capture-an-html-page" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#capture-an-html-page"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Capture an HTML page</h2><p>From <a href="https://gitlab.com/weitzman/drupal-test-traits#debugging-tests">https://gitlab.com/weitzman/drupal-test-traits#debugging-tests</a>:</p><p>• To write the current HTML of the page to a file, use $this-&gt;capturePageContent(). If using HtmlOutputPrinter this will be saved to the browser_output directory. Alternatively you can specify DTT_HTML_OUTPUT_DIRECTORY=/path/to/output_directory which is required when using a different printer, such as Teamcity, which is enforced by PHPStorm.</p><h3 id="example-of-capturing-a-page"> <a aria-labelledby="example-of-capturing-a-page" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#example-of-capturing-a-page"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Example of capturing a page</h3><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromRoute</span><span class="p">(</span><span class="s1">'tea_teks_publisher.correlation_detail'</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'node1'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">teaPublisherNid</span><span class="p">,</span>
    <span class="s1">'node2'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">testProgramOneNid</span><span class="p">,</span>
    <span class="s1">'node3'</span> <span class="o">=&gt;</span> <span class="nv">$expectation_nid</span><span class="p">,</span>
    <span class="s1">'node4'</span> <span class="o">=&gt;</span> <span class="nv">$correlation_nid</span><span class="p">,</span>
  <span class="p">]</span>
<span class="p">);</span>
<span class="nv">$page_source</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">capturePageContent</span><span class="p">();</span>
</code></pre></div></div><p>Use the following setting to specify the output directory in the <code class="language-plaintext highlighter-rouge">phpunit.xml</code> file</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;env name="DTT_HTML_OUTPUT_DIRECTORY" value="sites/simpletest/browser_output"/&gt;
</code></pre></div></div><p>Here is the whole &lt;php&gt; section:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;php&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_BASE_URL"</span> <span class="na">value=</span><span class="s">"http://tea.ddev.site"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_API_URL"</span> <span class="na">value=</span><span class="s">"http://chrome:9222"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_MINK_DRIVER_ARGS"</span> <span class="na">value=</span><span class="s">'["chrome", {"browserName":"chrome","chromeOptions":{"args":["--disable-gpu","--headless", "--no-sandbox"]}}, "http://chromedriver:9515"]'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_API_OPTIONS"</span> <span class="na">value=</span><span class="s">'{"socketTimeout": 360, "domWaitTimeout": 3600000}'</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!-- Example BROWSERTEST_OUTPUT_DIRECTORY value: /tmp
       Specify a temporary directory for storing debug images and html documents.
       These artifacts get copied to /sites/simpletest/browser_output by BrowserTestBase. --&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"BROWSERTEST_OUTPUT_DIRECTORY"</span> <span class="na">value=</span><span class="s">"/tmp"</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!-- To disable deprecation testing completely uncomment the next line. --&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"SYMFONY_DEPRECATIONS_HELPER"</span> <span class="na">value=</span><span class="s">"disabled"</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!-- Specify the default directory screenshots should be placed. --&gt;</span>
  <span class="c">&lt;!--&lt;env name="DTT_SCREENSHOT_REPORT_DIRECTORY" value=""/&gt;--&gt;</span>
  <span class="c">&lt;!-- Specify the default directory page captures should be placed.
      When using the \Drupal\Tests\Listeners\HtmlOutputPrinter printerClass this will default to
      /sites/simpletest/browser_output. If using another printer such as teamcity this must be defined.
      --&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_HTML_OUTPUT_DIRECTORY"</span> <span class="na">value=</span><span class="s">"sites/simpletest/browser_output"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/php&gt;</span>
</code></pre></div></div><h3 id="screenshot-using-existingsiteselenium2drivertest"> <a aria-labelledby="screenshot-using-existingsiteselenium2drivertest" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#screenshot-using-existingsiteselenium2drivertest"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Screenshot using ExistingSiteSelenium2DriverTest</h3><p>From <a href="https://gitlab.com/weitzman/drupal-test-traits#debugging-tests">https://gitlab.com/weitzman/drupal-test-traits#debugging-tests</a>:</p><p>• To take a screenshot of the current page under ExistingSiteSelenium2DriverTest, use \weitzman\DrupalTestTraits\ScreenShotTrait::captureScreenshot. Be careful when using this to debug tests that are "randomly" failing. Most likely, these tests are failing due to missing <a href="https://api.drupal.org/api/drupal/core%21tests%21Drupal%21FunctionalJavascriptTests%21JSWebAssert.php/function/JSWebAssert%3A%3AwaitForElementVisible/9.3.x">[waitForElementVisible]{.underline}</a> checks, as the act of taking a screenshot gives the browser additional time to finish rendering the page.</p><p>This trait doesn't need to be installed separately, it is included with DTT. Just add a use statement to your class e.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Pub1Test</span> <span class="kd">extends</span> <span class="nc">ExistingSiteSelenium2DriverTestBase</span> <span class="p">{</span>
  <span class="kn">use</span> <span class="nc">\weitzman\DrupalTestTraits\ScreenShotTrait</span><span class="p">;</span>

  <span class="k">private</span> <span class="kt">int</span> <span class="nv">$teaPublisherUid</span> <span class="o">=</span> <span class="mi">5071</span><span class="p">;</span>
  <span class="k">private</span> <span class="kt">int</span> <span class="nv">$teaPublisherNid</span> <span class="o">=</span> <span class="mi">61821</span><span class="p">;</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">testSetup</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">markTestIncomplete</span><span class="p">(</span><span class="s1">'later'</span><span class="p">);</span>
<span class="mf">...</span>
</code></pre></div></div><p>Calling it in code:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Load the publisher correlation detail page.</span>
<span class="k">do</span> <span class="p">{</span>
  <span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromRoute</span><span class="p">(</span><span class="s1">'too_teks_publisher.correlation_detail'</span><span class="p">,</span> <span class="p">[</span>
      <span class="s1">'node1'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tooPublisherNid</span><span class="p">,</span>
      <span class="s1">'node2'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">testProgramOneNid</span><span class="p">,</span>
      <span class="s1">'node3'</span> <span class="o">=&gt;</span> <span class="nv">$expectation_nid</span><span class="p">,</span>
      <span class="s1">'node4'</span> <span class="o">=&gt;</span> <span class="nv">$correlation_nid</span><span class="p">,</span>
    <span class="p">]</span>
  <span class="p">);</span>
  <span class="nv">$page_source</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
  <span class="c1">//$this-&gt;capturePageContent();</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">captureScreenshot</span><span class="p">();</span>
</code></pre></div></div><p>The output appears as png files like:</p><p><img alt="Output files" src="https://selwynpolit.github.io/d9book/assets/images/output-files.png"/></p><p>Curiously, this only captures the visible part of the page - I notice parts of it were clipped.</p><p>Location of the files is specified in the <code class="language-plaintext highlighter-rouge">phpunit.xml</code> in the <code class="language-plaintext highlighter-rouge">&lt;php&gt;</code> section as</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_SCREENSHOT_REPORT_DIRECTORY"</span> <span class="na">value=</span><span class="s">""</span><span class="nt">/&gt;</span>
</code></pre></div></div><p>That whole &lt;php&gt; section looks like:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;php&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_BASE_URL"</span> <span class="na">value=</span><span class="s">"http://tea.ddev.site"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_API_URL"</span> <span class="na">value=</span><span class="s">"http://chrome:9222"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_MINK_DRIVER_ARGS"</span> <span class="na">value=</span><span class="s">'["chrome", {"browserName":"chrome","chromeOptions":{"args":["--disable-gpu","--headless", "--no-sandbox"]}}, "http://chromedriver:9515"]'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_API_OPTIONS"</span> <span class="na">value=</span><span class="s">'{"socketTimeout": 360, "domWaitTimeout": 3600000}'</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!-- Example BROWSERTEST_OUTPUT_DIRECTORY value: /tmp
       Specify a temporary directory for storing debug images and html documents.
       These artifacts get copied to /sites/simpletest/browser_output by BrowserTestBase. --&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"BROWSERTEST_OUTPUT_DIRECTORY"</span> <span class="na">value=</span><span class="s">"/tmp"</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!-- To disable deprecation testing completely uncomment the next line. --&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"SYMFONY_DEPRECATIONS_HELPER"</span> <span class="na">value=</span><span class="s">"disabled"</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!-- Specify the default directory screenshots should be placed. --&gt;</span>
  <span class="c">&lt;!-- &lt;env name="DTT_SCREENSHOT_REPORT_DIRECTORY" value=""/&gt;--&gt;</span>
  <span class="c">&lt;!-- Specify the default directory page captures should be placed.
      When using the \Drupal\Tests\Listeners\HtmlOutputPrinter printerClass this will default to
      /sites/simpletest/browser_output. If using another printer such as teamcity this must be defined.
      --&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_HTML_OUTPUT_DIRECTORY"</span> <span class="na">value=</span><span class="s">"sites/simpletest/browser_output"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/php&gt;</span>
</code></pre></div></div><h1 id="writing-dtt-tests"> <a aria-labelledby="writing-dtt-tests" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#writing-dtt-tests"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Writing DTT Tests</h1><h2 id="test-locations"> <a aria-labelledby="test-locations" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#test-locations"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Test locations</h2><p>Tests that require no Ajax or Javascript are put in the <code class="language-plaintext highlighter-rouge">ExistingSite</code> directory. These will run quite quickly especially if you run them on the host (instead of in the DDEV/Docker containers). These tests are derived from ExistingSiteBase.</p><p>Putting tests in the ExistingSiteJavascript directory (and deriving them from ExistingSiteSelenium2DriverTestBase) will cause the test to be run against the Chromedriver which can handle Javascript and Ajax.</p><h2 id="generate-dtt-tests-with-drush"> <a aria-labelledby="generate-dtt-tests-with-drush" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#generate-dtt-tests-with-drush"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Generate DTT tests with drush</h2><p>Use the latest drush (11 at this time) to generate both types of tests using:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ drush generate test:existing
</code></pre></div></div><p>And</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ drush generate test:existing-js
</code></pre></div></div><p>More at <a href="https://www.drush.org/latest/generators/">https://www.drush.org/latest/generators/</a></p><h2 id="example-tests"> <a aria-labelledby="example-tests" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#example-tests"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Example tests</h2><h3 id="exampletestphp-creating-user-term-article"> <a aria-labelledby="exampletestphp-creating-user-term-article" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#exampletestphp-creating-user-term-article"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> ExampleTest.php creating user term, article</h3><p>From <a href="https://gitlab.com/weitzman/drupal-test-traits/-/blob/2.x/tests/ExampleTest.php">https://gitlab.com/weitzman/drupal-test-traits/-/blob/2.x/tests/ExampleTest.php</a> this example creates a user, a taxonomy term, an article, retrieves it, checks for a return code of 200, logs in as the user and retrieves the node edit page.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\Tests\tea_teks_voting\ExistingSite</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\taxonomy\Entity\Vocabulary</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">weitzman\DrupalTestTraits\ExistingSiteBase</span><span class="p">;</span>

<span class="cd">/**
 * A model test case using traits from Drupal Test Traits.
 */</span>
<span class="kd">class</span> <span class="nc">ExampleTest</span> <span class="kd">extends</span> <span class="nc">ExistingSiteBase</span> <span class="p">{</span>

  <span class="k">protected</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
    <span class="k">parent</span><span class="o">::</span><span class="nf">setUp</span><span class="p">();</span>

    <span class="c1">// Cause tests to fail if an error is sent to Drupal logs.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">failOnLoggedErrors</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="cd">/**
   * An example test method; note that Drupal API's and Mink are available.
   *
   * @throws \Drupal\Core\Entity\EntityStorageException
   * @throws \Drupal\Core\Entity\EntityMalformedException
   * @throws \Behat\Mink\Exception\ExpectationException
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">testLlama</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Creates a user. Will be automatically cleaned up at the end of the test.</span>
    <span class="nv">$author</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createUser</span><span class="p">([],</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

    <span class="c1">// Create a taxonomy term. Will be automatically cleaned up at the end of the test.</span>
    <span class="nv">$vocab</span> <span class="o">=</span> <span class="nc">Vocabulary</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="s1">'tags'</span><span class="p">);</span>
    <span class="nv">$term</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createTerm</span><span class="p">(</span><span class="nv">$vocab</span><span class="p">);</span>

    <span class="c1">// Create a "Llama" article. Will be automatically cleaned up at end of test.</span>
    <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createNode</span><span class="p">([</span>
      <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Llama'</span><span class="p">,</span>
      <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'article'</span><span class="p">,</span>
      <span class="s1">'field_tags'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'target_id'</span> <span class="o">=&gt;</span> <span class="nv">$term</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">(),</span>
      <span class="p">],</span>
      <span class="s1">'uid'</span> <span class="o">=&gt;</span> <span class="nv">$author</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">(),</span>
    <span class="p">]);</span>
    <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">setPublished</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nv">$author</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">(),</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">getOwnerId</span><span class="p">());</span>

    <span class="c1">// We can browse pages.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">toUrl</span><span class="p">());</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSession</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">statusCodeEquals</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

    <span class="c1">// We can login and browse admin pages.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalLogin</span><span class="p">(</span><span class="nv">$author</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">toUrl</span><span class="p">(</span><span class="s1">'edit-form'</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="votingpagetest"> <a aria-labelledby="votingpagetest" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#votingpagetest"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> VotingPageTest</h3><p>This test runs code in a project and at various times asserts that various things are true or equal to expected values. It also does some setup including logging in as a voter. More about that below.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">VotingPageTest</span> <span class="kd">extends</span> <span class="nc">ExistingSiteBase</span> <span class="p">{</span>

  <span class="k">protected</span> <span class="kt">int</span> <span class="nv">$testProgramOneNid</span> <span class="o">=</span> <span class="mi">852061</span><span class="p">;</span>
  <span class="k">protected</span> <span class="kt">int</span> <span class="nv">$publisher_user_id</span> <span class="o">=</span> <span class="mi">3501</span><span class="p">;</span>  <span class="c1">// DannyTest Lufkin.</span>
  <span class="k">protected</span> <span class="kt">int</span> <span class="nv">$correlationNid</span> <span class="o">=</span> <span class="mi">852086</span><span class="p">;</span>
  <span class="k">protected</span> <span class="kt">int</span> <span class="nv">$expectationNid</span> <span class="o">=</span> <span class="mi">852076</span><span class="p">;</span>
  <span class="k">protected</span> <span class="kt">int</span> <span class="nv">$teaPublisherNid</span> <span class="o">=</span> <span class="mi">61821</span><span class="p">;</span>
  <span class="k">protected</span> <span class="kt">?int</span> <span class="nv">$adminUserId</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">;</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">testVoter1Vote</span><span class="p">()</span> <span class="p">{</span>
<span class="c1">//    $this-&gt;markTestIncomplete('later');</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setupTestProgram1ForVotingRound0</span><span class="p">();</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">loginVoter1</span><span class="p">();</span>
    <span class="nv">$program_nid</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">testProgramOneNid</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">program</span>  <span class="o">=</span> <span class="k">new</span> <span class="nc">Program</span><span class="p">(</span><span class="nv">$program_nid</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">persona</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Persona</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1UserId</span><span class="p">);</span>

    <span class="nv">$citation_nid</span> <span class="o">=</span> <span class="mi">858676</span><span class="p">;</span>
    <span class="nv">$citation_nid</span> <span class="o">=</span> <span class="mi">858741</span><span class="p">;</span>
    <span class="nv">$citation_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$citation_nid</span><span class="p">);</span>
    <span class="nv">$expectation_nid</span> <span class="o">=</span> <span class="nv">$citation_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_tks_pub_expectation'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
    <span class="nv">$correlation_nid</span> <span class="o">=</span> <span class="nv">$citation_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_tks_pub_correlation'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>

    <span class="nv">$options</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'program_nid'</span> <span class="o">=&gt;</span> <span class="nv">$program_nid</span><span class="p">,</span>
      <span class="s1">'expectation_nid'</span> <span class="o">=&gt;</span> <span class="nv">$expectation_nid</span><span class="p">,</span>
      <span class="s1">'correlation_nid'</span> <span class="o">=&gt;</span> <span class="nv">$correlation_nid</span><span class="p">,</span>
      <span class="s1">'citation_nid'</span> <span class="o">=&gt;</span> <span class="nv">$citation_nid</span><span class="p">,</span>
      <span class="s1">'rejection_reason'</span> <span class="o">=&gt;</span> <span class="s1">'auto-test rejection reason'</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'tea_teks_srp.vote_processor'</span><span class="p">);</span>
    <span class="nv">$correlation_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$correlation_nid</span><span class="p">);</span>
    <span class="nv">$valid_voting_path</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">loadVotingPath</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="nf">getProgramNode</span><span class="p">(),</span> <span class="s1">'all'</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">setVotingRequirements</span><span class="p">(</span><span class="nv">$correlation_node</span><span class="p">);</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">assertTrue</span><span class="p">(</span><span class="nv">$valid_voting_path</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">voteOnCitation</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="s1">'accepted'</span><span class="p">);</span>
    <span class="nv">$voting_record_node</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">loadVotingRecord</span><span class="p">(</span><span class="nv">$citation_nid</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1UserId</span><span class="p">);</span>
    <span class="nv">$vote</span> <span class="o">=</span> <span class="nv">$voting_record_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_vote'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'accepted'</span><span class="p">,</span> <span class="nv">$vote</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">voteOnCitation</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="s1">'rejected'</span><span class="p">);</span>
    <span class="nv">$voting_record_node</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">loadVotingRecord</span><span class="p">(</span><span class="nv">$citation_nid</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1UserId</span><span class="p">);</span>
    <span class="nv">$vote</span> <span class="o">=</span> <span class="nv">$voting_record_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_vote'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'rejected'</span><span class="p">,</span> <span class="nv">$vote</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">cancelVoteOnCitation</span><span class="p">(</span><span class="nv">$citation_nid</span><span class="p">,</span> <span class="nv">$correlation_nid</span><span class="p">);</span>
    <span class="nv">$voting_record_node</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">loadVotingRecord</span><span class="p">(</span><span class="nv">$citation_nid</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1UserId</span><span class="p">);</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">assertEmpty</span><span class="p">(</span><span class="nv">$voting_record_node</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is the setupTestProgram1ForVoting</p><p>This checks some data in nodes, logs in as an admin user and fills out a form that executes a batch api process. I wasn’t able to make a batch api process run directly from a test. Not sure why. Moshe Weitzman says it should work but that the batch API is ancient.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">function</span> <span class="n">setupTestProgram1ForVotingRound0</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//$this-&gt;resetProgram1Voting();</span>

  <span class="nv">$program_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">testProgramOneNid</span><span class="p">);</span>
  <span class="nv">$teks_program_status</span> <span class="o">=</span> <span class="nv">$program_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_tks_program_status'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$teks_program_status</span> <span class="o">==</span> <span class="s1">'publisher_complete'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">loginAdminUser</span><span class="p">();</span>
    <span class="nv">$page_source</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="nc">Url</span><span class="o">::</span><span class="nf">fromRoute</span><span class="p">(</span><span class="s1">'tea_teks_publisher.change_input_collection_status'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'node'</span> <span class="o">=&gt;</span> <span class="mi">852071</span><span class="p">,]));</span>

    <span class="c1">// To check if the form displayed correctly you can look for something in the $page_source and check the return code.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSession</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">statusCodeEquals</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">submitForm</span><span class="p">([</span>
      <span class="s1">'program_status'</span> <span class="o">=&gt;</span> <span class="s1">'ready_for_release'</span><span class="p">,</span>
    <span class="p">],</span> <span class="s1">'Change Status'</span><span class="p">);</span>

    <span class="c1">// Confirm that the voting requirements were written to a correlation.</span>
    <span class="nv">$correlation_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="mi">852081</span><span class="p">);</span>
    <span class="nv">$voting_requirements_json</span> <span class="o">=</span> <span class="nv">$correlation_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_voting_requirements_json'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">assertNotNull</span><span class="p">(</span><span class="nv">$voting_requirements_json</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// Set team.</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setupVotingTeamA</span><span class="p">();</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setupTestProgram1TeamAForRound0</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>Other supporting functions</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">function</span> <span class="n">setupVoter1</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$query</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityQuery</span><span class="p">(</span><span class="s1">'user'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'Voter 1 Test'</span><span class="p">);</span>
  <span class="nv">$uids</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$uids</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setupVotingTeamA</span><span class="p">();</span>
    <span class="nv">$query</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityQuery</span><span class="p">(</span><span class="s1">'user'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'Voter 1 Test'</span><span class="p">);</span>
    <span class="nv">$uids</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="nv">$uids</span> <span class="o">=</span> <span class="nb">array_values</span><span class="p">(</span><span class="nv">$uids</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1UserId</span> <span class="o">=</span> <span class="nv">$uids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div><p>and</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">function</span> <span class="n">loginVoter1</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setupVoter1</span><span class="p">();</span>
  <span class="nv">$user</span> <span class="o">=</span> <span class="nc">User</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1UserId</span><span class="p">);</span>
  <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">passRaw</span> <span class="o">=</span> <span class="s1">'password'</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalLogin</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="examplelogintestphp"> <a aria-labelledby="examplelogintestphp" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#examplelogintestphp"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> ExampleLoginTest.php</h3><p>From <a href="https://gitlab.com/weitzman/logintrait/-/blob/master/src/ExampleLoginTest.php">https://gitlab.com/weitzman/logintrait/-/blob/master/src/ExampleLoginTest.php</a> This example shows how to use the Login trait.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="c1">// Use your module's testing namespace such as the one below.</span>
<span class="kn">namespace</span> <span class="nn">Drupal\Tests\moduleName\ExistingSite</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">weitzman\DrupalTestTraits\ExistingSiteBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">weitzman\LoginTrait\LoginTrait</span><span class="p">;</span>

<span class="cd">/**
 * Login and Logout via user reset URL instead of forms. Useful when TFA/SAML are enabled.
 */</span>
<span class="kd">class</span> <span class="nc">ExampleLoginTest</span> <span class="kd">extends</span> <span class="nc">ExistingSiteBase</span> <span class="p">{</span>
    <span class="kn">use</span> <span class="nc">LoginTrait</span><span class="p">;</span>

    <span class="cd">/**
     * Login and logout via password reset URL.
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testLoginLogout</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Creates a user. Will be automatically cleaned up at the end of the test.</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createUser</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalLogin</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="s1">'user'</span><span class="p">);</span>
        <span class="nv">$user2</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createUser</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalLogin</span><span class="p">(</span><span class="nv">$user2</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="selenium2drivertest"> <a aria-labelledby="selenium2drivertest" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#selenium2drivertest"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Selenium2DriverTest</h3><p>This is an example from the Weitzman repo using AJAX</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="c1">// Use your module's testing namespace such as the one below.</span>
<span class="c1">//namespace Drupal\Tests\tea_teks_voting\ExampleSelenium2DriverTest;</span>
<span class="kn">namespace</span> <span class="nn">Drupal\Tests\tea_teks_voting\ExistingSiteJavascript</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\node\Entity\Node</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\taxonomy\Entity\Vocabulary</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\user\Entity\User</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">weitzman\DrupalTestTraits\ExistingSiteSelenium2DriverTestBase</span><span class="p">;</span>

<span class="cd">/**
 * A WebDriver test suitable for testing Ajax and client-side interactions.
 */</span>
<span class="kd">class</span> <span class="nc">ExampleSelenium2DriverTest</span> <span class="kd">extends</span> <span class="nc">ExistingSiteSelenium2DriverTestBase</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">testContentCreation</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// Create a taxonomy term. Will be automatically cleaned up at the end of the test.</span>
    <span class="nv">$web_assert</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSession</span><span class="p">();</span>
    <span class="nv">$vocab</span> <span class="o">=</span> <span class="nc">Vocabulary</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="s1">'tags'</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createTerm</span><span class="p">(</span><span class="nv">$vocab</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Term 1'</span><span class="p">]);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createTerm</span><span class="p">(</span><span class="nv">$vocab</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Term 2'</span><span class="p">]);</span>
    <span class="nv">$admin</span> <span class="o">=</span> <span class="nc">User</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nv">$admin</span><span class="o">-&gt;</span><span class="n">passRaw</span> <span class="o">=</span> <span class="s1">'password'</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalLogin</span><span class="p">(</span><span class="nv">$admin</span><span class="p">);</span>

    <span class="c1">// @codingStandardsIgnoreStart</span>
    <span class="c1">// These lines are left here as examples of how to debug requests.</span>
    <span class="c1">// \weitzman\DrupalTestTraits\ScreenShotTrait::captureScreenshot();</span>
    <span class="c1">// $this-&gt;capturePageContent();</span>
    <span class="c1">// @codingStandardsIgnoreStop</span>

    <span class="c1">// Test autocomplete on article creation.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="s1">'/node/add/article'</span><span class="p">);</span>
    <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getCurrentPage</span><span class="p">();</span>
    <span class="nv">$page</span><span class="o">-&gt;</span><span class="nf">fillField</span><span class="p">(</span><span class="s1">'title[0][value]'</span><span class="p">,</span> <span class="s1">'Article Title'</span><span class="p">);</span>
    <span class="nv">$tags</span> <span class="o">=</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="nf">findField</span><span class="p">(</span><span class="s1">'field_tags[target_id]'</span><span class="p">);</span>
    <span class="nv">$tags</span><span class="o">-&gt;</span><span class="nf">setValue</span><span class="p">(</span><span class="s1">'Ter'</span><span class="p">);</span>
    <span class="nv">$tags</span><span class="o">-&gt;</span><span class="nf">keyDown</span><span class="p">(</span><span class="s1">'m'</span><span class="p">);</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$web_assert</span><span class="o">-&gt;</span><span class="nf">waitForElementVisible</span><span class="p">(</span><span class="s1">'css'</span><span class="p">,</span> <span class="s1">'.ui-autocomplete li'</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertNotNull</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
    <span class="c1">// Click the autocomplete option</span>
    <span class="nv">$result</span><span class="o">-&gt;</span><span class="nf">click</span><span class="p">();</span>
    <span class="c1">// Verify that correct the input is selected.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertStringContainsString</span><span class="p">(</span><span class="s1">'Term 1'</span><span class="p">,</span> <span class="nv">$tags</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">());</span>
    <span class="nv">$submit_button</span> <span class="o">=</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="nf">findButton</span><span class="p">(</span><span class="s1">'Save'</span><span class="p">);</span>
    <span class="nv">$submit_button</span><span class="o">-&gt;</span><span class="nf">press</span><span class="p">();</span>
    <span class="c1">// Verify the URL and get the nid.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertTrue</span><span class="p">((</span><span class="n">bool</span><span class="p">)</span> <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/.+node\/(?P&lt;nid&gt;\d+)/'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getUrl</span><span class="p">(),</span> <span class="nv">$matches</span><span class="p">));</span>
    <span class="nv">$node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="s1">'nid'</span><span class="p">]);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">markEntityForCleanup</span><span class="p">(</span><span class="nv">$node</span><span class="p">);</span>
    <span class="c1">// Verify the text on the page.</span>
    <span class="nv">$web_assert</span><span class="o">-&gt;</span><span class="nf">pageTextContains</span><span class="p">(</span><span class="s1">'Article Title'</span><span class="p">);</span>
    <span class="nv">$web_assert</span><span class="o">-&gt;</span><span class="nf">pageTextContains</span><span class="p">(</span><span class="s1">'Term 1'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="login-to-your-site"> <a aria-labelledby="login-to-your-site" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#login-to-your-site"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Login to your site</h2><p>There are some contributed packages with useful features. The <a href="https://gitlab.com/weitzman/logintrait.git">login trait repo</a> adds some useful functionality.</p><p>Install via Composer with:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require weitzman/logintrait
</code></pre></div></div><h3 id="create-a-new-user-and-login-as-that-user"> <a aria-labelledby="create-a-new-user-and-login-as-that-user" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#create-a-new-user-and-login-as-that-user"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Create a new user and login as that user:</h3><p>From <a href="https://gitlab.com/weitzman/logintrait/-/blob/master/src/ExampleLoginTest.php">https://gitlab.com/weitzman/logintrait/-/blob/master/src/ExampleLoginTest.php</a></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="c1">// Use your module's testing namespace such as the one below.</span>
<span class="kn">namespace</span> <span class="nn">Drupal\Tests\moduleName\ExistingSite</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">weitzman\DrupalTestTraits\ExistingSiteBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">weitzman\LoginTrait\LoginTrait</span><span class="p">;</span>

<span class="cd">/**
 * Login and Logout via user reset URL instead of forms. Useful when TFA/SAML are enabled.
 */</span>
<span class="kd">class</span> <span class="nc">ExampleLoginTest</span> <span class="kd">extends</span> <span class="nc">ExistingSiteBase</span> <span class="p">{</span>
    <span class="kn">use</span> <span class="nc">LoginTrait</span><span class="p">;</span>

    <span class="cd">/**
     * Login and logout via password reset URL.
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testLoginLogout</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Creates a user. Will be automatically cleaned up at the end of the test.</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createUser</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalLogin</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="s1">'user'</span><span class="p">);</span>
        <span class="nv">$user2</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createUser</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalLogin</span><span class="p">(</span><span class="nv">$user2</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="create-an-admin-user"> <a aria-labelledby="create-an-admin-user" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#create-an-admin-user"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Create an admin user</h3><p>This will create a user named Fred Bloggs who is in a new randomly named group. The user and the group will be deleted when the test run finishes.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Creates a user. Will be automatically cleaned up at the end of the test.</span>
<span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createUser</span><span class="p">([],</span> <span class="s1">'Fred Bloggs'</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalLogin</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="s1">'user'</span><span class="p">);</span>
</code></pre></div></div><h3 id="login-as-an-existing-user"> <a aria-labelledby="login-as-an-existing-user" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#login-as-an-existing-user"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Login as an existing user</h3><p>Be sure to set that user’s password to “password” (in the Drupal U/I or in code) in order to make this work.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$voter1_user_id</span> <span class="o">=</span> <span class="mi">5284</span><span class="p">;</span>
<span class="nv">$voter1</span> <span class="o">=</span> <span class="nc">User</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$voter1_user_id</span><span class="p">);</span>
<span class="nv">$voter1</span><span class="o">-&gt;</span><span class="n">passRaw</span> <span class="o">=</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalLogin</span><span class="p">(</span><span class="nv">$voter1</span><span class="p">);</span>
</code></pre></div></div><p>Add users using Drupal API</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$voter1</span> <span class="o">=</span> <span class="nc">User</span><span class="o">::</span><span class="nf">create</span><span class="p">([</span>
  <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span>
  <span class="s1">'field_firstname'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1</span><span class="p">[</span><span class="s1">'field_firstname'</span><span class="p">],</span>
  <span class="s1">'field_lastname'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1</span><span class="p">[</span><span class="s1">'field_lastname'</span><span class="p">],</span>
  <span class="s1">'field_srp_voter_role'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1</span><span class="p">[</span><span class="s1">'field_srp_voter_role'</span><span class="p">],</span>
  <span class="s1">'field_phone'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1</span><span class="p">[</span><span class="s1">'field_phone'</span><span class="p">],</span>
  <span class="s1">'field_title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1</span><span class="p">[</span><span class="s1">'field_title'</span><span class="p">],</span>
<span class="p">]);</span>
<span class="nv">$voter1</span><span class="o">-&gt;</span><span class="nf">addRole</span><span class="p">(</span><span class="s1">'srp_voter'</span><span class="p">);</span>
<span class="nv">$voter1</span><span class="o">-&gt;</span><span class="nf">setEmail</span><span class="p">(</span><span class="s1">'voter1@mightycitizen.com'</span><span class="p">);</span>
<span class="nv">$voter1</span><span class="o">-&gt;</span><span class="nf">setPassword</span><span class="p">(</span><span class="s1">'password'</span><span class="p">);</span>
<span class="nv">$voter1</span><span class="o">-&gt;</span><span class="nf">activate</span><span class="p">();</span>
<span class="nv">$voter1</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
<span class="nv">$voter1_uid</span> <span class="o">=</span> <span class="nv">$voter1</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
</code></pre></div></div><h2 id="fill-out-a-form"> <a aria-labelledby="fill-out-a-form" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#fill-out-a-form"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Fill out a form</h2><p>Here is the code from <code class="language-plaintext highlighter-rouge">docroot/core/tests/Drupal/Tests/UiHelperTrait.php</code> to fill out the login form:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="nc">Url</span><span class="o">::</span><span class="nf">fromRoute</span><span class="p">(</span><span class="s1">'user.login'</span><span class="p">));</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">submitForm</span><span class="p">([</span>
  <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">getAccountName</span><span class="p">(),</span>
  <span class="s1">'pass'</span> <span class="o">=&gt;</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="n">passRaw</span><span class="p">,</span>
<span class="p">],</span> <span class="s1">'Log in'</span><span class="p">);</span>
</code></pre></div></div><p>Here is another example:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Load the form.</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromRoute</span><span class="p">(</span><span class="s1">'tea_teks_admin.sanity_checker'</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'program'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">testProgramOneNid</span><span class="p">,</span>
  <span class="p">]</span>
<span class="p">);</span>
<span class="c1">// Confirm that it loaded without errors.</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSession</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">statusCodeEquals</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="c1">// Check the destructive checkbox and click the 'verify vote counts' button.</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">submitForm</span><span class="p">([</span><span class="s1">'destructive'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'Verify Vote Counts'</span><span class="p">);</span>
</code></pre></div></div><p>In the above example the code in render array for the form that builds the destructive checkbox and the submit button looks like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'sanity_fieldset'</span><span class="p">][</span><span class="s1">'destructive'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'checkbox'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Check this box to permanently update statuses.'</span><span class="p">),</span>
  <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Recalculate all votes and statuses for current vote number. Leave unchecked for testing.'</span><span class="p">),</span>
<span class="p">];</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'sanity_fieldset'</span><span class="p">][</span><span class="s1">'actions'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'actions'</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'sanity_fieldset'</span><span class="p">][</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'submit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
  <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Verify Vote Counts'</span><span class="p">),</span>
<span class="p">];</span>

</code></pre></div></div><h3 id="parameter-gotcha"> <a aria-labelledby="parameter-gotcha" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#parameter-gotcha"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Parameter gotcha</h3><p>And my effort to fill out a form with a dropdown. This route required a node id to be passed as a parameter to the form – hence the [‘node’=&gt; 852071] and my submit button is called “Change Status”</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="nc">Url</span><span class="o">::</span><span class="nf">fromRoute</span><span class="p">(</span><span class="s1">'tea_teks_publisher.change_input_collection_status'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'node'</span> <span class="o">=&gt;</span> <span class="mi">852071</span><span class="p">,])</span> <span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">submitForm</span><span class="p">([</span>
  <span class="s1">'program_status'</span> <span class="o">=&gt;</span> <span class="s1">'ready_for_release'</span><span class="p">,</span>
<span class="p">],</span> <span class="s1">'Change Status'</span><span class="p">);</span>
</code></pre></div></div><p>Note. When you define a form in Drupal, it permits you to use a different variable name in the routing file versus the parameter in the buildForm() function. E.g. Here the parameter is called “program”:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tea_teks_srp.reset_program_votes</span><span class="pi">:</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/teks/admin/srp/program/{program}/resetvotes'</span>
  <span class="na">defaults</span><span class="pi">:</span>
    <span class="na">_form</span><span class="pi">:</span> <span class="s1">'</span><span class="s">\Drupal\tea_teks_srp\Form\SrpResetProgramVotesForm'</span>
    <span class="na">_title</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Reset</span><span class="nv"> </span><span class="s">Program</span><span class="nv"> </span><span class="s">Votes'</span>
  <span class="na">requirements</span><span class="pi">:</span>
    <span class="na">_permission</span><span class="pi">:</span> <span class="s1">'</span><span class="s">manage</span><span class="nv"> </span><span class="s">teks</span><span class="nv"> </span><span class="s">srp</span><span class="nv"> </span><span class="s">process'</span>
  <span class="na">options</span><span class="pi">:</span>
    <span class="na">parameters</span><span class="pi">:</span>
      <span class="na">program</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">entity:node</span>
    <span class="na">no_cache</span><span class="pi">:</span> <span class="s1">'</span><span class="s">TRUE'</span>
</code></pre></div></div><p>In the form, the parameter can be something different. i.e. the <code class="language-plaintext highlighter-rouge">$node</code> parameter here represents the program parameter above. If you change them to match i.e. change the parameter in the buildForm function below, it should work fine.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="kt">EntityInterface</span> <span class="nv">$node</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'#theme'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'tea_teks_srp__reset_votes'</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">bundle</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'teks_pub_program'</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nv">$request</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">request</span><span class="p">();</span>
    <span class="nv">$referer</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">headers</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'referer'</span><span class="p">);</span>
    <span class="nv">$base_url</span> <span class="o">=</span> <span class="nc">Request</span><span class="o">::</span><span class="nf">createFromGlobals</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getSchemeAndHttpHost</span><span class="p">();</span>
    <span class="nv">$alias</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$referer</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$base_url</span><span class="p">));</span>
    <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'referrer_alias'</span><span class="p">,</span> <span class="nv">$alias</span><span class="p">);</span>
    <span class="nv">$current_user</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">currentUser</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$current_user</span><span class="o">-&gt;</span><span class="nf">hasPermission</span><span class="p">(</span><span class="s1">'manage teks srp process'</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'actions'</span><span class="p">,</span>
      <span class="p">];</span>
      <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'submit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
        <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span>
          <span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'TESTING ONLY: Reset Program Votes/Data'</span><span class="p">),</span>
      <span class="p">];</span>
      <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'program_id'</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">());</span>
      <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'program_title'</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="n">title</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>So if you try in the test to execute this form and pass it a parameter called “program” it will fail to load the form. You will see errors like:</p><blockquote><p>There was 1 error:</p><p>1) Drupal\Tests\tea_teks_voting\ExistingSite\Vote1::testSetup</p><p>Behat\Mink\Exception\ElementNotFoundException: Button with id|name|label|value "TESTING ONLY: Reset Program Votes/Data" not found.</p></blockquote><p>Note. This code will do the same thing if you put it in the ExistingSite or the ExistingSiteJavascript directory however, putting it in the ExistingSiteJavascript directory (and deriving the test from ExistingSiteSelenium2DriverTestBase) will cause the test to be run against the Chromedriver which can handle Javascript and Ajax.</p><h2 id="data-provider"> <a aria-labelledby="data-provider" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#data-provider"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Data Provider</h2><p>Tests can be repeated with varying values by providing a data provider function. The data provider just returns an array of values and the function below has annotation indicating to PHPUnit to rerun the test once for each value in the data provider.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">providerForTest1</span><span class="p">():</span> <span class="kt">array</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">858641</span><span class="p">,</span> <span class="s1">'accepted'</span><span class="p">,],</span>
    <span class="p">[</span><span class="mi">858651</span><span class="p">,</span> <span class="s1">'accepted'</span><span class="p">,],</span>
    <span class="p">[</span><span class="mi">858661</span><span class="p">,</span> <span class="s1">'accepted'</span><span class="p">,],</span>
    <span class="p">[</span><span class="mi">858676</span><span class="p">,</span> <span class="s1">'accepted'</span><span class="p">,],</span>
    <span class="p">[</span><span class="mi">858721</span><span class="p">,</span> <span class="s1">'accepted'</span><span class="p">,],</span>
    <span class="p">[</span><span class="mi">858726</span><span class="p">,</span> <span class="s1">'accepted'</span><span class="p">,],</span>
    <span class="p">[</span><span class="mi">858736</span><span class="p">,</span> <span class="s1">'accepted'</span><span class="p">,],</span>
    <span class="p">[</span><span class="mi">858741</span><span class="p">,</span> <span class="s1">'accepted'</span><span class="p">,],</span>
  <span class="p">];</span>
<span class="p">}</span>

<span class="cd">/**
 * @dataProvider ProviderForTest1
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">test1</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$citation_nid</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$vote</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="nv">$voter1_uid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setupTestProgram1ForVotingRound0</span><span class="p">();</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">loginVoter1</span><span class="p">();</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">program</span>  <span class="o">=</span> <span class="k">new</span> <span class="nc">Program</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">testProgramOneNid</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">persona</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Persona</span><span class="p">(</span><span class="nv">$voter1_uid</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'tea_teks_srp.vote_processor'</span><span class="p">);</span>
  <span class="nv">$valid_voting_path</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">loadVotingPath</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">program</span><span class="o">-&gt;</span><span class="nf">getProgramNode</span><span class="p">(),</span> <span class="s1">'all'</span><span class="p">);</span>
  <span class="k">self</span><span class="o">::</span><span class="nf">assertTrue</span><span class="p">(</span><span class="nv">$valid_voting_path</span><span class="p">);</span>

  <span class="nv">$citation_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$citation_nid</span><span class="p">);</span>
  <span class="nv">$correlation_nid</span> <span class="o">=</span> <span class="nv">$citation_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_tks_pub_correlation'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
  <span class="nv">$expectation_nid</span> <span class="o">=</span> <span class="nv">$citation_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_tks_pub_expectation'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
  <span class="nv">$correlation_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$correlation_nid</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">setVotingRequirements</span><span class="p">(</span><span class="nv">$correlation_node</span><span class="p">);</span>
  <span class="nv">$voting_options</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'program_nid'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">testProgramOneNid</span><span class="p">,</span>
    <span class="s1">'expectation_nid'</span> <span class="o">=&gt;</span> <span class="nv">$expectation_nid</span><span class="p">,</span>
    <span class="s1">'correlation_nid'</span> <span class="o">=&gt;</span> <span class="nv">$correlation_nid</span><span class="p">,</span>
    <span class="s1">'citation_nid'</span> <span class="o">=&gt;</span> <span class="nv">$citation_nid</span><span class="p">,</span>
    <span class="s1">'rejection_reason'</span> <span class="o">=&gt;</span> <span class="s1">'auto-test rejection reason'</span><span class="p">,</span>
  <span class="p">];</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">voteOnCitation</span><span class="p">(</span><span class="nv">$voting_options</span><span class="p">,</span> <span class="s1">'accepted'</span><span class="p">);</span>
  <span class="nv">$voting_record_node</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">votingProcessor</span><span class="o">-&gt;</span><span class="nf">loadVotingRecord</span><span class="p">(</span><span class="nv">$citation_nid</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">voter1UserId</span><span class="p">);</span>
  <span class="nv">$vote_value_from_node</span> <span class="o">=</span> <span class="nv">$voting_record_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_vote'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
  <span class="k">self</span><span class="o">::</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nv">$vote</span><span class="p">,</span> <span class="nv">$vote_value_from_node</span><span class="p">);</span>

<span class="p">}</span>
</code></pre></div></div><h2 id="fill-a-queue-and-run-a-trait"> <a aria-labelledby="fill-a-queue-and-run-a-trait" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#fill-a-queue-and-run-a-trait"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Fill a queue and run a trait</h2><p>From Moshe Weitzman 9-27-22</p><p>I have seen tests that fill a queue and then run the queue with <a href="https://github.com/drupaltest/queue-runner-trait/">https://github.com/drupaltest/queue-runner-trait/</a></p><p>//@TODO: Explore this</p><h1 id="mink"> <a aria-labelledby="mink" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#mink"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Mink</h1><h2 id="checking-page-return-code"> <a aria-labelledby="checking-page-return-code" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#checking-page-return-code"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Checking page return code</h2><p>This only works for non-Selenium/Chromedriver type test:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$session</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getSession</span><span class="p">();</span>
<span class="nv">$status_code</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="nf">getStatusCode</span><span class="p">();</span>
<span class="k">print</span> <span class="s2">"</span><span class="se">\n</span><span class="s2"> Current Status code: </span><span class="nv">$status_code</span><span class="s2">"</span><span class="p">;</span>
</code></pre></div></div><p>In the ExampleTest.php there was this example:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// We can browse pages.</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">drupalGet</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">toUrl</span><span class="p">());</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSession</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">statusCodeEquals</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</code></pre></div></div><h2 id="grab-the-text-from-the-page"> <a aria-labelledby="grab-the-text-from-the-page" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#grab-the-text-from-the-page"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Grab the text from the page</h2><p>You can do some interesting things when running Selenium type tests. Here we can grab the text and search in it for a particular string.</p><p>This will get you the text that is visible on the page. It is unformatted and is one long string.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$session</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getSession</span><span class="p">();</span>
<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="nf">getPage</span><span class="p">();</span>
<span class="nv">$page_text</span> <span class="o">=</span> <span class="nv">$page</span><span class="o">-&gt;</span><span class="nb">getText</span><span class="p">();</span>
</code></pre></div></div><h2 id="current-url"> <a aria-labelledby="current-url" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#current-url"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Current URL</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$url_string</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getSession</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getCurrentUrl</span><span class="p">();</span>
<span class="k">print</span> <span class="s2">"</span><span class="se">\n</span><span class="s2"> Current URL: </span><span class="nv">$url_string</span><span class="s2">"</span><span class="p">;</span>
</code></pre></div></div><h1 id="load-and-parse-a-csv-file"> <a aria-labelledby="load-and-parse-a-csv-file" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#load-and-parse-a-csv-file"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Load and parse a CSV file</h1><p>I found it useful for tests to be able to load a CSV file to drive a test by inputting repeatable data over and over. This is similar to using a data provider function.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">function</span> <span class="n">readCsv2</span><span class="p">():</span> <span class="kt">array</span> <span class="p">{</span>
  <span class="nv">$file</span> <span class="o">=</span> <span class="nb">getcwd</span><span class="p">()</span> <span class="mf">.</span> <span class="s1">'/modules/custom/tea_teks/modules/tea_teks_publisher/tests/ExistingSiteJavascript/test2.csv'</span><span class="p">;</span>
  <span class="nv">$csv</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'str_getcsv'</span><span class="p">,</span> <span class="nb">file</span><span class="p">(</span><span class="nv">$file</span><span class="p">));</span>
  <span class="nb">array_walk</span><span class="p">(</span><span class="nv">$csv</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$a</span><span class="p">)</span> <span class="nf">use</span> <span class="p">(</span><span class="nv">$csv</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="nb">array_combine</span><span class="p">(</span><span class="nv">$csv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$a</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nb">array_shift</span><span class="p">(</span><span class="nv">$csv</span><span class="p">);</span> <span class="c1"># remove column header</span>

  <span class="cm">/*
   * The above code produces arrays of values for the CSV file:
   * [0] =&gt;[
          [Num] =&gt; 1
          [Program] =&gt; 852061
          [Expectation] =&gt; 852076
          [Correlation] =&gt; 852081
          [SKIP] =&gt; N
          [Romanette] =&gt; i
          [KSS-SE] =&gt; met
          [xofy] =&gt; 1 1 1 1
          [Citations] =&gt; SN, SA
          [BrkStatus] =&gt; complete
          [ExpecStatus] =&gt; unmet
      ]
   * Use this code to display it on screen:
   * echo '&lt;pre&gt;';
   * print_r($csv);
   * echo '&lt;/pre&gt;';
   *
   */</span>
  <span class="k">return</span> <span class="nv">$csv</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is the CSV file:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>**Num**,**Program**,**Expectation**,**Correlation**,**SKIP**,**Romanette**,**KSS-SE**,**xofy**,**Citations**,**BrkStatus**,**ExpecStatus\
1**,**852061**,**852076**,**852081**,**N**,**i**,**1.A**,**\"1, 1, 1,
1\"**,**\"SN, SA\"**,**met**,**unmet\
2**,**852061**,**852076**,**852086**,**N**,**ii**,**1.A**,**\"1, 1, 1,
1\"**,**\"SN, SA, TN, TA\"**,**met**,**unmet\
3**,**852061**,**852076**,**852091**,**N**,**iii**,**1.A**,**\"0, 1, 0,
1\"**,**SA**,**unmet**,**unmet\
4**,**852061**,**852076**,**852096**,**N**,**iv**,**1.A**,**\"0, 1, 0,
1\"**,**SA**,**unmet**,**unmet\
5**,**852061**,**852161**,**852166**,**N**,**i**,**1.B**,**\"0, 0 ,1,
1\"**,**\"TN, TA\"**,**unmet**,**unmet\
6**,**852061**,**852161**,**852171**,**N**,**ii**,**1.B**,**\"0, 1, 1,
1\"**,**\"SA, SA, SA, SA, TN, TA\"**,**unmet**,**unmet\
7**,**852061**,**852101**,**852106**,**N**,**i**,**2.A**,,**\"TN, TN,
TN, TN, TA\"**,**unmet**,**unmet\
8**,**852061**,**852101**,**852111**,**N**,**ii**,**2.A**,,**\"SN, SA,
SA, TN, TN, TA, TA\"**,**met**,**unmet\
9**,**852061**,**852116**,**852121**,**N**,**i**,**2.B**,,**\"SN,
TA\"**,**unmet**,**unmet\
10**,**852061**,**852116**,**852126**,**N**,**ii**,**2.B**,,**\"SN,
SA\"**,**unmet**,**unmet\
11**,**852061**,**852131**,**852136**,**N**,**i**,**3.A**,,**\"SN, SN,
SN, SN, SA, SA, SA, SA\"**,**met**,**met\
12**,**852061**,**852131**,**852141**,**N**,**ii**,**3.A**,,**TN**,**met**,**met\
13**,**852061**,**852146**,**852151**,**N**,**i**,**3.B**,,**TA**,**met**,**met\
14**,**852061**,**852146**,**852156**,**N**,**ii**,**3.B**,,**\"TN,
TA\"**,**met**,**met**
</code></pre></div></div><p>Picture of CSV file with color formatting:</p><p><img alt="CSV in color" src="https://selwynpolit.github.io/d9book/assets/images/csv-in-color.png"/></p><h1 id="adding-dtt-to-an-existing-site"> <a aria-labelledby="adding-dtt-to-an-existing-site" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#adding-dtt-to-an-existing-site"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Adding DTT to an existing site</h1><h2 id="install-dtt-and-dev-requirements-with"> <a aria-labelledby="install-dtt-and-dev-requirements-with" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#install-dtt-and-dev-requirements-with"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Install DTT and dev requirements with:</h2><p>Follow these steps to quickly get DTT running on your project.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require weitzman/drupal-test-traits --dev

$ composer require drupal/core-dev --dev --update-with-all-dependencies
</code></pre></div></div><p>Setup <code class="language-plaintext highlighter-rouge">phpunit.xml</code> in the root of the project (not docroot or web). There will usually be a <code class="language-plaintext highlighter-rouge">phpunit.xml.dist</code> file there. Use that file and add your tweaks to it using <a href="https://gitlab.com/weitzman/drupal-test-traits/-/blob/master/docs/phpunit.xml">https://gitlab.com/weitzman/drupal-test-traits/-/blob/master/docs/phpunit.xml</a> as the basis.</p><h2 id="create-phpunitxml-file"> <a aria-labelledby="create-phpunitxml-file" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#create-phpunitxml-file"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Create phpunit.xml file</h2><p>My <code class="language-plaintext highlighter-rouge">phpunit.xml.dist</code>:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="nt">&lt;phpunit</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"http://schema.phpunit.de/4.1/phpunit.xsd"</span>
         <span class="na">backupGlobals=</span><span class="s">"false"</span>
         <span class="na">colors=</span><span class="s">"true"</span>
         <span class="na">bootstrap=</span><span class="s">"vendor/autoload.php"</span>
         <span class="na">verbose=</span><span class="s">"true"</span>
        <span class="nt">&gt;</span>
    <span class="nt">&lt;testsuites&gt;</span>
        <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"drupal-composer-project tests"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;directory&gt;</span>./test/<span class="nt">&lt;/directory&gt;</span>
        <span class="nt">&lt;/testsuite&gt;</span>
    <span class="nt">&lt;/testsuites&gt;</span>
<span class="nt">&lt;/phpunit&gt;</span>
</code></pre></div></div><p>My phpunit.xml with edits for site tea3.ddev.site. replace tea3 with the sitename for your ddev site in the <code class="language-plaintext highlighter-rouge">&lt;env name="DTT_BASE_URL" value="http://tea3.ddev.site"/&gt;</code>.</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="nt">&lt;phpunit</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"http://schema.phpunit.de/4.1/phpunit.xsd"</span>
         <span class="na">backupGlobals=</span><span class="s">"false"</span>
         <span class="na">colors=</span><span class="s">"true"</span>
         <span class="na">bootstrap=</span><span class="s">"scripts/bootstrap-fast.php"</span>
         <span class="na">verbose=</span><span class="s">"true"</span>
        <span class="nt">&gt;</span>
  <span class="nt">&lt;php&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_BASE_URL"</span> <span class="na">value=</span><span class="s">"http://tea3.ddev.site"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_API_URL"</span> <span class="na">value=</span><span class="s">"http://chrome:9222"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_MINK_DRIVER_ARGS"</span> <span class="na">value=</span><span class="s">'["chrome", {"browserName":"chrome","chromeOptions":{"args":["--disable-gpu","--headless", "--no-sandbox"]}}, "http://chromedriver:9515"]'</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"DTT_API_OPTIONS"</span> <span class="na">value=</span><span class="s">'{"socketTimeout": 360, "domWaitTimeout": 3600000}'</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- Example BROWSERTEST_OUTPUT_DIRECTORY value: /tmp
         Specify a temporary directory for storing debug images and html documents.
         These artifacts get copied to /sites/simpletest/browser_output by BrowserTestBase. --&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"BROWSERTEST_OUTPUT_DIRECTORY"</span> <span class="na">value=</span><span class="s">"/tmp"</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- To disable deprecation testing completely uncomment the next line. --&gt;</span>
    <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"SYMFONY_DEPRECATIONS_HELPER"</span> <span class="na">value=</span><span class="s">"disabled"</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- Specify the default directory screenshots should be placed. --&gt;</span>
    <span class="c">&lt;!--&lt;env name="DTT_SCREENSHOT_REPORT_DIRECTORY" value=""/&gt;--&gt;</span>
    <span class="c">&lt;!-- Specify the default directory page captures should be placed.
        When using the \Drupal\Tests\Listeners\HtmlOutputPrinter printerClass this will default to
        /sites/simpletest/browser_output. If using another printer such as teamcity this must be defined.
        --&gt;</span>
    <span class="c">&lt;!--&lt;env name="DTT_HTML_OUTPUT_DIRECTORY" value=""/&gt;--&gt;</span>
  <span class="nt">&lt;/php&gt;</span>
  <span class="nt">&lt;testsuites&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"drupal-composer-project tests"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;directory&gt;</span>./test/<span class="nt">&lt;/directory&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"unit"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;directory&gt;</span>./web/modules/custom/*/tests/src/Unit<span class="nt">&lt;/directory&gt;</span>
      <span class="c">&lt;!--&lt;directory&gt;./web/profiles/custom/*/tests/src/Unit&lt;/directory&gt;--&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"kernel"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;directory&gt;</span>./web/modules/custom/*/tests/src/Kernel<span class="nt">&lt;/directory&gt;</span>
      <span class="c">&lt;!--&lt;directory&gt;./web/profiles/custom/*/tests/src/Kernel&lt;/directory&gt;--&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"existing-site"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- Assumes tests are namespaced as \Drupal\Tests\custom_foo\ExistingSite. --&gt;</span>
      <span class="nt">&lt;directory&gt;</span>./web/modules/custom/*/tests/src/ExistingSite<span class="nt">&lt;/directory&gt;</span>
      <span class="c">&lt;!--&lt;directory&gt;./web/profiles/custom/*/tests/src/ExistingSite&lt;/directory&gt;--&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">"existing-site-javascript"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- Assumes tests are namespaced as \Drupal\Tests\custom_foo\ExistingSiteJavascript. --&gt;</span>
      <span class="nt">&lt;directory&gt;</span>./web/modules/custom/*/tests/src/ExistingSiteJavascript<span class="nt">&lt;/directory&gt;</span>
      <span class="c">&lt;!--&lt;directory&gt;./web/profiles/custom/*/tests/src/ExistingSiteJavascript&lt;/directory&gt;--&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
  <span class="nt">&lt;/testsuites&gt;</span>
<span class="nt">&lt;/phpunit&gt;</span>
</code></pre></div></div><h2 id="create-bootstrap-fastphp"> <a aria-labelledby="create-bootstrap-fastphp" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#create-bootstrap-fastphp"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Create bootstrap-fast.php</h2><p>Create <code class="language-plaintext highlighter-rouge">/scripts/bootstrap-fast.php</code> with the following contents</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="cd">/**
 * @file
 *   A bootstrap file for `phpunit` test runner.
 *
 * This bootstrap file from DTT is fast and customizable.
 *
 * If you get 'class not found' errors while running tests, you should copy this
 * file to a location inside your code-base --such as `/scripts`. Then add the
 * missing namespaces to the bottom of the copied field. Specify your custom
 * `bootstrap-fast.php` file as the bootstrap in `phpunit.xml`.
 *
 * Alternatively, use the bootstrap.php file, in this same directory, which is
 * slower but registers all the namespaces that Drupal tests expect.
 */</span>

<span class="kn">use</span> <span class="nc">Drupal\TestTools\PhpUnitCompatibility\PhpUnit8\ClassWriter</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">weitzman\DrupalTestTraits\AddPsr4</span><span class="p">;</span>

<span class="k">list</span><span class="p">(</span><span class="nv">$finder</span><span class="p">,</span> <span class="nv">$class_loader</span><span class="p">)</span> <span class="o">=</span> <span class="nc">AddPsr4</span><span class="o">::</span><span class="nf">add</span><span class="p">();</span>
<span class="nv">$root</span> <span class="o">=</span> <span class="nv">$finder</span><span class="o">-&gt;</span><span class="nf">getDrupalRoot</span><span class="p">();</span>

<span class="c1">// So that test cases may be simultaneously compatible with multiple major versions of PHPUnit.</span>
<span class="nv">$class_loader</span><span class="o">-&gt;</span><span class="nf">addPsr4</span><span class="p">(</span><span class="s1">'Drupal\TestTools\\'</span><span class="p">,</span> <span class="s2">"</span><span class="nv">$root</span><span class="s2">/core/tests"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">class_exists</span><span class="p">(</span><span class="s1">'Drupal\TestTools\PhpUnitCompatibility\PhpUnit8\ClassWriter'</span><span class="p">))</span> <span class="p">{</span>
  <span class="nc">ClassWriter</span><span class="o">::</span><span class="nf">mutateTestBase</span><span class="p">(</span><span class="nv">$class_loader</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Register more namespaces, as needed.</span>
<span class="c1"># $class_loader-&gt;addPsr4('Drupal\Tests\my_module\\', "$root/modules/custom/my_module/tests/src");</span>
</code></pre></div></div><h2 id="add-phpunitresultcache-file-to-gitignore"> <a aria-labelledby="add-phpunitresultcache-file-to-gitignore" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#add-phpunitresultcache-file-to-gitignore"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Add .phpunit.result.cache file to .gitignore</h2><p>To stop result cache getting checked into the repo, add the <code class="language-plaintext highlighter-rouge">.phpunit.result.cache</code> to the <code class="language-plaintext highlighter-rouge">.gitignore file</code>.</p><p>You could also change this file location by editing phpunit.xml:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;phpunit</span> 
    <span class="err">...</span>
    <span class="na">cacheResultFile=</span><span class="s">"../.temp/fs_cache/.phpunit.result.cache"</span>
<span class="nt">&gt;</span>
</code></pre></div></div><p>Or completely disable it by:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;phpunit</span> 
    <span class="err">...</span>
    <span class="na">cacheResult =</span><span class="s">"false"</span>
<span class="nt">&gt;</span>
</code></pre></div></div><h2 id="remove-dtt-and-core-dev"> <a aria-labelledby="remove-dtt-and-core-dev" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#remove-dtt-and-core-dev"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Remove DTT and core-dev</h2><p>For production deployment, you can remove DTT and core-dev with:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer remove drupal/core-dev --dev

$ composer remove weitzman/drupal-test-traits --dev
</code></pre></div></div><p>Alternatively, just run</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer update --no-dev
</code></pre></div></div><h2 id="hide-deprecation-notices"> <a aria-labelledby="hide-deprecation-notices" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#hide-deprecation-notices"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Hide deprecation notices</h2><p>To hide deprecation notices when running test on the host, update your php.ini (run <code class="language-plaintext highlighter-rouge">php --ini</code> to find the php.ini file) and change the error_reporting line from:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error_reporting = E_ALL
</code></pre></div></div><p>to:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error_reporting = E_ALL &amp; ~E_DEPRECATE
</code></pre></div></div><p>Now tests should look like this:</p><blockquote><p>$ vendor/bin/phpunit docroot/modules/custom/tea_teks/modules/tea_teks_voting/tests/src/ExistingSite/VotingPageTest.php</p><p>PHPUnit 9.5.24 #StandWithUkraine</p><p>Runtime: PHP 8.1.9</p><p>Configuration: /Users/selwyn/Sites/tea/phpunit.xml</p><p>. 1 / 1 (100%)</p><p>Time: 00:00.830, Memory: 46.50 MB</p><p>OK (1 test, 3 assertions)</p></blockquote><h1 id="troubleshooting-dtt-tests"> <a aria-labelledby="troubleshooting-dtt-tests" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#troubleshooting-dtt-tests"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Troubleshooting DTT Tests</h1><h2 id="which-test"> <a aria-labelledby="which-test" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#which-test"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Which test?</h2><p>For tests that involve the Drupal API, if a test fails, you might see output like this:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1) Drupal\Tests\tea_teks_requirements\ExistingSite\Requirements1Test::testEmptyRequirements
ArgumentCountError: Too few arguments to function Drupal\Core\Entity\EntityBase::load(), 0 passed in /var/www/html/web/modules/custom/tea_teks_requirements/tests/src/ExistingSite/Requirements1Test.php on line 13 and exactly 1 expected
</code></pre></div></div><p>This is indicating the first test by: “1)”. If this were the second test in the file, it would show “2)”. The error is that too few arguments were passed to EntityBase::load() – in my case, I was passing null to a Node::load() function.</p><h2 id="polyfillasserttrait-not-found"> <a aria-labelledby="polyfillasserttrait-not-found" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#polyfillasserttrait-not-found"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> PolyfillAssertTrait not found</h2><p>After installing DTT you see errors when you try to run the tests like this:</p><blockquote><p>selwyn@tea3-web:/var/www/html$ ./vendor/bin/phpunit --bootstrap=./vendor/weitzman/drupal-test-traits/src/bootstrap-fast.php ./docroot/modules/custom/tea_teks/modules/tea_teks_requirements/tests/src/ExistingSite/RequirementsCreationTest.php</p><p>PHP Fatal error: Trait "Symfony\Bridge\PhpUnit\Legacy\PolyfillAssertTrait" not found in /var/www/html/docroot/sites/simpletest/Assert.php on line 91</p><p>Fatal error: Trait "Symfony\Bridge\PhpUnit\Legacy\PolyfillAssertTrait" not found in /var/www/html/docroot/sites/simpletest/Assert.php on line 91</p></blockquote><p>You will need to install the dev requirements with:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ composer require drupal/core-dev --dev
--update-with-all-dependencies
</code></pre></div></div><h2 id="class-not-found-errors"> <a aria-labelledby="class-not-found-errors" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#class-not-found-errors"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Class not found errors</h2><p>If you see something like this on your brand new class you created:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1) Drupal\Tests\tea_teks_voting\ExistingSite\ProgramTest::testIsVotingPermitted
Error: Class "Drupal\tea_teks_voting\Program" not found
</code></pre></div></div><p>This is a real forehead slapper! Be sure to enable your custom module under Drupal’s extend menu option.</p><p>Also</p><p>When running the tests, if they start throwing “class not found” errors, this may indicate some outdated code in your codebase.</p><blockquote><p>$ vendor/bin/phpunit docroot/modules/custom/tea_teks/modules/tea_teks_voting/Tests/src/ExistingSite/RequirementsCreationTest.php</p><p>PHP Fatal error: Uncaught Error: Class "PHPUnit\TextUI\Command" not found in /var/www/html/vendor/phpunit/phpunit/phpunit:98</p><p>Stack trace:</p><p>#0 /var/www/html/vendor/bin/phpunit(123): include()</p><p>#1 {main}</p><p>thrown in /var/www/html/vendor/phpunit/phpunit/phpunit on line 98</p><p>Fatal error: Uncaught Error: Class "PHPUnit\TextUI\Command" not found in /var/www/html/vendor/phpunit/phpunit/phpunit:98</p><p>Stack trace:</p><p>#0 /var/www/html/vendor/bin/phpunit(123): include()</p><p>#1 {main}</p><p>thrown in /var/www/html/vendor/phpunit/phpunit/phpunit on line 98</p></blockquote><p>The fix in this case was a composer update.</p><p>Also If you use another test as a starting point (ie. Copy the file) and forget to change the class name, that would cause a similar error:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vendor/bin/phpunit docroot/modules/custom/tea_teks/modules/tea_teks_voting/tests/src/ExistingSite/PersonaTest.php

Class 'PersonaTest' could not be found in '/Users/selwyn/Sites/tea/docroot/modules/custom/tea_teks/modules/tea_teks_voting/tests/src/ExistingSite/PersonaTest.php'.
</code></pre></div></div><p>In this example, the filename was PersonaTest.php but the class name is accidentally called TeamTest so the interpreter could not find a PersonaTest. Oops. Here is the errant <code class="language-plaintext highlighter-rouge">PersonaTest.php</code> file:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\Tests\tea_teks_voting\ExistingSite</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\node\Entity\Node</span><span class="p">;</span>
<span class="kn">use</span> <span class="nf">Drupal\tea_teks_voting</span><span class="nc">\Persona</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">weitzman\DrupalTestTraits\ExistingSiteBase</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TeamTest</span> <span class="kd">extends</span> <span class="nc">ExistingSiteBase</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">testPersonaEmptyLoading</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$p</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Persona</span><span class="p">();</span>
    <span class="nv">$user_id</span> <span class="o">=</span> <span class="nv">$p</span><span class="o">-&gt;</span><span class="nf">getUserId</span><span class="p">();</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">assertEquals</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><h2 id="var_dump-echo-print"> <a aria-labelledby="var_dump-echo-print" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#var_dump-echo-print"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> var_dump, echo, print</h2><p>For quick variable dumps, it is quite valid to use var_dump in your tests. Here is a test with a var_dump() call.</p><p>You can also print or echo variables e.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// \n will put this output on a new line.</span>
<span class="nv">$temp</span> <span class="o">=</span> <span class="s2">"blah"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Results = </span><span class="nv">$temp</span><span class="s2">"</span><span class="p">;</span>
<span class="k">print</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Results = </span><span class="nv">$temp</span><span class="s2">"</span><span class="p">;</span>
</code></pre></div></div><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\Tests\tea_teks_voting\ExistingSite</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\node\Entity\Node</span><span class="p">;</span>
<span class="kn">use</span> <span class="nf">Drupal\tea_teks_voting</span><span class="nc">\Team</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">weitzman\DrupalTestTraits\ExistingSiteBase</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">TeamTest</span> <span class="kd">extends</span> <span class="nc">ExistingSiteBase</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">testTeamLoading</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Team D - Voter 1, 2, 3</span>
    <span class="c1">// 5101, 5106, 5116</span>
    <span class="nv">$t</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Team</span><span class="p">(</span><span class="mi">868296</span><span class="p">);</span>
    <span class="nv">$team_member_info</span> <span class="o">=</span> <span class="nv">$t</span><span class="o">-&gt;</span><span class="nf">getTeamMemberInfo</span><span class="p">(</span><span class="mi">5101</span><span class="p">);</span>
    <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$team_member_info</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="nv">$team_member_info</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span> <span class="s1">'Voter 1'</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="nv">$team_member_info</span><span class="p">[</span><span class="s1">'fullname'</span><span class="p">],</span> <span class="s1">'Voter 1 Test'</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="nv">$team_member_info</span><span class="p">[</span><span class="s1">'mail'</span><span class="p">],</span> <span class="s1">'voter1@mightycitizen.com'</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="nv">$team_member_info</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'authenticated'</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertSame</span><span class="p">(</span><span class="nv">$team_member_info</span><span class="p">[</span><span class="s1">'roles'</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="s1">'srp_voter'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is the output. Note. I removed the deprecated messages for clarity. First the command to run the test:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vendor/bin/phpunit docroot/modules/custom/tea_teks/modules/tea_teks_voting/tests/src/ExistingSite/TeamTest.php
</code></pre></div></div><p>and the output:</p><blockquote><p>PHPUnit 9.5.24 #StandWithUkraine</p><p>Runtime: PHP 8.1.9</p><p>Configuration: /Users/selwyn/Sites/tea/phpunit.xml</p><p>.</p><p>1 / 1 (100%)</p><p>array(11) {</p><p>["uid"]=&gt; string(4) "5101"</p><p>["fullname"]=&gt; string(12) "Voter 1 Test"</p><p>["name"]=&gt; string(7) "Voter 1"</p><p>["mail"]=&gt; string(24) "voter1@mightycitizen.com"</p><p>["status"]=&gt; string(1) "1"</p><p>["firstname"]=&gt; string(7) "Voter 1"</p><p>["lastname"]=&gt; string(4) "Test"</p><p>["title"]=&gt; NULL</p><p>["phone"]=&gt; NULL</p><p>["roles"]=&gt; array(2) {</p><p>[0]=&gt; string(13) "authenticated"</p><p>[1]=&gt; string(9) "srp_voter"</p><p>}</p><p>["voter_role"]=&gt; string(8) "educator"</p><p>}</p><p>Time: 00:00.773, Memory: 44.50 MB</p><p>OK (1 test, 5 assertions)</p></blockquote><h1 id="using-xdebug-and-phpstorm-to-debug-dtt-scripts"> <a aria-labelledby="using-xdebug-and-phpstorm-to-debug-dtt-scripts" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#using-xdebug-and-phpstorm-to-debug-dtt-scripts"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Using Xdebug and PHPStorm to debug DTT scripts</h1><p>It is easiest to make sure you have PHPStorm Xdebug working first, then make sure the path mappings are correct. Note. This process is almost identical to debugging drush commands.</p><p><img alt="Path mappings" src="https://selwynpolit.github.io/d9book/assets/images/path-mappings.png"/></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ddev exec enable_xdebug

$ ddev ssh
</code></pre></div></div><p>Note. Servername has to match the servername in your phpstorm setup on a per project – see screenshot below.</p><p>Sometimes this step doesn’t seem to be required. Not sure why.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ export PHP_IDE_CONFIG=\"serverName=tea.ddev.site\"
</code></pre></div></div><p>(the tea part above needs to match your ddev project name. e.g. drupal.ddev.site or selwyn.ddev.site etc.)</p><p>click listen in PHPStorm</p><p>click on the line number in PHPStorm to set a breakpoint</p><p>Issue the phpunit command in the vendor directory:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vendor/bin/phpunit
docroot/modules/custom/tea_teks/modules/tea_teks_requirements/Tests/src/ExistingSite/RequirementsCreationTest.php
</code></pre></div></div><p>When Phpstorm pops up, specify that the vendor directory is at <code class="language-plaintext highlighter-rouge">/var/www/html/vendor</code> - note you only have to do that once and then PHPStorm will remember it.</p><h1 id="resources"> <a aria-labelledby="resources" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#resources"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Resources</h1><h2 id="general"> <a aria-labelledby="general" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#general"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> General</h2><ul><li><p>Video intro to DTT with Moshe Weitzman from DrupalCon Global Sep 2020 <a href="https://www.youtube.com/watch?v=TExPFQ1-AA0&amp;t=10s">https://www.youtube.com/watch?v=TExPFQ1-AA0&amp;t=10s</a></p><li><p>Unit Tests in Drupal: the road to test-driven development video from DrupalCon Global 2020 by CivicActions folks: Gerardo Gonzalez and Eric Napier. This gets into the details but is hard to make out the code as it is small. <a href="https://www.youtube.com/watch?v=UGg3G0dsAGw">https://www.youtube.com/watch?v=UGg3G0dsAGw</a></p><li><p>Understanding Automated Tests in Drupal video from DrupalGov 2020 by Ridhima Abrol &amp; Sujeet Kumar Verma. They are showing examples using MAMP. This covers unit vs kernel vs functional vs functional JS. There are fairly legible code examples. <a href="https://www.youtube.com/watch?v=kQEMnk4boP4&amp;list=TLPQMTcwODIwMjKbpqkPMTkhyA&amp;index=4">https://www.youtube.com/watch?v=kQEMnk4boP4&amp;list=TLPQMTcwODIwMjKbpqkPMTkhyA&amp;index=4</a></p><li><p>How to unit test your code in Drupal 8 video by Daniel Nitsche for DrupalSouth 2017 1-10-2017 (Loft??). Australian chap (very hands-on) going through live demo on PHPStorm running phpunit on Drupal 8. Using mockery. <a href="https://www.youtube.com/watch?v=7FjjZ3OoD6Y">https://www.youtube.com/watch?v=7FjjZ3OoD6Y</a></p><li><p>Running and debugging PHPUnit tests in PHPStorm with ddev and xdebug video by Australian Michael Strelan on 8-18-21. The audio is very soft. He walks through details of setting up PHPStorm for DDEV etc. <a href="https://www.youtube.com/watch?v=OdoEyY8Kl9w">https://www.youtube.com/watch?v=OdoEyY8Kl9w</a> . There is also a companion article from Michael Strelan at <a href="https://www.previousnext.com.au/blog/running-and-debugging-phpunit-tests-phpstorm-ddev-and-xdebug">https://www.previousnext.com.au/blog/running-and-debugging-phpunit-tests-phpstorm-ddev-and-xdebug</a> and a repo: <a href="https://github.com/mstrelan/ddev-phpunit-demo">https://github.com/mstrelan/ddev-phpunit-demo</a>. It is useful to mention that since this video was created there is a <a href="https://plugins.jetbrains.com/plugin/18813-ddev-integration">DDEV integration plugin</a> for PHPStorm which automatically configures things like path mappings, cli interpreters and phpunit configuration. This makes some of what he describes a lot easier.</p><li><p>From a discord chat with Randy Fey and \@shaal. This may be useful to explore phpunit tests on tugboat when we get that all set up. Here's a good PR where we added phpunit into DrupalPod <a href="https://github.com/shaal/DrupalPod/pull/41/files">https://github.com/shaal/DrupalPod/pull/41/files</a></p><li><p>Benji Fisher Drupal Testing repo from February 2022. Benji set up this repository to help with testing Drupal modules for coding standards and Drupal 10 compatibility.It is based on drupal/recommended-project with some parts borrowed from Matt Glaman's <a href="https://github.com/bluehorndigital/drupal-testing-workshop">Drupal &amp; Nightwatch.js training</a> . Main features: DDev configuration (mostly standard), upgrade Status module, custom DDev commands phpunit, phpcs, phpcbf, Docker config to support PHPUnit testing. - <a href="https://github.com/benjifisher/drupal-testing">https://github.com/benjifisher/drupal-testing</a></p><li><p>The abovementioned Matt Glaman’s repo from March 2021 on Drupal &amp; Nightwatch.js training. This repository is based on a Composer build and not meant for core contributions, it is fine for contrib. - <a href="https://github.com/bluehorndigital/drupal-testing-workshop">https://github.com/bluehorndigital/drupal-testing-workshop</a></p><li><p>And its companion website with some details on how to get tests running: <a href="https://bluehorndigital.github.io/drupal-testing-workshop/getting-tests-running/ddev.html">https://bluehorndigital.github.io/drupal-testing-workshop/getting-tests-running/ddev.html</a></p><li><p>Generating tests with drush: <a href="https://www.drush.org/latest/generators/">https://www.drush.org/latest/generators/</a></p></li></li></li></li></li></li></li></li></li></li></ul><h2 id="documentation"> <a aria-labelledby="documentation" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#documentation"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Documentation</h2><ul><li>Mink documentation: <a href="https://mink.behat.org/en/latest/">https://mink.behat.org/en/latest/</a></li></ul><h2 id="testing-setup"> <a aria-labelledby="testing-setup" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#testing-setup"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Testing setup</h2><ul><li><p>Debug any of Drupal's PHPUnit tests in PhpStorm with a DDEV-Local Environment from August 3, 2021 by Joe Shindelar. Includes how to set up Chromedriver in DDEV: <a href="https://drupalize.me/blog/debug-any-drupals-phpunit-tests-phpstorm-ddev-local-environment">https://drupalize.me/blog/debug-any-drupals-phpunit-tests-phpstorm-ddev-local-environment</a></p><li><p>Joe references this article from 5-13-2021 called Update 2021 - Fully integrate DDEV and PHPStorm - including Unit Tests with Coverage by \@sasunegomo <a href="https://susi.dev/fully-integrate-ddev-and-phpstorm-including-unit-tests-with-coverage-update-2021/">https://susi.dev/fully-integrate-ddev-and-phpstorm-including-unit-tests-with-coverage-update-2021/</a></p><li><p>Setup Behat for Drupal 8/9 with DDEV-Local and Selenium Recipe on Github as part of the ddev-contrib repo from July 2021 by Mike Miles: <a href="https://github.com/drud/ddev-contrib/tree/master/docker-compose-services/drupal8-behat-selenium">https://github.com/drud/ddev-contrib/tree/master/docker-compose-services/drupal8-behat-selenium</a></p><li><p>Randy Fay lays out some details about running Selenium/Behat inside DDEV containers in August 2020 <a href="https://stackoverflow.com/questions/51527663/running-selenium-tests-using-behat-drupal-extension-inside-ddev-containers">https://stackoverflow.com/questions/51527663/running-selenium-tests-using-behat-drupal-extension-inside-ddev-containers</a></p><li><p>Running and debugging PHPUnit tests in PHPStorm with DDev and xdebug from 8-19-21 by Michael Strelan of Australia which includes 15 minute video showing all this. You can also checkout the <a href="https://github.com/mstrelan/ddev-phpunit-demo">ddev-phpunit-demo</a> repo if you want to try it out yourself with DDev and PHPUnit pre-configured. <a href="https://www.previousnext.com.au/blog/running-and-debugging-phpunit-tests-phpstorm-ddev-and-xdebug">https://www.previousnext.com.au/blog/running-and-debugging-phpunit-tests-phpstorm-ddev-and-xdebug</a></p><li><p>Matt Glaman’s Guide to Test-Driven Development with DDEV and Drupal by Heather McNamee 1-30-2019. She runs through the series of 2018 articles that Matt published</p><ul><li><p><strong>Part 1. <a href="https://glamanate.com/blog/running-drupals-phpunit-test-suites-ddev">Running Drupal’s PHPUnit test suites on DDEV</a>.</strong> How to execute PHPUnit from within the web container in DDEV for Unit, Kernel, and Functional tests.</p><li><p><strong>Part 2. <a href="https://glamanate.com/blog/running-drupals-functionaljavascript-tests-ddev">Running Drupal’s FunctionalJavascript tests on DDEV</a>.</strong> How to Chromedriver running to execute the FunctionalJavascript test suite.</p><li><p><strong>Part 3. <a href="https://glamanate.com/blog/running-drupals-nightwatch-test-suite-ddev">Running Drupal’s Nightwatch test suite on DDEV</a>.</strong> How to run Drupal’s newest testing framework: Nightwatch.js, for end-to-end tests in Node.js run against a Selenium/WebDriver server.</p></li></li></li></ul><li><p>Running Drupal’s PHPUnit test suites on DDEV by Matt Glaman from October 2018. The first in his series referenced above <a href="https://glamanate.com/blog/running-drupals-phpunit-test-suites-ddev">https://glamanate.com/blog/running-drupals-phpunit-test-suites-ddev</a></p><li><p>DDEV Contrib Repo <a href="https://github.com/drud/ddev-contrib">https://github.com/drud/ddev-contrib</a></p></li></li></li></li></li></li></li></li></ul><h2 id="mocking"> <a aria-labelledby="mocking" class="anchor-heading" href="https://selwynpolit.github.io/d9book/dtt#mocking"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Mocking</h2><ul><li><p>From Matthew Radcliffe mradcliffe \@mattkineme – Mocking Drupal: Unit Testing in Drupal 8 slides from a 2015 presentation at <a href="http://drupalcampohio.org/sites/default/files/slides/dco2015-mocking-drupal.pdf">http://drupalcampohio.org/sites/default/files/slides/dco2015-mocking-drupal.pdf</a></p><li><p>Drupal 8/9: Unit Test cases mocking the global Drupal object and Services by Vishwa Chikate - Talks about prophecy objecting mocking which is better than PHPunit’s built in mocking. https://medium.com/@vishwa.chikate/drupal-8-9-unit-test-cases-mocking-the-global-drupal-object-and-services-bc536477edff</p></li></li></ul><hr/> <script async="" crossorigin="anonymous" data-category="Q&amp;A" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMjY2NDE4" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="selwynpolit/d9book" data-repo-id="MDEwOlJlcG9zaXRvcnkzMjUxNTQ1Nzg=" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js"> </script><hr/><footer><p><a href="https://selwynpolit.github.io/d9book/dtt#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0"><span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"> <a href="http://www.selwynpolit.github.io/d9book" property="dct:title" rel="cc:attributionURL">Drupal at your fingertips</a> by <a href="http://www.drupal.org/u/selwynpolit" property="cc:attributionName" rel="cc:attributionURL dct:creator">Selwyn Polit</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="license noopener noreferrer" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" style="height:16px!important;vertical-align:text-bottom;"/> <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" style="height:16px!important;vertical-align:text-bottom;"/> </a></span></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0 mr-2"> Page last modified: <span class="d-inline-block">Jun 27 2023</span>.</p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/selwynpolit/d9book/tree/gh-pages/book/dtt.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
</body></link></meta></meta></meta></head></html>