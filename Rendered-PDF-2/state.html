<!DOCTYPE html>
<html lang="en-US"><head><meta charset="utf-8"/><meta content="IE=Edge" http-equiv="X-UA-Compatible"/><link href="https://selwynpolit.github.io/d9book/assets/css/just-the-docs-default.css" rel="stylesheet"/> <script async="" src="https://www.googletagmanager.com/gtag/js?id=8V22RQEJ71"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '8V22RQEJ71', { 'anonymize_ip': true }); </script> <script src="https://selwynpolit.github.io/d9book/assets/js/vendor/lunr.min.js"></script> <script src="https://selwynpolit.github.io/d9book/assets/js/just-the-docs.js"></script><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://selwynpolit.github.io/d9book/assets/images/favicon.ico" rel="icon" type="image/x-icon"/><title>State | Drupal Book</title><meta content="Jekyll v4.3.2" name="generator"><meta content="State" property="og:title"><meta content="en_US" property="og:locale"><meta content="Drupal at your fingertips" name="description"/><meta content="Drupal at your fingertips" property="og:description"/><link href="https://selwynpolit.github.io/d9book/d9book/state" rel="canonical"><meta content="https://selwynpolit.github.io/d9book/d9book/state" property="og:url"/><meta content="Drupal Book" property="og:site_name"/><meta content="website" property="og:type"/><meta content="summary" name="twitter:card"/><meta content="State" property="twitter:title"/> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Drupal at your fingertips","headline":"State","url":"https://selwynpolit.github.io/d9book/d9book/state"}</script><body> <a class="skip-to-main" href="https://selwynpolit.github.io/d9book/state#main-content">Skip to main content</a> <svg class="d-none" xmlns="http://www.w3.org/2000/svg"> <symbol id="svg-link" viewbox="0 0 24 24"><title>Link</title><svg class="feather feather-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"><title>Menu</title><svg class="feather feather-menu" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"><title>Expand</title><svg class="feather feather-chevron-right" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol class="feather feather-external-link" fill="none" height="24" id="svg-external-link" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"><title>Document</title><svg class="feather feather-file" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"><title>Search</title><svg class="feather feather-search" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"> <circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewbox="0 0 16 16"><title>Copy</title><svg class="bi bi-clipboard" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path> </svg> </symbol> <symbol id="svg-copied" viewbox="0 0 16 16"><title>Copied</title><svg class="bi bi-clipboard-check-fill" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a class="site-title lh-tight" href="https://selwynpolit.github.io/d9book/"> Drupal Book </a> <a class="site-button" href="https://selwynpolit.github.io/d9book/state" id="menu-button"> <svg class="icon" viewbox="0 0 24 24"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" class="site-nav" id="site-nav"><ul class="nav-list"><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/">Home</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/actions">Actions</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/attribution">Attribution</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/bq">Batch and Queue</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/blocks">Blocks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/caching">Caching</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/composer">Composer</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/config">Config</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/cron">Cron</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dates">Dates and Times</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/debugging">Debugging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/development">Development</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/drush">Drush</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/email">Email</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/entities">Entities</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/forms">Forms</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/general">General</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/off-island">Getting off the Island</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/hooks">Hooks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/learn">Learning</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/links">Links</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/logging">Logging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/menus">Menus</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/migrate">Migrate</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/modals">Modals</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/nodes-and-fields">Nodes and Fields</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/queries">Queries</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/redirects">Redirects</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/render">Render Arrays</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/routes">Routes</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/security">Security</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/services">Services</a><li class="nav-list-item active"><a class="nav-list-link active" href="https://selwynpolit.github.io/d9book/state">State</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/taxonomy">Taxonomy</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dtt">Tests</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/twig">Twig</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><ul class="nav-list"><li class="nav-list-item external"> <a class="nav-list-link external" href="https://github.com/selwynpolit/d9book/fork"> Fork me on GitHub <svg aria-labelledby="svg-external-link-title" viewbox="0 0 24 24"><use xlink:href="#svg-external-link"></use></svg> </a></li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div class="main-header" id="main-header"><div class="search"><div class="search-input-wrap"> <input aria-label="Search Drupal Book" autocomplete="off" class="search-input" id="search-input" placeholder="Search Drupal Book" tabindex="0" type="text"/> <label class="search-label" for="search-input"><svg class="search-icon" viewbox="0 0 24 24"><use xlink:href="#svg-search"></use></svg></label></div><div class="search-results" id="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a class="site-button" href="https://twitter.com/selwynpolit" rel="noopener noreferrer" target="_blank"> <img alt="Twitter logo" src="https://atuin.ru/demo/simple-icons/icons/twitter.svg" style="width: 30px; height: 30px;" title="Author in Twitter"/> </a><li class="aux-nav-list-item"> <a class="site-button" href="https://github.com/selwynpolit/d9book/tree/gh-pages" rel="noopener noreferrer" target="_blank"> <img alt="GitHub logo" src="https://atuin.ru/demo/simple-icons/icons/github.svg" style="width: 30px; height: 30px;" title="D9Book on GitHub"/> </a></li></li></ul></nav></div><div class="main-content-wrap" id="main-content-wrap"><div class="main-content" id="main-content" role="main"><h1 class="no_toc fw-500" id="state-api-tempstore-and-userdata"> <a aria-labelledby="state-api-tempstore-and-userdata" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#state-api-tempstore-and-userdata"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> State API, TempStore and UserData</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a aria-labelledby="table-of-contents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#table-of-contents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ul id="markdown-toc"><li><a href="https://selwynpolit.github.io/d9book/state#overview" id="markdown-toc-overview">Overview</a><li><a href="https://selwynpolit.github.io/d9book/state#state-api" id="markdown-toc-state-api">State API</a><ul><li><a href="https://selwynpolit.github.io/d9book/state#using-drush-to-read-the-state-api" id="markdown-toc-using-drush-to-read-the-state-api">Using Drush to read the State API</a><li><a href="https://selwynpolit.github.io/d9book/state#example-accessing-state-api" id="markdown-toc-example-accessing-state-api">Example accessing State API</a><li><a href="https://selwynpolit.github.io/d9book/state#long-strings-broken-into-paragraphs" id="markdown-toc-long-strings-broken-into-paragraphs">Long strings broken into paragraphs</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/state#userdata" id="markdown-toc-userdata">UserData</a><li><a href="https://selwynpolit.github.io/d9book/state#tempstore" id="markdown-toc-tempstore">TempStore</a><ul><li><a href="https://selwynpolit.github.io/d9book/state#privatetempstore" id="markdown-toc-privatetempstore">PrivateTempStore</a><li><a href="https://selwynpolit.github.io/d9book/state#sharedtempstore" id="markdown-toc-sharedtempstore">SharedTempStore</a><ul><li><a href="https://selwynpolit.github.io/d9book/state#injecting-tempstoreshared" id="markdown-toc-injecting-tempstoreshared">Injecting tempstore.shared</a></li></ul></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/state#reference" id="markdown-toc-reference">Reference</a></li></li></li></li></li></ul><p><img alt="views" src="https://api.visitor.plantree.me/visitor-badge/pv?label=views&amp;color=informational&amp;namespace=d9book&amp;key=state.md"/></p><hr/><h2 id="overview"> <a aria-labelledby="overview" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#overview"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Overview</h2><p>The State API, TempStore API, and UserData are all storage mechanisms in Drupal. There is some overlap in their capabilities however they can be used for different purposes. Here is a brief explanation of each:</p><p><strong>State API:</strong> This provides a global way to store key-value pairs of data that need to persist between page loads or can be shared across different parts of the website. It is used to persist data such as cron key, last cron run, system last check for updates, installation time and whether the system is in maintenance mode. It is like configuration data except it can't be exported (and imported) and stored in source code, thereby making it a little more secure. Typically, configuration settings are exportable values used in modules, features, or installation profiles e.g. front page path.</p><p><strong>UserData:</strong> This allows you to store user-specific data (in key-value pairs) in a similar manner as the State API. Because the data is specific to each user, it is useful for custom user preferences or other user-specific information.</p><p><strong>TempStore:</strong> This provides a way to store user-specific data (also key-value pairs) that may be needed for a short period of time but does not need to be permanently stored. For example, it can be used to store data that is being edited in a form, allowing users to continue working on the form even if they navigate away from the page before saving the changes. It is also ideal for storing data such as the contents of a shopping cart. I’ve used tempstore to quickly access a list of nodes that need to be voted on by each voter. This means they don’t need to run a complex set of queries more than once.</p><p class="note">Similarly to TempStore, you can also use the Drupal cache system to load complicated data really quickly. I use this for storing arrays of nodes and data for a complicated voting application to improve scalability and performance.</p><h2 id="state-api"> <a aria-labelledby="state-api" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#state-api"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> State API</h2><p>The State API allows you to store small pieces of information specific to a site. This information is stored permanently in the database.</p><p>State API data is stored permanently in the key_value table. There is a <code class="language-plaintext highlighter-rouge">set()</code>, <code class="language-plaintext highlighter-rouge">get()</code> and <code class="language-plaintext highlighter-rouge">delete()</code> as well as <code class="language-plaintext highlighter-rouge">setMultiple()</code> and <code class="language-plaintext highlighter-rouge">getMultiple()</code> functions. The convention for the key name is to use periods(. or full-stops) to separate words. E.g. <code class="language-plaintext highlighter-rouge">my.state.data</code> or <code class="language-plaintext highlighter-rouge">emergency.header.message</code>. Underscores are also used e.g. <code class="language-plaintext highlighter-rouge">system.cron_key</code> or <code class="language-plaintext highlighter-rouge">system.cron_last</code>.</p><p>State settings are values which should usually not be exported to code, and only make sense in the context of one site. For example, cron key is a state setting whereas the front page path is a "config" variable.</p><p>To set a state value:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'system.cron_key'</span><span class="p">,</span> <span class="nb">md5</span><span class="p">(</span><span class="s2">"This is an example of a bad cron key"</span><span class="p">));</span> 
</code></pre></div></div><p>In contrast, this is how you set a config value:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">\Drupal</span><span class="o">::</span><span class="nf">configFactory</span><span class="p">()</span>
  <span class="o">-&gt;</span><span class="nf">getEditable</span><span class="p">(</span><span class="s1">'system.site'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'page.front'</span><span class="p">,</span> <span class="s1">'node/1'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span> 
</code></pre></div></div><p>In Drupal 7, this was done using variable_set(). If you are upgrading from a Drupal 7 site, check out this article from March 2021 about upgrading to the Drupal 8 State system at <a href="https://www.drupal.org/node/1787318">https://www.drupal.org/node/1787318</a></p><p>Writing state data looks like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'selwyn.important.string'</span><span class="p">,</span> <span class="s1">'abc'</span><span class="p">);</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'selwyn.more.important.string'</span><span class="p">,</span> <span class="s1">'def'</span><span class="p">);</span>
</code></pre></div></div><p>In the screenshot below, you can see where this is stored in the <code class="language-plaintext highlighter-rouge">key_value</code> table. Notice that the collection column is set to "state" indicating these are State API values.</p><p><img alt="State API data in its table" src="https://selwynpolit.github.io/d9book/assets/images/state_data1.png"/></p><h3 id="using-drush-to-read-the-state-api"> <a aria-labelledby="using-drush-to-read-the-state-api" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#using-drush-to-read-the-state-api"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Using Drush to read the State API</h3><p>You can use Drush to set, read or delete values in the State API: e.g. here we read the selwyn1 key value:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>drush ev <span class="s1">'return \Drupal::state()-&gt;get("selwyn1");'</span>
abc
</code></pre></div></div><h3 id="example-accessing-state-api"> <a aria-labelledby="example-accessing-state-api" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#example-accessing-state-api"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Example accessing State API</h3><p>Here is code that shows examples of setting, getting and deleting state values:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\state_examples\Controller</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Controller\ControllerBase</span><span class="p">;</span>

<span class="cd">/**
 * Returns responses for State API, TempStore and UserData Examples routes.
 */</span>
<span class="kd">class</span> <span class="nc">StateExamplesController</span> <span class="kd">extends</span> <span class="nc">ControllerBase</span> <span class="p">{</span>

  <span class="cd">/**
   * Builds the response.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">build1</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Set single value.</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'selwyn1'</span><span class="p">,</span> <span class="s1">'abc'</span><span class="p">);</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'selwyn2'</span><span class="p">,</span> <span class="s1">'def'</span><span class="p">);</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Retrieved State API data: selwyn1: %selwyn1 and selwyn2: %selwyn2 .'</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">'%selwyn1'</span> <span class="o">=&gt;</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'selwyn1'</span><span class="p">),</span>
        <span class="s1">'%selwyn2'</span> <span class="o">=&gt;</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'selwyn2'</span><span class="p">),</span>
      <span class="p">]),</span>
    <span class="p">];</span>

    <span class="c1">// Delete single value.</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nb">delete</span><span class="p">(</span><span class="s1">'selwyn1'</span><span class="p">);</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nb">delete</span><span class="p">(</span><span class="s1">'selwyn2'</span><span class="p">);</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Deleted (single) State API data.'</span><span class="p">),</span>
    <span class="p">];</span>

    <span class="c1">// Set multiple values.</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">setMultiple</span><span class="p">([</span><span class="s1">'selwyn1'</span> <span class="o">=&gt;</span> <span class="s1">'ghi'</span><span class="p">,</span> <span class="s1">'selwyn2'</span> <span class="o">=&gt;</span> <span class="s1">'jkl'</span><span class="p">]);</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Retrieved State API data: selwyn1: %selwyn1 and selwyn2: %selwyn2 .'</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">'%selwyn1'</span> <span class="o">=&gt;</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'selwyn1'</span><span class="p">),</span>
        <span class="s1">'%selwyn2'</span> <span class="o">=&gt;</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'selwyn2'</span><span class="p">),</span>
      <span class="p">]),</span>
    <span class="p">];</span>

    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">deleteMultiple</span><span class="p">([</span><span class="s1">'selwyn1'</span><span class="p">,</span> <span class="s1">'selwyn2'</span><span class="p">]);</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Deleted (multiple) State API data.'</span><span class="p">),</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><h3 id="long-strings-broken-into-paragraphs"> <a aria-labelledby="long-strings-broken-into-paragraphs" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#long-strings-broken-into-paragraphs"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Long strings broken into paragraphs</h3><p>If you store long strings, you can explode them into arrays of paragraphs for more control of their display.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$str</span> <span class="o">=</span> <span class="s1">'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque porttitor urna consequat dolor convallis iaculis. Nullam blandit ipsum eget odio semper rhoncus. 
Aenean libero tortor, ullamcorper vitae porttitor sit amet, posuere a ante. Vestibulum ipsum tellus, porta eu ligula at, porttitor congue nunc. Suspendisse felis lacus, tristique vel aliquam eget, congue non mi.'</span><span class="p">;</span>

<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'selwyn.long.string'</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>

<span class="c1">// Explode string into array of paragraphs. </span>
<span class="nv">$test2</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'selwyn.long.string'</span><span class="p">));</span>
</code></pre></div></div><h2 id="userdata"> <a aria-labelledby="userdata" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#userdata"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> UserData</h2><p>UserData is stored permanently in the users_data table. This is typically used for unstructured information pertaining to the user eg. user preferences, flags etc. I've used it to keep track of a user's progress in a complicated web application.</p><p>Here is an example where a value of <code class="language-plaintext highlighter-rouge">COMPLETED</code> is stored, read back and then deleted for the key <code class="language-plaintext highlighter-rouge">program.123.vote.0.finalized</code>:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">build4</span><span class="p">()</span> <span class="p">{</span>

  <span class="cd">/** @var \Drupal\user\UserDataInterface $userData */</span>
  <span class="nv">$userData</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'user.data'</span><span class="p">);</span>
  <span class="nv">$user_id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  
  <span class="nv">$userData</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'state_examples'</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">,</span> <span class="s1">'program.123.vote.0.finalized'</span><span class="p">,</span> <span class="s1">'COMPLETED'</span><span class="p">);</span>

  <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
    <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Retrieved User Data API data: %value1.'</span><span class="p">,</span> <span class="p">[</span>
      <span class="s1">'%value1'</span> <span class="o">=&gt;</span> <span class="nv">$userData</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'state_examples'</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">,</span> <span class="s1">'program.123.vote.0.finalized'</span><span class="p">),</span>
    <span class="p">]),</span>
  <span class="p">];</span>

  <span class="nv">$userData</span><span class="o">-&gt;</span><span class="nb">delete</span><span class="p">(</span><span class="s1">'state_examples'</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">,</span> <span class="s1">'program.123.vote.0.finalized'</span><span class="p">);</span>

  <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is the data stored in the <code class="language-plaintext highlighter-rouge">users_data</code> table. Notice that there is also some user data from the contact module as well as the data from the <code class="language-plaintext highlighter-rouge">state_examples</code> module that was created from the code above.</p><p><img alt="Users_data table" src="https://selwynpolit.github.io/d9book/assets/images/users_data_table.png"/></p><h2 id="tempstore"> <a aria-labelledby="tempstore" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#tempstore"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> TempStore</h2><p>TempStore is used to keep temporary data across multiple requests. The data is intended to be non-cache data (i.e. not easily be rebuilt) and is stored in the <code class="language-plaintext highlighter-rouge">key_value_expire</code> table.</p><p>TempStore has two flavors, private and shared. The difference between them is that the private TempStore entries are connected to a specific user (via their user id) whereas shared TempStore entries can be shared between multiple users. Shared TempStore could for example be used to trigger a locking mechanism.</p><h3 id="privatetempstore"> <a aria-labelledby="privatetempstore" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#privatetempstore"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> PrivateTempStore</h3><p>The Drupal <em>tempstore.private</em> service is used to allow temporary user data that is available from one web request to the next. It is intended to be used for non-cache data that cannot easily be rebuilt. This includes work-in-progress data that isn't ready to be saved permanently.</p><p>The temporary store is a key/value store and can therefore store anything from a single Boolean value to a serialized object. (adapted from <a href="https://www.hashbangcode.com/article/drupal-9-using-private-temporary-store-service">https://www.hashbangcode.com/article/drupal-9-using-private-temporary-store-service</a>)</p><p><strong>Stores and retrieves temporary data for a given owner.</strong></p><p>A PrivateTempStore can be used to make temporary, non-cache data available across requests. The data for the PrivateTempStore is stored in one key/value collection. PrivateTempStore data expires automatically after a given timeframe.</p><p><em>By default, data is stored for one week (604800 seconds) before expiring.</em></p><p>The PrivateTempStore is different from a cache because the data in it is not yet saved permanently and so it cannot be rebuilt. Typically, the PrivateTempStore might be used to store work in progress that is later saved permanently elsewhere, e.g. autosave data, multistep forms, or in-progress changes to complex configuration that are not ready to be saved.</p><p>The PrivateTempStore differs from the SharedTempStore in that all keys are ensured to be unique for a particular user and users can never share data. If you want to be able to share data between users or use it for locking, use \Drupal\Core\TempStore\SharedTempStore. (Adapted from <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21TempStore%21PrivateTempStore.php/class/PrivateTempStore/9.0.x">https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21TempStore%21PrivateTempStore.php/class/PrivateTempStore/9.0.x</a>)</p><p>In this example, we can see writing, reading, and deleting a private TempStore value:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="k">function</span> <span class="n">build5</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Private TempStore example.</span>

    <span class="c1">// Get the private TempStore for the state_examples module.</span>
    <span class="nv">$tempstore</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'tempstore.private'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'state_examples'</span><span class="p">);</span>
    <span class="nv">$tempstore</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'selwyn.important.string'</span><span class="p">,</span> <span class="s1">'abcdef'</span><span class="p">);</span>

    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Retrieved Private TempStore API data: %value1.'</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">'%value1'</span> <span class="o">=&gt;</span> <span class="nv">$tempstore</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'selwyn.important.string'</span><span class="p">),</span>
      <span class="p">]),</span>
    <span class="p">];</span>

<span class="c1">//    $tempstore-&gt;delete('selwyn.important.string');</span>

    <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div><p>Drupal automatically inserts the user id (e.g. 1:) into the front of the name field so that the data is connected with that user. Notice in the database screenshot below that the name field (i.e. 1:selwyn.important.string) is preceded by 1: which makes it unique. Even though the code specified "selwyn.important.string" each user gets a unique copy. I was logged in as user 1 when I ran this program initially, and then I ran it again logged in as user 2.</p><p><img alt="Private tempstore in the database" src="https://selwynpolit.github.io/d9book/assets/images/private_tempstore1.png"/></p><p>In the next example we're storing an array with the key "selwyn.important.array". The array is automatically serialized into the value field. Incidentally, you don't have to specify the type of content (i.e. array) as I have. Instead of using selwyn.important.array, you could use selwyn.important.banana or selwyn.important.kiwi (depending on your fruit preference).</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Store an array.</span>
<span class="nv">$array</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="s1">'123'</span><span class="p">,</span>
  <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Dave'</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$tempstore</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'selwyn.important.array'</span><span class="p">,</span> <span class="nv">$array</span><span class="p">);</span>
<span class="nv">$array</span> <span class="o">=</span> <span class="nv">$tempstore</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'selwyn.important.array'</span><span class="p">);</span>

<span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
  <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Retrieved Private TempStore API data: id = %value1, name= %value2.'</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'%value1'</span> <span class="o">=&gt;</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span>
    <span class="s1">'%value2'</span> <span class="o">=&gt;</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span>
  <span class="p">]),</span>
<span class="p">];</span>

<span class="c1">// Delete the data.</span>
<span class="nv">$tempstore</span><span class="o">-&gt;</span><span class="nb">delete</span><span class="p">(</span><span class="s1">'selwyn.important.array'</span><span class="p">);</span>
</code></pre></div></div><p><img alt="Storing an array via tempstore in the database" src="https://selwynpolit.github.io/d9book/assets/images/tempstore_db_array.png"/></p><p>This is a screenshot of the value for the array field above. Notice the id = 123 and name = Dave. There is no need to manipulate the data to get it stored away safely. Drupal will serialize it for you:</p><p><img alt="Serialized array in database" src="https://selwynpolit.github.io/d9book/assets/images/serialized_array.png"/></p><p>Also see this article showing how to save values from a form and then later retrieve and process them in a controller. Saving temporarily values of a form with Private Tempstore in Drupal 8 by Karim Boudjema Mar 2019 <a href="http://karimboudjema.com/en/drupal/20190315/saving-temporary-values-form-private-tempstore-drupal-8">http://karimboudjema.com/en/drupal/20190315/saving-temporary-values-form-private-tempstore-drupal-8</a></p><h3 id="sharedtempstore"> <a aria-labelledby="sharedtempstore" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#sharedtempstore"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> SharedTempStore</h3><p><strong>Stores and retrieves temporary data for a given owner.</strong></p><p>A SharedTempStore can be used to make temporary, non-cache data available across requests. The data for the SharedTempStore is stored in a key/value pair. SharedTempStore data expires automatically after a given timeframe.</p><p><em>By default, data is stored for one week (604800 seconds) before expiring.</em></p><p>The SharedTempStore is different from a cache because the data in it is not yet saved permanently and so it cannot be rebuilt. Typically, the SharedTempStore might be used to store work in progress that is later saved permanently elsewhere, e.g. autosave data, multistep forms, or in-progress changes to complex configuration that are not ready to be saved.</p><p>Each SharedTempStore belongs to a particular owner (e.g. a user, session, or process). Multiple owners may use the same key/value collection, and the owner is stored along with the key/value pair in the value field.</p><p>Every key is unique within the collection, so the SharedTempStore can check whether a particular key is already set by a different owner. This is useful for informing one owner that the data is already in use by another; for example, to let one user know that another user is in the process of editing certain data, or even to restrict other users from editing it at the same time. It is the responsibility of the implementation to decide when and whether one owner can use or update another owner's data.</p><p>If you want to be able to ensure that the data belongs to the current user, use \Drupal\Core\TempStore\PrivateTempStore. (Adapted from <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21TempStore%21PrivateTempStore.php/class/PrivateTempStore/9.0.x">https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21TempStore%21PrivateTempStore.php/class/PrivateTempStore/9.0.x</a>)</p><p>Here is example code showing writing, reading and deleting data from SharedTempStore:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="k">function</span> <span class="n">build6</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Shared TempStore example.</span>

    <span class="c1">// Get the shared TempStore for the state_examples module.</span>
    <span class="cd">/** @var \Drupal\Core\TempStore\SharedTempStoreFactory $factory */</span>
    <span class="nv">$factory</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'tempstore.shared'</span><span class="p">);</span>
    <span class="nv">$tempstore</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'state_examples'</span><span class="p">);</span>

    <span class="c1">// Store an array.</span>
    <span class="nv">$agent_array</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="s1">'007'</span><span class="p">,</span>
      <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'James Bond'</span><span class="p">,</span>
    <span class="p">];</span>
    <span class="nv">$tempstore</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'selwyn.important.agent'</span><span class="p">,</span> <span class="nv">$agent_array</span><span class="p">);</span>

    <span class="c1">// Retrieve the data.</span>
    <span class="nv">$array</span> <span class="o">=</span> <span class="nv">$tempstore</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'selwyn.important.agent'</span><span class="p">);</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Retrieved Private TempStore API data: id = %value1, name= %value2.'</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">'%value1'</span> <span class="o">=&gt;</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span>
        <span class="s1">'%value2'</span> <span class="o">=&gt;</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span>
      <span class="p">]),</span>
    <span class="p">];</span>

    <span class="c1">// Delete the data.</span>
<span class="c1">//    $tempstore-&gt;delete('selwyn.important.agent');</span>

    <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div><p>And here is the data in the database:</p><p><img alt="Shared tempstore in the database" src="https://selwynpolit.github.io/d9book/assets/images/shared_tempstore1.png"/></p><p>And you can see the data owner in the screen shot below:</p><p><img alt="Shared tempstore data in the database" src="https://selwynpolit.github.io/d9book/assets/images/shared_tempstore2.png"/></p><h4 id="injecting-tempstoreshared"> <a aria-labelledby="injecting-tempstoreshared" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#injecting-tempstoreshared"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Injecting tempstore.shared</h4><p>If you want to inject the service rather than use it statically, you have to inject <code class="language-plaintext highlighter-rouge">tempstore.shared</code>. e.g. In the <code class="language-plaintext highlighter-rouge">module.services.yml</code> file below, we inject 3 services, including the <code class="language-plaintext highlighter-rouge">tempstore.shared</code>. Note that this is actually the <code class="language-plaintext highlighter-rouge">SharedTempStoreFactory</code> (and not the <code class="language-plaintext highlighter-rouge">SharedTempStore</code> class itself). Remember to derive the “collection” as shown in the php snippet below:</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">tea_teks_srp.vote_processor</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\tea_teks_srp\VotingProcessor</span>
    <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@entity_type.manager'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@current_user'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@tempstore.shared'</span><span class="pi">]</span>
</code></pre></div></div><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cd">/** @var \Drupal\Core\TempStore\SharedTempStore|null  */</span>
  <span class="k">protected</span> <span class="kt">?SharedTempStore</span> <span class="nv">$tempStore</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">;</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">EntityTypeManager</span> <span class="nv">$entityTypeManager</span><span class="p">,</span> <span class="kt">AccountInterface</span> <span class="nv">$account</span><span class="p">,</span> <span class="kt">SharedTempStoreFactory</span> <span class="nv">$sharedTempStoreFactory</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span> <span class="o">=</span> <span class="nv">$entityTypeManager</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nv">$account</span><span class="p">;</span>
    <span class="c1">// Derive the collection.</span>
    <span class="c1">// Note. this will write into the key_value_expire table collection column: tempstore.shared.tea_teks_srp.   */</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tempStore</span> <span class="o">=</span> <span class="nv">$sharedTempStoreFactory</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'tea_teks_srp'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'entity_type.manager'</span><span class="p">),</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'current_user'</span><span class="p">),</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'tempstore.shared'</span><span class="p">)</span>
    <span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div><p>Here is an example of actually writing and then reading the value from the shared tempstore.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DrupalDateTime</span><span class="p">(</span><span class="s1">'now'</span><span class="p">);</span>
    <span class="nv">$votes</span><span class="p">[</span><span class="mi">12345</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'vote'</span> <span class="o">=&gt;</span> <span class="s1">'a'</span><span class="p">,</span>
      <span class="s1">'reason'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
      <span class="s1">'timestamp'</span> <span class="o">=&gt;</span> <span class="nv">$now</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d H:i:s'</span><span class="p">),</span>
      <span class="s1">'serialized'</span> <span class="o">=&gt;</span> <span class="kc">FALSE</span><span class="p">,</span>
    <span class="p">];</span>
    <span class="c1">// Write.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tempStore</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tempstoreKey</span><span class="p">,</span> <span class="nv">$votes</span><span class="p">);</span>
    <span class="c1">// Read.</span>
    <span class="nv">$x</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tempStore</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tempstoreKey</span><span class="p">);</span>

</code></pre></div></div><p>In <code class="language-plaintext highlighter-rouge">core.services.yml</code>, you can see that <code class="language-plaintext highlighter-rouge">tempstore.shared</code> uses the <code class="language-plaintext highlighter-rouge">SharedTempStoreFactory</code> class:</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">tempstore.shared</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\Core\TempStore\SharedTempStoreFactory</span>
    <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@keyvalue.expirable'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@lock'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@request_stack'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@current_user'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">%tempstore.expire%'</span><span class="pi">]</span>
    <span class="na">tags</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="pi">{</span> <span class="nv">name</span><span class="pi">:</span> <span class="nv">backend_overridable</span> <span class="pi">}</span>
</code></pre></div></div><h2 id="reference"> <a aria-labelledby="reference" class="anchor-heading" href="https://selwynpolit.github.io/d9book/state#reference"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Reference</h2><ul><li><a href="https://www.drupal.org/docs/8/api/state-api/overview">State API Overview updated September 2022</a><li>[If you are upgrading from a Drupal 7 site which uses variable_set, check out this article from March 2021 about upgrading to the Drupal 8 State system at] (https://www.drupal.org/node/1787318)<li><a href="https://api.drupal.org/api/drupal/core%21modules%21user%21src%21UserData.php/class/UserData/8.2.x">Drupal API documentation for UserData</a><li><a href="https://api.drupal.org/api/drupal/core%21modules%21user%21src%21UserData.php/function/UserData%3A%3Aget/8.2.x">Drupal API documentation for UserData::get</a><li><a href="https://www.webomelette.com/storing-user-data-such-preferences-drupal-8-using-userdata-service">Storing user data such as preferences in Drupal 8 using the UserData service by Daniel Sipos Mar 2017</a><li><a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21TempStore%21PrivateTempStore.php/class/PrivateTempStore/9.0.x">Drupal Documentation on PrivateTempStore</a><li><a href="https://alexrayu.com/snippets/drupal-8-tempstore">Drupal 8: Tempstore (with code snippets) by Oleksii Raiu</a><li>[Drupal 9: Using The Private Temporary Store Service by Phil Norton July 2022] (https://www.hashbangcode.com/article/drupal-9-using-private-temporary-store-service)<li><a href="http://karimboudjema.com/en/drupal/20190315/saving-temporary-values-form-private-tempstore-drupal-8">Saving temporarily values of a form with Private Tempstore in Drupal 8 by Karim Boudjema Mar 2019</a></li></li></li></li></li></li></li></li></li></ul><hr/> <script async="" crossorigin="anonymous" data-category="Q&amp;A" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMjY2NDE4" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="selwynpolit/d9book" data-repo-id="MDEwOlJlcG9zaXRvcnkzMjUxNTQ1Nzg=" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js"> </script><hr/><footer><p><a href="https://selwynpolit.github.io/d9book/state#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0"><span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"> <a href="http://www.selwynpolit.github.io/d9book" property="dct:title" rel="cc:attributionURL">Drupal at your fingertips</a> by <a href="http://www.drupal.org/u/selwynpolit" property="cc:attributionName" rel="cc:attributionURL dct:creator">Selwyn Polit</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="license noopener noreferrer" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" style="height:16px!important;vertical-align:text-bottom;"/> <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" style="height:16px!important;vertical-align:text-bottom;"/> </a></span></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0 mr-2"> Page last modified: <span class="d-inline-block">Jul 23 2023</span>.</p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/selwynpolit/d9book/tree/gh-pages/book/state.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
</body></link></meta></meta></meta></head></html>