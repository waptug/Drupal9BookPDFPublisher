<!DOCTYPE html>
<html lang="en-US"><head><meta charset="utf-8"/><meta content="IE=Edge" http-equiv="X-UA-Compatible"/><link href="https://selwynpolit.github.io/d9book/assets/css/just-the-docs-default.css" rel="stylesheet"/> <script async="" src="https://www.googletagmanager.com/gtag/js?id=8V22RQEJ71"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '8V22RQEJ71', { 'anonymize_ip': true }); </script> <script src="https://selwynpolit.github.io/d9book/assets/js/vendor/lunr.min.js"></script> <script src="https://selwynpolit.github.io/d9book/assets/js/just-the-docs.js"></script><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://selwynpolit.github.io/d9book/assets/images/favicon.ico" rel="icon" type="image/x-icon"/><title>Batch and Queue | Drupal Book</title><meta content="Jekyll v4.3.2" name="generator"><meta content="Batch and Queue" property="og:title"><meta content="en_US" property="og:locale"><meta content="Drupal at your fingertips" name="description"/><meta content="Drupal at your fingertips" property="og:description"/><link href="https://selwynpolit.github.io/d9book/d9book/bq" rel="canonical"><meta content="https://selwynpolit.github.io/d9book/d9book/bq" property="og:url"/><meta content="Drupal Book" property="og:site_name"/><meta content="website" property="og:type"/><meta content="summary" name="twitter:card"/><meta content="Batch and Queue" property="twitter:title"/> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Drupal at your fingertips","headline":"Batch and Queue","url":"https://selwynpolit.github.io/d9book/d9book/bq"}</script><body> <a class="skip-to-main" href="https://selwynpolit.github.io/d9book/bq#main-content">Skip to main content</a> <svg class="d-none" xmlns="http://www.w3.org/2000/svg"> <symbol id="svg-link" viewbox="0 0 24 24"><title>Link</title><svg class="feather feather-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"><title>Menu</title><svg class="feather feather-menu" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"><title>Expand</title><svg class="feather feather-chevron-right" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol class="feather feather-external-link" fill="none" height="24" id="svg-external-link" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"><title>Document</title><svg class="feather feather-file" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"><title>Search</title><svg class="feather feather-search" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"> <circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewbox="0 0 16 16"><title>Copy</title><svg class="bi bi-clipboard" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path> </svg> </symbol> <symbol id="svg-copied" viewbox="0 0 16 16"><title>Copied</title><svg class="bi bi-clipboard-check-fill" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a class="site-title lh-tight" href="https://selwynpolit.github.io/d9book/"> Drupal Book </a> <a class="site-button" href="https://selwynpolit.github.io/d9book/bq" id="menu-button"> <svg class="icon" viewbox="0 0 24 24"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" class="site-nav" id="site-nav"><ul class="nav-list"><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/">Home</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/actions">Actions</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/attribution">Attribution</a><li class="nav-list-item active"><a class="nav-list-link active" href="https://selwynpolit.github.io/d9book/bq">Batch and Queue</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/blocks">Blocks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/caching">Caching</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/composer">Composer</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/config">Config</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/cron">Cron</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dates">Dates and Times</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/debugging">Debugging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/development">Development</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/drush">Drush</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/email">Email</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/entities">Entities</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/forms">Forms</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/general">General</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/off-island">Getting off the Island</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/hooks">Hooks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/learn">Learning</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/links">Links</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/logging">Logging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/menus">Menus</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/migrate">Migrate</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/modals">Modals</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/nodes-and-fields">Nodes and Fields</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/queries">Queries</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/redirects">Redirects</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/render">Render Arrays</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/routes">Routes</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/security">Security</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/services">Services</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/state">State</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/taxonomy">Taxonomy</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dtt">Tests</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/twig">Twig</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><ul class="nav-list"><li class="nav-list-item external"> <a class="nav-list-link external" href="https://github.com/selwynpolit/d9book/fork"> Fork me on GitHub <svg aria-labelledby="svg-external-link-title" viewbox="0 0 24 24"><use xlink:href="#svg-external-link"></use></svg> </a></li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div class="main-header" id="main-header"><div class="search"><div class="search-input-wrap"> <input aria-label="Search Drupal Book" autocomplete="off" class="search-input" id="search-input" placeholder="Search Drupal Book" tabindex="0" type="text"/> <label class="search-label" for="search-input"><svg class="search-icon" viewbox="0 0 24 24"><use xlink:href="#svg-search"></use></svg></label></div><div class="search-results" id="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a class="site-button" href="https://twitter.com/selwynpolit" rel="noopener noreferrer" target="_blank"> <img alt="Twitter logo" src="https://atuin.ru/demo/simple-icons/icons/twitter.svg" style="width: 30px; height: 30px;" title="Author in Twitter"/> </a><li class="aux-nav-list-item"> <a class="site-button" href="https://github.com/selwynpolit/d9book/tree/gh-pages" rel="noopener noreferrer" target="_blank"> <img alt="GitHub logo" src="https://atuin.ru/demo/simple-icons/icons/github.svg" style="width: 30px; height: 30px;" title="D9Book on GitHub"/> </a></li></li></ul></nav></div><div class="main-content-wrap" id="main-content-wrap"><div class="main-content" id="main-content" role="main"><h1 class="no_toc fw-500" id="batch-processing-and-the-drupal-queue-system"> <a aria-labelledby="batch-processing-and-the-drupal-queue-system" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#batch-processing-and-the-drupal-queue-system"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Batch Processing and the Drupal Queue System</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a aria-labelledby="table-of-contents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#table-of-contents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ul id="markdown-toc"><li><a href="https://selwynpolit.github.io/d9book/bq#batch-processing-using-the-batch-api" id="markdown-toc-batch-processing-using-the-batch-api">Batch Processing Using the Batch API</a><ul><li><a href="https://selwynpolit.github.io/d9book/bq#overview" id="markdown-toc-overview">Overview</a><li><a href="https://selwynpolit.github.io/d9book/bq#using-the-batch-api-with-a-form" id="markdown-toc-using-the-batch-api-with-a-form">Using the Batch API with a form</a><li><a href="https://selwynpolit.github.io/d9book/bq#using-the-batch-api-from-a-controller" id="markdown-toc-using-the-batch-api-from-a-controller">Using the Batch API from a controller</a><li><a href="https://selwynpolit.github.io/d9book/bq#using-the-batch-api-with-hook_update" id="markdown-toc-using-the-batch-api-with-hook_update">Using the Batch API with hook_update</a><li><a href="https://selwynpolit.github.io/d9book/bq#important-rules-about-functions-when-using-batch-api" id="markdown-toc-important-rules-about-functions-when-using-batch-api">Important rules about functions when using Batch API</a><li><a href="https://selwynpolit.github.io/d9book/bq#looking-at-the-source" id="markdown-toc-looking-at-the-source">Looking at the source</a><ul><li><a href="https://selwynpolit.github.io/d9book/bq#passing-parameters-to-the-functions-in-a-batch-operation" id="markdown-toc-passing-parameters-to-the-functions-in-a-batch-operation">Passing parameters to the functions in a batch operation</a></li></ul></li></li></li></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/bq#queue-system" id="markdown-toc-queue-system">Queue System</a><li><a href="https://selwynpolit.github.io/d9book/bq#resources" id="markdown-toc-resources">Resources</a></li></li></li></ul><p><img alt="views" src="https://api.visitor.plantree.me/visitor-badge/pv?label=views&amp;color=informational&amp;namespace=d9book&amp;key=bq.md"/></p><hr/><h2 id="batch-processing-using-the-batch-api"> <a aria-labelledby="batch-processing-using-the-batch-api" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#batch-processing-using-the-batch-api"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Batch Processing Using the Batch API</h2><h3 id="overview"> <a aria-labelledby="overview" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#overview"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Overview</h3><p>The Batch API provides very useful functionality that lets you do work by breaking it into pieces to avoid PHP timeouts, etc. Usually, you’ll do this by creating a group of node id’s (using <code class="language-plaintext highlighter-rouge">array_chunk</code>)to be processed and use the batch API to process those arrays (chunks) of ids. You can also provide code that will let it figure out how much work to do and stop itself.</p><p>In addition, you create a function to handle things once all the chunks are complete. You can also give the Batch API a bunch of work to do and have it figure out for itself when it is finished.</p><p>The Batch API uses the Drupal Queue system, allowing it to pick up where it left off in case of problems.</p><p>You can use the Batch API in controllers, forms, hook updates, and Drush commands. The implementation of each one is slightly different, as you can see in the examples.</p><p>Most often you start a batch from a form where you fill in some options and click a button. You can also run a batch on a controller where the batch operation starts when you point the browser at a URL. Batch operations in Drush commands are started when you type the command in the terminal.</p><p>In the code: For a drush command, you use <code class="language-plaintext highlighter-rouge">drush_backend_batch_process()</code> to kick off the batch (from DirtSalesforceController.php):</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nv">$browser</span> <span class="o">===</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">drush_backend_batch_process</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is an explanation from the source of what it does:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">*</span> <span class="nc">Process</span> <span class="n">a</span> <span class="nc">Drupal</span> <span class="n">batch</span> <span class="n">by</span> <span class="n">spawning</span> <span class="n">multiple</span> <span class="nc">Drush</span> <span class="n">processes</span><span class="mf">.</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="nc">This</span> <span class="k">function</span> <span class="n">will</span> <span class="n">include</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">batch</span> <span class="n">engine</span> <span class="n">for</span> <span class="n">the</span> <span class="n">current</span>
 <span class="o">*</span> <span class="n">major</span> <span class="n">version</span> <span class="n">of</span> <span class="nc">Drupal</span><span class="p">,</span> <span class="k">and</span> <span class="n">will</span> <span class="n">make</span> <span class="kn">use</span> <span class="n">of</span> <span class="n">the</span> <span class="nf">drush_backend_invoke</span>
 <span class="o">*</span> <span class="n">system</span> <span class="n">to</span> <span class="n">spawn</span> <span class="n">multiple</span> <span class="n">worker</span> <span class="n">threads</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">the</span> <span class="n">processing</span> <span class="n">of</span>
 <span class="o">*</span> <span class="n">the</span> <span class="n">current</span> <span class="n">batch</span><span class="p">,</span> <span class="k">while</span> <span class="n">keeping</span> <span class="n">track</span> <span class="n">of</span> <span class="n">available</span> <span class="n">memory</span><span class="mf">.</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="nc">The</span> <span class="n">batch</span> <span class="n">system</span> <span class="n">will</span> <span class="n">process</span> <span class="k">as</span> <span class="n">many</span> <span class="n">batch</span> <span class="n">sets</span> <span class="k">as</span> <span class="n">possible</span> <span class="n">until</span>
 <span class="o">*</span> <span class="n">the</span> <span class="n">entire</span> <span class="n">batch</span> <span class="n">has</span> <span class="n">been</span> <span class="n">completed</span> <span class="k">or</span> <span class="mi">60</span><span class="o">%</span> <span class="n">of</span> <span class="n">the</span> <span class="n">available</span> <span class="n">memory</span>
 <span class="o">*</span> <span class="n">has</span> <span class="n">been</span> <span class="n">used</span><span class="mf">.</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="nc">This</span> <span class="k">function</span> <span class="n">is</span> <span class="n">a</span> <span class="n">drop</span> <span class="n">in</span> <span class="n">replacement</span> <span class="n">for</span> <span class="n">the</span> <span class="n">existing</span> <span class="n">batch_process</span><span class="p">()</span>
 <span class="o">*</span> <span class="k">function</span> <span class="n">of</span> <span class="n">Drupal</span><span class="mf">.</span>
</code></pre></div></div><p>Although it will be covered in more detail in the future, it is useful to know that there is now a batch builder: The <a href="https://www.drupal.org/node/2875389">BatchBuilder class</a> for batch API. It provides a more streamlined object-oriented approach to creating batches.</p><h3 id="using-the-batch-api-with-a-form"> <a aria-labelledby="using-the-batch-api-with-a-form" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#using-the-batch-api-with-a-form"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Using the Batch API with a form</h3><p>This example replaces a multivalue field with some new values processing 10 nodes at a time. The decision to process 10 at a time is arbitrary, but be aware that the more nodes you process at a time, the higher the possibility that the process will time out causing the batch will fail.</p><p>The form example is in the accompanying source and is accessed at <a href="https://d9book.ddev.site/batch-examples/batchform">https://d9book.ddev.site/batch-examples/batchform</a></p><p>The source file is at <code class="language-plaintext highlighter-rouge">web/modules/custom/batch_examples/src/Form/BatchForm.php</code> and is presented in pieces below:</p><p>Here is a simple form with a button used to kick off the batch operation.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">):</span> <span class="kt">array</span> <span class="p">{</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Click the button below to kick off the batch!'</span><span class="p">),</span>
  <span class="p">];</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'#type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'actions'</span><span class="p">;</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'submit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
    <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Run Batch'</span><span class="p">),</span>
  <span class="p">];</span>

  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">submitForm()</code> method calls <code class="language-plaintext highlighter-rouge">updateEventPresenters()</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">submitForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">updateEventPresenters</span><span class="p">();</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addStatus</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'The message has been sent.'</span><span class="p">));</span>
  <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setRedirect</span><span class="p">(</span><span class="s1">'&lt;front&gt;'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>The route is:</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">batch_examples.batch</span><span class="pi">:</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/batch-examples/batchform'</span>
  <span class="na">defaults</span><span class="pi">:</span>
    <span class="na">_title</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Batch</span><span class="nv"> </span><span class="s">Form'</span>
    <span class="na">_form</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Drupal\batch_examples\Form\BatchForm'</span>
  <span class="na">requirements</span><span class="pi">:</span>
    <span class="na">_permission</span><span class="pi">:</span> <span class="s1">'</span><span class="s">access</span><span class="nv"> </span><span class="s">content'</span>
</code></pre></div></div><p>Here is the <code class="language-plaintext highlighter-rouge">updateEventPresenters()</code> method. Notice the <code class="language-plaintext highlighter-rouge">$operations</code> array, which contains the function to call to do the work of each batch as well as the list of nids to process.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">updateEventPresenters</span><span class="p">():</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="nv">$query</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityQuery</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'event'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nb">sort</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'ASC'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">accessCheck</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">);</span>
  <span class="nv">$nids</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>

  <span class="c1">// Create batches.</span>
  <span class="nv">$chunk_size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="nv">$chunks</span> <span class="o">=</span> <span class="nb">array_chunk</span><span class="p">(</span><span class="nv">$nids</span><span class="p">,</span> <span class="nv">$chunk_size</span><span class="p">);</span>
  <span class="nv">$num_chunks</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$chunks</span><span class="p">);</span>

  <span class="c1">// Submit batches.</span>
  <span class="nv">$operations</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="nv">$batch_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$batch_id</span> <span class="o">&lt;</span> <span class="nv">$num_chunks</span><span class="p">;</span> <span class="nv">$batch_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$operations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'\Drupal\batch_examples\Form\BatchForm::exampleProcessBatch'</span><span class="p">,</span>
      <span class="p">[</span>
        <span class="nv">$batch_id</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
        <span class="nv">$chunks</span><span class="p">[</span><span class="nv">$batch_id</span><span class="p">]],</span>
    <span class="p">];</span>
  <span class="p">}</span>
  <span class="nv">$batch</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Updating Presenters'</span><span class="p">),</span>
    <span class="s1">'init_message'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Starting to process events.'</span><span class="p">),</span>
    <span class="s1">'progress_message'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Completed @current out of @total batches.'</span><span class="p">),</span>
    <span class="s1">'finished'</span> <span class="o">=&gt;</span> <span class="s1">'\Drupal\batch_examples\Form\BatchForm::batchFinished'</span><span class="p">,</span>
    <span class="s1">'error_message'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Event processing has encountered an error.'</span><span class="p">),</span>
    <span class="s1">'operations'</span> <span class="o">=&gt;</span> <span class="nv">$operations</span><span class="p">,</span>
  <span class="p">];</span>
  <span class="nf">batch_set</span><span class="p">(</span><span class="nv">$batch</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is the method that actually does the work. Most of the code is for information reporting. The actual work is in the <code class="language-plaintext highlighter-rouge">foreach $nids as $nid</code> loop:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">exampleProcessBatch</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$batch_id</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$nids</span><span class="p">,</span> <span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$context</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'progress'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'progress'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'current_node'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'max'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'updated'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'updated'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'skipped'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'failed'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'progress'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Keep track of progress.</span>
  <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'progress'</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$nids</span><span class="p">);</span>
  <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'process'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Import request files'</span><span class="p">;</span>
  <span class="c1">// Message above progress bar.</span>
  <span class="nv">$context</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Processing batch #@batch_id batch size @batch_size for total @count items.'</span><span class="p">,[</span>
    <span class="s1">'@batch_id'</span> <span class="o">=&gt;</span> <span class="nb">number_format</span><span class="p">(</span><span class="nv">$batch_id</span><span class="p">),</span>
    <span class="s1">'@batch_size'</span> <span class="o">=&gt;</span> <span class="nb">number_format</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$nids</span><span class="p">)),</span>
    <span class="s1">'@count'</span> <span class="o">=&gt;</span> <span class="nb">number_format</span><span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'max'</span><span class="p">]),</span>
  <span class="p">]);</span>

  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$nids</span> <span class="k">as</span> <span class="nv">$nid</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$filename</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
    <span class="cd">/** @var \Drupal\node\NodeInterface $event_node */</span>
    <span class="nv">$event_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$nid</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$event_node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$array</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Mary Smith'</span><span class="p">,</span> <span class="s1">'Fred Blue'</span><span class="p">,</span> <span class="s1">'Elizabeth Queen'</span><span class="p">];</span>
      <span class="nb">shuffle</span><span class="p">(</span><span class="nv">$array</span><span class="p">);</span>
      <span class="nv">$event_node</span><span class="o">-&gt;</span><span class="n">field_presenter</span> <span class="o">=</span> <span class="nv">$array</span><span class="p">;</span>
      <span class="nv">$event_node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>The Form API will take care of getting the batches executed. If you aren’t using a form, you use <code class="language-plaintext highlighter-rouge">batch_process()</code> like the line shown below. For this method, you specify any valid alias and the system will redirect to that alias after the batch completes.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// node/1 should be a valid node.</span>
<span class="k">return</span> <span class="nf">batch_process</span><span class="p">(</span><span class="s1">'node/1'</span><span class="p">);</span> 
</code></pre></div></div><p class="note">Also you can set up a <code class="language-plaintext highlighter-rouge">$batch</code> array with a title and a progress message with some variables that will get displayed.</p><p>You specify a <code class="language-plaintext highlighter-rouge">finished</code> index, which identifies a function to call after the batch is finished processing, as in the example below.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'finished'</span> <span class="o">=&gt;</span> <span class="s1">'\Drupal\batch_examples\Form\BatchForm::batchFinished'</span><span class="p">,</span>
</code></pre></div></div><p>Here is the <code class="language-plaintext highlighter-rouge">batchFinished()</code> method, which displays and logs the results.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Symfony\Component\HttpFoundation\RedirectResponse</span><span class="p">;</span>

<span class="cd">/**
 * Handle batch completion.
 *
 * @param bool $success
 *   TRUE if all batch API tasks were completed successfully.
 * @param array $results
 *   An array of processed node IDs.
 * @param array $operations
 *   A list of the operations that had not been completed.
 * @param string $elapsed
 *   Batch.inc kindly provides the elapsed processing time in seconds.
 */</span>
 <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">batchFinished</span><span class="p">(</span><span class="kt">bool</span> <span class="nv">$success</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$results</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$operations</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$elapsed</span><span class="p">):</span> <span class="kt">RedirectResponse</span> <span class="p">{</span>
  <span class="nv">$messenger</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$success</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$messenger</span><span class="o">-&gt;</span><span class="nf">addMessage</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'@process processed @count nodes, skipped @skipped, updated @updated, failed @failed in @elapsed.'</span><span class="p">,</span> <span class="p">[</span>
      <span class="s1">'@process'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'process'</span><span class="p">],</span>
      <span class="s1">'@count'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'progress'</span><span class="p">],</span>
      <span class="s1">'@skipped'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'skipped'</span><span class="p">],</span>
      <span class="s1">'@updated'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'updated'</span><span class="p">],</span>
      <span class="s1">'@failed'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'failed'</span><span class="p">],</span>
      <span class="s1">'@elapsed'</span> <span class="o">=&gt;</span> <span class="nv">$elapsed</span><span class="p">,</span>
    <span class="p">]));</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">logger</span><span class="p">(</span><span class="s1">'d9book'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">info</span><span class="p">(</span>
      <span class="s1">'@process processed @count nodes, skipped @skipped, updated @updated, failed @failed in @elapsed.'</span><span class="p">,</span> <span class="p">[</span>
      <span class="s1">'@process'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'process'</span><span class="p">],</span>
      <span class="s1">'@count'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'progress'</span><span class="p">],</span>
      <span class="s1">'@skipped'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'skipped'</span><span class="p">],</span>
      <span class="s1">'@updated'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'updated'</span><span class="p">],</span>
      <span class="s1">'@failed'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'failed'</span><span class="p">],</span>
      <span class="s1">'@elapsed'</span> <span class="o">=&gt;</span> <span class="nv">$elapsed</span><span class="p">,</span>
    <span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// An error occurred.</span>
    <span class="c1">// $operations contains the operations that remained unprocessed.</span>
    <span class="nv">$error_operation</span> <span class="o">=</span> <span class="nb">reset</span><span class="p">(</span><span class="nv">$operations</span><span class="p">);</span>
    <span class="nv">$message</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'An error occurred while processing %error_operation with arguments: @arguments'</span><span class="p">,</span> <span class="p">[</span>
      <span class="s1">'%error_operation'</span> <span class="o">=&gt;</span> <span class="nv">$error_operation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="s1">'@arguments'</span> <span class="o">=&gt;</span> <span class="nb">print_r</span><span class="p">(</span><span class="nv">$error_operation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">TRUE</span><span class="p">),</span>
    <span class="p">]);</span>
    <span class="nv">$messenger</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// Optionally redirect back to the form.</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nc">RedirectResponse</span><span class="p">(</span><span class="s1">'/batch-examples/batchform'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="using-the-batch-api-from-a-controller"> <a aria-labelledby="using-the-batch-api-from-a-controller" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#using-the-batch-api-from-a-controller"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Using the Batch API from a controller</h3><p>The Batch API is often used in connection with forms. If you're using a page callback, you will need to setup all the items, submit them to the batch API, and then call <code class="language-plaintext highlighter-rouge">batch_process()</code> with a url as the argument.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="nf">batch_process</span><span class="p">(</span><span class="s1">'node/1'</span><span class="p">);</span>
</code></pre></div></div><p>After the batch is complete, Drupal will redirect you to that url. E.g. <code class="language-plaintext highlighter-rouge">/node/1</code></p><p class="more_link"><a href="https://api.drupal.org/api/drupal/core%21includes%21form.inc/group/batch/10.0.x">Drupal API | Batch operations</a></p><p>In this example of a processing function, you can see error handling, logging, and tracking while retrieving files from a remote source. This is fairly common when moving data between systems. The rest of the code is almost identical to the previous example.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">fileImportProcessBatch</span><span class="p">(</span><span class="kt">int</span> <span class="nv">$batch_id</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$nids</span><span class="p">,</span> <span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$context</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'progress'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'progress'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'current_node'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'max'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'updated'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'updated'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'skipped'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'failed'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'progress'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Total records to process for all batches.</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'max'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$query</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityQuery</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'opinion_request'</span><span class="p">);</span>
    <span class="nv">$total_nids</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
    <span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'max'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$total_nids</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Keep track of progress.</span>
  <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'progress'</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$nids</span><span class="p">);</span>
  <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'process'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Import request files'</span><span class="p">;</span>
  <span class="c1">// Message above progress bar.</span>
  <span class="nv">$context</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Processing batch #@batch_id batch size @batch_size for total @count items.'</span><span class="p">,[</span>
    <span class="s1">'@batch_id'</span> <span class="o">=&gt;</span> <span class="nb">number_format</span><span class="p">(</span><span class="nv">$batch_id</span><span class="p">),</span>
    <span class="s1">'@batch_size'</span> <span class="o">=&gt;</span> <span class="nb">number_format</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$nids</span><span class="p">)),</span>
    <span class="s1">'@count'</span> <span class="o">=&gt;</span> <span class="nb">number_format</span><span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'max'</span><span class="p">]),</span>
  <span class="p">]);</span>

  <span class="nv">$fileRepository</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'file.repository'</span><span class="p">);</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$nids</span> <span class="k">as</span> <span class="nv">$nid</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$filename</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
    <span class="nv">$request_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$nid</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$request_node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$file_id</span> <span class="o">=</span> <span class="nv">$request_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_request_file'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$file_id</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// confirm that the file exists.</span>
        <span class="nv">$file</span> <span class="o">=</span> <span class="nc">File</span><span class="o">::</span><span class="nf">load</span><span class="p">(</span><span class="nv">$file_id</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">getFileUri</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$uri</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'skipped'</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">//Skip retrieving file if there is no request date.</span>
      <span class="nv">$request_date</span> <span class="o">=</span> <span class="nv">$request_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_request_date'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$request_date</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'skipped'</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nv">$source_url</span> <span class="o">=</span> <span class="nv">$request_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_pdf_file_with_path'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$source_url</span> <span class="o">==</span> <span class="s2">"missing"</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'skipped'</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$source_url</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">basename</span><span class="p">(</span><span class="nv">$source_url</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span> <span class="p">{</span>
          <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">logger</span><span class="p">(</span><span class="s1">'oag_opinions'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span><span class="s1">'file_import - Error retrieving file - invalid filename in'</span> <span class="mf">.</span> <span class="nv">$source_url</span><span class="p">);</span>
          <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'skipped'</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$file_contents</span> <span class="o">=</span> <span class="o">@</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$source_url</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$file_contents</span> <span class="o">===</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="p">{</span>
          <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">logger</span><span class="p">(</span><span class="s1">'oag_opinions'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span><span class="s1">'file_import - Error retrieving file '</span> <span class="mf">.</span> <span class="nv">$source_url</span><span class="p">);</span>
          <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Error retrieving file %filename.'</span><span class="p">,[</span><span class="s1">'%filename'</span> <span class="o">=&gt;</span> <span class="nv">$source_url</span><span class="p">]),</span> <span class="kc">FALSE</span><span class="p">);</span>
          <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'failed'</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$destination</span> <span class="o">=</span> <span class="s2">"public://"</span> <span class="mf">.</span> <span class="nv">$filename</span><span class="p">;</span>
        <span class="nv">$file</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$fileRepository</span><span class="o">-&gt;</span><span class="nf">writeData</span><span class="p">(</span><span class="nv">$file_contents</span><span class="p">,</span> <span class="nv">$destination</span><span class="p">,</span> <span class="nc">FileSystemInterface</span><span class="o">::</span><span class="no">EXISTS_REPLACE</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nc">FileException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">logger</span><span class="p">(</span><span class="s1">'oag_opinions'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span><span class="s1">'file_import - Error saving file '</span> <span class="mf">.</span> <span class="nv">$destination</span><span class="p">);</span>
          <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Error saving file %filename'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'%filename'</span> <span class="o">=&gt;</span> <span class="nv">$destination</span><span class="p">]),</span> <span class="kc">FALSE</span><span class="p">);</span>
          <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'failed'</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'failed'</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$fid</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
        <span class="nv">$request_node</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'field_request_file'</span><span class="p">,</span> <span class="nv">$fid</span><span class="p">);</span>
        <span class="c1">//$request_node-&gt;field_request_file-&gt;target_id = $fid;</span>
        <span class="nv">$request_node</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
        <span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'updated'</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is the code that creates the batches and submits them.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">summaryImport</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">summaryCreateBatches</span><span class="p">();</span>
  <span class="k">return</span> <span class="nf">batch_process</span><span class="p">(</span><span class="s1">'/admin/content'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="using-the-batch-api-with-hook_update"> <a aria-labelledby="using-the-batch-api-with-hook_update" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#using-the-batch-api-with-hook_update"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Using the Batch API with hook_update</h3><p>If you want to update the default value of a field for all nodes using the Batch API and hook_update_N checkout the following links:</p><ul><li><a href="https://www.thirdandgrove.com/insights/using-batch-api-and-hookupdaten-drupal-8/">Using the Batch API and hook_update_N in Drupal 8</a><li><a href="https://api.drupal.org/api/examples/batch_example%21batch_example.install/function/batch_example_update_8001/8.x-1.x">Drupal API | batch_example_update_8001 | batch_example.install</a></li></li></ul><h3 id="important-rules-about-functions-when-using-batch-api"> <a aria-labelledby="important-rules-about-functions-when-using-batch-api" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#important-rules-about-functions-when-using-batch-api"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Important rules about functions when using Batch API</h3><p>All batch functions must be <code class="language-plaintext highlighter-rouge">public static functions</code> and all functions calling those must be explicitly namespaced like:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$nid</span> <span class="o">=</span> <span class="nc">\Drupal\dirt_salesforce\Controller\DirtSalesforceController</span><span class="o">::</span><span class="nf">lookupCommodityItem</span><span class="p">(</span><span class="nv">$commodity_item_id</span><span class="p">);</span>
</code></pre></div></div><p>You can’t use <code class="language-plaintext highlighter-rouge">$this-&gt;my_function</code> even if they are in the same class. Grab the namespace from the top of the PHP file you are using. In this case:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">Drupal\dirt_salesforce\Controller</span><span class="p">;</span>
</code></pre></div></div><p>You can however refer to the functions with <code class="language-plaintext highlighter-rouge">self::</code> e.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$node_to_update_dirt_contact_nid</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nf">getFirstRef</span><span class="p">(</span><span class="nv">$node_to_update</span><span class="p">,</span> <span class="s1">'field_sf_dirt_contact_ref'</span><span class="p">);</span>
</code></pre></div></div><h3 id="looking-at-the-source"> <a aria-labelledby="looking-at-the-source" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#looking-at-the-source"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Looking at the source</h3><p>The <a href="https://git.drupalcode.org/project/drupal/-/blob/10.1.x/core/includes/form.inc">source code for the Batch API</a> is really well commented and worth reading.</p><h4 id="passing-parameters-to-the-functions-in-a-batch-operation"> <a aria-labelledby="passing-parameters-to-the-functions-in-a-batch-operation" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#passing-parameters-to-the-functions-in-a-batch-operation"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Passing parameters to the functions in a batch operation</h4><p>In this file <a href="https://git.drupalcode.org/project/drupal/-/blob/10.1.x/core/includes/form.inc#L562-678">https://git.drupalcode.org/project/drupal/-/blob/10.1.x/core/includes/form.inc#L562-678</a>, there is an example batch that defines two operations that call <code class="language-plaintext highlighter-rouge">my_function_1</code> and <code class="language-plaintext highlighter-rouge">my_function_2</code>. Notice how parameters can be passed to my_function_1 separated by commas. From <a href="https://git.drupalcode.org/project/drupal/blob/8.7.8/core/includes/form.inc#L570">https://git.drupalcode.org/project/drupal/blob/8.7.8/core/includes/form.inc#L570</a>:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">*</span> <span class="nc">Example</span><span class="o">:</span>
 <span class="o">*</span> <span class="o">@</span><span class="n">code</span>
 <span class="o">*</span> <span class="nv">$batch</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
 <span class="o">*</span>   <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Exporting'</span><span class="p">),</span>
 <span class="o">*</span>   <span class="s1">'operations'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
 <span class="o">*</span>     <span class="k">array</span><span class="p">(</span><span class="s1">'my_function_1'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">(),</span> <span class="s1">'story'</span><span class="p">)),</span>
 <span class="o">*</span>     <span class="k">array</span><span class="p">(</span><span class="s1">'my_function_2'</span><span class="p">,</span> <span class="k">array</span><span class="p">()),</span>
 <span class="o">*</span>   <span class="p">),</span>
 <span class="o">*</span>   <span class="s1">'finished'</span> <span class="o">=&gt;</span> <span class="s1">'my_finished_callback'</span><span class="p">,</span>
 <span class="o">*</span>   <span class="s1">'file'</span> <span class="o">=&gt;</span> <span class="s1">'path_to_file_containing_my_functions'</span><span class="p">,</span>
 <span class="o">*</span> <span class="p">);</span>
 <span class="o">*</span> <span class="nf">batch_set</span><span class="p">(</span><span class="nv">$batch</span><span class="p">);</span>
 <span class="o">*</span> <span class="c1">// Only needed if not inside a form _submit handler.</span>
 <span class="o">*</span> <span class="c1">// Setting redirect in batch_process.</span>
 <span class="o">*</span> <span class="nf">batch_process</span><span class="p">(</span><span class="s1">'node/1'</span><span class="p">);</span>
</code></pre></div></div><p class="note">To execute the batch, the example shows a call to <code class="language-plaintext highlighter-rouge">batch_process('node/1')</code>. This could be any valid url alias e.g., <code class="language-plaintext highlighter-rouge">/admin/content</code>.</p><p>So here are the arguments for my_function_1:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span> <span class="k">function</span> <span class="n">my_function_1</span><span class="p">(</span><span class="nv">$uid</span><span class="p">,</span> <span class="nv">$type</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$context</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div><p>You call the batch finished function with the following arguments:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Handle batch completion.
 *
 * @param bool $success
 *   TRUE if all batch API tasks were completed successfully.
 * @param array $results
 *   An array of processed node IDs. - or whatever you put in $context['results'][]
 * @param array $operations
 *   A list of the operations that had NOT been completed.
 * @param $elapsed
 *   Elapsed time for processing in seconds.
 */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">batchFinished</span><span class="p">(</span><span class="nv">$success</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$results</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$operations</span><span class="p">,</span> <span class="nv">$elapsed</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div><p>The results are displayed:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$messenger</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$success</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$messenger</span><span class="o">-&gt;</span><span class="nf">addMessage</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Processed @count nodes in @elapsed.'</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'@count'</span> <span class="o">=&gt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$results</span><span class="p">),</span>
    <span class="s1">'@elapsed'</span> <span class="o">=&gt;</span> <span class="nv">$elapsed</span><span class="p">,</span>
  <span class="p">]));</span>
<span class="p">}</span>
</code></pre></div></div><p>You can load the <code class="language-plaintext highlighter-rouge">$results</code> array with all sorts of interesting data, such as:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'skipped'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$skipped</span><span class="p">;</span>
<span class="nv">$context</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'updated'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$updated</span><span class="p">;</span>
</code></pre></div></div><p>Batch API provides a nice way to display detailed results using code like:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$messenger</span><span class="o">-&gt;</span><span class="nf">addMessage</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Processed @count nodes, skipped @skipped, updated @updated in @elapsed.'</span><span class="p">,</span> <span class="p">[</span>
  <span class="s1">'@count'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'nodes'</span><span class="p">],</span>
  <span class="s1">'@skipped'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'skipped'</span><span class="p">],</span>
  <span class="s1">'@updated'</span> <span class="o">=&gt;</span> <span class="nv">$results</span><span class="p">[</span><span class="s1">'updated'</span><span class="p">],</span>
  <span class="s1">'@elapsed'</span> <span class="o">=&gt;</span> <span class="nv">$elapsed</span><span class="p">,</span>
<span class="p">]));</span>
</code></pre></div></div><p>Which produce the following output:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Processed 50 nodes, skipped 45, updated 5 in 3 sec.
</code></pre></div></div><p>You can display an informative message above the progress bar this way.</p><p>I filled in the <code class="language-plaintext highlighter-rouge">$context['sandbox']['max']</code> with a value, but I could have used <code class="language-plaintext highlighter-rouge">$context['sandbox']['whole-bunch']</code> or any variable here.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'max'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$max_nids</span><span class="p">);</span>
</code></pre></div></div><p>An informative message above the progress bar using number_format puts commas in the number if it is over 1,000.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$context</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Processing total @count nodes'</span><span class="p">,</span>
  <span class="p">[</span><span class="s1">'@count'</span> <span class="o">=&gt;</span> <span class="nb">number_format</span><span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'max'</span><span class="p">])]</span>
<span class="p">);</span>
</code></pre></div></div><p>Also you could show something about which batch number is running.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$operation_details</span> <span class="o">=</span> <span class="s1">'Yoyoma'</span><span class="p">;</span>
<span class="nv">$id</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
<span class="nv">$context</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Running Batch "@id" @details'</span><span class="p">,</span>
  <span class="p">[</span><span class="s1">'@id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span> <span class="s1">'@details'</span> <span class="o">=&gt;</span> <span class="nv">$operation_details</span><span class="p">]</span>
<span class="p">);</span>
</code></pre></div></div><p>You do have to provide your own info for the variables.</p><p>You can also stop the batch engine yourself with something like this. If you don’t know beforehand how many records you need to process, you could use code like this.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Inform the batch engine that we are not finished,</span>
<span class="c1">// and provide an estimation of the completion level we reached.</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'progress'</span><span class="p">]</span> <span class="o">!=</span> <span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'max'</span><span class="p">])</span> <span class="p">{</span>
  <span class="nv">$context</span><span class="p">[</span><span class="s1">'finished'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'progress'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nv">$context</span><span class="p">[</span><span class="s1">'sandbox'</span><span class="p">][</span><span class="s1">'max'</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="queue-system"> <a aria-labelledby="queue-system" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#queue-system"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Queue System</h2><p>From <a href="https://www.alansaunders.co.uk/blog/queues-drupal-8-and-9">Alan Saunders article</a> on December 2021:</p><p>A queue is simply a list of stuff that gets worked through one by one, one analogy could be a conveyor belt on a till in a supermarket, the cashier works through each item on the belt to scan them.</p><p>Queues are handy in Drupal for chunking up large operations, like sending emails to many people. By using a queue, you are trying to avoid overloading the servers resources which could cause the site to go offline until the resources on the server are free’d up.</p><p>From <a href="https://www.tothenew.com/blog/how-to-implement-queue-workerapi-in-drupal-8">Sarthak TTN</a> on Feb 2017:</p><p>This is the <code class="language-plaintext highlighter-rouge">submitForm()</code> which creates an item and puts it in the queue.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">submitForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
  <span class="cd">/** @var QueueFactory $queue_factory */</span>
  <span class="nv">$queue_factory</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'queue'</span><span class="p">);</span>
  <span class="cd">/** @var QueueInterface $queue */</span>
  <span class="nv">$queue</span> <span class="o">=</span> <span class="nv">$queue_factory</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'email_processor'</span><span class="p">);</span>
  <span class="nv">$item</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">\stdClass</span><span class="p">();</span>
  <span class="nv">$item</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
  <span class="nv">$item</span><span class="o">-&gt;</span><span class="n">email</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'email'</span><span class="p">);</span>
  <span class="nv">$item</span><span class="o">-&gt;</span><span class="n">query</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'query'</span><span class="p">);</span>
  <span class="nv">$queue</span><span class="o">-&gt;</span><span class="nf">createItem</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>Then you create a Queue Worker that implements <code class="language-plaintext highlighter-rouge">ContainerFactoryPluginInterface</code> and in the <code class="language-plaintext highlighter-rouge">processItem()</code> it processes a single item from the queue.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">Drupal\my_module\Plugin\QueueWorker</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Plugin\ContainerFactoryPluginInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Queue\QueueWorkerBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Mail\MailManager</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\DependencyInjection\ContainerInterface</span><span class="p">;</span>

<span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="kd">class</span> <span class="nc">EmailEventBase</span> <span class="kd">extends</span> <span class="nc">QueueWorkerBase</span> <span class="kd">implements</span> <span class="nc">ContainerFactoryPluginInterface</span> <span class="p">{</span>

  <span class="cd">/**
   * @param Drupal\Core\Mail\MailManager $mail
   *   The mail manager.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="k">protected</span> <span class="kt">MailManager</span> <span class="nv">$mail</span><span class="p">)</span> <span class="p">{}</span>

  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'plugin.manager.mail'</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="cd">/**
   * Processes a single item of Queue.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">processItem</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$params</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'query'</span><span class="p">);</span>
    <span class="nv">$params</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">;</span>
    <span class="nv">$params</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">;</span>
    <span class="nv">$params</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">;</span>
    <span class="nv">$to</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">config</span><span class="p">(</span><span class="s1">'system.site'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'mail'</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">mail</span><span class="o">-&gt;</span><span class="nb">mail</span><span class="p">(</span><span class="s1">'my_module'</span><span class="p">,</span> <span class="s1">'query_mail'</span><span class="p">,</span> <span class="nv">$to</span><span class="p">,</span> <span class="s1">'en'</span><span class="p">,</span> <span class="nv">$params</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>Then you’ll need a cronEventProcessor which in annotation tells cron how often to run the job:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">Drupal\my_module\Plugin\QueueWorker</span><span class="p">;</span>
 
<span class="cd">/**
 *
 * @QueueWorker(
 * id = "email_processor",
 * title = "My custom Queue Worker",
 * cron = {"time" = 10}
 * )
 */</span>
<span class="kd">class</span> <span class="nc">CronEventProcessor</span> <span class="kd">extends</span> <span class="nc">EmailEventBase</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div><h2 id="resources"> <a aria-labelledby="resources" class="anchor-heading" href="https://selwynpolit.github.io/d9book/bq#resources"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Resources</h2><p>Read more about batch processing at these sites:</p><ul><li><a href="https://www.weareaccess.co.uk/blog/2016/07/smack-my-batch-batch-processing-drupal-8">Smack My Batch Up : Batch Processing In Drupal 8</a> by Phil Norton July 2016<li>Highly commented <a href="https://git.drupalcode.org/project/drupal/-/blob/10.1.x/core/includes/form.inc#L561">source code for batch operations around line 561 for Drupal 10</a> (or search for ‘batch operations’)</li></li></ul><p>Read more about the Queue API at these sites:</p><ul><li>Karim Boudjema from August 2018 has <a href="http://karimboudjema.com/en/drupal/20180807/create-queue-controller-drupal8">some good examples using the queue API</a><li>Sarthak TTN from Feb 2017 shows some <a href="https://www.tothenew.com/blog/how-to-implement-queue-workerapi-in-drupal-8">sample code on implementing cron and the queue API</a><li><a href="https://www.alansaunders.co.uk/blog/queues-drupal-8-and-9">There is a somewhat incomplete example</a> From Alan Saunders article on December 2021</li></li></li></ul><hr/> <script async="" crossorigin="anonymous" data-category="Q&amp;A" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMjY2NDE4" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="selwynpolit/d9book" data-repo-id="MDEwOlJlcG9zaXRvcnkzMjUxNTQ1Nzg=" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js"> </script><hr/><footer><p><a href="https://selwynpolit.github.io/d9book/bq#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0"><span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"> <a href="http://www.selwynpolit.github.io/d9book" property="dct:title" rel="cc:attributionURL">Drupal at your fingertips</a> by <a href="http://www.drupal.org/u/selwynpolit" property="cc:attributionName" rel="cc:attributionURL dct:creator">Selwyn Polit</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="license noopener noreferrer" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" style="height:16px!important;vertical-align:text-bottom;"/> <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" style="height:16px!important;vertical-align:text-bottom;"/> </a></span></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0 mr-2"> Page last modified: <span class="d-inline-block">Jul 29 2023</span>.</p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/selwynpolit/d9book/tree/gh-pages/book/bq.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
</body></link></meta></meta></meta></head></html>