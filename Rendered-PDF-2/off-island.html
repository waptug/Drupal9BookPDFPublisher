<!DOCTYPE html>
<html lang="en-US"><head><meta charset="utf-8"/><meta content="IE=Edge" http-equiv="X-UA-Compatible"/><link href="https://selwynpolit.github.io/d9book/assets/css/just-the-docs-default.css" rel="stylesheet"/> <script async="" src="https://www.googletagmanager.com/gtag/js?id=8V22RQEJ71"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '8V22RQEJ71', { 'anonymize_ip': true }); </script> <script src="https://selwynpolit.github.io/d9book/assets/js/vendor/lunr.min.js"></script> <script src="https://selwynpolit.github.io/d9book/assets/js/just-the-docs.js"></script><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://selwynpolit.github.io/d9book/assets/images/favicon.ico" rel="icon" type="image/x-icon"/><title>Getting off the Island | Drupal Book</title><meta content="Jekyll v4.3.2" name="generator"><meta content="Getting off the Island" property="og:title"><meta content="en_US" property="og:locale"><meta content="Drupal at your fingertips" name="description"/><meta content="Drupal at your fingertips" property="og:description"/><link href="https://selwynpolit.github.io/d9book/d9book/off-island" rel="canonical"><meta content="https://selwynpolit.github.io/d9book/d9book/off-island" property="og:url"/><meta content="Drupal Book" property="og:site_name"/><meta content="website" property="og:type"/><meta content="summary" name="twitter:card"/><meta content="Getting off the Island" property="twitter:title"/> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Drupal at your fingertips","headline":"Getting off the Island","url":"https://selwynpolit.github.io/d9book/d9book/off-island"}</script><body> <a class="skip-to-main" href="https://selwynpolit.github.io/d9book/off-island#main-content">Skip to main content</a> <svg class="d-none" xmlns="http://www.w3.org/2000/svg"> <symbol id="svg-link" viewbox="0 0 24 24"><title>Link</title><svg class="feather feather-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"><title>Menu</title><svg class="feather feather-menu" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"><title>Expand</title><svg class="feather feather-chevron-right" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol class="feather feather-external-link" fill="none" height="24" id="svg-external-link" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"><title>Document</title><svg class="feather feather-file" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"><title>Search</title><svg class="feather feather-search" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"> <circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewbox="0 0 16 16"><title>Copy</title><svg class="bi bi-clipboard" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path> </svg> </symbol> <symbol id="svg-copied" viewbox="0 0 16 16"><title>Copied</title><svg class="bi bi-clipboard-check-fill" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a class="site-title lh-tight" href="https://selwynpolit.github.io/d9book/"> Drupal Book </a> <a class="site-button" href="https://selwynpolit.github.io/d9book/off-island" id="menu-button"> <svg class="icon" viewbox="0 0 24 24"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" class="site-nav" id="site-nav"><ul class="nav-list"><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/">Home</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/actions">Actions</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/attribution">Attribution</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/bq">Batch and Queue</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/blocks">Blocks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/caching">Caching</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/composer">Composer</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/config">Config</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/cron">Cron</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dates">Dates and Times</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/debugging">Debugging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/development">Development</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/drush">Drush</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/email">Email</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/entities">Entities</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/forms">Forms</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/general">General</a><li class="nav-list-item active"><a class="nav-list-link active" href="https://selwynpolit.github.io/d9book/off-island">Getting off the Island</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/hooks">Hooks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/learn">Learning</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/links">Links</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/logging">Logging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/menus">Menus</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/migrate">Migrate</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/modals">Modals</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/nodes-and-fields">Nodes and Fields</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/queries">Queries</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/redirects">Redirects</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/render">Render Arrays</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/routes">Routes</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/security">Security</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/services">Services</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/state">State</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/taxonomy">Taxonomy</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dtt">Tests</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/twig">Twig</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><ul class="nav-list"><li class="nav-list-item external"> <a class="nav-list-link external" href="https://github.com/selwynpolit/d9book/fork"> Fork me on GitHub <svg aria-labelledby="svg-external-link-title" viewbox="0 0 24 24"><use xlink:href="#svg-external-link"></use></svg> </a></li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div class="main-header" id="main-header"><div class="search"><div class="search-input-wrap"> <input aria-label="Search Drupal Book" autocomplete="off" class="search-input" id="search-input" placeholder="Search Drupal Book" tabindex="0" type="text"/> <label class="search-label" for="search-input"><svg class="search-icon" viewbox="0 0 24 24"><use xlink:href="#svg-search"></use></svg></label></div><div class="search-results" id="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a class="site-button" href="https://twitter.com/selwynpolit" rel="noopener noreferrer" target="_blank"> <img alt="Twitter logo" src="https://atuin.ru/demo/simple-icons/icons/twitter.svg" style="width: 30px; height: 30px;" title="Author in Twitter"/> </a><li class="aux-nav-list-item"> <a class="site-button" href="https://github.com/selwynpolit/d9book/tree/gh-pages" rel="noopener noreferrer" target="_blank"> <img alt="GitHub logo" src="https://atuin.ru/demo/simple-icons/icons/github.svg" style="width: 30px; height: 30px;" title="D9Book on GitHub"/> </a></li></li></ul></nav></div><div class="main-content-wrap" id="main-content-wrap"><div class="main-content" id="main-content" role="main"><h1 class="no_toc fw-500" id="getting-off-the-island-formerly-reaching-out-of-drupal"> <a aria-labelledby="getting-off-the-island-formerly-reaching-out-of-drupal" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#getting-off-the-island-formerly-reaching-out-of-drupal"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Getting off the Island (formerly Reaching out of Drupal)</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a aria-labelledby="table-of-contents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#table-of-contents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ul id="markdown-toc"><li><a href="https://selwynpolit.github.io/d9book/off-island#overview" id="markdown-toc-overview">Overview</a><li><a href="https://selwynpolit.github.io/d9book/off-island#guzzle-example" id="markdown-toc-guzzle-example">Guzzle example</a><li><a href="https://selwynpolit.github.io/d9book/off-island#guzzle-post-example" id="markdown-toc-guzzle-post-example">Guzzle POST example</a><li><a href="https://selwynpolit.github.io/d9book/off-island#magic-methods-to-send-synchronous-requests" id="markdown-toc-magic-methods-to-send-synchronous-requests">Magic methods to send synchronous requests</a><li><a href="https://selwynpolit.github.io/d9book/off-island#http-basic-authentication" id="markdown-toc-http-basic-authentication">HTTP basic authentication</a><li><a href="https://selwynpolit.github.io/d9book/off-island#exception-handling" id="markdown-toc-exception-handling">Exception handling</a><li><a href="https://selwynpolit.github.io/d9book/off-island#guzzle-exceptions" id="markdown-toc-guzzle-exceptions">Guzzle Exceptions</a><li><a href="https://selwynpolit.github.io/d9book/off-island#http-response-status-codes" id="markdown-toc-http-response-status-codes">HTTP response status codes</a><li><a href="https://selwynpolit.github.io/d9book/off-island#reading-from-an-api" id="markdown-toc-reading-from-an-api">Reading from an API</a><li><a href="https://selwynpolit.github.io/d9book/off-island#download-a-file-using-guzzle" id="markdown-toc-download-a-file-using-guzzle">Download a file using guzzle</a><li><a href="https://selwynpolit.github.io/d9book/off-island#download-a-file-using-curl-in-php" id="markdown-toc-download-a-file-using-curl-in-php">Download a file using curl in PHP</a><li><a href="https://selwynpolit.github.io/d9book/off-island#resources" id="markdown-toc-resources">Resources</a></li></li></li></li></li></li></li></li></li></li></li></li></ul><p><img alt="views" src="https://api.visitor.plantree.me/visitor-badge/pv?label=views&amp;color=informational&amp;namespace=d9book&amp;key=off_the_island.md"/></p><hr/><h2 id="overview"> <a aria-labelledby="overview" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#overview"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Overview</h2><p>To communicate with external websites or web services we can make web requests via the <a href="https://api.drupal.org/Drupal::httpClient">Drupal::httpClient</a> class. This is a wrapper for the <a href="https://github.com/guzzle/guzzle">Guzzle HTTP Client</a>.</p><p>From <a href="https://www.php-fig.org/psr/psr-7/">https://www.php-fig.org/psr/psr-7/</a> HTTP messages are the foundation of web development. Web browsers and HTTP clients such as cURL create HTTP request messages that are sent to a web server, which provides an HTTP response message. Server-side code receives an HTTP request message, and returns an HTTP response message.</p><p>HTTP messages are typically abstracted from the end-user consumer, but as developers, we typically need to know how they are structured and how to access or manipulate them in order to perform our tasks, whether that might be making a request to an HTTP API, or handling an incoming request.</p><p>Guzzle utilizes <a href="http://www.php-fig.org/psr/psr-7/">PSR-7</a> as the HTTP message interface. <a href="http://www.php-fig.org/psr/psr-7/">PSR-7</a> describes common interfaces for representing HTTP messages. This allows Guzzle to work with any other library that utilizes PSR-7 message interfaces.</p><h2 id="guzzle-example"> <a aria-labelledby="guzzle-example" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#guzzle-example"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Guzzle example</h2><p>This is an example which retrieves data from within a controller using a GET:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="k">function</span> <span class="n">example1</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">//Initialize client;</span>
    <span class="nv">$client</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">httpClient</span><span class="p">();</span>
    <span class="nv">$uri</span> <span class="o">=</span> <span class="s1">'https://demo.ckan.org/api/3/action/package_list'</span><span class="p">;</span>

    <span class="c1">// Returns a GuzzleHttp\Psr7\Response.</span>
    <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">request</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'https://demo.ckan.org/api/3/action/package_list'</span><span class="p">);</span>
    <span class="c1">// Or using the magic method.</span>
    <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$uri</span><span class="p">);</span>

    <span class="c1">// Returns a GuzzleHttp\Psr7\Stream.</span>
    <span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getBody</span><span class="p">();</span>
    <span class="nv">$json_data</span> <span class="o">=</span> <span class="nc">Json</span><span class="o">::</span><span class="nf">decode</span><span class="p">(</span><span class="nv">$stream</span><span class="p">);</span>

    <span class="nv">$help</span> <span class="o">=</span> <span class="nv">$json_data</span><span class="p">[</span><span class="s1">'help'</span><span class="p">];</span>
    <span class="nv">$success</span> <span class="o">=</span> <span class="nv">$json_data</span><span class="p">[</span><span class="s1">'success'</span><span class="p">];</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$json_data</span><span class="p">[</span><span class="s1">'result'</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

    <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">"&lt;br&gt;URI: "</span> <span class="mf">.</span> <span class="nv">$uri</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;Help: "</span> <span class="mf">.</span> <span class="nv">$help</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;Success: "</span> <span class="mf">.</span> <span class="nv">$success</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;Result: "</span> <span class="mf">.</span> <span class="nv">$result</span><span class="p">;</span>

    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="nv">$msg</span><span class="p">),</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div><h2 id="guzzle-post-example"> <a aria-labelledby="guzzle-post-example" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#guzzle-post-example"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Guzzle POST example</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Initialize client;</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">httpClient</span><span class="p">();</span>
<span class="nv">$uri</span> <span class="o">=</span> <span class="s1">'http://demo.ckan.org/api/3/action/group_list'</span><span class="p">;</span>
<span class="nv">$request</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="p">[</span>
  <span class="s1">'json'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'id'</span><span class="o">=&gt;</span> <span class="s1">'data-explorer'</span>
  <span class="p">]</span>
<span class="p">]);</span>
<span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">getBody</span><span class="p">();</span>
<span class="nv">$json_data</span> <span class="o">=</span> <span class="nc">Json</span><span class="o">::</span><span class="nf">decode</span><span class="p">(</span><span class="nv">$stream</span><span class="p">);</span>
<span class="nv">$help</span> <span class="o">=</span> <span class="nv">$json_data</span><span class="p">[</span><span class="s1">'help'</span><span class="p">];</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$json_data</span><span class="p">[</span><span class="s1">'success'</span><span class="p">];</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$json_data</span><span class="p">[</span><span class="s1">'result'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">' and '</span> <span class="mf">.</span> <span class="nv">$json_data</span><span class="p">[</span><span class="s1">'result'</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
</code></pre></div></div><p>Guzzle takes care of adding a 'Content-Type','application/json' header, as well as json_encoding the 'json' array.</p><h2 id="magic-methods-to-send-synchronous-requests"> <a aria-labelledby="magic-methods-to-send-synchronous-requests" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#magic-methods-to-send-synchronous-requests"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Magic methods to send synchronous requests</h2><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'http://httpbin.org/get'</span><span class="p">);</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nb">delete</span><span class="p">(</span><span class="s1">'http://httpbin.org/delete'</span><span class="p">);</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">head</span><span class="p">(</span><span class="s1">'http://httpbin.org/get'</span><span class="p">);</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">options</span><span class="p">(</span><span class="s1">'http://httpbin.org/get'</span><span class="p">);</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">patch</span><span class="p">(</span><span class="s1">'http://httpbin.org/patch'</span><span class="p">);</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="s1">'http://httpbin.org/post'</span><span class="p">);</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">put</span><span class="p">(</span><span class="s1">'http://httpbin.org/put'</span><span class="p">);</span>
</code></pre></div></div><p>From <a href="https://docs.guzzlephp.org/en/latest/quickstart.html#sending-requests">https://docs.guzzlephp.org/en/latest/quickstart.html#sending-requests</a></p><h2 id="http-basic-authentication"> <a aria-labelledby="http-basic-authentication" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#http-basic-authentication"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> HTTP basic authentication</h2><p>This shows a failed attempt to authenticate with Github's API with exception handling. It will log the error to Drupal's watchdog and display it on screen:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">example2</span><span class="p">()</span> <span class="p">{</span>

  <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
  <span class="nv">$client</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">httpClient</span><span class="p">();</span>
  <span class="nv">$uri</span> <span class="o">=</span> <span class="s1">'https://api.github.com/user'</span><span class="p">;</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="p">[</span>
      <span class="s1">'auth'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'username'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">]</span>
    <span class="p">]);</span>
    <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">getBody</span><span class="p">();</span>
    <span class="nv">$msg</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;&lt;strong&gt;GET&lt;/strong&gt;"</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;URI: "</span> <span class="mf">.</span> <span class="nv">$uri</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">catch</span> <span class="p">(</span><span class="nc">ClientException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
    <span class="nf">watchdog_exception</span><span class="p">(</span><span class="s1">'guzzle_examples'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">catch</span> <span class="p">(</span><span class="nc">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
    <span class="nf">watchdog_exception</span><span class="p">(</span><span class="s1">'guzzle_examples'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
    <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="nv">$msg</span><span class="p">),</span>
  <span class="p">];</span>

  <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>See <a href="https://docs.guzzlephp.org/en/latest/request-options.html#auth">https://docs.guzzlephp.org/en/latest/request-options.html#auth</a> for more.</p><h2 id="exception-handling"> <a aria-labelledby="exception-handling" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#exception-handling"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Exception handling</h2><p>When using <code class="language-plaintext highlighter-rouge">Drupal::httpClient</code>, you should always wrap your requests in a try/catch block, to handle any exceptions. Here is an example of logging <code class="language-plaintext highlighter-rouge">Drupal::httpClient</code> request exceptions via <code class="language-plaintext highlighter-rouge">watchdog_exception</code>. This example will fail with a <code class="language-plaintext highlighter-rouge">401</code> error and display it on screen.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">example2</span><span class="p">()</span> <span class="p">{</span>

  <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
  <span class="nv">$client</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">httpClient</span><span class="p">();</span>
  <span class="nv">$uri</span> <span class="o">=</span> <span class="s1">'https://api.github.com/user'</span><span class="p">;</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="p">[</span>
      <span class="s1">'auth'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'username'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">]</span>
    <span class="p">]);</span>
    <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nf">getBody</span><span class="p">();</span>
    <span class="nv">$msg</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;&lt;strong&gt;GET&lt;/strong&gt;"</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;URI: "</span> <span class="mf">.</span> <span class="nv">$uri</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">catch</span> <span class="p">(</span><span class="nc">ClientException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
    <span class="nf">watchdog_exception</span><span class="p">(</span><span class="s1">'guzzle_examples'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">catch</span> <span class="p">(</span><span class="nc">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
    <span class="nf">watchdog_exception</span><span class="p">(</span><span class="s1">'guzzle_examples'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
    <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="nv">$msg</span><span class="p">),</span>
  <span class="p">];</span>

  <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="guzzle-exceptions"> <a aria-labelledby="guzzle-exceptions" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#guzzle-exceptions"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Guzzle Exceptions</h2><p>You can get a full list of Exception types simply by listing the contents of the directory: <code class="language-plaintext highlighter-rouge">\&lt;drupal_root\&gt;/vendor/guzzlehttp/guzzle/src/Exception</code>. Utilizing this list allows you to provide different behavior based on exception type.</p><p>At the time of writing, the contents of that directory is:</p><ul><li>BadResponseException.php<li>ClientException.php - use this to handle a 4xx error<li>ConnectException.php<li>GuzzleException.php<li>RequestException.php<li>SeekException.php<li>ServerException.php<li>TooManyRedirectsException.php<li>TransferException.php</li></li></li></li></li></li></li></li></li></ul><h2 id="http-response-status-codes"> <a aria-labelledby="http-response-status-codes" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#http-response-status-codes"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> HTTP response status codes</h2><p>From <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">https://developer.mozilla.org/en-US/docs/Web/HTTP/Status</a></p><p>HTTP response status codes indicate whether a specific <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP">HTTP</a> request has been successfully completed. Responses are grouped in five classes:</p><ol><li><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#information_responses">Informational responses</a> (100 – 199)</p><li><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#successful_responses">Successful responses</a> (200 – 299)</p><li><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#redirection_messages">Redirection messages</a> (300 – 399)</p><li><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#client_error_responses">Client error responses</a> (400 – 499)</p><li><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#server_error_responses">Server error responses</a> (500 – 599)</p></li></li></li></li></li></ol><h2 id="reading-from-an-api"> <a aria-labelledby="reading-from-an-api" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#reading-from-an-api"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Reading from an API</h2><p>In this example, a class was created which extends <code class="language-plaintext highlighter-rouge">SqlBase</code> ( docroot/core/modules/migrate/src/Plugin/migrate/source/SqlBase php). The code below is from the <code class="language-plaintext highlighter-rouge">prepareRow()</code> function which retrieves a row of data from the data source. In this case, rather than a SQL database, it is retrieved from an API. It uses basic http authentication during the GET call and if there are any errors, it updates a status elsewhere with a call to <code class="language-plaintext highlighter-rouge">setUpdateStatus()</code>. The following code is not included below, but it may be interesting to know what it does. If the <code class="language-plaintext highlighter-rouge">GET</code> succeeds, the data is parsed out and put into variables to be returned to the called. This acts just like <code class="language-plaintext highlighter-rouge">prepareRow()</code> does when retrieving a row from a <code class="language-plaintext highlighter-rouge">SQL</code> source. Taxonomy terms are looked up and added if they don't already exist (so taxonomy term id's can be returned) and the status is updated showing this row was successfully retrieved.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$nard_auth_settings</span> <span class="o">=</span> <span class="nc">Settings</span><span class="o">::</span><span class="nf">get</span><span class="p">(</span><span class="s1">'nard_api_auth'</span><span class="p">,</span> <span class="p">[]);</span>
<span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$nard_auth_settings</span><span class="p">[</span><span class="s1">'default'</span><span class="p">][</span><span class="s1">'server'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">':'</span> <span class="mf">.</span> <span class="nv">$nard_auth_settings</span><span class="p">[</span><span class="s1">'default'</span><span class="p">][</span><span class="s1">'port'</span><span class="p">];</span>
<span class="nv">$uri</span> <span class="mf">.</span><span class="o">=</span> <span class="s1">'/sourcecontent/search'</span><span class="p">;</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">httpClient</span><span class="p">();</span>

<span class="k">switch</span> <span class="p">(</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$row</span><span class="o">-&gt;</span><span class="nf">getSourceProperty</span><span class="p">(</span><span class="s1">'type'</span><span class="p">)))</span> <span class="p">{</span>
  <span class="k">case</span> <span class="s1">'article'</span><span class="o">:</span>
    <span class="nv">$uuid</span> <span class="o">=</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="nf">getSourceProperty</span><span class="p">(</span><span class="s1">'uuid'</span><span class="p">);</span>
    <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="nf">getSourceProperty</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>

    <span class="c1">// Retrieve the article from the API.</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">request</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">'auth'</span> <span class="o">=&gt;</span> <span class="p">[</span>
          <span class="nv">$nard_auth_settings</span><span class="p">[</span><span class="s1">'default'</span><span class="p">][</span><span class="s1">'username'</span><span class="p">],</span>
          <span class="nv">$nard_auth_settings</span><span class="p">[</span><span class="s1">'default'</span><span class="p">][</span><span class="s1">'password'</span><span class="p">]</span>
        <span class="p">],</span>
        <span class="s1">'query'</span> <span class="o">=&gt;</span> <span class="p">[</span>
          <span class="s1">'uuid'</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="nf">getSourceProperty</span><span class="p">(</span><span class="s1">'uuid'</span><span class="p">),</span>
          <span class="s1">'properties'</span> <span class="o">=&gt;</span> <span class="s1">'Byline,updated,created,uuid'</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">'timeout'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
      <span class="p">]);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">RequestException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">watchdog_exception</span><span class="p">(</span><span class="s1">'nard_myconnect'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
      <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">logger</span><span class="p">(</span><span class="s1">'nard_myconnect'</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="nf">info</span><span class="p">(</span><span class="s2">"API error retrieving item </span><span class="nv">$id</span><span class="s2"> with uuid=</span><span class="nv">$uuid</span><span class="s2">."</span><span class="p">);</span>
      <span class="c1">// TODO: Deal with this error</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setUpdateStatus</span><span class="p">(</span><span class="nv">$uuid</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Retrieve the details from the API call.</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getBody</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getContents</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">ClientException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">watchdog_exception</span><span class="p">(</span><span class="s1">'nard_myconnect'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
      <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">logger</span><span class="p">(</span><span class="s1">'nard_myconnect'</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="nf">info</span><span class="p">(</span><span class="s2">"API error retrieving body for item </span><span class="nv">$id</span><span class="s2"> with uuid=</span><span class="nv">$uuid</span><span class="s2">."</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">setUpdateStatus</span><span class="p">(</span><span class="nv">$uuid</span><span class="p">,</span> <span class="s1">'error'</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Parse retrieved JSON into fields.</span>
    <span class="nv">$response</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$response</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$response</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$response</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><p>Curl Request using Drupal httpClient</p><p>From the now defunct link: <a href="http://btobac.com/blog/how-do-curl-request-using-drupal-httpclient-drupal-8">http://btobac.com/blog/how-do-curl-request-using-drupal-httpclient-drupal-8</a></p><p>Here the author has an example of a function which takes a few parameters and can execute a <code class="language-plaintext highlighter-rouge">POST</code>, <code class="language-plaintext highlighter-rouge">PUT</code> or <code class="language-plaintext highlighter-rouge">GET</code>. There is no security code which you almost always need, but there is exception handling and error logging to Drupal watchdog.</p><p>Drupal HTTP client for curl HTTP request like <code class="language-plaintext highlighter-rouge">POST</code>, <code class="language-plaintext highlighter-rouge">PUT</code>, <code class="language-plaintext highlighter-rouge">GET</code> Method even for <code class="language-plaintext highlighter-rouge">DELETE</code>, you can add one type in the below switch case in the class method</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">class</span> <span class="nc">DrupalHTTPClient</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">initRequest</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="p">[],</span><span class="nv">$content</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span> <span class="nv">$method</span> <span class="o">=</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="nv">$msg</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">$type</span> <span class="o">=</span> <span class="s2">"Third Party"</span><span class="p">,</span> <span class="nv">$requestContentType</span> <span class="o">=</span> <span class="s2">"json"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>

      <span class="nv">$client</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">httpClient</span><span class="p">();</span>
      <span class="nv">$params</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">'http_errors'</span> <span class="o">=&gt;</span> <span class="kc">FALSE</span><span class="p">];</span>
      <span class="nv">$params</span><span class="p">[</span><span class="nv">$requestContentType</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$content</span><span class="p">;</span>

      <span class="nv">$params</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$headers</span><span class="p">,</span><span class="nv">$params</span><span class="p">);</span>

      <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">'POST'</span><span class="o">:</span>
          <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">'PUT'</span><span class="o">:</span>
          <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">put</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">'GET'</span><span class="o">:</span>
          <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">post</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getStatusCode</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'200'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getBody</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getContents</span><span class="p">();</span>
        <span class="c1">//\Drupal::messenger()-&gt;addMessage(serialize($data));</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$setMessage</span> <span class="o">=</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$result</span><span class="p">[</span><span class="s1">'message'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$result</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">:</span>
            <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$data</span> <span class="o">:</span> <span class="s2">"Request is done successfully "</span><span class="p">);</span>
            <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addMessage</span><span class="p">(</span><span class="nv">$type</span><span class="mf">.</span><span class="s2">":"</span><span class="mf">.</span><span class="nv">$setMessage</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$result</span><span class="p">[</span><span class="s1">'exception'</span><span class="p">])){</span>
          <span class="nv">$result_message</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
          <span class="k">foreach</span><span class="p">(</span><span class="nv">$result</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">){</span>
            <span class="nv">$result_message</span> <span class="mf">.</span><span class="o">=</span> <span class="nv">$key</span> <span class="mf">.</span><span class="s1">': '</span><span class="mf">.</span><span class="nv">$value</span><span class="mf">.</span><span class="s1">', '</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">logger</span><span class="p">(</span><span class="s1">'invalid_exception'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span><span class="s2">" </span><span class="se">\"</span><span class="s2">Invalid Response: &lt;i&gt;`&lt;strong&gt;"</span><span class="mf">.</span><span class="nv">$method</span><span class="mf">.</span><span class="s2">"&lt;/strong&gt; "</span><span class="mf">.</span><span class="nv">$url</span><span class="mf">.</span><span class="s2">"`&lt;/i&gt; resulted in a &lt;strong&gt;`status:"</span><span class="mf">.</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getStatusCode</span><span class="p">()</span><span class="mf">.</span><span class="s2">", "</span><span class="mf">.</span> <span class="nv">$result_message</span> <span class="mf">.</span><span class="s2">"`&lt;/strong&gt; response </span><span class="se">\"</span><span class="s2"> in &lt;i&gt;"</span><span class="mf">.</span><span class="k">__METHOD__</span><span class="mf">.</span><span class="s2">"() (line "</span><span class="mf">.</span><span class="k">__LINE__</span><span class="mf">.</span><span class="s2">" of "</span><span class="mf">.</span><span class="k">__FILE__</span><span class="mf">.</span><span class="s2">"&lt;/i&gt;)."</span><span class="p">);</span>
          <span class="k">return</span> <span class="kc">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="nv">$type</span><span class="mf">.</span><span class="s1">' exception contact administrator'</span><span class="p">);</span>
        <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">logger</span><span class="p">(</span><span class="s1">'server_exception'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span><span class="s2">" </span><span class="se">\"</span><span class="s2">Server error: &lt;i&gt;`&lt;strong&gt;"</span><span class="mf">.</span><span class="nv">$method</span><span class="mf">.</span><span class="s2">"&lt;/strong&gt; "</span><span class="mf">.</span><span class="nv">$url</span><span class="mf">.</span><span class="s2">"`&lt;/i&gt; resulted in a &lt;strong&gt;`"</span><span class="mf">.</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getStatusCode</span><span class="p">()</span><span class="mf">.</span><span class="s2">" "</span><span class="mf">.</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getReasonPhrase</span><span class="p">()</span><span class="mf">.</span><span class="s2">"`&lt;/strong&gt; response </span><span class="se">\"</span><span class="s2"> in &lt;i&gt;"</span><span class="mf">.</span><span class="k">__METHOD__</span><span class="mf">.</span><span class="s2">"() (line "</span><span class="mf">.</span><span class="k">__LINE__</span><span class="mf">.</span><span class="s2">" of "</span><span class="mf">.</span><span class="k">__FILE__</span><span class="mf">.</span><span class="s2">"&lt;/i&gt;)."</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nc">\GuzzleHttp\Exception\ConnectException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="s1">'Cannot contact '</span><span class="mf">.</span><span class="nv">$type</span><span class="p">);</span>
      <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">logger</span><span class="p">(</span><span class="s1">'connect_exception'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span><span class="s2">" </span><span class="se">\"</span><span class="s2">Connection error: &lt;i&gt;`&lt;strong&gt;"</span><span class="mf">.</span><span class="nv">$method</span><span class="mf">.</span><span class="s2">"&lt;/strong&gt; "</span><span class="mf">.</span><span class="nv">$url</span><span class="mf">.</span><span class="s2">"`&lt;/i&gt; resulted in a &lt;strong&gt;`"</span><span class="mf">.</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">()</span><span class="mf">.</span><span class="s2">"`&lt;/strong&gt; response </span><span class="se">\"</span><span class="s2"> in &lt;i&gt;"</span><span class="mf">.</span><span class="k">__METHOD__</span><span class="mf">.</span><span class="s2">"() (line "</span><span class="mf">.</span><span class="k">__LINE__</span><span class="mf">.</span><span class="s2">" of "</span><span class="mf">.</span><span class="k">__FILE__</span><span class="mf">.</span><span class="s2">"&lt;/i&gt;)."</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">NULL</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="nv">$cl</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DrupalHTTPClient</span><span class="p">();</span>

<span class="nv">$url</span> <span class="o">=</span> <span class="s2">"http://api.adadasdadadasd/adasd/ad/ad"</span><span class="p">;</span>
<span class="nv">$content</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"key"</span> <span class="o">=&gt;</span> <span class="s2">"value"</span><span class="p">];</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nv">$cl</span><span class="o">-&gt;</span><span class="nf">initRequest</span><span class="p">(</span><span class="nv">$url</span><span class="p">,[],</span><span class="nv">$content</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="s2">"anytime just flag"</span><span class="p">);</span>
</code></pre></div></div><h2 id="download-a-file-using-guzzle"> <a aria-labelledby="download-a-file-using-guzzle" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#download-a-file-using-guzzle"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Download a file using guzzle</h2><p>Details are borrowed from <a href="https://gist.github.com/edutrul/9d04d7742545dbedd1a36f7b17632b7a">https://gist.github.com/edutrul/9d04d7742545dbedd1a36f7b17632b7a</a></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">example3</span><span class="p">()</span> <span class="p">{</span>

  <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
  <span class="nv">$client</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">httpClient</span><span class="p">();</span>
  <span class="nv">$uri</span> <span class="o">=</span> <span class="s1">'https://api.github.com/user'</span><span class="p">;</span>

  <span class="k">try</span> <span class="p">{</span>

    <span class="nv">$source_uri</span> <span class="o">=</span> <span class="s1">'https://www.austinprogressivecalendar.com/sites/default/files/styles/medium/public/inserted-images/2018-04-02_5.jpg'</span><span class="p">;</span>
    <span class="c1">// Note sites/default/files/abc directory must exist for this to succeed.</span>
    <span class="nv">$destination_uri</span> <span class="o">=</span> <span class="s1">'sites/default/files/abc/test.png'</span><span class="p">;</span>
    <span class="cd">/** @var \GuzzleHttp\Psr7\Response $response */</span>
    <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$source_uri</span><span class="p">,</span> <span class="p">[</span><span class="s1">'sink'</span> <span class="o">=&gt;</span> <span class="nv">$destination_uri</span><span class="p">]);</span>
    <span class="c1">// file gets downloaded to /sites/default/files/abc/test.png</span>

    <span class="nv">$msg</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;&lt;strong&gt;Retrieve File via Guzzle&lt;/strong&gt;"</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;Source: "</span> <span class="mf">.</span> <span class="nv">$source_uri</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;Dest: "</span> <span class="mf">.</span> <span class="nv">$destination_uri</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nc">ClientException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
    <span class="nf">watchdog_exception</span><span class="p">(</span><span class="s1">'guzzle_examples'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">catch</span> <span class="p">(</span><span class="nc">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addError</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
    <span class="nf">watchdog_exception</span><span class="p">(</span><span class="s1">'guzzle_examples'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
    <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="nv">$msg</span><span class="p">),</span>
  <span class="p">];</span>

  <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="download-a-file-using-curl-in-php"> <a aria-labelledby="download-a-file-using-curl-in-php" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#download-a-file-using-curl-in-php"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Download a file using curl in PHP</h2><p>For comparison, I've included an example of how to download a file using curl.</p><p>From <a href="https://stackoverflow.com/questions/6177661/how-to-download-a-file-using-curl-in-php">Stackoverflow: How to download a file using curl in php?</a></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="c1">// Username or E-mail</span>
<span class="nv">$login</span> <span class="o">=</span> <span class="s1">'username'</span><span class="p">;</span>
<span class="c1">// Password</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="c1">// API Request</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="s1">'https://example.com/api'</span><span class="p">;</span>
<span class="c1">// POST data</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'someTask'</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
<span class="c1">// Convert POST data to json</span>
<span class="nv">$data_string</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
<span class="c1">// initialize cURL</span>
<span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_URL</span><span class="p">,</span><span class="nv">$url</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_HTTPAUTH</span><span class="p">,</span> <span class="no">CURLAUTH_BASIC</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_USERPWD</span><span class="p">,</span> <span class="s2">"</span><span class="nv">$login</span><span class="s2">:</span><span class="nv">$password</span><span class="s2">"</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_CUSTOMREQUEST</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_POSTFIELDS</span><span class="p">,</span> <span class="nv">$data_string</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_HEADER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="c1">// Execute cURL and store the response in a variable</span>
<span class="nv">$file</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>

<span class="c1">// Get the Header Size</span>
<span class="nv">$header_size</span> <span class="o">=</span> <span class="nb">curl_getinfo</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="no">CURLINFO_HEADER_SIZE</span><span class="p">);</span>
<span class="c1">// Get the Header from response</span>
<span class="nv">$header</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$header_size</span><span class="p">);</span>
<span class="c1">// Get the Body from response</span>
<span class="nv">$body</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$header_size</span><span class="p">);</span>
<span class="c1">// Explode Header rows into an array</span>
<span class="nv">$header_items</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$header</span><span class="p">);</span>
<span class="c1">// Close cURL handler</span>
<span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>

<span class="c1">// define new variable for the File name</span>
<span class="nv">$file_name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="c1">// find the filname in the headers.</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/filename="(.*?)"/'</span><span class="p">,</span> <span class="nv">$header</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">)){</span>
  <span class="c1">// If filename not found do something...</span>
  <span class="k">echo</span> <span class="s2">"Unable to find filename.&lt;br&gt;Please check the Response Headers or Header parsing!"</span><span class="p">;</span>
  <span class="k">exit</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// If filename was found assign the name to the variable above </span>
  <span class="nv">$file_name</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>
<span class="c1">// Check header response, if HTTP response is not 200, then display the error.</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/200/'</span><span class="p">,</span> <span class="nv">$header_items</span><span class="p">[</span><span class="mi">0</span><span class="p">])){</span>
  <span class="k">echo</span> <span class="s1">'&lt;pre&gt;'</span><span class="mf">.</span><span class="nb">print_r</span><span class="p">(</span><span class="nv">$header_items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">true</span><span class="p">)</span><span class="mf">.</span><span class="s1">'&lt;/pre&gt;'</span><span class="p">;</span>
  <span class="k">exit</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// Check header response, if HTTP response is 200, then proceed further.</span>

  <span class="c1">// Set the header for PHP to tell it, we would like to download a file</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Description: File Transfer'</span><span class="p">);</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/octet-stream'</span><span class="p">);</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Transfer-Encoding: binary'</span><span class="p">);</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Expires: 0'</span><span class="p">);</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Cache-Control: must-revalidate'</span><span class="p">);</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Pragma: public'</span><span class="p">);</span>
  <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Disposition: attachment; filename='</span><span class="mf">.</span><span class="nv">$file_name</span><span class="p">);</span>

  <span class="c1">// Echo out the file, which then should trigger the download</span>
  <span class="k">echo</span> <span class="nv">$file</span><span class="p">;</span>
  <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Also there were other examples on that page that are probably worth looking at.</p><p>Someone responded with this shorter paste in November 2020 at <a href="http://paste.debian.net/1170460/">http://paste.debian.net/1170460/</a> with the following comment: this code is not downloading a file with PHP, it is PROXYING a file with PHP, and it's not doing a good job either, being way slower and more memory-hungry than required, this script would do it much faster, benchmark it</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
<span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
<span class="nf">curl_setopt_arrah</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="p">[</span>
  <span class="no">CURLOPT_URL</span> <span class="o">=&gt;</span> <span class="s1">'http://example.org'</span><span class="p">,</span>
  <span class="no">CURLOPT_HEADERFUNCTION</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$header</span><span class="p">):</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="nv">$header_trimmed</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$header</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$header_trimmed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">header</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$header</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">]);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Description: File Transfer'</span><span class="p">);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/octet-stream'</span><span class="p">);</span>

<span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
<span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</code></pre></div></div><h2 id="resources"> <a aria-labelledby="resources" class="anchor-heading" href="https://selwynpolit.github.io/d9book/off-island#resources"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Resources</h2><ul><li><p>Guzzle docs <a href="https://docs.guzzlephp.org/en/stable/overview.html">https://docs.guzzlephp.org/en/stable/overview.html</a></p><li><p>Guzzle project <a href="https://github.com/guzzle/guzzle">https://github.com/guzzle/guzzle</a></p><li><p>Article at Drupalize.me by William Hetherington from December 2015 on using Drupal 8 to speak http (using guzzle): <a href="https://drupalize.me/blog/201512/speak-http-drupal-httpclient">https://drupalize.me/blog/201512/speak-http-drupal-httpclient</a></p><li><p>Nice little code snippet from J M Olivas showing how to use dependency injection with Guzzle at <a href="https://gist.github.com/jmolivas/ca258d7f2742d9e1aae4">https://gist.github.com/jmolivas/ca258d7f2742d9e1aae4</a></p><li><p>PSR-7: HTTP message interfaces describes common interfaces for representing HTTP messages and URIs <a href="https://www.php-fig.org/psr/psr-7/">https://www.php-fig.org/psr/psr-7/</a></p></li></li></li></li></li></ul><hr/> <script async="" crossorigin="anonymous" data-category="Q&amp;A" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMjY2NDE4" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="selwynpolit/d9book" data-repo-id="MDEwOlJlcG9zaXRvcnkzMjUxNTQ1Nzg=" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js"> </script><hr/><footer><p><a href="https://selwynpolit.github.io/d9book/off-island#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0"><span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"> <a href="http://www.selwynpolit.github.io/d9book" property="dct:title" rel="cc:attributionURL">Drupal at your fingertips</a> by <a href="http://www.drupal.org/u/selwynpolit" property="cc:attributionName" rel="cc:attributionURL dct:creator">Selwyn Polit</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="license noopener noreferrer" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" style="height:16px!important;vertical-align:text-bottom;"/> <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" style="height:16px!important;vertical-align:text-bottom;"/> </a></span></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0 mr-2"> Page last modified: <span class="d-inline-block">Apr 14 2023</span>.</p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/selwynpolit/d9book/tree/gh-pages/book/off_the_island.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
</body></link></meta></meta></meta></head></html>