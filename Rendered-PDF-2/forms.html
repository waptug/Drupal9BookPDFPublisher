<!DOCTYPE html>
<html lang="en-US"><head><meta charset="utf-8"/><meta content="IE=Edge" http-equiv="X-UA-Compatible"/><link href="https://selwynpolit.github.io/d9book/assets/css/just-the-docs-default.css" rel="stylesheet"/> <script async="" src="https://www.googletagmanager.com/gtag/js?id=8V22RQEJ71"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '8V22RQEJ71', { 'anonymize_ip': true }); </script> <script src="https://selwynpolit.github.io/d9book/assets/js/vendor/lunr.min.js"></script> <script src="https://selwynpolit.github.io/d9book/assets/js/just-the-docs.js"></script><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://selwynpolit.github.io/d9book/assets/images/favicon.ico" rel="icon" type="image/x-icon"/><title>Forms | Drupal Book</title><meta content="Jekyll v4.3.2" name="generator"><meta content="Forms" property="og:title"><meta content="en_US" property="og:locale"><meta content="Drupal at your fingertips" name="description"/><meta content="Drupal at your fingertips" property="og:description"/><link href="https://selwynpolit.github.io/d9book/d9book/forms" rel="canonical"><meta content="https://selwynpolit.github.io/d9book/d9book/forms" property="og:url"/><meta content="Drupal Book" property="og:site_name"/><meta content="website" property="og:type"/><meta content="summary" name="twitter:card"/><meta content="Forms" property="twitter:title"/> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Drupal at your fingertips","headline":"Forms","url":"https://selwynpolit.github.io/d9book/d9book/forms"}</script><body> <a class="skip-to-main" href="https://selwynpolit.github.io/d9book/forms#main-content">Skip to main content</a> <svg class="d-none" xmlns="http://www.w3.org/2000/svg"> <symbol id="svg-link" viewbox="0 0 24 24"><title>Link</title><svg class="feather feather-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"><title>Menu</title><svg class="feather feather-menu" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"><title>Expand</title><svg class="feather feather-chevron-right" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol class="feather feather-external-link" fill="none" height="24" id="svg-external-link" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"><title>Document</title><svg class="feather feather-file" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"><title>Search</title><svg class="feather feather-search" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"> <circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewbox="0 0 16 16"><title>Copy</title><svg class="bi bi-clipboard" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path> </svg> </symbol> <symbol id="svg-copied" viewbox="0 0 16 16"><title>Copied</title><svg class="bi bi-clipboard-check-fill" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a class="site-title lh-tight" href="https://selwynpolit.github.io/d9book/"> Drupal Book </a> <a class="site-button" href="https://selwynpolit.github.io/d9book/forms" id="menu-button"> <svg class="icon" viewbox="0 0 24 24"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" class="site-nav" id="site-nav"><ul class="nav-list"><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/">Home</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/actions">Actions</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/attribution">Attribution</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/bq">Batch and Queue</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/blocks">Blocks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/caching">Caching</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/composer">Composer</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/config">Config</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/cron">Cron</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dates">Dates and Times</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/debugging">Debugging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/development">Development</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/drush">Drush</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/email">Email</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/entities">Entities</a><li class="nav-list-item active"><a class="nav-list-link active" href="https://selwynpolit.github.io/d9book/forms">Forms</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/general">General</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/off-island">Getting off the Island</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/hooks">Hooks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/learn">Learning</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/links">Links</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/logging">Logging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/menus">Menus</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/migrate">Migrate</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/modals">Modals</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/nodes-and-fields">Nodes and Fields</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/queries">Queries</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/redirects">Redirects</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/render">Render Arrays</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/routes">Routes</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/security">Security</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/services">Services</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/state">State</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/taxonomy">Taxonomy</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dtt">Tests</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/twig">Twig</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><ul class="nav-list"><li class="nav-list-item external"> <a class="nav-list-link external" href="https://github.com/selwynpolit/d9book/fork"> Fork me on GitHub <svg aria-labelledby="svg-external-link-title" viewbox="0 0 24 24"><use xlink:href="#svg-external-link"></use></svg> </a></li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div class="main-header" id="main-header"><div class="search"><div class="search-input-wrap"> <input aria-label="Search Drupal Book" autocomplete="off" class="search-input" id="search-input" placeholder="Search Drupal Book" tabindex="0" type="text"/> <label class="search-label" for="search-input"><svg class="search-icon" viewbox="0 0 24 24"><use xlink:href="#svg-search"></use></svg></label></div><div class="search-results" id="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a class="site-button" href="https://twitter.com/selwynpolit" rel="noopener noreferrer" target="_blank"> <img alt="Twitter logo" src="https://atuin.ru/demo/simple-icons/icons/twitter.svg" style="width: 30px; height: 30px;" title="Author in Twitter"/> </a><li class="aux-nav-list-item"> <a class="site-button" href="https://github.com/selwynpolit/d9book/tree/gh-pages" rel="noopener noreferrer" target="_blank"> <img alt="GitHub logo" src="https://atuin.ru/demo/simple-icons/icons/github.svg" style="width: 30px; height: 30px;" title="D9Book on GitHub"/> </a></li></li></ul></nav></div><div class="main-content-wrap" id="main-content-wrap"><div class="main-content" id="main-content" role="main"><h1 class="no_toc fw-500" id="forms-form-api-and-ajax"> <a aria-labelledby="forms-form-api-and-ajax" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#forms-form-api-and-ajax"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Forms, Form API and AJAX</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a aria-labelledby="table-of-contents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#table-of-contents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ul id="markdown-toc"><li><a href="https://selwynpolit.github.io/d9book/forms#overview" id="markdown-toc-overview">Overview</a><li><a href="https://selwynpolit.github.io/d9book/forms#find-a-form-id-in-the-page-source" id="markdown-toc-find-a-form-id-in-the-page-source">Find a form id in the page source</a><li><a href="https://selwynpolit.github.io/d9book/forms#add-buttons-to-your-custom-forms" id="markdown-toc-add-buttons-to-your-custom-forms">Add buttons to your custom forms</a><li><a href="https://selwynpolit.github.io/d9book/forms#modify-a-button-on-a-form-with-hook_form_alter" id="markdown-toc-modify-a-button-on-a-form-with-hook_form_alter">Modify a button on a form with hook_form_alter</a><li><a href="https://selwynpolit.github.io/d9book/forms#hide-a-field-with-hook_form_alter" id="markdown-toc-hide-a-field-with-hook_form_alter">Hide a field with hook_form_alter</a><li><a href="https://selwynpolit.github.io/d9book/forms#hide-revision-info-and-moderation-state" id="markdown-toc-hide-revision-info-and-moderation-state">Hide revision info and moderation state</a><li><a href="https://selwynpolit.github.io/d9book/forms#multiple-fields-on-the-same-controllerpage" id="markdown-toc-multiple-fields-on-the-same-controllerpage">Multiple fields on the same controller/page</a><li><a href="https://selwynpolit.github.io/d9book/forms#conditional-fields-and-field-states-api-states" id="markdown-toc-conditional-fields-and-field-states-api-states">Conditional fields and field states API (#states)</a><ul><li><a href="https://selwynpolit.github.io/d9book/forms#conditional-fields-in-a-form" id="markdown-toc-conditional-fields-in-a-form">Conditional fields in a form</a><li><a href="https://selwynpolit.github.io/d9book/forms#conditional-fields-in-node-add-or-edit-form" id="markdown-toc-conditional-fields-in-node-add-or-edit-form">Conditional fields in node add or edit form</a></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/forms#get-the-key-and-value-from-a-select-drop-down" id="markdown-toc-get-the-key-and-value-from-a-select-drop-down">Get the key and value from a select drop-down</a><li><a href="https://selwynpolit.github.io/d9book/forms#autocomplete" id="markdown-toc-autocomplete">Autocomplete</a><ul><li><a href="https://selwynpolit.github.io/d9book/forms#add-an-autocomplete-taxonomy-field" id="markdown-toc-add-an-autocomplete-taxonomy-field">Add an autocomplete taxonomy field</a><li><a href="https://selwynpolit.github.io/d9book/forms#add-a-views-driven-entity-autocomplete-field" id="markdown-toc-add-a-views-driven-entity-autocomplete-field">Add a views-driven entity autocomplete field</a><li><a href="https://selwynpolit.github.io/d9book/forms#disable-autocomplete-for-user-login-and-password-fields" id="markdown-toc-disable-autocomplete-for-user-login-and-password-fields">Disable autocomplete for user login and password fields</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/forms#validating-input" id="markdown-toc-validating-input">Validating input</a><ul><li><a href="https://selwynpolit.github.io/d9book/forms#validate-string-length" id="markdown-toc-validate-string-length">Validate string length</a><li><a href="https://selwynpolit.github.io/d9book/forms#validate-an-email" id="markdown-toc-validate-an-email">Validate an email</a><li><a href="https://selwynpolit.github.io/d9book/forms#validate-date" id="markdown-toc-validate-date">Validate date</a><li><a href="https://selwynpolit.github.io/d9book/forms#validate-a-node-add-or-edit" id="markdown-toc-validate-a-node-add-or-edit">Validate a node add or edit</a></li></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/forms#displaying-forms" id="markdown-toc-displaying-forms">Displaying Forms</a><ul><li><a href="https://selwynpolit.github.io/d9book/forms#embedding-a-form" id="markdown-toc-embedding-a-form">Embedding a form:</a><li><a href="https://selwynpolit.github.io/d9book/forms#show-a-form-in-a-block" id="markdown-toc-show-a-form-in-a-block">Show a form in a block</a><li><a href="https://selwynpolit.github.io/d9book/forms#provide-a-block-template-for-a-form-in-a-block" id="markdown-toc-provide-a-block-template-for-a-form-in-a-block">Provide a block template for a form in a block</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/forms#redirecting" id="markdown-toc-redirecting">Redirecting</a><ul><li><a href="https://selwynpolit.github.io/d9book/forms#form-submission-with-redirect" id="markdown-toc-form-submission-with-redirect">Form submission with redirect</a><li><a href="https://selwynpolit.github.io/d9book/forms#ajax-redirect" id="markdown-toc-ajax-redirect">Ajax redirect</a><li><a href="https://selwynpolit.github.io/d9book/forms#ajax-redirect-from-a-select-element-dropdown" id="markdown-toc-ajax-redirect-from-a-select-element-dropdown">AJAX redirect from a select element (dropdown)</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/forms#add-javascript-to-a-form" id="markdown-toc-add-javascript-to-a-form">Add Javascript to a form</a><li><a href="https://selwynpolit.github.io/d9book/forms#ajax-forms" id="markdown-toc-ajax-forms">AJAX Forms</a><ul><li><a href="https://selwynpolit.github.io/d9book/forms#popup-an-ajax-modal-dialog" id="markdown-toc-popup-an-ajax-modal-dialog">Popup an AJAX modal dialog</a><li><a href="https://selwynpolit.github.io/d9book/forms#ajax-modal-dialog-with-redirect-example" id="markdown-toc-ajax-modal-dialog-with-redirect-example">AJAX modal dialog with redirect example</a><ul><li><a href="https://selwynpolit.github.io/d9book/forms#ajax-submit" id="markdown-toc-ajax-submit">Ajax submit</a><li><a href="https://selwynpolit.github.io/d9book/forms#ajax-redirect-1" id="markdown-toc-ajax-redirect-1">Ajax redirect</a></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/forms#ajax-redirect-from-a-select-element-dropdown-1" id="markdown-toc-ajax-redirect-from-a-select-element-dropdown-1">AJAX redirect from a select element (dropdown)</a><li><a href="https://selwynpolit.github.io/d9book/forms#update-a-value-in-another-fieldi-am-i-want-using-ajax" id="markdown-toc-update-a-value-in-another-fieldi-am-i-want-using-ajax">Update a value in another field(I am I want) using AJAX</a><li><a href="https://selwynpolit.github.io/d9book/forms#i-am-i-want-revisited" id="markdown-toc-i-am-i-want-revisited">I Am I Want revisited</a><ul><li><a href="https://selwynpolit.github.io/d9book/forms#custom-responses" id="markdown-toc-custom-responses">Custom responses</a></li></ul><li><a href="https://selwynpolit.github.io/d9book/forms#how-do-you-find-all-the-possible-ajax-commands-to-use-with-addcommand" id="markdown-toc-how-do-you-find-all-the-possible-ajax-commands-to-use-with-addcommand">How do you find all the possible AJAX commands to use with addCommand()?</a><li><a href="https://selwynpolit.github.io/d9book/forms#another-ajax-submit-example" id="markdown-toc-another-ajax-submit-example">Another AJAX Submit example</a></li></li></li></li></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/forms#config-forms" id="markdown-toc-config-forms">Config Forms</a><ul><li><a href="https://selwynpolit.github.io/d9book/forms#generate-a-config-form-with-drush" id="markdown-toc-generate-a-config-form-with-drush">Generate a config form with drush</a><li><a href="https://selwynpolit.github.io/d9book/forms#config-forms-overview" id="markdown-toc-config-forms-overview">Config forms overview</a></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/forms#the-basics-of-implementing-forms" id="markdown-toc-the-basics-of-implementing-forms">The basics of implementing forms</a><ul><li><a href="https://selwynpolit.github.io/d9book/forms#location" id="markdown-toc-location">Location</a><li><a href="https://selwynpolit.github.io/d9book/forms#base-classes-for-forms" id="markdown-toc-base-classes-for-forms">Base Classes for forms</a><li><a href="https://selwynpolit.github.io/d9book/forms#create-your-form-class-by-extending-formbase" id="markdown-toc-create-your-form-class-by-extending-formbase">Create your form class by extending Formbase</a><li><a href="https://selwynpolit.github.io/d9book/forms#the-main-methods" id="markdown-toc-the-main-methods">The main methods</a><ul><li><a href="https://selwynpolit.github.io/d9book/forms#getformid" id="markdown-toc-getformid">getFormId()</a><li><a href="https://selwynpolit.github.io/d9book/forms#buildform" id="markdown-toc-buildform">buildForm()</a><li><a href="https://selwynpolit.github.io/d9book/forms#submitform" id="markdown-toc-submitform">submitForm()</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/forms#form-validation-example-1" id="markdown-toc-form-validation-example-1">Form validation example #1</a><li><a href="https://selwynpolit.github.io/d9book/forms#form-validation-example-2" id="markdown-toc-form-validation-example-2">Form Validation example #2</a><li><a href="https://selwynpolit.github.io/d9book/forms#field-attributes" id="markdown-toc-field-attributes">Field attributes</a><li><a href="https://selwynpolit.github.io/d9book/forms#form-elements" id="markdown-toc-form-elements">Form Elements</a><li><a href="https://selwynpolit.github.io/d9book/forms#retrieving-field-values" id="markdown-toc-retrieving-field-values">Retrieving field values</a></li></li></li></li></li></li></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/forms#resources" id="markdown-toc-resources">Resources</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><p><img alt="views" src="https://api.visitor.plantree.me/visitor-badge/pv?label=views&amp;color=informational&amp;namespace=d9book&amp;key=forms.md"/></p><hr/><h2 id="overview"> <a aria-labelledby="overview" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#overview"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Overview</h2><p>Forms can act just like controllers. You can set up a route and call the form in a very similar fashion. See the example route below:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">batch_examples.batch</span><span class="pi">:</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/batch-examples/batchform'</span>
  <span class="na">defaults</span><span class="pi">:</span>
    <span class="na">_title</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Batch'</span>
    <span class="na">_form</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Drupal\batch_examples\Form\BatchForm'</span>
  <span class="na">requirements</span><span class="pi">:</span>
    <span class="na">_permission</span><span class="pi">:</span> <span class="s1">'</span><span class="s">access</span><span class="nv"> </span><span class="s">content'</span>
</code></pre></div></div><h2 id="find-a-form-id-in-the-page-source"> <a aria-labelledby="find-a-form-id-in-the-page-source" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#find-a-form-id-in-the-page-source"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Find a form id in the page source</h2><p>When you need to make changes to a form, it can take a little time to find the form. You often need to find the form id as the first step. To find the form_id for a node comment form, start by editing an article node with the comment form displaying. Inspect code in chrome and look for something like this:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"comment-comment-form comment-form"</span> <span class="na">data-drupal-selector=</span><span class="s">"comment-form"</span> <span class="na">action=</span><span class="s">"/comment/reply/node/1/comment"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">id=</span><span class="s">"comment-form"</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">data-drupal-form-fields=</span><span class="s">"edit-subject-0-value,edit-comment-body-0-value,edit-comment-body-0-format--2,edit-submit,edit-preview"</span><span class="nt">&gt;</span>
</code></pre></div></div><p>The formid is <code class="language-plaintext highlighter-rouge">comment_comment_form</code>. Note <em>dashes will need to become underscores in your code</em>.</p><p>Alternatively, you can add a <code class="language-plaintext highlighter-rouge">hook_form_alter</code> and <code class="language-plaintext highlighter-rouge">print_r</code> or <code class="language-plaintext highlighter-rouge">dsm</code> the <code class="language-plaintext highlighter-rouge">$form_id</code>. If you prefer, you could also log it to the watchdog log:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">nisto_form_alter</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="nc">\Drupal\Core\Form\FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$form_id</span><span class="p">){</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addMessage</span><span class="p">(</span><span class="s1">'Form ID: '</span> <span class="mf">.</span> <span class="nv">$form_id</span><span class="p">);</span>
<span class="c1">// Or log it to watchdog log.</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">logger</span><span class="p">(</span><span class="s1">'nisto_form_alter'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">notice</span><span class="p">(</span><span class="s1">'Form ID: '</span> <span class="mf">.</span> <span class="nv">$form_id</span><span class="p">);</span>
</code></pre></div></div><p>Notice that a node add form looks like <code class="language-plaintext highlighter-rouge">node_catastrophe_notice_form</code> while a node edit form looks more like this: <code class="language-plaintext highlighter-rouge">node_catastrophe_notice_edit_form</code></p><h2 id="add-buttons-to-your-custom-forms"> <a aria-labelledby="add-buttons-to-your-custom-forms" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#add-buttons-to-your-custom-forms"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Add buttons to your custom forms</h2><p>Many forms need extra buttons. Fortunately Drupal allows this to be done easily. In the code below there is a submit button which will execute the <code class="language-plaintext highlighter-rouge">submitForm</code> function. There are two additional buttons: <code class="language-plaintext highlighter-rouge">update_nodes</code> which (on click) calls the <code class="language-plaintext highlighter-rouge">updateNodes</code> function and <code class="language-plaintext highlighter-rouge">cache_warmer</code> which (one click) will execute the <code class="language-plaintext highlighter-rouge">warmCaches</code> function.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$form</span><span class="p">[</span><span class="s1">'sanity_fieldset'</span><span class="p">][</span><span class="s1">'actions'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'actions'</span><span class="p">,</span>
    <span class="p">];</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'sanity_fieldset'</span><span class="p">][</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'submit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
      <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Submit'</span><span class="p">),</span>
    <span class="p">];</span>

    <span class="nv">$form</span><span class="p">[</span><span class="s1">'sanity_fieldset'</span><span class="p">][</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'update_nodes'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
      <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Update'</span><span class="p">),</span>
      <span class="s1">'#submit'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'::updateNodes'</span><span class="p">],</span>
    <span class="p">];</span>

    <span class="nv">$form</span><span class="p">[</span><span class="s1">'sanity_fieldset'</span><span class="p">][</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'cache_warmer'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
      <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Warm Caches'</span><span class="p">),</span>
      <span class="s1">'#submit'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'::warmCaches'</span><span class="p">],</span>
    <span class="p">];</span>
</code></pre></div></div><p>and here is the beginning of the <code class="language-plaintext highlighter-rouge">submit</code> function that goes along with the <code class="language-plaintext highlighter-rouge">update_nodes</code> submit button:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="k">function</span> <span class="n">updateNodesFromCache</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$program_nid</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'program_nid'</span><span class="p">);</span>
    <span class="nv">$vote_number</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'vote_number'</span><span class="p">);</span>
    <span class="nv">$program_node</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'program'</span><span class="p">);</span>
    <span class="nv">$program_title</span> <span class="o">=</span> <span class="nv">$program_node</span><span class="o">-&gt;</span><span class="nf">getTitle</span><span class="p">();</span>
    <span class="nv">$team_nid</span> <span class="o">=</span> <span class="nv">$program_node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_srp_team_ref'</span><span class="p">)[</span><span class="nv">$vote_number</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">;</span>

    <span class="nv">$chunk_size</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="nv">$operations</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="nv">$cache_id</span> <span class="o">=</span> <span class="s2">"expectations.program.</span><span class="nv">$program_nid</span><span class="s2">.vote.</span><span class="nv">$vote_number</span><span class="s2">.team.</span><span class="nv">$team_nid</span><span class="s2">"</span><span class="p">;</span>
    <span class="nv">$cache_data</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">cache</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$cache_id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$cache_data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$expectations</span> <span class="o">=</span> <span class="nv">$cache_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
      <span class="nv">$chunks</span> <span class="o">=</span> <span class="nb">array_chunk</span><span class="p">(</span><span class="nv">$expectations</span><span class="p">,</span> <span class="nv">$chunk_size</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$chunks</span><span class="p">);</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$operations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
          <span class="s1">'\Drupal\tea_teks_voting\Batch\VotingCacheBatch::updateExpectations'</span><span class="p">,</span>
          <span class="p">[</span><span class="nv">$chunks</span><span class="p">[</span><span class="nv">$i</span><span class="p">]],</span>
        <span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="nv">$batch</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s2">"Updating nodes from voting caches for </span><span class="nv">$program_title</span><span class="s2">"</span><span class="p">),</span>
      <span class="s1">'progress_message'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Completed @current out of @total chunks.'</span><span class="p">),</span>
      <span class="s1">'finished'</span> <span class="o">=&gt;</span> <span class="s1">'\Drupal\tea_teks_voting\Batch\VotingCacheBatch::batchFinished'</span><span class="p">,</span>
      <span class="s1">'operations'</span> <span class="o">=&gt;</span> <span class="nv">$operations</span><span class="p">,</span>
    <span class="p">];</span>
    <span class="nf">batch_set</span><span class="p">(</span><span class="nv">$batch</span><span class="p">);</span>    
    
</code></pre></div></div><blockquote><p>Note. The example above shows a batch function. You can read more in the <a href="https://selwynpolit.github.io/d9book/book/bq.html">Batch and Queue chapter</a></p></blockquote><h2 id="modify-a-button-on-a-form-with-hook_form_alter"> <a aria-labelledby="modify-a-button-on-a-form-with-hook_form_alter" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#modify-a-button-on-a-form-with-hook_form_alter"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Modify a button on a form with hook_form_alter</h2><p>in a <code class="language-plaintext highlighter-rouge">.module</code> file like web/modules/custom/mymod/mymod.module we can change the caption on the “save” button to “Comment”</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">mymod_form_alter</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="nc">\Drupal\Core\Form\FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$form_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$form_id</span> <span class="o">==</span> <span class="s1">'comment_comment_form'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'submit'</span><span class="p">][</span><span class="s1">'#value'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Comment'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is a dropdown form element that I added an item to:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s2">"topic"</span><span class="p">][</span><span class="s2">"#options"</span><span class="p">][</span><span class="mi">992</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"selwyn"</span><span class="p">;</span>
</code></pre></div></div><p>And in another <code class="language-plaintext highlighter-rouge">.module</code> file I nuke the contents of the dropdown topic and reload it with different content. These are children of term with tid 2806 sorted by the term name:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">nisto_form_alter</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="nc">\Drupal\Core\Form\FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$form_id</span><span class="p">){</span>
<span class="c1">//  xdebug_break();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$form_id</span> <span class="o">==</span> <span class="s2">"views_exposed_form"</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Clear the current options.</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s2">"topic"</span><span class="p">][</span><span class="s2">"#options"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="nv">$tid</span> <span class="o">=</span> <span class="mi">2806</span><span class="p">;</span>
    <span class="nv">$terms</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'taxonomy_term'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">loadChildren</span><span class="p">(</span><span class="nv">$tid</span><span class="p">);</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$terms</span> <span class="k">as</span> <span class="nv">$term</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$childTerm</span> <span class="o">=</span> <span class="nv">$term</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'tid'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
      <span class="nv">$termName</span> <span class="o">=</span> <span class="nb">ucfirst</span><span class="p">(</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$term</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">));</span>
      <span class="nv">$tid</span> <span class="o">=</span> <span class="nv">$term</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s2">"tid"</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
      <span class="nv">$form</span><span class="p">[</span><span class="s2">"topic"</span><span class="p">][</span><span class="s2">"#options"</span><span class="p">][</span><span class="nv">$tid</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$termName</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">natcasesort</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s2">"topic"</span><span class="p">][</span><span class="s2">"#options"</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="hide-a-field-with-hook_form_alter"> <a aria-labelledby="hide-a-field-with-hook_form_alter" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#hide-a-field-with-hook_form_alter"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Hide a field with hook_form_alter</h2><p>In a <code class="language-plaintext highlighter-rouge">.module</code> file, I used this code to remove access to these fields:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'field_highlight_section'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'field_accordion_section'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div><p>This grays out a field:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'field_text2'</span><span class="p">][</span><span class="s1">'#disabled'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</code></pre></div></div><p>Here is the whole function where I also check what these is currently in use:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">dan_form_alter</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="nc">\Drupal\Core\Form\FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$form_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$activeThemeName</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'theme.manager'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getActiveTheme</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$activeThemeName</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'seven'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'#attributes'</span><span class="p">][</span><span class="s1">'novalidate'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'novalidate'</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$form_id</span> <span class="o">==</span> <span class="s1">'views-exposed-form-site-search-page-search'</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$form</span><span class="p">[</span><span class="s1">'#theme'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'header_search_form'</span><span class="p">];</span>

  <span class="p">}</span>
  <span class="c1">// User is editing or adding content of type overview.</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$form_id</span> <span class="o">==</span> <span class="s1">'node_overview_edit_form'</span> <span class="o">||</span> <span class="nv">$form_id</span> <span class="o">==</span> <span class="s1">'node_overview_form'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addMessage</span><span class="p">(</span><span class="s2">"blah"</span><span class="p">);</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'field_text2'</span><span class="p">][</span><span class="s1">'#disabled'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'field_highlight_section'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'field_accordion_section'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="hide-revision-info-and-moderation-state"> <a aria-labelledby="hide-revision-info-and-moderation-state" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#hide-revision-info-and-moderation-state"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Hide revision info and moderation state</h2><p>In a <code class="language-plaintext highlighter-rouge">.module</code> file you can turn off (or hide) revision information and moderation state like this.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'revision_information'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'moderation_state'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
</code></pre></div></div><h2 id="multiple-fields-on-the-same-controllerpage"> <a aria-labelledby="multiple-fields-on-the-same-controllerpage" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#multiple-fields-on-the-same-controllerpage"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Multiple fields on the same controller/page</h2><p>If you need to have the same form appear multiple times on a page, you need to add a little special logic. In one example, I had several items displayed on a page, and each one needed an option to add feedback by the user. This required the use of a static class variable to uniquely identify each instance of the form on the page.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Class SrpAddFeedbackForm.
 */</span>
<span class="kd">class</span> <span class="nc">SrpAddFeedbackForm</span> <span class="kd">extends</span> <span class="nc">FormBase</span> <span class="p">{</span>

  <span class="cd">/**
   * @var int $instanceId
   *   Used to make sure the getFormId is always unique.
   */</span>
  <span class="k">private</span> <span class="k">static</span> <span class="kt">int</span> <span class="nv">$instanceId</span><span class="p">;</span>
  <span class="mf">...</span>  
</code></pre></div></div><p>In the <code class="language-plaintext highlighter-rouge">getFormId()</code> method where you would normally just use <code class="language-plaintext highlighter-rouge">return 'tea_teks_srp_feedback_add';</code>, you can use the following code instead:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * {@inheritdoc}
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">getFormId</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="nv">$instanceId</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">::</span><span class="nv">$instanceId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">::</span><span class="nv">$instanceId</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="s1">'tea_teks_srp_feedback_add'</span> <span class="mf">.</span> <span class="k">self</span><span class="o">::</span><span class="nv">$instanceId</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="conditional-fields-and-field-states-api-states"> <a aria-labelledby="conditional-fields-and-field-states-api-states" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#conditional-fields-and-field-states-api-states"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Conditional fields and field states API (#states)</h2><p>There are some nice articles at <a href="https://mushtaq.ch/blog/11/drupal-8-conditionally-hide-a-form-field">https://mushtaq.ch/blog/11/drupal-8-conditionally-hide-a-form-field</a> and <a href="https://www.lullabot.com/articles/form-api-states">https://www.lullabot.com/articles/form-api-states</a> that go into more detail.</p><p>Note. There is a very workable conditional fields module <a href="https://www.drupal.org/project/conditional_fields">https://www.drupal.org/project/conditional_fields</a> which lets you do the same sort of thing without any code.</p><p>The magic sauce is to use the jQuery selector to identify the field that will control the states. You can see the left side of the <code class="language-plaintext highlighter-rouge">=&gt;</code> has the jQuery code to select a checkbox or radio button.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">':input[name="copies_yes_no"]'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s1">'0'</span><span class="p">]</span>
</code></pre></div></div><h3 id="conditional-fields-in-a-form"> <a aria-labelledby="conditional-fields-in-a-form" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#conditional-fields-in-a-form"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Conditional fields in a form</h3><p>When creating a form, follow these steps:</p><ol><li><p>Create the field that will control the other field (radio buttons in this case)</p><li><p>Create the field that will be hidden (or manipulated in various ways)</p><li><p>Create the field with a <code class="language-plaintext highlighter-rouge">['#states']</code> index</p></li></li></li></ol><p>Create the <code class="language-plaintext highlighter-rouge">copies_yes_no</code> field, then the <code class="language-plaintext highlighter-rouge">how_many_oversized field</code> and then finally the <code class="language-plaintext highlighter-rouge">#states</code> attribute which will make the <code class="language-plaintext highlighter-rouge">how_many_oversized</code> field appear if you click Yes to the <code class="language-plaintext highlighter-rouge">copies_yes_no</code> field.</p><p>Here is an Example form which will only show the <code class="language-plaintext highlighter-rouge">how_many_oversized</code> field when the <code class="language-plaintext highlighter-rouge">copies_yes_no</code> radio is set to <code class="language-plaintext highlighter-rouge">yes</code>:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'nonstandard'</span><span class="p">][</span><span class="s1">'copies_yes_no'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'radios'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Did the requestor ask for copies of nonstandard documents (e.g., oversized paper, DVD, or VHS tape)?'</span><span class="p">),</span>
  <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="mi">0</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Yes'</span><span class="p">),</span>
    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'No'</span><span class="p">),</span>
  <span class="p">],</span>
<span class="p">];</span>

<span class="nv">$form</span><span class="p">[</span><span class="s1">'nonstandard'</span><span class="p">][</span><span class="s1">'how_many_oversized'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'number'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Oversized paper copies (e.g., 11 inches by 17 inches, greenbar, bluebar), # of pages'</span><span class="p">),</span>
  <span class="s1">'#min'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s1">'#max'</span> <span class="o">=&gt;</span> <span class="mi">65535</span><span class="p">,</span>
  <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">];</span>

<span class="nv">$form</span><span class="p">[</span><span class="s1">'nonstandard'</span><span class="p">][</span><span class="s1">'how_many_oversized'</span><span class="p">][</span><span class="s1">'#states'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="c1">// Only show when copies_yes_no is yes.</span>
  <span class="s1">'visible'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">':input[name="copies_yes_no"]'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s1">'0'</span><span class="p">],</span>
  <span class="p">],</span>
<span class="p">];</span>
</code></pre></div></div><h3 id="conditional-fields-in-node-add-or-edit-form"> <a aria-labelledby="conditional-fields-in-node-add-or-edit-form" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#conditional-fields-in-node-add-or-edit-form"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Conditional fields in node add or edit form</h3><p>To customize how fields are handled in an existing form, use <code class="language-plaintext highlighter-rouge">hook_form_alter</code> and check to see if you are a node add or edit form for our type of node. Set the state to visible for <code class="language-plaintext highlighter-rouge">field_cn_original_notice</code> (so the user can see it) if the <code class="language-plaintext highlighter-rouge">field_cn_extension</code> has a value of checked=TRUE. This has the effect of dynamically displaying the field once the checkbox for <code class="language-plaintext highlighter-rouge">field_cn_extension</code> is clicked. The rest of the function has various other field tweaks</p><p>This is from a <code class="language-plaintext highlighter-rouge">.module</code> file</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">org_mods_form_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$form_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$accountProxy</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">currentUser</span><span class="p">();</span>
  <span class="nv">$account</span> <span class="o">=</span> <span class="nv">$accountProxy</span><span class="o">-&gt;</span><span class="nf">getAccount</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">((</span><span class="nv">$form_id</span> <span class="o">==</span> <span class="s1">'node_catastrophe_notice_form'</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$form_id</span> <span class="o">==</span> <span class="s1">'node_catastrophe_notice_edit_form'</span><span class="p">))</span> <span class="p">{</span>

    <span class="c1">//Disable field.</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'field_cn_end_date'</span><span class="p">][</span><span class="s1">'widget'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'value'</span><span class="p">][</span><span class="s1">'#attributes'</span><span class="p">][</span><span class="s1">'disabled'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'disabled'</span><span class="p">;</span>
    <span class="c1">//Or the simpler.</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'field_cn_end_date'</span><span class="p">][</span><span class="s1">'#disabled'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">hasPermission</span><span class="p">(</span><span class="s1">'administer catastrophe notice'</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$form</span><span class="p">[</span><span class="s1">'field_cn_notes'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
      <span class="nv">$form</span><span class="p">[</span><span class="s1">'field_cn_initial_start_date'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
      <span class="nv">$form</span><span class="p">[</span><span class="s1">'field_cn_initial_end_date'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
      <span class="nv">$form</span><span class="p">[</span><span class="s1">'revision_information'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
      <span class="nv">$form</span><span class="p">[</span><span class="s1">'moderation_state'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Hides Title since it is automatically populated on presave.</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'title'</span><span class="p">][</span><span class="s1">'#access'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>

    <span class="c1">// When the value of field_cn_extension is checked, show this field.</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'field_cn_original_notice'</span><span class="p">][</span><span class="s1">'#states'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'visible'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">':input[name="field_cn_extension[value]"]'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'checked'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">],</span>
      <span class="p">],</span>
    <span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is a variant on this theme for making a field visible or required. In this example, it isn’t using the <code class="language-plaintext highlighter-rouge">[value]</code> as part of the name. When I tried that above, it didn’t seem to work. Perhaps I didn’t have the correct jquery selector.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'field_blah_blah'</span><span class="p">][</span><span class="s1">'#states'</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span>
  <span class="c1">// Only show when scoring_unavailable is not checked.</span>
  <span class="s1">'visible'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">':input[name="scoring_unavailable"]'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'unchecked'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">],</span>
  <span class="p">],</span>
  <span class="s1">'required'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">':input[name="scoring_unavailable"]'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'unchecked'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">],</span>
  <span class="p">],</span>
<span class="p">];</span>
</code></pre></div></div><h2 id="get-the-key-and-value-from-a-select-drop-down"> <a aria-labelledby="get-the-key-and-value-from-a-select-drop-down" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#get-the-key-and-value-from-a-select-drop-down"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Get the key and value from a select drop-down</h2><p>To get the key and the value that the user sees in the dropdown use the following. When the dropdown was created, we gave it array of strings so the key is a zero-based number and the value (<code class="language-plaintext highlighter-rouge">$educationLevel</code>) is the string. This shows how to get both.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$key</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'education_level'</span><span class="p">);</span>
<span class="nv">$educationLevel</span> <span class="o">=</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'education_level'</span><span class="p">][</span><span class="s1">'#options'</span><span class="p">][</span><span class="nv">$key</span><span class="p">];</span>
</code></pre></div></div><h2 id="autocomplete"> <a aria-labelledby="autocomplete" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#autocomplete"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Autocomplete</h2><h3 id="add-an-autocomplete-taxonomy-field"> <a aria-labelledby="add-an-autocomplete-taxonomy-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#add-an-autocomplete-taxonomy-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Add an autocomplete taxonomy field</h3><p>This makes a field on your form that automagically starts populating with terms when you start typing. Here the <code class="language-plaintext highlighter-rouge">$vid</code> is a vocabulary machine name like <code class="language-plaintext highlighter-rouge">media_tags</code>. Not sure what <code class="language-plaintext highlighter-rouge">#tags</code> does – It doesn’t seem to be required. Notice vocab id (vid) is the taxonomy machine name not a number.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$vid1</span> <span class="o">=</span> <span class="s1">'media_tags'</span><span class="p">;</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'tags'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'entity_autocomplete'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Tags'</span><span class="p">),</span>
  <span class="s1">'#target_type'</span> <span class="o">=&gt;</span> <span class="s1">'taxonomy_term'</span><span class="p">,</span>
  <span class="s1">'#selection_settings'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'target_bundles'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$vid1</span><span class="p">],</span>  <span class="c1">//could be [$vid1, $vid2..].</span>
  <span class="p">],</span>
<span class="c1">//      '#tags' =&gt; TRUE,</span>
<span class="p">];</span>
</code></pre></div></div><h3 id="add-a-views-driven-entity-autocomplete-field"> <a aria-labelledby="add-a-views-driven-entity-autocomplete-field" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#add-a-views-driven-entity-autocomplete-field"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Add a views-driven entity autocomplete field</h3><p>This allows you to create a field on your form with a user field. This will be an autocomplete field which uses the view: <code class="language-plaintext highlighter-rouge">users_view</code> and the display <code class="language-plaintext highlighter-rouge">users</code>. It allows you to start typing a username in the field and all matching users will be displayed in the dropdown below the field:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'entity_autocomplete'</span><span class="p">,</span>
  <span class="s1">'#target_type'</span> <span class="o">=&gt;</span> <span class="s1">'user'</span><span class="p">,</span>
  <span class="s1">'#selection_handler'</span> <span class="o">=&gt;</span> <span class="s1">'views'</span><span class="p">,</span>
  <span class="s1">'#selection_settings'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'view'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'view_name'</span> <span class="o">=&gt;</span> <span class="s1">'users_view'</span><span class="p">,</span>
      <span class="s1">'display_name'</span> <span class="o">=&gt;</span> <span class="s1">'users'</span><span class="p">,</span>
      <span class="s1">'arguments'</span> <span class="o">=&gt;</span> <span class="p">[]</span>
    <span class="p">],</span>
  <span class="s1">'match_operator'</span> <span class="o">=&gt;</span> <span class="s1">'CONTAINS'</span>
 <span class="p">],</span>
<span class="p">];</span>
</code></pre></div></div><p>from <a href="https://drupal.stackexchange.com/questions/308870/entity-autocomplete-form-api-field-with-viewsselection-handler">https://drupal.stackexchange.com/questions/308870/entity-autocomplete-form-api-field-with-viewsselection-handler</a></p><h3 id="disable-autocomplete-for-user-login-and-password-fields"> <a aria-labelledby="disable-autocomplete-for-user-login-and-password-fields" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#disable-autocomplete-for-user-login-and-password-fields"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Disable autocomplete for user login and password fields</h3><p>In a .module file use the following code.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Turn off autocomplete on login.
 */</span>
<span class="k">function</span> <span class="n">dirt_form_user_login_form_alter</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="nc">\Drupal\Core\Form\FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$form_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'pass'</span><span class="p">][</span><span class="s1">'#attributes'</span><span class="p">][</span><span class="s1">'autocomplete'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'off'</span><span class="p">;</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'name'</span><span class="p">][</span><span class="s1">'#attributes'</span><span class="p">][</span><span class="s1">'autocomplete'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'off'</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">function</span> <span class="n">dirt_form_user_pass_alter</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="nc">\Drupal\Core\Form\FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$form_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'name'</span><span class="p">][</span><span class="s1">'#attributes'</span><span class="p">][</span><span class="s1">'autocomplete'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'off'</span><span class="p">;</span>
</code></pre></div></div><h2 id="validating-input"> <a aria-labelledby="validating-input" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#validating-input"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Validating input</h2><h3 id="validate-string-length"> <a aria-labelledby="validate-string-length" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#validate-string-length"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Validate string length</h3><p>Check a string length for the <code class="language-plaintext highlighter-rouge">company_name</code> field.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">validateForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$formState</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$formState</span><span class="o">-&gt;</span><span class="nf">isValueEmpty</span><span class="p">(</span><span class="s1">'company_name'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$formState</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'company_name'</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//Set validation error.</span>
      <span class="nv">$formState</span><span class="o">-&gt;</span><span class="nf">setErrorByName</span><span class="p">(</span><span class="s1">'company_name'</span><span class="p">,</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Company name is less than 5 characters'</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="validate-an-email"> <a aria-labelledby="validate-an-email" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#validate-an-email"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Validate an email</h3><p>From web/modules/custom/rsvp/src/Form/RSVPForm.php we call Drupal’s <code class="language-plaintext highlighter-rouge">email.validator</code> service and if it fails, setErrorByName()</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">validateForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'email'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'email.validator'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">isValid</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setErrorByName</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'The email %mail is not valid.'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'%mail'</span><span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">]));</span>
  <span class="p">}</span>

  <span class="k">parent</span><span class="o">::</span><span class="nf">validateForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="nv">$form_state</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="validate-date"> <a aria-labelledby="validate-date" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#validate-date"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Validate date</h3><p>You can also add a custom validation in a .module file. Here we use setTime()to remove the time part of a datetime so we can make comparisons of just the date.</p><p>From a .module file.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Custom form validation for catastrophe notices.
 *
 * Checks if a user enters a date that is more than
 * 2 days earlier than the current date, but only if they didn't
 * check the extension checkbox.
 *
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 */</span>
<span class="k">function</span> <span class="n">cn_form_validate</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$extension</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'field_cn_extension'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$extension</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$extension</span> <span class="o">=</span> <span class="nv">$extension</span><span class="p">[</span><span class="s1">'value'</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="nv">$start_date</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'field_cn_start_date'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$start_date</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$start_date</span> <span class="o">=</span> <span class="nv">$start_date</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'value'</span><span class="p">];</span>
    <span class="nv">$start_date</span><span class="o">-&gt;</span><span class="nf">setTime</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nv">$now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Drupal\Core\Datetime\DrupalDateTime</span><span class="p">();</span>
    <span class="nv">$now</span><span class="o">-&gt;</span><span class="nf">modify</span><span class="p">(</span><span class="s2">"-2 days"</span><span class="p">);</span>
    <span class="nv">$now</span><span class="o">-&gt;</span><span class="nf">setTime</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$start_date</span> <span class="o">&lt;</span> <span class="nv">$now</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$extension</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setErrorByName</span><span class="p">(</span><span class="s1">'field_cn_start_date'</span><span class="p">,</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'The starting date is more than 2 days in the past. Please select a more recent date.'</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="validate-a-node-add-or-edit"> <a aria-labelledby="validate-a-node-add-or-edit" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#validate-a-node-add-or-edit"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Validate a node add or edit</h3><p>In org_mods.module we implement a <code class="language-plaintext highlighter-rouge">hook_form_alter</code>, and add a validate callback function for anonymous users only.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Implements hook_form_alter().
 */</span>
<span class="k">function</span> <span class="n">org_mods_form_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$form_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$accountProxy</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">currentUser</span><span class="p">();</span>
  <span class="nv">$account</span> <span class="o">=</span> <span class="nv">$accountProxy</span><span class="o">-&gt;</span><span class="nf">getAccount</span><span class="p">();</span>

  <span class="c1">// Add special validation for anonymous users (node add) only.</span>
  <span class="k">if</span> <span class="p">((</span><span class="nv">$accountProxy</span><span class="o">-&gt;</span><span class="nf">isAnonymous</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$form_id</span> <span class="o">==</span> <span class="s1">'node_catastrophe_notice_form'</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'#validate'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'cn_form_validate'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>And here is the custom validate function which does some fun date arithmetic.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Custom form validation for catastrophe notices.
 *
 * Checks if a user enters a date that is more than
 * 2 days earlier than the current date, but only if they didn't
 * check the extension checkbox.
 *
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 */</span>
<span class="k">function</span> <span class="n">cn_form_validate</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$extension</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'field_cn_extension'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$extension</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$extension</span> <span class="o">=</span> <span class="nv">$extension</span><span class="p">[</span><span class="s1">'value'</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="nv">$start_date</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'field_cn_start_date'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$start_date</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$start_date</span> <span class="o">=</span> <span class="nv">$start_date</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'value'</span><span class="p">];</span>
    <span class="nv">$start_date</span><span class="o">-&gt;</span><span class="nf">setTime</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nv">$now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Drupal\Core\Datetime\DrupalDateTime</span><span class="p">();</span>
    <span class="nv">$now</span><span class="o">-&gt;</span><span class="nf">modify</span><span class="p">(</span><span class="s2">"-2 days"</span><span class="p">);</span>
    <span class="nv">$now</span><span class="o">-&gt;</span><span class="nf">setTime</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$start_date</span> <span class="o">&lt;</span> <span class="nv">$now</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$extension</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setErrorByName</span><span class="p">(</span><span class="s1">'field_cn_start_date'</span><span class="p">,</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'The starting date is more than 2 days in the past. Please select a later date'</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="displaying-forms"> <a aria-labelledby="displaying-forms" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#displaying-forms"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Displaying Forms</h2><h3 id="embedding-a-form"> <a aria-labelledby="embedding-a-form" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#embedding-a-form"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Embedding a form:</h3><p>In this example, there is a form called <code class="language-plaintext highlighter-rouge">ExampleForm</code> at <code class="language-plaintext highlighter-rouge">web/modules/custom/test/src/Form/ExampleForm.php</code>.</p><p>To render a form programmatically, either inside a Controller or a block, use the <code class="language-plaintext highlighter-rouge">FormBuilder</code> service. The form builder can be injected using the form_builder service key or used statically to then build the form (which returns a render array)</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">formBuilder</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getForm</span><span class="p">(</span><span class="s1">'Drupal\test\Form\ExampleForm'</span><span class="p">);</span>
<span class="nv">$build</span><span class="p">[</span><span class="s1">'egform'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$form</span><span class="p">;</span>
<span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
</code></pre></div></div><h3 id="show-a-form-in-a-block"> <a aria-labelledby="show-a-form-in-a-block" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#show-a-form-in-a-block"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Show a form in a block</h3><p>In dev1/web/modules/custom/rsvp/src/Plugin/Block/RSVPBlock.php you can see in the build() method, we invoke a form like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">RSVPBlock</span> <span class="kd">extends</span> <span class="nc">BlockBase</span> <span class="p">{</span>

  <span class="cd">/**
   * @inheritDoc
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">formBuilder</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getForm</span><span class="p">(</span><span class="s1">'Drupal\rsvp\Form\RSVPForm'</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div><p>In <code class="language-plaintext highlighter-rouge">docroot/modules/custom/quick_pivot/src/Plugin/Block/QuickPivotSubscribeBlock.php</code> we use dependency injection to pass in the <code class="language-plaintext highlighter-rouge">FormBuilderInterface</code> and then get the form in a very similar way.</p><p>The constructor grabbed the formbuilder like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">,</span> <span class="kt">ConfigFactoryInterface</span> <span class="nv">$config_factory</span><span class="p">,</span> <span class="kt">FormBuilderInterface</span> <span class="nv">$form_builder</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">(</span><span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">);</span>

  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">configFactory</span> <span class="o">=</span> <span class="nv">$config_factory</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">formBuilder</span> <span class="o">=</span> <span class="nv">$form_builder</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">formBuilder</span><span class="o">-&gt;</span><span class="nf">getForm</span><span class="p">(</span><span class="s1">'Drupal\quick_pivot\Form\QuickPivotSubscribeForm'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="provide-a-block-template-for-a-form-in-a-block"> <a aria-labelledby="provide-a-block-template-for-a-form-in-a-block" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#provide-a-block-template-for-a-form-in-a-block"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Provide a block template for a form in a block</h3><p>In /modules/custom/dan_pagination/src/Form/VideoPaginationForm.php I have a form which is displayed in a block. The usual block template file provided by the theme is <code class="language-plaintext highlighter-rouge">block.html.twig</code> and looks like this:</p><p>(Here is an image of this source code. Strangely, Jekyll/Github requires me to jump through some hoops for TWIG source. I’m still experimenting.) <img alt="block template" src="https://selwynpolit.github.io/d9book/assets/images/block_template.png"/></p><p>Here is the source:</p><div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span>
  <span class="cp">{{</span> <span class="nv">attributes</span> <span class="cp">}}</span><span class="nt">&gt;</span>
  <span class="cp">{{</span> <span class="nv">title_prefix</span> <span class="cp">}}</span>
  <span class="cp">{%</span> <span class="k">if</span> <span class="nv">label</span> <span class="cp">%}</span>
    <span class="nt">&lt;h2</span><span class="cp">{{</span> <span class="nv">title_attributes</span> <span class="cp">}}</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="nv">label</span> <span class="cp">}}</span><span class="nt">&lt;/h2&gt;</span>
  <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">title_suffix</span> <span class="cp">}}</span>
  <span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="cp">{{</span> <span class="nv">content</span> <span class="cp">}}</span>
  <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div><p>The template outputs the guts of the block as</p><div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{{</span> <span class="nv">block</span> <span class="nv">content</span> <span class="cp">}}</span>
</code></pre></div></div><p>For my custom theme called dprime, I added a new template file at <code class="language-plaintext highlighter-rouge">themes/custom/dprime/templates/block/block--videopaginationblock.html.twig</code> and added lots of fun stuff to output the form in bits and pieces.</p><p>e.g. like here, to display the previous_clip item from the form’s render array which looks like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'previous_clip'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'markup'</span><span class="p">,</span>
  <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="s2">"(Clip </span><span class="nv">$previous_clip_num</span><span class="s2">/</span><span class="nv">$clip_count</span><span class="s2">)"</span><span class="p">,</span>
<span class="p">];</span>
</code></pre></div></div><p>And in the template, you can see <code class="language-plaintext highlighter-rouge">content.previous_clip</code> referencing this content.</p><div class="language-twig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"cell medium-6 medium-order-2 text-center"</span><span class="nt">&gt;</span>
  
  <span class="cp">{{</span> <span class="nv">content.select</span> <span class="cp">}}</span>
  
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"cell small-6 medium-order-1 medium-3"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">""</span> <span class="na">class=</span><span class="s">"linkPager linkPager--prev"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"linkPager-icon"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon--arrowLeft"</span> <span class="na">data-grunticon-embed=</span><span class="s">""</span><span class="nt">&gt;&lt;/span&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"linkPager-text"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"linkPager-title"</span><span class="nt">&gt;</span>Prev<span class="nt">&lt;/span&gt;</span>
    
    <span class="cp">{{</span> <span class="nv">content.previous_clip</span> <span class="cp">}}</span>
    
  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div><h2 id="redirecting"> <a aria-labelledby="redirecting" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#redirecting"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Redirecting</h2><h3 id="form-submission-with-redirect"> <a aria-labelledby="form-submission-with-redirect" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#form-submission-with-redirect"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Form submission with redirect</h3><p>Here is a <code class="language-plaintext highlighter-rouge">submitForm()</code> function from docroot/modules/custom/websphere_commerce/modules/checkout/src/Form/ReviewForm.php</p><p>The call to <code class="language-plaintext highlighter-rouge">$form_state-&gt;getValues()</code> retrieves all the values in the form. The rest of the logic checks a value and redirects the user to a specific page.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">submitForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$values</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="nv">$values</span><span class="p">[</span><span class="s1">'op'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Goback'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">redirectUser</span><span class="p">(</span><span class="s1">'/checkout/'</span> <span class="mf">.</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'cart_id'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">'/billing'</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div><p>Here is the source for the redirectUser() call from above.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">redirectUser</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="nv">$route</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$route</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$redirectUrl</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromUserInput</span><span class="p">(</span><span class="nv">$path</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">();</span>
    <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedirectResponse</span><span class="p">(</span><span class="nv">$redirectUrl</span><span class="p">);</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">send</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="ajax-redirect"> <a aria-labelledby="ajax-redirect" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#ajax-redirect"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Ajax redirect</h3><p>If you want to redirect to the <code class="language-plaintext highlighter-rouge">/cart</code> url, you must add an AJAX command. See the <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Ajax%21RedirectCommand.php/class/RedirectCommand/9.4.x">RedirectCommand in the API Reference</a></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$cartUrl</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromUri</span><span class="p">(</span><span class="s1">'internal:/cart'</span><span class="p">);</span>
<span class="nv">$ajax_response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span>
    <span class="k">new</span> <span class="nc">RedirectCommand</span><span class="p">(</span><span class="nv">$cartUrl</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">())</span><span class="c1">//Note this is a string!! </span>
<span class="p">);</span>
<span class="k">return</span> <span class="nv">$ajax_response</span><span class="p">;</span>
</code></pre></div></div><p>In a non-ajax form, to redirect to the cart url, we would just use something like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setRedirectUrl</span><span class="p">(</span><span class="nv">$cartUrl</span><span class="p">);</span>
</code></pre></div></div><h3 id="ajax-redirect-from-a-select-element-dropdown"> <a aria-labelledby="ajax-redirect-from-a-select-element-dropdown" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#ajax-redirect-from-a-select-element-dropdown"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> AJAX redirect from a select element (dropdown)</h3><p>Here I set up a dropdown with the url’s and when the user makes a change in the dropdown, the browser goes to that url. The url’s are /node/1 /node/2 etc. For the correct url to be built, we have to prefix “internal:” to them and that happens in the callback function <code class="language-plaintext highlighter-rouge">mySelectChange()</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$nojs</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Get the form values and raw input (unvalidated values).</span>
    <span class="nv">$values</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">();</span>

    <span class="c1">// Define a wrapper id to populate new content into.</span>
    <span class="nv">$ajax_wrapper</span> <span class="o">=</span> <span class="s1">'my-ajax-wrapper'</span><span class="p">;</span>

    <span class="c1">// Select element.</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
      <span class="s1">'#empty_value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
      <span class="s1">'#empty_option'</span> <span class="o">=&gt;</span> <span class="s1">'- Select a value -'</span><span class="p">,</span>
      <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span>
      <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'/node/1'</span> <span class="o">=&gt;</span> <span class="s1">'One'</span><span class="p">,</span>
        <span class="s1">'/node/2'</span> <span class="o">=&gt;</span> <span class="s1">'Two'</span><span class="p">,</span>
        <span class="s1">'/node/3'</span> <span class="o">=&gt;</span> <span class="s1">'Three'</span>
      <span class="p">],</span>
      <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'mySelectChange'</span><span class="p">],</span>
        <span class="s1">'event'</span> <span class="o">=&gt;</span> <span class="s1">'change'</span><span class="p">,</span>
        <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="nv">$ajax_wrapper</span><span class="p">,</span>
      <span class="p">],</span>
    <span class="p">];</span>
    <span class="c1">// Build a wrapper for the ajax response.</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'my_ajax_container'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'container'</span><span class="p">,</span>
      <span class="s1">'#attributes'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$ajax_wrapper</span><span class="p">,</span>
      <span class="p">]</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cd">/**
   * The callback function for when the `my_select` element is changed.
   *
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">mySelectChange</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$values</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">();</span>

    <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AjaxResponse</span><span class="p">();</span>
<span class="c1">//    $url = Url::fromUri('internal:/node/2');</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromUri</span><span class="p">(</span><span class="s1">'internal:'</span> <span class="mf">.</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]);</span>

    <span class="nv">$command</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedirectCommand</span><span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">());</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//Don't forget an empty submitForm().</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">submitForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This function left blank intentionally.</span>
  <span class="p">}</span>
</code></pre></div></div><p>Invoke the form from the controller with:</p><p>return</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">formBuilder</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getForm</span><span class="p">(</span><span class="s1">'Drupal\org_opinions\Form\IndividualOpinionForm'</span><span class="p">);</span>
</code></pre></div></div><p>The form is at <code class="language-plaintext highlighter-rouge">docroot/modules/custom/org_opinions/src/Form/IndividualOpinionForm.php</code>.</p><p>And don’t forget these:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Form\FormBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Form\FormStateInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Link</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Url</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\AjaxResponse</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\RedirectCommand</span><span class="p">;</span>
</code></pre></div></div><p>Let’s say you have several select elements on the form like <code class="language-plaintext highlighter-rouge">my_select</code> and <code class="language-plaintext highlighter-rouge">my_select2</code> like this (Sorry - not too creative, I know.):</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ajax_wrapper</span> <span class="o">=</span> <span class="s1">'my-ajax-wrapper'</span><span class="p">;</span>
<span class="c1">// Select.</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
  <span class="s1">'#empty_value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
  <span class="s1">'#empty_option'</span> <span class="o">=&gt;</span> <span class="s1">'- Select a value -'</span><span class="p">,</span>
  <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span>
  <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'/node/1'</span> <span class="o">=&gt;</span> <span class="s1">'One'</span><span class="p">,</span>
    <span class="s1">'/node/2'</span> <span class="o">=&gt;</span> <span class="s1">'Two'</span><span class="p">,</span>
    <span class="s1">'/node/3'</span> <span class="o">=&gt;</span> <span class="s1">'Three'</span>
  <span class="p">],</span>
  <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'mySelectChange'</span><span class="p">],</span>
    <span class="s1">'event'</span> <span class="o">=&gt;</span> <span class="s1">'change'</span><span class="p">,</span>
    <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="nv">$ajax_wrapper</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">];</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'my_select2'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
    <span class="s1">'#empty_value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'#empty_option'</span> <span class="o">=&gt;</span> <span class="s1">'- Select a value -'</span><span class="p">,</span>
    <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span>
    <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'/node/4'</span> <span class="o">=&gt;</span> <span class="s1">'Four'</span><span class="p">,</span>
      <span class="s1">'/node/5'</span> <span class="o">=&gt;</span> <span class="s1">'Five'</span><span class="p">,</span>
      <span class="s1">'/node/6'</span> <span class="o">=&gt;</span> <span class="s1">'Six'</span>
    <span class="p">],</span>
    <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'mySelectChange'</span><span class="p">],</span>
      <span class="s1">'event'</span> <span class="o">=&gt;</span> <span class="s1">'change'</span><span class="p">,</span>
      <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="nv">$ajax_wrapper</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">];</span>
</code></pre></div></div><p>Both use the same callback: <code class="language-plaintext highlighter-rouge">mySelectChange</code>. We can make the callback a little smarter by figuring out internally which element called it.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cd">/**
   * Callback function for changes to the `my_select`any select element.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">mySelectChange</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$values</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">();</span>

    <span class="c1">//$elem stores the element info </span>
    <span class="nv">$elem</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getTriggeringElement</span><span class="p">();</span>
    <span class="c1">//$value[$elem["#name"]] stores the path like /node/2</span>

    <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AjaxResponse</span><span class="p">();</span>
    <span class="c1">// Internal URLS must look like this: 'internal:/node/2'.</span>
<span class="c1">//    $url = Url::fromUri('internal:' . $values['my_select']);</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromUri</span><span class="p">(</span><span class="s1">'internal:'</span> <span class="mf">.</span> <span class="nv">$values</span><span class="p">[</span><span class="nv">$elem</span><span class="p">[</span><span class="s2">"#name"</span><span class="p">]]);</span>

    <span class="nv">$command</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedirectCommand</span><span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">());</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>

  <span class="p">}</span>
</code></pre></div></div><h2 id="add-javascript-to-a-form"> <a aria-labelledby="add-javascript-to-a-form" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#add-javascript-to-a-form"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Add Javascript to a form</h2><p>This code is in the <a href="https://www.drupal.org/project/examples">examples</a> module in the <code class="language-plaintext highlighter-rouge">DependentDropdown</code> example where one field depends on the value from another</p><p>From web/modules/contrib/examples/ajax_example/src/Form/DependentDropdown.php the form has some Javascript included via a library:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$nojs</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Add our CSS and tiny JS to hide things when they should be hidden.</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'#attached'</span><span class="p">][</span><span class="s1">'library'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'ajax_example/ajax_example.library'</span><span class="p">;</span>
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">ajax_example.libraries.yml</code> looks like this:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">ajax_example.library</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">1.x</span>
  <span class="na">css</span><span class="pi">:</span>
    <span class="na">base</span><span class="pi">:</span>
      <span class="na">css/ajax-example-base.css</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">js</span><span class="pi">:</span>
    <span class="na">js/ajax-example.js</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div><p>Notice in the <code class="language-plaintext highlighter-rouge">buildform()</code> function that the code references the machine name for the library (not the library’s filename which is <code class="language-plaintext highlighter-rouge">ajax_example.libraries.yml</code>.)</p><p>Here is the js for completeness:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Re-enable form elements that are disabled for non-ajax situations.</span>
  <span class="nx">Drupal</span><span class="p">.</span><span class="nx">behaviors</span><span class="p">.</span><span class="nx">enableFormItemsForAjaxForms</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">attach</span><span class="p">:</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// If ajax is enabled, we want to hide items that are marked as hidden in</span>
      <span class="c1">// our example.</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">Drupal</span><span class="p">.</span><span class="nx">ajax</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">.ajax-example-hide</span><span class="dl">'</span><span class="p">).</span><span class="nf">hide</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

<span class="p">})(</span><span class="nx">jQuery</span><span class="p">);</span>
</code></pre></div></div><h2 id="ajax-forms"> <a aria-labelledby="ajax-forms" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#ajax-forms"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> AJAX Forms</h2><p>When adding ajax to a form, you will need the code:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'#attached'</span><span class="p">][</span><span class="s1">'library'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'core/drupal.dialog.ajax'</span><span class="p">;</span>
</code></pre></div></div><p>This line attaches the <code class="language-plaintext highlighter-rouge">core/drupal.dialog.ajax</code> library to the form and is necessary to render the modal dialogs. Alternatively, you can include this as a dependency in your module’s <code class="language-plaintext highlighter-rouge">*.info.yml</code> file.</p><p>There are some really sweet <a href="https://www.drupal.org/docs/8/api/javascript-api/ajax-forms">writeups about AJAX forms</a> and <a href="https://www.drupal.org/docs/drupal-apis/ajax-api/ajax-dialog-boxes">AJAX Dialog boxes</a></p><h3 id="popup-an-ajax-modal-dialog"> <a aria-labelledby="popup-an-ajax-modal-dialog" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#popup-an-ajax-modal-dialog"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Popup an AJAX modal dialog</h3><p>If you want to have a form pop up a modal dialog or do something via ajax you have to do some slightly special stuff.</p><p>First define what will appear on the dialog</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$checkoutLink</span> <span class="o">=</span> <span class="s1">'/checkout/'</span> <span class="mf">.</span> <span class="nv">$get_order_item_id</span> <span class="mf">.</span> <span class="s1">'/shipping'</span><span class="p">;</span>
<span class="nv">$success_modal_popup</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#theme'</span> <span class="o">=&gt;</span> <span class="s1">'add_cart_success_modal_popup'</span><span class="p">,</span>
  <span class="s1">'#data'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'product_title'</span> <span class="o">=&gt;</span> <span class="nv">$productDetails</span><span class="o">-&gt;</span><span class="n">title</span><span class="o">-&gt;</span><span class="n">value</span> <span class="mf">.</span> <span class="nv">$popup_title</span><span class="p">,</span>
    <span class="s1">'checkout_link'</span> <span class="o">=&gt;</span> <span class="nv">$checkoutLink</span><span class="p">,</span>
    <span class="s1">'cart_link'</span> <span class="o">=&gt;</span> <span class="s1">'/cart'</span><span class="p">,</span>
    <span class="s1">'continue_shopping_link'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;span class="continue-shopping&gt;"Continue Shopping&lt;/p&gt;'</span><span class="p">,</span>
      <span class="s1">'product_id'</span><span class="o">=&gt;</span><span class="nv">$product_id</span><span class="p">,</span>
      <span class="s1">'product_price'</span><span class="o">=&gt;</span><span class="nb">number_format</span><span class="p">(</span><span class="nv">$productDetails_p</span><span class="o">-&gt;</span><span class="n">price</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
      <span class="s1">'product_category'</span><span class="o">=&gt;</span><span class="s1">'Singer'</span><span class="p">,</span>
      <span class="s1">'product_quantity'</span><span class="o">=&gt;</span><span class="nv">$product_qty</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">];</span>
<span class="nv">$content</span><span class="p">[</span><span class="s1">'#markup'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$success_modal_popup</span><span class="p">);</span>
<span class="nv">$content</span><span class="p">[</span><span class="s1">'#attached'</span><span class="p">][</span><span class="s1">'library'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'core/drupal.dialog.ajax'</span><span class="p">;</span>
<span class="nv">$content</span><span class="p">[</span><span class="s1">'#attached'</span><span class="p">][</span><span class="s1">'library'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'websphere_commerce_cart/minicart'</span><span class="p">;</span>
</code></pre></div></div><p>Then add an ajax command to open the dialog:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ajax_response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span>
  <span class="k">new</span> <span class="nc">OpenModalDialogCommand</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="nv">$popup_title</span><span class="p">),</span> <span class="nv">$content</span><span class="p">,</span> <span class="p">[</span><span class="s1">'width'</span> <span class="o">=&gt;</span> <span class="s1">'60%'</span><span class="p">,</span> <span class="s1">'dialogClass'</span> <span class="o">=&gt;</span> <span class="s1">'product-cart-popup'</span><span class="p">])</span>
<span class="p">);</span>
<span class="k">return</span> <span class="nv">$ajax_response</span><span class="p">;</span>
</code></pre></div></div><p>Don’t forget to <strong>return</strong> the <code class="language-plaintext highlighter-rouge">$ajax_response;</code></p><p>Here is a slightly example displaying a modal dialog:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$addTocartFailed</span> <span class="o">=</span> <span class="nv">$websphere_config</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'cart.add_to_cart_failed'</span><span class="p">);</span>
<span class="nv">$success_modal_popup</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#theme'</span> <span class="o">=&gt;</span> <span class="s1">'add_cart_success_modal_popup'</span><span class="p">,</span>
  <span class="s1">'#data'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'addtocart_failed'</span> <span class="o">=&gt;</span> <span class="nv">$addTocartFailed</span><span class="p">,</span>
      <span class="s1">'product_id'</span><span class="o">=&gt;</span><span class="nv">$product_id</span><span class="p">,</span>
      <span class="s1">'product_price'</span><span class="o">=&gt;</span><span class="nb">number_format</span><span class="p">(</span><span class="nv">$productDetails_p</span><span class="o">-&gt;</span><span class="n">price</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
      <span class="s1">'product_category'</span><span class="o">=&gt;</span><span class="s1">'Singer'</span><span class="p">,</span>
      <span class="s1">'product_quantity'</span><span class="o">=&gt;</span><span class="nv">$product_qty</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">];</span>
<span class="nv">$content</span><span class="p">[</span><span class="s1">'#markup'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$success_modal_popup</span><span class="p">);</span>
<span class="nv">$content</span><span class="p">[</span><span class="s1">'#attached'</span><span class="p">][</span><span class="s1">'library'</span><span class="p">][]</span> <span class="o">=</span> <span class="s1">'core/drupal.dialog.ajax'</span><span class="p">;</span>
<span class="nv">$ajax_response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span>
    <span class="k">new</span> <span class="nc">OpenModalDialogCommand</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="nv">$popup_title</span><span class="p">),</span> <span class="nv">$content</span><span class="p">,</span> <span class="p">[</span><span class="s1">'width'</span> <span class="o">=&gt;</span> <span class="s1">'60%'</span><span class="p">,</span> <span class="s1">'dialogClass'</span> <span class="o">=&gt;</span> <span class="s1">'product-cart-popup'</span><span class="p">])</span>
<span class="p">);</span>
<span class="k">return</span> <span class="nv">$ajax_response</span><span class="p">;</span>
</code></pre></div></div><h3 id="ajax-modal-dialog-with-redirect-example"> <a aria-labelledby="ajax-modal-dialog-with-redirect-example" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#ajax-modal-dialog-with-redirect-example"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> AJAX modal dialog with redirect example</h3><p>From <code class="language-plaintext highlighter-rouge">docroot/modules/custom/websphere_commerce/modules/product/src/Form/AddToCartForm.php</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\RedirectCommand</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AddToCartForm</span> <span class="kd">extends</span> <span class="nc">FormBase</span> <span class="p">{</span>
<span class="c1">// Create constructor and create functions for dependency injection</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">PrivateTempStoreFactory</span> <span class="nv">$temp_store_factory</span><span class="p">,</span> <span class="kt">SessionManagerInterface</span> <span class="nv">$session_manager</span><span class="p">,</span> <span class="kt">AccountInterface</span> <span class="nv">$current_user</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">tempStoreFactory</span> <span class="o">=</span> <span class="nv">$temp_store_factory</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sessionManager</span> <span class="o">=</span> <span class="nv">$session_manager</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">currentUser</span> <span class="o">=</span> <span class="nv">$current_user</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'user.private_tempstore'</span><span class="p">),</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'session_manager'</span><span class="p">),</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'current_user'</span><span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Use buildForm() function to create the elements on the form:</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$nid</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> <span class="nv">$productId</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div><h4 id="ajax-submit"> <a aria-labelledby="ajax-submit" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#ajax-submit"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Ajax submit</h4><p>Submit element is a little special. See all that ‘#ajax’ stuff?</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'submit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
  <span class="s1">'#attributes'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'class'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'mobile-hide'</span><span class="p">]),</span>
  <span class="s1">'#id'</span> <span class="o">=&gt;</span> <span class="s1">'add_to_cart'</span><span class="p">,</span>
  <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Add to cart'</span><span class="p">),</span>
  <span class="s1">'#button_type'</span> <span class="o">=&gt;</span> <span class="s1">'primary'</span><span class="p">,</span>
  <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="s1">'::add_to_cart_submit'</span><span class="p">,</span>
    <span class="s1">'event'</span> <span class="o">=&gt;</span> <span class="s1">'click'</span><span class="p">,</span>
    <span class="s1">'progress'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'throbber'</span><span class="p">,</span>
      <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="s1">'editor-settings-wrapper'</span><span class="p">,</span>
    <span class="p">],</span>
  <span class="p">],</span>
<span class="p">];</span>
<span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
</code></pre></div></div><p>In this implementation, there is an empty <code class="language-plaintext highlighter-rouge">submitForm()</code> function. For the ajax submit callback we use <code class="language-plaintext highlighter-rouge">add_to_cart_submit()</code>. Note how a <code class="language-plaintext highlighter-rouge">new AjaxResponse</code> is created.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">add_to_cart_submit</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">global</span> <span class="nv">$user_status</span><span class="p">;</span>
  <span class="nv">$inputs</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getUserInput</span><span class="p">();</span>
  <span class="nv">$ajax_response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AjaxResponse</span><span class="p">();</span>
  <span class="nv">$product_qty</span> <span class="o">=</span> <span class="nv">$inputs</span><span class="p">[</span><span class="s1">'product_qty'</span><span class="p">];</span>
</code></pre></div></div><p>Note. This should probably be a static function to avoid this symfony error:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TypeError: Argument 1 passed to Drupal\Core\Routing\RequestContext::fromRequest() must be an instance of Symfony\Component\HttpFoundation\Request, null given
</code></pre></div></div><h4 id="ajax-redirect-1"> <a aria-labelledby="ajax-redirect-1" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#ajax-redirect-1"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Ajax redirect</h4><p>If you want to redirect to the <code class="language-plaintext highlighter-rouge">/cart</code> url, you must add an AJAX command. See the <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Ajax%21RedirectCommand.php/class/RedirectCommand/9.4.x">RedirectCommand in the API Reference</a></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$cartUrl</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromUri</span><span class="p">(</span><span class="s1">'internal:/cart'</span><span class="p">);</span>
<span class="nv">$ajax_response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span>
    <span class="k">new</span> <span class="nc">RedirectCommand</span><span class="p">(</span><span class="nv">$cartUrl</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">())</span><span class="c1">//Note this is a string!! </span>
<span class="p">);</span>
<span class="k">return</span> <span class="nv">$ajax_response</span><span class="p">;</span>
</code></pre></div></div><p>In a non-ajax form, to redirect to the cart url, we would just use something like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setRedirectUrl</span><span class="p">(</span><span class="nv">$cartUrl</span><span class="p">);</span>
</code></pre></div></div><h3 id="ajax-redirect-from-a-select-element-dropdown-1"> <a aria-labelledby="ajax-redirect-from-a-select-element-dropdown-1" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#ajax-redirect-from-a-select-element-dropdown-1"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> AJAX redirect from a select element (dropdown)</h3><p>Here I set up a dropdown with the url’s and when the user makes a change in the dropdown, the browser goes to that url. The url’s are /node/1 /node/2 etc. For the correct url to be built, we have to prefix “internal:” to them and that happens in the callback function <code class="language-plaintext highlighter-rouge">mySelectChange()</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cd">/**
   * {@inheritdoc}
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$nojs</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Get the form values and raw input (unvalidated values).</span>
    <span class="nv">$values</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">();</span>

    <span class="c1">// Define a wrapper id to populate new content into.</span>
    <span class="nv">$ajax_wrapper</span> <span class="o">=</span> <span class="s1">'my-ajax-wrapper'</span><span class="p">;</span>

    <span class="c1">// Select element.</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
      <span class="s1">'#empty_value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
      <span class="s1">'#empty_option'</span> <span class="o">=&gt;</span> <span class="s1">'- Select a value -'</span><span class="p">,</span>
      <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span>
      <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'/node/1'</span> <span class="o">=&gt;</span> <span class="s1">'One'</span><span class="p">,</span>
        <span class="s1">'/node/2'</span> <span class="o">=&gt;</span> <span class="s1">'Two'</span><span class="p">,</span>
        <span class="s1">'/node/3'</span> <span class="o">=&gt;</span> <span class="s1">'Three'</span>
      <span class="p">],</span>
      <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'mySelectChange'</span><span class="p">],</span>
        <span class="s1">'event'</span> <span class="o">=&gt;</span> <span class="s1">'change'</span><span class="p">,</span>
        <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="nv">$ajax_wrapper</span><span class="p">,</span>
      <span class="p">],</span>
    <span class="p">];</span>
    <span class="c1">// Build a wrapper for the ajax response.</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'my_ajax_container'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'container'</span><span class="p">,</span>
      <span class="s1">'#attributes'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$ajax_wrapper</span><span class="p">,</span>
      <span class="p">]</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cd">/**
   * The callback function for when the `my_select` element is changed.
   *
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">mySelectChange</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$values</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">();</span>

    <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AjaxResponse</span><span class="p">();</span>
<span class="c1">//    $url = Url::fromUri('internal:/node/2');</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromUri</span><span class="p">(</span><span class="s1">'internal:'</span> <span class="mf">.</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]);</span>

    <span class="nv">$command</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedirectCommand</span><span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">());</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//Don't forget an empty submitForm().</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">submitForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This function left blank intentionally.</span>
  <span class="p">}</span>
</code></pre></div></div><p>Invoke the form from the controller with:</p><p>return</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">formBuilder</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getForm</span><span class="p">(</span><span class="s1">'Drupal\org_opinions\Form\IndividualOpinionForm'</span><span class="p">);</span>
</code></pre></div></div><p>The form is at <code class="language-plaintext highlighter-rouge">docroot/modules/custom/org_opinions/src/Form/IndividualOpinionForm.php</code>.</p><p>And don’t forget these:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Form\FormBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Form\FormStateInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Link</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Url</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\AjaxResponse</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\RedirectCommand</span><span class="p">;</span>
</code></pre></div></div><p>Let’s say you have several select elements on the form like <code class="language-plaintext highlighter-rouge">my_select</code> and <code class="language-plaintext highlighter-rouge">my_select2</code> like this (Sorry - not too creative, I know.):</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ajax_wrapper</span> <span class="o">=</span> <span class="s1">'my-ajax-wrapper'</span><span class="p">;</span>
<span class="c1">// Select.</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
  <span class="s1">'#empty_value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
  <span class="s1">'#empty_option'</span> <span class="o">=&gt;</span> <span class="s1">'- Select a value -'</span><span class="p">,</span>
  <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span>
  <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'/node/1'</span> <span class="o">=&gt;</span> <span class="s1">'One'</span><span class="p">,</span>
    <span class="s1">'/node/2'</span> <span class="o">=&gt;</span> <span class="s1">'Two'</span><span class="p">,</span>
    <span class="s1">'/node/3'</span> <span class="o">=&gt;</span> <span class="s1">'Three'</span>
  <span class="p">],</span>
  <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'mySelectChange'</span><span class="p">],</span>
    <span class="s1">'event'</span> <span class="o">=&gt;</span> <span class="s1">'change'</span><span class="p">,</span>
    <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="nv">$ajax_wrapper</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">];</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'my_select2'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
    <span class="s1">'#empty_value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'#empty_option'</span> <span class="o">=&gt;</span> <span class="s1">'- Select a value -'</span><span class="p">,</span>
    <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'my_select'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">),</span>
    <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'/node/4'</span> <span class="o">=&gt;</span> <span class="s1">'Four'</span><span class="p">,</span>
      <span class="s1">'/node/5'</span> <span class="o">=&gt;</span> <span class="s1">'Five'</span><span class="p">,</span>
      <span class="s1">'/node/6'</span> <span class="o">=&gt;</span> <span class="s1">'Six'</span>
    <span class="p">],</span>
    <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">'mySelectChange'</span><span class="p">],</span>
      <span class="s1">'event'</span> <span class="o">=&gt;</span> <span class="s1">'change'</span><span class="p">,</span>
      <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="nv">$ajax_wrapper</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">];</span>
</code></pre></div></div><p>Both use the same callback: <code class="language-plaintext highlighter-rouge">mySelectChange</code>. We can make the callback a little smarter by figuring out internally which element called it.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cd">/**
   * Callback function for changes to the `my_select`any select element.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">mySelectChange</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$values</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">();</span>


    <span class="c1">//$elem stores the element info </span>
    <span class="nv">$elem</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getTriggeringElement</span><span class="p">();</span>
    <span class="c1">//$value[$elem["#name"]] stores the path like /node/2</span>

    <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AjaxResponse</span><span class="p">();</span>
    <span class="c1">// Internal URLS must look like this: 'internal:/node/2'.</span>
<span class="c1">//    $url = Url::fromUri('internal:' . $values['my_select']);</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromUri</span><span class="p">(</span><span class="s1">'internal:'</span> <span class="mf">.</span> <span class="nv">$values</span><span class="p">[</span><span class="nv">$elem</span><span class="p">[</span><span class="s2">"#name"</span><span class="p">]]);</span>

    <span class="nv">$command</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedirectCommand</span><span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">());</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>

  <span class="p">}</span>
</code></pre></div></div><h3 id="update-a-value-in-another-fieldi-am-i-want-using-ajax"> <a aria-labelledby="update-a-value-in-another-fieldi-am-i-want-using-ajax" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#update-a-value-in-another-fieldi-am-i-want-using-ajax"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Update a value in another field(I am I want) using AJAX</h3><p>This was used for a web page that had 2 dropdown fields. It showed I am a ____ and I want ____.</p><p>The code makes the assumption that there is only 1 matching <code class="language-plaintext highlighter-rouge">I want</code> for each <code class="language-plaintext highlighter-rouge">I am</code> which is way too limiting but it does illuminate the techniques somewhat. Therefor, if you select an <code class="language-plaintext highlighter-rouge">I am</code>, you only get 1 choice for an <code class="language-plaintext highlighter-rouge">I want</code>.</p><p>There is nothing too interesting in the <code class="language-plaintext highlighter-rouge">IamiwantBlock.php</code> but in the <code class="language-plaintext highlighter-rouge">iamiwantForm.php</code> it gets a little more juicy. The form presents two dropdown fields, <code class="language-plaintext highlighter-rouge">I am</code> and <code class="language-plaintext highlighter-rouge">I want</code> and a <code class="language-plaintext highlighter-rouge">go</code> button. The value in the <code class="language-plaintext highlighter-rouge">I am</code> dropdown controls the value in the <code class="language-plaintext highlighter-rouge">I want</code>.</p><p>From: <code class="language-plaintext highlighter-rouge">txg/web/modules/custom/iamiwant/src/Form/IamiwantForm.php</code>.</p><p>The code loads <code class="language-plaintext highlighter-rouge">$nids</code> from the database, loops thru them, putting them into an array <code class="language-plaintext highlighter-rouge">$iam</code> indexed by node id. Then it defines the <code class="language-plaintext highlighter-rouge">$form['iam']</code> element with all the good <code class="language-plaintext highlighter-rouge">#ajax</code> stuff including:</p><ol><li>The ‘#submit’ callback: ::submitSelectIam<li>The #executes_submit_callback =&gt; TRUE<li>The ‘callback’ =&gt; ‘::ajaxReplaceIwantForm’ specifies what function to call when this field is “submitted”<li>The ‘wrapper’ =&gt; ‘iwant-container’ is the container that will get replaced<li>The ‘method’ =&gt; ‘replace’ which I guess means replace everything in said wrapper.</li></li></li></li></li></ol><p>Then it defines the <code class="language-plaintext highlighter-rouge">$form['iwant_container']</code> and the <code class="language-plaintext highlighter-rouge">$form['iwant_container']['iwant']</code> element in readiness for the AJAX magic. Lastly it defines the submit <code class="language-plaintext highlighter-rouge">go</code> button.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$nodeStorage</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
  <span class="c1">// Get i_am_i_want node ids.</span>
  <span class="nv">$nids</span> <span class="o">=</span> <span class="nv">$nodeStorage</span><span class="o">-&gt;</span><span class="nf">getQuery</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">accessCheck</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_iam'</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="s1">'IS NOT NULL'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_iwant'</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="s1">'IS NOT NULL'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_link'</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="s1">'IS NOT NULL'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="nc">NodeInterface</span><span class="o">::</span><span class="no">PUBLISHED</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
  <span class="nv">$nodes</span> <span class="o">=</span> <span class="nv">$nodeStorage</span><span class="o">-&gt;</span><span class="nf">loadMultiple</span><span class="p">(</span><span class="nv">$nids</span><span class="p">);</span>
  <span class="nv">$iam</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$nodes</span> <span class="k">as</span> <span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* @var \Drupal\node\NodeInterface $node */</span>
    <span class="nv">$iam</span><span class="p">[</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()]</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_iam'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getString</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'iam'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
    <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'I am'</span><span class="p">),</span>
    <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="nv">$iam</span><span class="p">,</span>
    <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
    <span class="s1">'#submit'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'::submitSelectIam'</span><span class="p">],</span>
    <span class="s1">'#executes_submit_callback'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
    <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="s1">'::ajaxReplaceIwantForm'</span><span class="p">,</span>
      <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="s1">'iwant-container'</span><span class="p">,</span>
      <span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'replace'</span><span class="p">,</span>
    <span class="p">],</span>
  <span class="p">];</span>
  <span class="nv">$iwant</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="c1">// Updates iwant values according to iam.</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'node'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$iwant</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_iwant'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getString</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'iwant_container'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'container'</span><span class="p">,</span>
    <span class="s1">'#prefix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;div id="iwant-container"&gt;'</span><span class="p">,</span>
    <span class="s1">'#suffix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">,</span>
  <span class="p">];</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'iwant_container'</span><span class="p">][</span><span class="s1">'iwant'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
    <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'and I want to'</span><span class="p">),</span>
    <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="nv">$iwant</span><span class="p">,</span>
  <span class="p">];</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'actions'</span><span class="p">,</span>
  <span class="p">];</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'submit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
    <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Go'</span><span class="p">),</span>
  <span class="p">];</span>

  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Below is the callback <code class="language-plaintext highlighter-rouge">submitSelectIam</code> (referenced above) that gets called when the <code class="language-plaintext highlighter-rouge">iamfield</code> value changes. The code grabs the <code class="language-plaintext highlighter-rouge">iam</code> value from the form, loads up that node and stores it in the <code class="language-plaintext highlighter-rouge">$form_state</code> with <code class="language-plaintext highlighter-rouge">$form_state-&gt;set('node', $node);</code> for use later to decide where to jump to.</p><p>In <code class="language-plaintext highlighter-rouge">submitForm()</code>, it grabs the node, pulls out the URI and does a <code class="language-plaintext highlighter-rouge">setRedirectUrl()</code> which causes a jump to that URL.</p><p>In <code class="language-plaintext highlighter-rouge">submitSelectIam()</code>, it loads whichever value the user has put in the iam select. Then he stores that node in the <code class="language-plaintext highlighter-rouge">$form_state</code>, then calls <code class="language-plaintext highlighter-rouge">$form_state-&gt;setRebuild()</code>. This is the code that runs each time iam is chosen.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Handles submit call when iam field is selected.
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">submitSelectIam</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$iam</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'iam'</span><span class="p">);</span>
  <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nv">$iam</span><span class="p">);</span>
  <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'node'</span><span class="p">,</span> <span class="nv">$node</span><span class="p">);</span>
  <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setRebuild</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>Then in the callback for the ajax <code class="language-plaintext highlighter-rouge">iam element</code>. It returns whatever needs to be replaced in the wrapper container (from above). It simply returns the new value for that container (<code class="language-plaintext highlighter-rouge">wrapper</code>).</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="s1">'::ajaxReplaceIwantForm'</span><span class="p">,</span>
      <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="s1">'iwant-container'</span><span class="p">,</span>
      <span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'replace'</span><span class="p">,</span>
</code></pre></div></div><p>Then, add the ajax callback.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Handles switching the iam selector.
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">ajaxReplaceIwantForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'iwant_container'</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div><p>And finally, this code does the actual redirecting when the user clicks go:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">submitForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* @var \Drupal\node\NodeInterface $node */</span>
  <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
  <span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_link'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getString</span><span class="p">();</span>
  <span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromUri</span><span class="p">(</span><span class="nv">$uri</span><span class="p">);</span>
  <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setRedirectUrl</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>This version handles external URL’s</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">submitForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* @var \Drupal\node\NodeInterface $node */</span>
  <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
  <span class="c1">// Get redirect uri from node.</span>
  <span class="nv">$fieldLink</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_link'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getString</span><span class="p">();</span>
  <span class="nv">$url</span> <span class="o">=</span> <span class="nc">Url</span><span class="o">::</span><span class="nf">fromUri</span><span class="p">(</span><span class="nv">$fieldLink</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nc">UrlHelper</span><span class="o">::</span><span class="nf">isExternal</span><span class="p">(</span><span class="nv">$fieldLink</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TrustedRedirectResponse</span><span class="p">(</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">());</span>
    <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setResponse</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setRedirectUrl</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>When this runs, it has the I am drop down showing ‘-select-‘ and the I want dropdown is empty. The I want dropdown is unresponsive. Hmm.</p><p>When I debug, as soon as I change the I am value, <code class="language-plaintext highlighter-rouge">buildForm()</code> runs, then <code class="language-plaintext highlighter-rouge">submitSelectIam()</code>, then <code class="language-plaintext highlighter-rouge">buildForm()</code> again and then <code class="language-plaintext highlighter-rouge">ajaxReplaceIwantForm()</code>. On subsequent runs, it skips the first <code class="language-plaintext highlighter-rouge">buildForm()</code> and runs through the sequence of</p><ol><li>submitSelectIam()<li>buildForm()<li>ajaxReplaceIwantForm()</li></li></li></ol><p>In <code class="language-plaintext highlighter-rouge">submitSelectIam()</code> this code <code class="language-plaintext highlighter-rouge">$form_state-&gt;set('node', $node);</code> stores the node into the form state for later use. You can <code class="language-plaintext highlighter-rouge">-&gt;set()</code> anything into a form for use later. This means that the buildForm can pull it back out to figure out the value for the I want field, like this (in <code class="language-plaintext highlighter-rouge">buildForm()</code>). Note. You can do this in a submit callback but not a callback defined as <code class="language-plaintext highlighter-rouge">'#ajax'</code>. For some reason, they are ignored if you do that type.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Updates iwant values according to iam.</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'node'</span><span class="p">))</span> <span class="p">{</span>
  <span class="nv">$iwant</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_iwant'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getString</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>This is the magic bullet as it limits the <code class="language-plaintext highlighter-rouge">$iwant[]</code> output to only 1 value and also provides the value needed by the submit (go) button so it knows where to send the output. Unfortunately this just sets the <code class="language-plaintext highlighter-rouge">$iwant[]</code> array to the only one possible <code class="language-plaintext highlighter-rouge">iwant</code> value. That is not as useful as one would want.</p><h3 id="i-am-i-want-revisited"> <a aria-labelledby="i-am-i-want-revisited" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#i-am-i-want-revisited"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> I Am I Want revisited</h3><p>Revisiting this code to make it limit the iwant field to only valid values:</p><p>From ddev81/web/modules/custom/iamiwant/src/Form/IamiwantForm.php here is buildForm() .</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$nodeStorage</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
  <span class="c1">// Get i_am_i_want node ids.</span>
  <span class="nv">$nids</span> <span class="o">=</span> <span class="nv">$nodeStorage</span><span class="o">-&gt;</span><span class="nf">getQuery</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">accessCheck</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_iam'</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="s1">'IS NOT NULL'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_iwant'</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="s1">'IS NOT NULL'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_link'</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="s1">'IS NOT NULL'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="nc">NodeInterface</span><span class="o">::</span><span class="no">PUBLISHED</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>

  <span class="c1">// Display the message if nodes don't exist.</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$nids</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'No "I am I want" nodes found.'</span><span class="p">),</span>
    <span class="p">];</span>
  <span class="p">}</span>

  <span class="nv">$nodes</span> <span class="o">=</span> <span class="nv">$nodeStorage</span><span class="o">-&gt;</span><span class="nf">loadMultiple</span><span class="p">(</span><span class="nv">$nids</span><span class="p">);</span>
  <span class="nv">$iam</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="c1">// Build I am select values.</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$nodes</span> <span class="k">as</span> <span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$iam</span><span class="p">[</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()]</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_iam'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getString</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'iam'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
    <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'I am'</span><span class="p">),</span>
    <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="nb">array_unique</span><span class="p">(</span><span class="nv">$iam</span><span class="p">),</span>
    <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
    <span class="s1">'#submit'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'::submitSelectIam'</span><span class="p">],</span>
    <span class="s1">'#executes_submit_callback'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
    <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="s1">'::ajaxReplaceIwantForm'</span><span class="p">,</span>
      <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="s1">'iwant-container'</span><span class="p">,</span>
      <span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'replace'</span><span class="p">,</span>
    <span class="p">],</span>
  <span class="p">];</span>
  <span class="nv">$iwant</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="c1">// Updates iwant values according to iam.</span>
  <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$iwant</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_iwant'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getString</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="nv">$iwantarray</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'iwantarray'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$iwantarray</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$iwant</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$iwantarray</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$iwant</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'iwant_container'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'container'</span><span class="p">,</span>
    <span class="s1">'#prefix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;div id="iwant-container"&gt;'</span><span class="p">,</span>
    <span class="s1">'#suffix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">,</span>
  <span class="p">];</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'iwant_container'</span><span class="p">][</span><span class="s1">'iwant'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
    <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'and I want to'</span><span class="p">),</span>
    <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="nv">$iwant</span><span class="p">,</span>
    <span class="s1">'#empty_value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
    <span class="s1">'#empty_option'</span> <span class="o">=&gt;</span> <span class="s1">'- Select -'</span><span class="p">,</span>
    <span class="s1">'#prefix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;div class="cell imw-want"&gt;'</span><span class="p">,</span>
    <span class="s1">'#suffix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">,</span>
    <span class="s1">'#submit'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'::submitSelectIwant'</span><span class="p">],</span>
    <span class="s1">'#executes_submit_callback'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
    <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="s1">'::ajaxUpdateActionsForm'</span><span class="p">,</span>
      <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="s1">'actions-container'</span><span class="p">,</span>
      <span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'replace'</span><span class="p">,</span>
      <span class="s1">'progress'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'none'</span><span class="p">,</span>
      <span class="p">],</span>
    <span class="p">],</span>
  <span class="p">];</span>

  <span class="c1">// Go button.</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'actions'</span><span class="p">,</span>
    <span class="s1">'#prefix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;div class="cell imw-submit" id="actions-container"&gt;'</span><span class="p">,</span>
    <span class="s1">'#suffix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">,</span>
  <span class="p">];</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'submit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
    <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Go'</span><span class="p">),</span>
  <span class="p">];</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'node'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'submit'</span><span class="p">][</span><span class="s1">'#attributes'</span><span class="p">][</span><span class="s1">'disabled'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'disabled'</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Notice that we are checking the <code class="language-plaintext highlighter-rouge">$iwantarray</code> variable which is set in the <code class="language-plaintext highlighter-rouge">submitSelectIam()</code> as shown below. I pull the value from the iam select dropdown, look up all the possible values for iwant and populate them in an indexed array. It isndexed by nid which is important later.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Handles submit call when iam field is selected.
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">submitSelectIam</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$nodeStorage</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
  <span class="nv">$iam</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'iam'</span><span class="p">);</span>
  <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$nodeStorage</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nv">$iam</span><span class="p">);</span>
  <span class="nv">$iam_text</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_iam'</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
  <span class="c1">// Rebuild the iwant values</span>
  <span class="c1">// Get i_am_i_want node ids.</span>
  <span class="nv">$nids</span> <span class="o">=</span> <span class="nv">$nodeStorage</span><span class="o">-&gt;</span><span class="nf">getQuery</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">accessCheck</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'i_am_i_want'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_iam'</span><span class="p">,</span> <span class="nv">$iam_text</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_iwant'</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="s1">'IS NOT NULL'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_link'</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="s1">'IS NOT NULL'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="nc">NodeInterface</span><span class="o">::</span><span class="no">PUBLISHED</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
  <span class="nv">$nodes</span> <span class="o">=</span> <span class="nv">$nodeStorage</span><span class="o">-&gt;</span><span class="nf">loadMultiple</span><span class="p">(</span><span class="nv">$nids</span><span class="p">);</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$nodes</span> <span class="k">as</span> <span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$iwant</span><span class="p">[</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()]</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'field_iwant'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">getString</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'iwantarray'</span><span class="p">,</span> <span class="nv">$iwant</span><span class="p">);</span>
  <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setRebuild</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>Here is the callback for when the <code class="language-plaintext highlighter-rouge">iwant</code> is selected. Most importantly, the line which sets the <code class="language-plaintext highlighter-rouge">$node</code> into the form_state (<code class="language-plaintext highlighter-rouge">$formstate-&gt;set('node', $node)</code>) stores the node, so the submit function can figure out where the go button should take us.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Handles submit call when iwant field is selected.
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">submitSelectIwant</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$nodeStorage</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
  <span class="nv">$iwant</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'iwant'</span><span class="p">);</span>
  <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$nodeStorage</span><span class="o">-&gt;</span><span class="nf">load</span><span class="p">(</span><span class="nv">$iwant</span><span class="p">);</span>
  <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'node'</span><span class="p">,</span> <span class="nv">$node</span><span class="p">);</span>
  <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setRebuild</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>These two little chaps handle updating the <code class="language-plaintext highlighter-rouge">iwant</code> container and the go button (enabling it when there is a valid node set.). These get fired after the <code class="language-plaintext highlighter-rouge">buildForm()</code> is run so they can extract meaningful info from the nice render array that is built and update just the container they are pointed at. How do I know which container (or wrapper) that is? See below..</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Fired from the iam selection to update the iwant select field.
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">ajaxReplaceIwantForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'iwant_container'</span><span class="p">];</span>
<span class="p">}</span>

<span class="cd">/**
 * Fired from the iwant selection to update the go button.
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">ajaxUpdateActionsForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div><p>In the buildForm, we specified <code class="language-plaintext highlighter-rouge">'#ajax'</code> and identified a callback function with a wrapper – this says “replace” the <code class="language-plaintext highlighter-rouge">'iwant-container'</code> by calling the <code class="language-plaintext highlighter-rouge">ajaxReplaceIwantForm()</code> function.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'iam'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'I am'</span><span class="p">),</span>
  <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="nb">array_unique</span><span class="p">(</span><span class="nv">$iam</span><span class="p">),</span>
  <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
  <span class="s1">'#submit'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'::submitSelectIam'</span><span class="p">],</span>
  <span class="s1">'#executes_submit_callback'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
  <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="s1">'::ajaxReplaceIwantForm'</span><span class="p">,</span>
    <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="s1">'iwant-container'</span><span class="p">,</span>
    <span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'replace'</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">];</span>
</code></pre></div></div><p>And if you look at the definition of the form in buildForm, you’ll see that the <code class="language-plaintext highlighter-rouge">$form['iwant_container']</code> is clearly defined like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'iwant_container'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'container'</span><span class="p">,</span>
  <span class="s1">'#prefix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;div id="iwant-container"&gt;'</span><span class="p">,</span>
  <span class="s1">'#suffix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">,</span>
<span class="p">];</span>
</code></pre></div></div><p>With a form element in it</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'iwant_container'</span><span class="p">][</span><span class="s1">'iwant'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'select'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'and I want to'</span><span class="p">),</span>
  <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="nv">$iwant</span><span class="p">,</span>
  <span class="s1">'#empty_value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
  <span class="s1">'#empty_option'</span> <span class="o">=&gt;</span> <span class="s1">'- Select -'</span><span class="p">,</span>
  <span class="s1">'#prefix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;div class="cell imw-want"&gt;'</span><span class="p">,</span>
  <span class="s1">'#suffix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">,</span>
  <span class="s1">'#submit'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'::submitSelectIwant'</span><span class="p">],</span>
  <span class="s1">'#executes_submit_callback'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
  <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="s1">'::ajaxUpdateActionsForm'</span><span class="p">,</span>
    <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="s1">'actions-container'</span><span class="p">,</span>
    <span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'replace'</span><span class="p">,</span>
    <span class="s1">'progress'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'none'</span><span class="p">,</span>
    <span class="p">],</span>
  <span class="p">],</span>
<span class="p">];</span>
</code></pre></div></div><p>So the code that “replaces” the <code class="language-plaintext highlighter-rouge">iwant_container</code> simply does a</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="k">return</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'iwant_container'</span><span class="p">];</span>
</code></pre></div></div><p>after buildform has run and filled in the <code class="language-plaintext highlighter-rouge">$form['iwant_container']</code></p><p>Magic!</p><p><code class="language-plaintext highlighter-rouge">ajaxUpdateActionsForm()</code> cleverly enables the Go button when there is a node stored in the form, otherwise it is disabled (from buildForm()). It actually just replaces the whole element with an enabled version:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Fired from the iwant selection to update the go button.
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">ajaxUpdateActionsForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div><p>This only runs if there is a node, otherwise the Go button is enabled. It seems a little counterintuitive to leave it enabled and only disable if there isn’t a node but it would probably work fine the other way around</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'node'</span><span class="p">))</span> <span class="p">{</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'submit'</span><span class="p">][</span><span class="s1">'#attributes'</span><span class="p">][</span><span class="s1">'disabled'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'disabled'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Phew! The explanation is much longer than the actual code. Hopefully it is helpful in explaining the intricasies of AJAX Drupal magic.</p><h4 id="custom-responses"> <a aria-labelledby="custom-responses" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#custom-responses"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Custom responses</h4><p>Here rather than just returning the part of the form we want to update, we can add a response followed by some JavaScript that should do something. While it seems this should work, sadly it doesn’t unless I wrap the function in <code class="language-plaintext highlighter-rouge">(function($){})(jQuery);</code>. More below.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\AjaxResponse</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\InvokeCommand</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Ajax\ReplaceCommand</span><span class="p">;</span>

<span class="mf">...</span>

  <span class="cd">/**
   * Fired from the iam selection to update the iwant select field.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">ajaxReplaceIwantForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//    return $form['iwant_container'];</span>
    <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AjaxResponse</span><span class="p">();</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">ReplaceCommand</span><span class="p">(</span><span class="s1">'#iwant-container'</span><span class="p">,</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'iwant_container'</span><span class="p">]));</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">InvokeCommand</span><span class="p">(</span><span class="kc">NULL</span><span class="p">,</span> <span class="s1">'initCustomForms'</span><span class="p">));</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div><p>I made a new function called myinitCustomForms in app.js (web/themes/custom/txg/foundation/src/assets/js/app.js).</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">InvokeCommand</span><span class="p">(</span><span class="kc">NULL</span><span class="p">,</span> <span class="s1">'myinitCustomForms'</span><span class="p">));</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
</code></pre></div></div><p>And it works a treat!!</p><p>At <a href="https://www.drupal.org/docs/8/api/javascript-api/ajax-forms">https://www.drupal.org/docs/8/api/javascript-api/ajax-forms</a> they suggest an example (which I tried in txg/web/themes/custom/txg/foundation/src/assets/js/app.js).</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Argument passed from InvokeCommand.</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">myAjaxCallback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">argument</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">myAjaxCallback is called.</span><span class="dl">'</span><span class="p">);</span>
    <span class="c1">// Set textfield's value to the passed arguments.</span>
    <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">input#edit-output</span><span class="dl">'</span><span class="p">).</span><span class="nf">attr</span><span class="p">(</span><span class="dl">'</span><span class="s1">value</span><span class="dl">'</span><span class="p">,</span> <span class="nx">argument</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">})(</span><span class="nx">jQuery</span><span class="p">);</span>
</code></pre></div></div><p>This works fine when called with:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">InvokeCommand</span><span class="p">(</span><span class="kc">NULL</span><span class="p">,</span> <span class="s1">'myAjaxCallback'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'This is the new text!'</span><span class="p">]));</span>
</code></pre></div></div><p>So my old JavaScript function:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// initialize custom form elements</span>
<span class="kd">function</span> <span class="nf">initCustomForms</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">jcf</span><span class="p">.</span><span class="nf">setOptions</span><span class="p">(</span><span class="dl">'</span><span class="s1">Select</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">maxVisibleItems</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="na">wrapNative</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">wrapNativeOnMobile</span><span class="p">:</span> <span class="kc">false</span>

    <span class="p">});</span>
    <span class="nx">jcf</span><span class="p">.</span><span class="nf">replaceAll</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>Should be wrapped in <code class="language-plaintext highlighter-rouge">(function($){}</code></p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Argument passed from InvokeCommand.</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">myinitCustomForms</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">argument</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">myinitCustomForms is called.</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">jcf</span><span class="p">.</span><span class="nf">setOptions</span><span class="p">(</span><span class="dl">'</span><span class="s1">Select</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">maxVisibleItems</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
      <span class="na">wrapNative</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">wrapNativeOnMobile</span><span class="p">:</span> <span class="kc">false</span>

    <span class="p">});</span>
    <span class="nx">jcf</span><span class="p">.</span><span class="nf">replaceAll</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">})(</span><span class="nx">jQuery</span><span class="p">);</span>
</code></pre></div></div><h3 id="how-do-you-find-all-the-possible-ajax-commands-to-use-with-addcommand"> <a aria-labelledby="how-do-you-find-all-the-possible-ajax-commands-to-use-with-addcommand" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#how-do-you-find-all-the-possible-ajax-commands-to-use-with-addcommand"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> How do you find all the possible AJAX commands to use with addCommand()?</h3><p>Just look in docroot/core/lib/Drupal/Core/Ajax</p><p>You will see a bunch of different classes - All the Commands you want to use with <code class="language-plaintext highlighter-rouge">addCommand()</code> for AJAX response e.g. <code class="language-plaintext highlighter-rouge">RedirectCommand</code> or <code class="language-plaintext highlighter-rouge">OpenModalDialogCommand</code>.</p><h3 id="another-ajax-submit-example"> <a aria-labelledby="another-ajax-submit-example" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#another-ajax-submit-example"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Another AJAX Submit example</h3><p>There is another example of a form with an AJAX submit in <code class="language-plaintext highlighter-rouge">docroot/modules/custom/quick_pivot/src/Form/QuickPivotSubscribeForm.php</code>.</p><p>Note how the callback is explicitly spelled out as:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="s1">'Drupal\quick_pivot\Form\QuickPivotSubscribeForm::quickPivotAjaxSubmit'</span><span class="p">,</span>
</code></pre></div></div><p>Build the form:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'#id'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'quick-pivot-subscribe-form'</span><span class="p">;</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'#cache'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'max-age'</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">];</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'#attributes'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'autocomplete'</span> <span class="o">=&gt;</span> <span class="s1">'off'</span><span class="p">];</span>

  <span class="nv">$form</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span>
    <span class="s1">'#id'</span> <span class="o">=&gt;</span> <span class="s1">'quick-pivot-email'</span><span class="p">,</span>
    <span class="s1">'#placeholder'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Email address'</span><span class="p">),</span>
    <span class="s1">'#attributes'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'class'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'edit-quick-pivot-email'</span><span class="p">]],</span>
    <span class="s1">'#prefix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;div class="subscriber-email-msg"&gt;'</span><span class="p">,</span>
    <span class="s1">'#suffix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">,</span>
  <span class="p">];</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'subscribe_submit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
    <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Sign Up'</span><span class="p">),</span>
    <span class="s1">'#name'</span> <span class="o">=&gt;</span> <span class="s1">'quick_pivot_subscribe_form_submit_button'</span><span class="p">,</span>
    <span class="s1">'#ajax'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="s1">'callback'</span> <span class="o">=&gt;</span> <span class="s1">'Drupal\quick_pivot\Form\QuickPivotSubscribeForm::quickPivotAjaxSubmit'</span><span class="p">,</span>
      <span class="s1">'wrapper'</span> <span class="o">=&gt;</span> <span class="s1">'quick-pivot-subscribe-form'</span><span class="p">,</span>
      <span class="s1">'progress'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'throbber'</span><span class="p">,</span> <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="kc">NULL</span><span class="p">],</span>
    <span class="p">],</span>
  <span class="p">];</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'markup'</span><span class="p">,</span>
    <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;div id="quick-pivot-message-area"&gt;&lt;/div&gt;'</span><span class="p">,</span>
  <span class="p">];</span>

  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Leave the <code class="language-plaintext highlighter-rouge">validateForm()</code> and <code class="language-plaintext highlighter-rouge">submitForm()</code> functions empty.</p><p>Here is the ajax callback. Note the function has to be static to avoid the possible error:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TypeError: Argument 1 passed to Drupal\Core\Routing\RequestContext::fromRequest() must be an instance of Symfony\Component\HttpFoundation\Request, null given 
</code></pre></div></div><p>This error seems to have something to do with memcache and anonymous users.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">quickPivotAjaxSubmit</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$validate</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">;</span>
  <span class="nv">$email</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'email'</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">filter_var</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="no">FILTER_VALIDATE_EMAIL</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$message</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Please enter a valid email address.'</span><span class="p">);</span>
    <span class="nv">$validate</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
    <span class="nv">$css_border</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'border'</span> <span class="o">=&gt;</span> <span class="s1">'1px solid red'</span><span class="p">];</span>
    <span class="nv">$css_color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'color'</span> <span class="o">=&gt;</span> <span class="s1">'red'</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$validate</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$css_border</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'border'</span> <span class="o">=&gt;</span> <span class="s1">'1px solid green'</span><span class="p">];</span>
    <span class="nv">$css_color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'color'</span> <span class="o">=&gt;</span> <span class="s1">'green'</span><span class="p">];</span>
    <span class="nv">$response</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'quick_pivot.api'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">subscribeEmail</span><span class="p">(</span><span class="nv">$email</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nb">reset</span><span class="p">(</span><span class="nv">$response</span><span class="p">),</span> <span class="s1">'Success'</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$message</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Thank you for signing up. Your subscription has been activated.'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nv">$message</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Your subscription could not be processed.'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AjaxResponse</span><span class="p">();</span>

  <span class="nv">$quick_pivot_form</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">formBuilder</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">rebuildForm</span><span class="p">(</span><span class="s1">'quick_pivot_subscribe_form'</span><span class="p">,</span> <span class="nv">$form_state</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$validate</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$quick_pivot_form</span><span class="p">[</span><span class="s1">'email'</span><span class="p">][</span><span class="s1">'#value'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nv">$quick_pivot_form</span><span class="p">[</span><span class="s1">'email'</span><span class="p">][</span><span class="s1">'#placeholder'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Email address'</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">ReplaceCommand</span><span class="p">(</span><span class="s1">'#quick-pivot-subscribe-form'</span><span class="p">,</span> <span class="nv">$quick_pivot_form</span><span class="p">));</span>
  <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">CssCommand</span><span class="p">(</span><span class="s1">'#edit-quick-pivot-email'</span><span class="p">,</span> <span class="nv">$css_border</span><span class="p">));</span>
  <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">HtmlCommand</span><span class="p">(</span><span class="s1">'#quick-pivot-message-area'</span><span class="p">,</span> <span class="nv">$message</span><span class="p">));</span>
  <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCommand</span><span class="p">(</span><span class="k">new</span> <span class="nc">CssCommand</span><span class="p">(</span><span class="s1">'#quick-pivot-message-area'</span><span class="p">,</span> <span class="nv">$css_color</span><span class="p">));</span>
  <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="config-forms"> <a aria-labelledby="config-forms" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#config-forms"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Config Forms</h2><h3 id="generate-a-config-form-with-drush"> <a aria-labelledby="generate-a-config-form-with-drush" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#generate-a-config-form-with-drush"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Generate a config form with drush</h3><p>Use the <a href="https://www.drush.org/latest/generators/form_config/">drush command</a> <code class="language-plaintext highlighter-rouge">drush generate form:config</code> for a quick boilerplate version.</p><h3 id="config-forms-overview"> <a aria-labelledby="config-forms-overview" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#config-forms-overview"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Config forms overview</h3><p>Configuration forms extend ConfigFormBase so be sure to</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Form\ConfigFormBase</span><span class="p">;</span>
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">$config</code> object has <code class="language-plaintext highlighter-rouge">get()</code>, <code class="language-plaintext highlighter-rouge">set()</code> and <code class="language-plaintext highlighter-rouge">save()</code> methods to access config information.</p><p>Create a <code class="language-plaintext highlighter-rouge">module.settings.yml</code> file in config/install directory for config objects that the module needs.</p><p>Also create a <code class="language-plaintext highlighter-rouge">module.schema.yml</code> file in config/schema for schema info i.e. definitions and mappings for config objects</p><p>Implement the following methods: <code class="language-plaintext highlighter-rouge">buildForm()</code>, <code class="language-plaintext highlighter-rouge">getEditableConfigNames()</code>, <code class="language-plaintext highlighter-rouge">getFormId()</code>, <code class="language-plaintext highlighter-rouge">submitForm()</code>, <code class="language-plaintext highlighter-rouge">validateForm()</code>.</p><p>from <code class="language-plaintext highlighter-rouge">dev1/web/modules/custom/rsvp/src/Form/RSVPConfigurationForm.php</code> here is the <code class="language-plaintext highlighter-rouge">buildForm()</code> function.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cd">/**
   * @inheritDoc
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// $types = node_types_get_names();</span>

    <span class="nv">$config</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">config</span><span class="p">(</span><span class="s1">'rsvp.settings'</span><span class="p">);</span>
    <span class="nv">$node_types</span> <span class="o">=</span> <span class="nc">\Drupal\node\Entity\NodeType</span><span class="o">::</span><span class="nf">loadMultiple</span><span class="p">();</span>
    <span class="c1">// If you need to display them in a drop down:</span>
    <span class="nv">$options</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$node_types</span> <span class="k">as</span> <span class="nv">$node_type</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$options</span><span class="p">[</span><span class="nv">$node_type</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()]</span> <span class="o">=</span> <span class="nv">$node_type</span><span class="o">-&gt;</span><span class="nf">label</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nv">$form</span><span class="p">[</span><span class="s1">'rsvp_node_types'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'checkboxes'</span><span class="p">,</span>
      <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'The content types top enable rSVP collection for'</span><span class="p">),</span>
      <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'allowed_types'</span><span class="p">),</span>
      <span class="s1">'#options'</span> <span class="o">=&gt;</span> <span class="nv">$options</span><span class="p">,</span>
      <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'On the specified node types, an RSVP option will be available and can be enabled while that node is being edited.'</span><span class="p">),</span>
    <span class="p">];</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">'array_filter'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'value'</span><span class="p">,</span> <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">];</span>
    <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="nf">buildForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="nv">$form_state</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div><p>And the <code class="language-plaintext highlighter-rouge">submitForm()</code></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @inheritDoc
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">submitForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$allowed_types</span> <span class="o">=</span> <span class="nb">array_filter</span><span class="p">(</span><span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'rsvp_node_types'</span><span class="p">));</span>
  <span class="nb">sort</span><span class="p">(</span><span class="nv">$allowed_types</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">config</span><span class="p">(</span><span class="s1">'rsvp.settings'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'allowed_types'</span><span class="p">,</span> <span class="nv">$allowed_types</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>

  <span class="k">parent</span><span class="o">::</span><span class="nf">submitForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="nv">$form_state</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>To set a default value for when the module is first installed, create web/modules/custom/rsvp/config/install/rsvp.settings.yml</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">allowed_types</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">article</span>
</code></pre></div></div><p>and to specify more details of what the config stores, create the <code class="language-plaintext highlighter-rouge">/Users/selwyn/Sites/dev1/web/modules/custom/rsvp/config/schema/rsvp.schema.yml</code>.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Schema for config file of rsvp module</span>
<span class="na">rsvp.admin_settings</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">config_object</span>
  <span class="na">label</span><span class="pi">:</span> <span class="s1">'</span><span class="s">RSVP</span><span class="nv"> </span><span class="s">Content</span><span class="nv"> </span><span class="s">Type</span><span class="nv"> </span><span class="s">Settings'</span>
  <span class="na">mapping</span><span class="pi">:</span>
    <span class="na">allowed_types</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">sequence</span>
      <span class="na">label</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Content</span><span class="nv"> </span><span class="s">types</span><span class="nv"> </span><span class="s">RSVP</span><span class="nv"> </span><span class="s">form</span><span class="nv"> </span><span class="s">can</span><span class="nv"> </span><span class="s">display</span><span class="nv"> </span><span class="s">on'</span>
      <span class="na">sequence</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">label</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Content</span><span class="nv"> </span><span class="s">type'</span>
</code></pre></div></div><hr/><h2 id="the-basics-of-implementing-forms"> <a aria-labelledby="the-basics-of-implementing-forms" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#the-basics-of-implementing-forms"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> The basics of implementing forms</h2><h3 id="location"> <a aria-labelledby="location" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#location"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Location</h3><p>Forms are stored in <code class="language-plaintext highlighter-rouge">modules/src/Form/MyClassForm.php</code> e.g. <code class="language-plaintext highlighter-rouge">/modules/custom/dmod/src/Form/HeaderFooterForm.php</code>.</p><h3 id="base-classes-for-forms"> <a aria-labelledby="base-classes-for-forms" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#base-classes-for-forms"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Base Classes for forms</h3><ul><li><p>FormBase – for any old form</p><li><p>ConfirmFormBase – for generic confirmation form</p><li><p>ConfigFormBase – for config forms</p></li></li></li></ul><h3 id="create-your-form-class-by-extending-formbase"> <a aria-labelledby="create-your-form-class-by-extending-formbase" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#create-your-form-class-by-extending-formbase"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Create your form class by extending Formbase</h3><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">HeaderFooterForm</span> <span class="kd">extends</span> <span class="nc">FormBase</span> <span class="p">{</span>
</code></pre></div></div><h3 id="the-main-methods"> <a aria-labelledby="the-main-methods" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#the-main-methods"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> The main methods</h3><p>Forms typically need a <code class="language-plaintext highlighter-rouge">buildForm()</code>, <code class="language-plaintext highlighter-rouge">submitForm()</code> and <code class="language-plaintext highlighter-rouge">getFormId()</code> member function. Validation is handled with a <code class="language-plaintext highlighter-rouge">validateForm()</code> member function. Each is explained with more detail below:</p><h4 id="getformid"> <a aria-labelledby="getformid" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#getformid"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> getFormId()</h4><p>It only returns a simple string identifying the form, e.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">getFormId</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s1">'dan_header_footer_form'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h4 id="buildform"> <a aria-labelledby="buildform" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#buildform"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> buildForm()</h4><p>Create the render array representing the form elements. Here I am using a fieldset to group fields. Also the <code class="language-plaintext highlighter-rouge">'#default_value'</code> provides a default value that users can edit.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'instructions'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'markup'</span><span class="p">,</span>
  <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'After clicking submit, test changes on the header and footer of the home page.&lt;br/&gt;&lt;br/&gt;'</span><span class="p">)</span>
<span class="p">];</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'header'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'fieldset'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Header'</span><span class="p">),</span>
  <span class="s1">'#collapsible'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
  <span class="s1">'#open'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'header'</span><span class="p">][</span><span class="s1">'logo_url'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'url'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Logo URL'</span><span class="p">),</span>
  <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">64</span><span class="p">,</span>
  <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$logo_url</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'footer'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'fieldset'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Footer'</span><span class="p">),</span>
  <span class="s1">'#collapsible'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
  <span class="s1">'#open'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'footer'</span><span class="p">][</span><span class="s1">'footer_address1'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Address line 1'</span><span class="p">),</span>
  <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$address1</span><span class="p">,</span>
<span class="p">];</span>

<span class="c1">// You need a submit button so users can click on something.</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'submit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
  <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Save'</span><span class="p">),</span>
<span class="p">];</span>
</code></pre></div></div><p>Don’t <strong>EVER EVER</strong> forget to return the $form render array you just created otherwise you get an empty form. Not that it ever ever happened to me ;-))</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
</code></pre></div></div><h4 id="submitform"> <a aria-labelledby="submitform" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#submitform"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> submitForm()</h4><p>When a user clicks on the submit button, this function is called. You can extract the entries from the <code class="language-plaintext highlighter-rouge">$form_state</code> and decide what to do with them. In this example we write them into the database using the <code class="language-plaintext highlighter-rouge">State API</code>. State API values are stored in the <code class="language-plaintext highlighter-rouge">key_value</code> table.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$values</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">();</span>

<span class="nv">$address1</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'footer_address1'</span><span class="p">];</span>
<span class="nv">$address2</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'footer_address2'</span><span class="p">];</span>
<span class="nv">$address3</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'footer_address3'</span><span class="p">];</span>
<span class="nv">$email</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'email'</span><span class="p">];</span>
<span class="nv">$logo_url</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'logo_url'</span><span class="p">];</span>
<span class="nv">$facebook</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'facebook'</span><span class="p">];</span>
<span class="nv">$linkedin</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'linkedin'</span><span class="p">];</span>
<span class="nv">$instagram</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'instagram'</span><span class="p">];</span>
<span class="nv">$twitter</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'twitter'</span><span class="p">];</span>
<span class="nv">$youtube</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'youtube'</span><span class="p">];</span>
</code></pre></div></div><p>Writing:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'logo_url'</span><span class="p">,</span> <span class="nv">$logo_url</span><span class="p">);</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'footer_address1'</span><span class="p">,</span> <span class="nv">$address1</span><span class="p">);</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'footer_address2'</span><span class="p">,</span> <span class="nv">$address2</span><span class="p">);</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'footer_address3'</span><span class="p">,</span> <span class="nv">$address3</span><span class="p">);</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'footer_email'</span><span class="p">,</span> <span class="nv">$email</span><span class="p">);</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'footer_facebook'</span><span class="p">,</span> <span class="nv">$facebook</span><span class="p">);</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'footer_instagram'</span><span class="p">,</span> <span class="nv">$instagram</span><span class="p">);</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'footer_linkedin'</span><span class="p">,</span> <span class="nv">$linkedin</span><span class="p">);</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'footer_twitter'</span><span class="p">,</span> <span class="nv">$twitter</span><span class="p">);</span>
<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'footer_youtube'</span><span class="p">,</span> <span class="nv">$youtube</span><span class="p">);</span>

<span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addMessage</span><span class="p">(</span><span class="s1">'Values updated'</span><span class="p">);</span>
</code></pre></div></div><p>To display the results of the form entry you can put this in <code class="language-plaintext highlighter-rouge">submitForm()</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Display result.</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">messenger</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="nf">addMessage</span><span class="p">(</span><span class="nv">$key</span> <span class="mf">.</span> <span class="s1">': '</span> <span class="mf">.</span> <span class="p">(</span><span class="nv">$key</span> <span class="o">===</span> <span class="s1">'text_format'</span> <span class="o">?</span> <span class="nv">$value</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$value</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="form-validation-example-1"> <a aria-labelledby="form-validation-example-1" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#form-validation-example-1"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Form validation example #1</h3><p>Check a string length for the <code class="language-plaintext highlighter-rouge">company_name</code> field.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">validateForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$formState</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$formState</span><span class="o">-&gt;</span><span class="nf">isValueEmpty</span><span class="p">(</span><span class="s1">'company_name'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$formState</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'company_name'</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//Set validation error.</span>
      <span class="nv">$formState</span><span class="o">-&gt;</span><span class="nf">setErrorByName</span><span class="p">(</span><span class="s1">'company_name'</span><span class="p">,</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Company name is less than 5 characters'</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="form-validation-example-2"> <a aria-labelledby="form-validation-example-2" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#form-validation-example-2"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Form Validation example #2</h3><p>From web/modules/custom/rsvp/src/Form/RSVPForm.php we call Drupal’s <code class="language-plaintext highlighter-rouge">email.validator</code> service and if it fails, setErrorByName()</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">validateForm</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'email'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'email.validator'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">isValid</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">setErrorByName</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'The email %mail is not valid.'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'%mail'</span><span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">]));</span>
  <span class="p">}</span>

  <span class="k">parent</span><span class="o">::</span><span class="nf">validateForm</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="nv">$form_state</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="field-attributes"> <a aria-labelledby="field-attributes" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#field-attributes"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Field attributes</h3><p>They always begin with <code class="language-plaintext highlighter-rouge">#</code>. You can find all the possible attributes at <a href="https://api.drupal.org/api/drupal/elements/10">Form Element Reference with examples</a></p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$form</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Email Address'</span><span class="p">),</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span>
  <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">25</span><span class="p">,</span>
  <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s2">"We'll send updates to the email address"</span><span class="p">),</span>
  <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="kc">TRUE</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'submit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>
  <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'RSVP'</span><span class="p">),</span>
<span class="p">];</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">'nid'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'hidden'</span><span class="p">,</span>
  <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$nid</span><span class="p">,</span>
<span class="p">];</span>
</code></pre></div></div><h3 id="form-elements"> <a aria-labelledby="form-elements" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#form-elements"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Form Elements</h3><p><a href="https://api.drupal.org/api/drupal/elements/10">Form Element Reference with examples</a></p><p>You can add markup to a form e.g. at web/modules/custom/modal_form_example/src/Form/ExampleForm.php</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$options</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>

  <span class="nv">$form</span><span class="p">[</span><span class="s1">'zzz'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'markup'</span><span class="p">,</span>
    <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'this is a test'</span><span class="p">),</span>
  <span class="p">];</span>

  <span class="nv">$form</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span>
    <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Name'</span><span class="p">),</span>
    <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="s1">'Joe Blow'</span><span class="p">,</span>
    <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="kc">FALSE</span><span class="p">,</span>
  <span class="p">];</span>
</code></pre></div></div><p>and prefixes and suffices</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">buildForm</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$options</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>

  <span class="nv">$form</span><span class="p">[</span><span class="s1">'#prefix'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'&lt;div id="example_form"&gt;'</span><span class="p">;</span>
  <span class="nv">$form</span><span class="p">[</span><span class="s1">'#suffix'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'&lt;/div&gt;'</span><span class="p">;</span>
</code></pre></div></div><p>Hidden or required via a custom class</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="s1">'#maxlength'</span> <span class="o">=&gt;</span> <span class="mi">40</span><span class="p">,</span>
  <span class="s1">'#attributes'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'class'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'hidden'</span><span class="p">],</span>
  <span class="p">],</span>
</code></pre></div></div><p>Another example:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'first_name'</span> <span class="o">=&gt;</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="s1">'First Name'</span><span class="p">,</span>
  <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
  <span class="s1">'#size'</span> <span class="o">=&gt;</span> <span class="mi">25</span><span class="p">,</span>
  <span class="s1">'#maxlength'</span> <span class="o">=&gt;</span> <span class="mi">40</span><span class="p">,</span>
  <span class="s1">'#attributes'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'class'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'required name-on-card'</span><span class="p">],</span>
  <span class="p">],</span>
  <span class="s1">'#field_prefix'</span> <span class="o">=&gt;</span> <span class="s1">'&lt;span class="error-msg"&gt;*&lt;/span&gt;'</span><span class="p">,</span>
</code></pre></div></div><h3 id="retrieving-field-values"> <a aria-labelledby="retrieving-field-values" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#retrieving-field-values"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Retrieving field values</h3><p>When you go to grab a field value from a form, use getValue(). The values that come back from this are arrays so you have to extract them like this (from org_mods.module)</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">cn_form_validate</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="kt">FormStateInterface</span> <span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$extension</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'field_cn_extension'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$extension</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$extension</span> <span class="o">=</span> <span class="nv">$extension</span><span class="p">[</span><span class="s1">'value'</span><span class="p">];</span>
  <span class="p">}</span>
</code></pre></div></div><p>Alternatively, you can get all the fields at one time with getValues(). And reference their value like this.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$values</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="nv">$values</span><span class="p">[</span><span class="s1">'op'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Goback'</span><span class="p">)</span> <span class="p">{</span>
    <span class="mf">...</span>
  <span class="p">}</span>
</code></pre></div></div><p>If you define the form with fields like <code class="language-plaintext highlighter-rouge">$form['header']['blah'] = ...</code> then you can retrieve those with <code class="language-plaintext highlighter-rouge">$form_state-&gt;getValue('header','blah');</code></p><p>or</p><p>if you define a checkbox like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$form</span><span class="p">[</span><span class="s1">'actions'</span><span class="p">][</span><span class="s1">'delete_extras'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'checkbox'</span><span class="p">,</span>
  <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nf">t</span><span class="p">(</span><span class="s1">'Also delete extra items'</span><span class="p">),</span>
  <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="kc">FALSE</span><span class="p">,</span>
  <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="kc">FALSE</span><span class="p">,</span>
  <span class="s1">'#description'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="s1">'Checking this box will delete extra items also.'</span><span class="p">),</span>
</code></pre></div></div><p>You can retrieve the value of the checkbox with:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$delete_extras</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">(</span><span class="s1">'delete_extras'</span><span class="p">);</span>

<span class="c1">// And then use it.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$delete_extras</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'field_extras'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'&lt;&gt;'</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div><h2 id="resources"> <a aria-labelledby="resources" class="anchor-heading" href="https://selwynpolit.github.io/d9book/forms#resources"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Resources</h2><ul><li><a href="https://api.drupal.org/api/drupal/elements/10">Drupal API Form Element Reference with examples</a><li><a href="https://www.drupal.org/docs/8/api/javascript-api/ajax-forms">Drupal AJAX AJAX forms updated Dec 2022</a><li><a href="https://www.drupal.org/docs/drupal-apis/ajax-api/ajax-dialog-boxes">Drupal AJAX Dialog boxes updated Nov 2022</a><li><a href="https://www.mediacurrent.com/blog/loading-and-rendering-modal-forms-drupal-8/">Great tutorial from Mediacurrent on using modal forms in Drupal from Mar 2017</a><li><a href="https://www.drupal.org/docs/drupal-apis/form-api/form-api-internal-workflow">Form API Internal Workflow updated Dec 2022</a><li><a href="https://www.hashbangcode.com/article/drupal-9-creating-get-form">#! code: Drupal 9: Creating A GET Form, July 2021</a><li><a href="https://www.drupal.org/project/conditional_fields">Conditional fields module</a></li></li></li></li></li></li></li></ul><hr/> <script async="" crossorigin="anonymous" data-category="Q&amp;A" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMjY2NDE4" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="selwynpolit/d9book" data-repo-id="MDEwOlJlcG9zaXRvcnkzMjUxNTQ1Nzg=" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js"> </script><hr/><footer><p><a href="https://selwynpolit.github.io/d9book/forms#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0"><span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"> <a href="http://www.selwynpolit.github.io/d9book" property="dct:title" rel="cc:attributionURL">Drupal at your fingertips</a> by <a href="http://www.drupal.org/u/selwynpolit" property="cc:attributionName" rel="cc:attributionURL dct:creator">Selwyn Polit</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="license noopener noreferrer" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" style="height:16px!important;vertical-align:text-bottom;"/> <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" style="height:16px!important;vertical-align:text-bottom;"/> </a></span></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0 mr-2"> Page last modified: <span class="d-inline-block">Jun 21 2023</span>.</p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/selwynpolit/d9book/tree/gh-pages/book/forms.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
</body></link></meta></meta></meta></head></html>