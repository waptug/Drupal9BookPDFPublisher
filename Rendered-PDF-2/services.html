<!DOCTYPE html>
<html lang="en-US"><head><meta charset="utf-8"/><meta content="IE=Edge" http-equiv="X-UA-Compatible"/><link href="https://selwynpolit.github.io/d9book/assets/css/just-the-docs-default.css" rel="stylesheet"/> <script async="" src="https://www.googletagmanager.com/gtag/js?id=8V22RQEJ71"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '8V22RQEJ71', { 'anonymize_ip': true }); </script> <script src="https://selwynpolit.github.io/d9book/assets/js/vendor/lunr.min.js"></script> <script src="https://selwynpolit.github.io/d9book/assets/js/just-the-docs.js"></script><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://selwynpolit.github.io/d9book/assets/images/favicon.ico" rel="icon" type="image/x-icon"/><title>Services | Drupal Book</title><meta content="Jekyll v4.3.2" name="generator"><meta content="Services" property="og:title"><meta content="en_US" property="og:locale"><meta content="Drupal at your fingertips" name="description"/><meta content="Drupal at your fingertips" property="og:description"/><link href="https://selwynpolit.github.io/d9book/d9book/services" rel="canonical"><meta content="https://selwynpolit.github.io/d9book/d9book/services" property="og:url"/><meta content="Drupal Book" property="og:site_name"/><meta content="website" property="og:type"/><meta content="summary" name="twitter:card"/><meta content="Services" property="twitter:title"/> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Drupal at your fingertips","headline":"Services","url":"https://selwynpolit.github.io/d9book/d9book/services"}</script><body> <a class="skip-to-main" href="https://selwynpolit.github.io/d9book/services#main-content">Skip to main content</a> <svg class="d-none" xmlns="http://www.w3.org/2000/svg"> <symbol id="svg-link" viewbox="0 0 24 24"><title>Link</title><svg class="feather feather-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"><title>Menu</title><svg class="feather feather-menu" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"><title>Expand</title><svg class="feather feather-chevron-right" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol class="feather feather-external-link" fill="none" height="24" id="svg-external-link" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"><title>Document</title><svg class="feather feather-file" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"><title>Search</title><svg class="feather feather-search" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"> <circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewbox="0 0 16 16"><title>Copy</title><svg class="bi bi-clipboard" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path> </svg> </symbol> <symbol id="svg-copied" viewbox="0 0 16 16"><title>Copied</title><svg class="bi bi-clipboard-check-fill" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a class="site-title lh-tight" href="https://selwynpolit.github.io/d9book/"> Drupal Book </a> <a class="site-button" href="https://selwynpolit.github.io/d9book/services" id="menu-button"> <svg class="icon" viewbox="0 0 24 24"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" class="site-nav" id="site-nav"><ul class="nav-list"><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/">Home</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/actions">Actions</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/attribution">Attribution</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/bq">Batch and Queue</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/blocks">Blocks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/caching">Caching</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/composer">Composer</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/config">Config</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/cron">Cron</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dates">Dates and Times</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/debugging">Debugging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/development">Development</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/drush">Drush</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/email">Email</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/entities">Entities</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/forms">Forms</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/general">General</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/off-island">Getting off the Island</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/hooks">Hooks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/learn">Learning</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/links">Links</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/logging">Logging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/menus">Menus</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/migrate">Migrate</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/modals">Modals</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/nodes-and-fields">Nodes and Fields</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/queries">Queries</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/redirects">Redirects</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/render">Render Arrays</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/routes">Routes</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/security">Security</a><li class="nav-list-item active"><a class="nav-list-link active" href="https://selwynpolit.github.io/d9book/services">Services</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/state">State</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/taxonomy">Taxonomy</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dtt">Tests</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/twig">Twig</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><ul class="nav-list"><li class="nav-list-item external"> <a class="nav-list-link external" href="https://github.com/selwynpolit/d9book/fork"> Fork me on GitHub <svg aria-labelledby="svg-external-link-title" viewbox="0 0 24 24"><use xlink:href="#svg-external-link"></use></svg> </a></li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div class="main-header" id="main-header"><div class="search"><div class="search-input-wrap"> <input aria-label="Search Drupal Book" autocomplete="off" class="search-input" id="search-input" placeholder="Search Drupal Book" tabindex="0" type="text"/> <label class="search-label" for="search-input"><svg class="search-icon" viewbox="0 0 24 24"><use xlink:href="#svg-search"></use></svg></label></div><div class="search-results" id="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a class="site-button" href="https://twitter.com/selwynpolit" rel="noopener noreferrer" target="_blank"> <img alt="Twitter logo" src="https://atuin.ru/demo/simple-icons/icons/twitter.svg" style="width: 30px; height: 30px;" title="Author in Twitter"/> </a><li class="aux-nav-list-item"> <a class="site-button" href="https://github.com/selwynpolit/d9book/tree/gh-pages" rel="noopener noreferrer" target="_blank"> <img alt="GitHub logo" src="https://atuin.ru/demo/simple-icons/icons/github.svg" style="width: 30px; height: 30px;" title="D9Book on GitHub"/> </a></li></li></ul></nav></div><div class="main-content-wrap" id="main-content-wrap"><div class="main-content" id="main-content" role="main"><h1 class="no_toc fw-500" id="services-and-dependency-injection"> <a aria-labelledby="services-and-dependency-injection" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#services-and-dependency-injection"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Services and Dependency Injection</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a aria-labelledby="table-of-contents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#table-of-contents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ul id="markdown-toc"><li><a href="https://selwynpolit.github.io/d9book/services#overview" id="markdown-toc-overview">Overview</a><li><a href="https://selwynpolit.github.io/d9book/services#static" id="markdown-toc-static">Static</a><li><a href="https://selwynpolit.github.io/d9book/services#static-shorthand-methods" id="markdown-toc-static-shorthand-methods">Static Shorthand methods</a><li><a href="https://selwynpolit.github.io/d9book/services#services-in-action" id="markdown-toc-services-in-action">Services in action</a><li><a href="https://selwynpolit.github.io/d9book/services#controllerbase-shortcuts" id="markdown-toc-controllerbase-shortcuts">ControllerBase shortcuts</a><li><a href="https://selwynpolit.github.io/d9book/services#injecteddependency-injection" id="markdown-toc-injecteddependency-injection">Injected/Dependency Injection</a><ul><li><a href="https://selwynpolit.github.io/d9book/services#controller-details" id="markdown-toc-controller-details">Controller details</a><li><a href="https://selwynpolit.github.io/d9book/services#controller-example-1" id="markdown-toc-controller-example-1">Controller Example 1</a><li><a href="https://selwynpolit.github.io/d9book/services#controller-example-2" id="markdown-toc-controller-example-2">Controller Example 2</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/services#finding-services" id="markdown-toc-finding-services">Finding services</a><li><a href="https://selwynpolit.github.io/d9book/services#creating-a-custom-service" id="markdown-toc-creating-a-custom-service">Creating a custom service</a><ul><li><a href="https://selwynpolit.github.io/d9book/services#arguments" id="markdown-toc-arguments">Arguments</a><li><a href="https://selwynpolit.github.io/d9book/services#passing-the-config-factory-to-our-service" id="markdown-toc-passing-the-config-factory-to-our-service">Passing the config factory to our service</a><li><a href="https://selwynpolit.github.io/d9book/services#taxonomy-tree-custom-service" id="markdown-toc-taxonomy-tree-custom-service">Taxonomy Tree Custom Service</a></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/services#using-your-custom-service" id="markdown-toc-using-your-custom-service">Using your custom service</a><li><a href="https://selwynpolit.github.io/d9book/services#dependency-injection" id="markdown-toc-dependency-injection">Dependency Injection</a><ul><li><a href="https://selwynpolit.github.io/d9book/services#overview-1" id="markdown-toc-overview-1">Overview</a><li><a href="https://selwynpolit.github.io/d9book/services#service-container" id="markdown-toc-service-container">Service Container</a><li><a href="https://selwynpolit.github.io/d9book/services#controller-example-1-1" id="markdown-toc-controller-example-1-1">Controller Example 1</a><li><a href="https://selwynpolit.github.io/d9book/services#controller-example-2-1" id="markdown-toc-controller-example-2-1">Controller Example 2</a><li><a href="https://selwynpolit.github.io/d9book/services#blocks-and-other-plugins" id="markdown-toc-blocks-and-other-plugins">Blocks and other plugins</a></li></li></li></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/services#procedural-to-class-based-dependency-injection" id="markdown-toc-procedural-to-class-based-dependency-injection">Procedural to Class-based dependency injection</a><li><a href="https://selwynpolit.github.io/d9book/services#drush-services-commands" id="markdown-toc-drush-services-commands">Drush services commands</a><ul><li><a href="https://selwynpolit.github.io/d9book/services#list-all-services" id="markdown-toc-list-all-services">List all services</a><li><a href="https://selwynpolit.github.io/d9book/services#generate-custom-service" id="markdown-toc-generate-custom-service">Generate custom service</a></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/services#resources" id="markdown-toc-resources">Resources</a></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><p><img alt="views" src="https://api.visitor.plantree.me/visitor-badge/pv?label=views&amp;color=informational&amp;namespace=d9book&amp;key=services.md"/></p><hr/><h2 id="overview"> <a aria-labelledby="overview" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#overview"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Overview</h2><p>Services provide a "decoupled" way to access classes and members. Services are pluggable and replaceable by registering them with a service container which makes them well suited to test with PHPUnit tests.</p><p>Services can be accessed using two possible methods: static and injected (using dependency injection).</p><h2 id="static"> <a aria-labelledby="static" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#static"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Static</h2><p>For <code class="language-plaintext highlighter-rouge">.module</code> files and classes which are not exposed to the service container (see below for a definition of the service container), you have to use the static method of retrieving the service:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Access the Drupal JSON serialization service.</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">jsonSerialization</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'serialization.json'</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-</span><span class="n">jsonSerialization</span><span class="o">-&gt;</span><span class="nf">decode</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span>

<span class="c1">// Access your custom service.</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">salutationService</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'hello_world.salutation'</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">salutationService</span><span class="o">-&gt;</span><span class="nf">hello</span><span class="p">();</span>
<span class="c1">// Or.</span>
<span class="nv">$abc_retrieval_service</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'abc.aardvark_retrieval_service'</span><span class="p">);</span>
<span class="nv">$aardvark_names</span> <span class="o">=</span> <span class="nv">$abc_retrieval_service</span><span class="o">-&gt;</span><span class="nf">getAardvarkNames</span><span class="p">();</span>
</code></pre></div></div><p>You can also get the container and use that to get a service (and then use the service) e.g.:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$container</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">getContainer</span><span class="p">()</span> 
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">keyValue</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'keyvalue'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$collection</span><span class="p">);</span>
</code></pre></div></div><h2 id="static-shorthand-methods"> <a aria-labelledby="static-shorthand-methods" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#static-shorthand-methods"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Static Shorthand methods</h2><p>A few popular services also have shorthand methods in the core Drupal.php file for accessing them faster (and easier for IDE autocompletion), for example, <code class="language-plaintext highlighter-rouge">\Drupal::entityTypeManager()</code>. Check it out for services with shorthand methods:</p><p>e.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">routeMatch</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="nf">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'current_route_match'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">currentUser</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="nf">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'current_user'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">entityTypeManager</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="nf">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'entity_type.manager'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">cache</span><span class="p">(</span><span class="nv">$bin</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="nf">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'cache.'</span> <span class="mf">.</span> <span class="nv">$bin</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>and many more..</p><h2 id="services-in-action"> <a aria-labelledby="services-in-action" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#services-in-action"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Services in action</h2><p>Most of these examples show Drupal configuration.</p><p>In this example we use the <code class="language-plaintext highlighter-rouge">config.factory</code> service (via the <code class="language-plaintext highlighter-rouge">::configFactory()</code> shortcut) to change the system email plugin to use our mail plugin:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 *  \Drupal::configFactory() retrieves the configuration factory.
 *
 * This is mostly used to change the override settings on the configuration
 * factory. For example, changing the language, or turning all overrides on
 * or off.
 */</span>

<span class="cd">/**
 * Implements hook_install().
 */</span>
<span class="k">function</span> <span class="n">hello_world_install</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$config</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">configFactory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getEditable</span><span class="p">(</span><span class="s1">'system.mail'</span><span class="p">);</span>
  <span class="nv">$mail_plugins</span> <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'interface'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="s1">'hello_world'</span><span class="p">,</span> <span class="nb">array_keys</span><span class="p">(</span><span class="nv">$mail_plugins</span><span class="p">)))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
  <span class="nv">$mail_plugins</span><span class="p">[</span><span class="s1">'hello_world'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'hello_world_mail'</span><span class="p">;</span>
  <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'interface'</span><span class="p">,</span> <span class="nv">$mail_plugins</span><span class="p">);</span>
  <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>Here we use <code class="language-plaintext highlighter-rouge">config.factory</code> service to change some config variables:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$values</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="o">-&gt;</span><span class="nf">getValues</span><span class="p">();</span>
<span class="nv">$address1</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'footer_address1'</span><span class="p">];</span>
<span class="nv">$address2</span> <span class="o">=</span> <span class="nv">$values</span><span class="p">[</span><span class="s1">'footer_address2'</span><span class="p">];</span>

<span class="nv">$config</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">configFactory</span><span class="p">()</span><span class="o">&gt;</span><span class="nf">getEditable</span><span class="p">(</span><span class="s1">'dat.header_footer_settings'</span><span class="p">);</span>
<span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'footer_address1'</span><span class="p">,</span> <span class="nv">$address1</span><span class="p">);</span>
<span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'footer_address2'</span><span class="p">,</span> <span class="nv">$address2</span><span class="p">);</span>
<span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">();</span>
</code></pre></div></div><p>Here we use the <code class="language-plaintext highlighter-rouge">config.factory</code> service (via <code class="language-plaintext highlighter-rouge">::config()</code> shorthand method) to load some values from Drupal config:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$config</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">config</span><span class="p">(</span><span class="s1">'dat.header_footer_settings'</span><span class="p">);</span>

<span class="nv">$address1</span> <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'footer_address1'</span><span class="p">);</span>
<span class="nv">$address2</span> <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'footer_address2'</span><span class="p">);</span>
<span class="nv">$email</span> <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'footer_email'</span><span class="p">);</span>
<span class="nv">$logo_url</span> <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'logo_url'</span><span class="p">);</span> 
</code></pre></div></div><p>Get the email address for the site using the <code class="language-plaintext highlighter-rouge">config.factory</code> service:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// returns website@d9book.com</span>
<span class="nv">$to</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">configFactory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getEditable</span><span class="p">(</span><span class="s1">'system.site'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'mail'</span><span class="p">);</span>
</code></pre></div></div><h2 id="controllerbase-shortcuts"> <a aria-labelledby="controllerbase-shortcuts" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#controllerbase-shortcuts"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> ControllerBase shortcuts</h2><p>ControllerBase.php comes prepackaged with functions to get the following services statically:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">protected</span> <span class="k">function</span> <span class="n">entityTypeManager</span><span class="p">()</span> <span class="p">{</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">entityFormBuilder</span><span class="p">()</span> <span class="p">{</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">cache</span><span class="p">(</span><span class="nv">$bin</span> <span class="o">=</span> <span class="s1">'default'</span><span class="p">)</span> <span class="p">{</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">config</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">keyValue</span><span class="p">(</span><span class="nv">$collection</span><span class="p">)</span> <span class="p">{</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">state</span><span class="p">()</span> <span class="p">{</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">moduleHandler</span><span class="p">()</span> <span class="p">{</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">formBuilder</span><span class="p">()</span> <span class="p">{</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">currentUser</span><span class="p">()</span> <span class="p">{</span>
<span class="k">protected</span> <span class="k">function</span> <span class="n">languageManager</span><span class="p">()</span> <span class="p">{</span>
</code></pre></div></div><p>This allows quick access from within your controllers to these services if you need to do things like:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Make an entityQuery</span>
<span class="nv">$storage</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$storage</span><span class="o">-&gt;</span><span class="nf">getQuery</span><span class="p">();</span>
<span class="nv">$query</span>
  <span class="o">-&gt;</span><span class="nf">accessCheck</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'article'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nb">count</span><span class="p">();</span>
<span class="nv">$count_nodes</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>

<span class="c1">// Or.</span>

<span class="c1">// Get info about the current user.</span>
<span class="nv">$account</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">currentUser</span><span class="p">();</span>
<span class="nv">$username</span> <span class="o">=</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">getAccountName</span><span class="p">();</span>
<span class="nv">$uid</span> <span class="o">=</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>
<span class="nv">$message</span> <span class="o">=</span> <span class="s2">"&lt;br&gt;Account info user id: "</span> <span class="mf">.</span> <span class="nv">$uid</span> <span class="mf">.</span> <span class="s2">" username: "</span> <span class="mf">.</span> <span class="nv">$username</span><span class="p">;</span>
</code></pre></div></div><h2 id="injecteddependency-injection"> <a aria-labelledby="injecteddependency-injection" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#injecteddependency-injection"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Injected/Dependency Injection</h2><p>Using dependency injection is the preferred way to use services although it involves more steps. See the <a href="https://selwynpolit.github.io/d9book/services#dependency-injection">Dependency Injection</a> section below for more details.</p><p>Using dependency injection requires that you create a constructor and a <code class="language-plaintext highlighter-rouge">create()</code> function in your controller class.</p><p>The create function gets the service container as a parameter and chooses the services it needs. The create function calls the constructor and passes the services as arguments and stores them as properties.</p><p>The process for a block (or plugin) is a little different:</p><p>Your block must implement ContainerFactoryPluginInterface. <em>Plugins only get access to the service container if they implement the <code class="language-plaintext highlighter-rouge">ContainerFactoryPluginInterface</code></em> e.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TestBlock</span> <span class="kd">extends</span> <span class="nc">BlockBase</span> <span class="kd">implements</span> <span class="nc">ContainerFactoryPluginInterface</span> <span class="p">{</span>
</code></pre></div></div><p>You must also add the extra parameters to the <code class="language-plaintext highlighter-rouge">create()</code> function and the constructor i.e. <code class="language-plaintext highlighter-rouge">$plugin_id</code> and <code class="language-plaintext highlighter-rouge">$plugin_definition</code> e.g.</p><p><code class="language-plaintext highlighter-rouge">public static function create(ContainerInterface $container, array $configuration, $plugin_id, $plugin_definition)</code></p><p>Here is an example of a block constructor with the <code class="language-plaintext highlighter-rouge">AccountProxyInterface</code> parameter added so we can inject that service:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">,</span> <span class="kt">AccountProxyInterface</span> <span class="nv">$account</span><span class="p">)</span> <span class="p">{</span>
<span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">(</span><span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nv">$account</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>More about services and dependency injection at <a href="https://code.tutsplus.com/tutorials/drupal-8-properly-injecting-dependencies-using-di--cms-26314">https://code.tutsplus.com/tutorials/drupal-8-properly-injecting-dependencies-using-di--cms-26314</a></p><p>More about using dependency injection for blocks and other plugins <a href="https://chromatichq.com/blog/dependency-injection-drupal-8-plugins">https://chromatichq.com/blog/dependency-injection-drupal-8-plugins</a></p><h3 id="controller-details"> <a aria-labelledby="controller-details" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#controller-details"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Controller details</h3><p>Here are the steps for implementing an injected service in a controller.</p><p>From: docroot/modules/custom/apitest/src/Controller/ApiTestController.php</p><p>1. Your controller must extend ControllerBase</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ApiTestController</span> <span class="kd">extends</span> <span class="nc">ControllerBase</span> <span class="p">{</span>
</code></pre></div></div><p>2. You need a protected variable to hold the service</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 *
 * The CmAPIClient.
 *
 * @var \Drupal\cm_api\CmAPIClient
 */</span>
<span class="k">protected</span> <span class="nv">$cmAPIClient</span><span class="p">;</span>
</code></pre></div></div><p>3. You need a <code class="language-plaintext highlighter-rouge">create()</code> function. This will get passed the <code class="language-plaintext highlighter-rouge">$container</code> so it can call it’s <code class="language-plaintext highlighter-rouge">get()</code> member function to instantiate the service you need. This function then calls the constructor and passes it's parameters to it.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span>
    <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'cm_api.client'</span><span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>Note, you can pass multiple services by adding additional <code class="language-plaintext highlighter-rouge">$container-&gt;get()</code> calls like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span>
    <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'current_user'</span><span class="p">),</span>
    <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'path.current'</span><span class="p">),</span>
    <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'path.validator'</span><span class="p">),</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>4. Your constructor will expect your newly instantiated service(s) as parameters:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * ApiTestController constructor.
 */</span>
<span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">CmAPIClient</span> <span class="nv">$cmAPIClient</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">cmAPIClient</span> <span class="o">=</span> <span class="nv">$cmAPIClient</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Similarly, if you are getting multiple services, add the additional parameters to the constructor, as well as assigning the variables. E.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">AccountProxyInterface</span> <span class="nv">$account</span><span class="p">,</span> <span class="kt">CurrentPathStack</span> <span class="nv">$path_stack</span><span class="p">,</span> <span class="kt">PathValidatorInterface</span> <span class="nv">$path_validator</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nv">$account</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pathStack</span> <span class="o">=</span> <span class="nv">$path_stack</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pathValidator</span> <span class="o">=</span> <span class="nv">$path_validator</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>5. In your code, use the protected variable (<code class="language-plaintext highlighter-rouge">$cmAPIClient</code>) to call functions in the service:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">cmAPIClient</span><span class="o">-&gt;</span><span class="nf">catchAll</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="nv">$body</span><span class="p">);</span>
</code></pre></div></div><p>Rejoice! Note. No need to make any routing changes. Drupal handles all the parameters with the instructions provided. etc.</p><h3 id="controller-example-1"> <a aria-labelledby="controller-example-1" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#controller-example-1"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Controller Example 1</h3><p>Here is a complete controller which uses the <code class="language-plaintext highlighter-rouge">current_user</code> service:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\di_examples\Controller</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Controller\ControllerBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Session\AccountProxyInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\DependencyInjection\ContainerInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">DiExamplesController</span> <span class="kd">extends</span> <span class="nc">ControllerBase</span> <span class="p">{</span>

  <span class="k">protected</span> <span class="kt">AccountProxyInterface</span> <span class="nv">$account</span><span class="p">;</span>

  <span class="cd">/**
   * Builds the response.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>

    <span class="nv">$account</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span><span class="o">-&gt;</span><span class="nf">getAccount</span><span class="p">();</span>
    <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">getAccountName</span><span class="p">();</span>
    <span class="nv">$uid</span> <span class="o">=</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>

    <span class="nv">$message</span> <span class="o">=</span> <span class="s2">"&lt;br&gt;Account info user id: "</span> <span class="mf">.</span> <span class="nv">$uid</span> <span class="mf">.</span> <span class="s2">" username: "</span> <span class="mf">.</span> <span class="nv">$username</span><span class="p">;</span>

    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="nv">$message</span><span class="p">),</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'current_user'</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">AccountProxyInterface</span> <span class="nv">$account</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nv">$account</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><h3 id="controller-example-2"> <a aria-labelledby="controller-example-2" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#controller-example-2"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Controller Example 2</h3><p>This controller uses 3 different services:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\di_examples\Controller</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Controller\ControllerBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Path\CurrentPathStack</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Path\PathValidatorInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Session\AccountProxyInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\DependencyInjection\ContainerInterface</span><span class="p">;</span>

<span class="cd">/**
 * Returns responses for DI Examples routes.
 */</span>
<span class="kd">class</span> <span class="nc">DiExamplesController</span> <span class="kd">extends</span> <span class="nc">ControllerBase</span> <span class="p">{</span>

  <span class="k">protected</span> <span class="kt">AccountProxyInterface</span> <span class="nv">$account</span><span class="p">;</span>
  <span class="k">protected</span> <span class="kt">CurrentPathStack</span> <span class="nv">$pathStack</span><span class="p">;</span>
  <span class="k">protected</span> <span class="kt">PathValidatorInterface</span> <span class="nv">$pathValidator</span><span class="p">;</span>

  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'current_user'</span><span class="p">),</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'path.current'</span><span class="p">),</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'path.validator'</span><span class="p">),</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">AccountProxyInterface</span> <span class="nv">$account</span><span class="p">,</span> <span class="kt">CurrentPathStack</span> <span class="nv">$path_stack</span><span class="p">,</span> <span class="kt">PathValidatorInterface</span> <span class="nv">$path_validator</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nv">$account</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pathStack</span> <span class="o">=</span> <span class="nv">$path_stack</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pathValidator</span> <span class="o">=</span> <span class="nv">$path_validator</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="cd">/**
   * Builds the response.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Use the injected account.</span>
    <span class="nv">$account</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span><span class="o">-&gt;</span><span class="nf">getAccount</span><span class="p">();</span>

    <span class="c1">// Use the ControllerBase static version.</span>
    <span class="nv">$account</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">currentUser</span><span class="p">();</span>

    <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">getAccountName</span><span class="p">();</span>
    <span class="nv">$uid</span> <span class="o">=</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>

    <span class="nv">$message</span> <span class="o">=</span> <span class="s2">"&lt;br&gt;Account info user id: "</span> <span class="mf">.</span> <span class="nv">$uid</span> <span class="mf">.</span> <span class="s2">" username: "</span> <span class="mf">.</span> <span class="nv">$username</span><span class="p">;</span>

    <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'hello'</span><span class="p">;</span>

    <span class="c1">// Use the ControllerBase static version to create an entityQuery.</span>
    <span class="nv">$storage</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
    <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$storage</span><span class="o">-&gt;</span><span class="nf">getQuery</span><span class="p">();</span>
    <span class="nv">$query</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'article'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nb">count</span><span class="p">();</span>
    <span class="nv">$count_nodes</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
    <span class="nv">$message</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;Retrieved "</span> <span class="mf">.</span> <span class="nv">$count_nodes</span> <span class="mf">.</span> <span class="s2">" nodes"</span><span class="p">;</span>

    <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pathStack</span><span class="o">-&gt;</span><span class="nf">getPath</span><span class="p">();</span>
    <span class="nv">$message</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt; Path: "</span> <span class="mf">.</span> <span class="nv">$path</span><span class="p">;</span>

    <span class="nv">$test_path</span> <span class="o">=</span> <span class="s2">"/vote1"</span><span class="p">;</span>
    <span class="nv">$valid_path</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pathValidator</span><span class="o">-&gt;</span><span class="nf">isValid</span><span class="p">(</span><span class="nv">$test_path</span><span class="p">);</span>
    <span class="nv">$message</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt; Check for valid path: "</span> <span class="mf">.</span> <span class="nv">$test_path</span> <span class="mf">.</span> <span class="s2">" returned: "</span> <span class="mf">.</span> <span class="nv">$valid_path</span><span class="p">;</span>


    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="nv">$message</span><span class="p">),</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><h2 id="finding-services"> <a aria-labelledby="finding-services" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#finding-services"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Finding services</h2><p>Here is the process to find a commonly used service, the entityTypeManager which is used for entityQueries.</p><p>You can look at <a href="https://api.drupal.org/api/drupal/services">https://api.drupal.org/api/drupal/services</a> and search for <code class="language-plaintext highlighter-rouge">entity_type</code>. This will result in:</p><p><img alt="Finding Services on Drupal API" src="https://selwynpolit.github.io/d9book/assets/images/find-services.png"/></p><p>This tells you to that the service is in <code class="language-plaintext highlighter-rouge">core.services.yml</code> and that it is implemented in the <code class="language-plaintext highlighter-rouge">EntityTypeManager</code> class.</p><p>So in Drupal core's <code class="language-plaintext highlighter-rouge">core.services.yml</code> file you will find:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">entity_type.manager</span><span class="pi">:</span>
  <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\Core\Entity\EntityTypeManager</span>
  <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@container.namespaces'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@module_handler'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@cache.discovery'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@string_translation'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@class_resolver'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@entity.last_installed_schema.repository'</span><span class="pi">]</span>
  <span class="na">parent</span><span class="pi">:</span> <span class="s">container.trait</span>
  <span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="pi">{</span> <span class="nv">name</span><span class="pi">:</span> <span class="nv">plugin_manager_cache_clear</span> <span class="pi">}</span>
</code></pre></div></div><p>Looking in Drupal.php, you will also find a shorthand method:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Retrieves the entity type manager.
 *
 * @return \Drupal\Core\Entity\EntityTypeManagerInterface
 *   The entity type manager.
 */</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">entityTypeManager</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="nf">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'entity_type.manager'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>So to use this statically, you can use the following:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$storage</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="nv">$entity_type</span><span class="p">);</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$storage</span><span class="o">-&gt;</span><span class="nf">getQuery</span><span class="p">();</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">entityQuery</span><span class="p">(</span><span class="s1">'node'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">accessCheck</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'page'</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'status'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nv">$nids</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
</code></pre></div></div><p>To do this using dependency injection you will need to inject <code class="language-plaintext highlighter-rouge">entity_type.manager</code>. Follow the procedure outlined above in Controller details.</p><h2 id="creating-a-custom-service"> <a aria-labelledby="creating-a-custom-service" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#creating-a-custom-service"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Creating a custom service</h2><p>To make a service, you will need two parts: a <code class="language-plaintext highlighter-rouge">module.services.yml</code> file and a controller.</p><p>In the <code class="language-plaintext highlighter-rouge">module.services.yml</code> file. You need a machine name for the service and a class that implements it. E.g. in <code class="language-plaintext highlighter-rouge">kitchen_product.services.yml</code> you might have the following:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">kitchen_product.product_manager_service</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\kitchen_product\ProductManagerService</span>
</code></pre></div></div><h3 id="arguments"> <a aria-labelledby="arguments" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#arguments"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Arguments</h3><p>You can specify optional arguments to pass to your service which might be needed when Drupal instantiates your service. Here we pass the <code class="language-plaintext highlighter-rouge">keyvalue</code> service as well as a Boolean value:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">highway.road_generator</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\highway\RoadGenerator</span>
    <span class="na">arguments</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">@keyvalue'</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">%highway.road.use_key_value_cache%"</span>
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">%highway.road.user_key_value_cache%</code> value is a special argument which has been defined above the services key as a parameter. Its value will default to true on production:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">parameters</span><span class="pi">:</span>
  <span class="na">highway.road.use_key_value_cache</span><span class="pi">:</span> <span class="kc">true</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">dino_roar.roar_generator</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\dino_roar\Jurassic\RoarGenerator</span>
    <span class="na">arguments</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">@keyvalue'</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">%highway.road.use_key_value_cache%"</span>
</code></pre></div></div><p>This means that it is configurable. If you need to set it to false during development, you can easily override it on your local machine. Simply add it to the <code class="language-plaintext highlighter-rouge">development.services.yml</code> file like this:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Local development services.</span>
<span class="c1">#</span>
<span class="c1"># To activate this feature, follow the instructions at the top of the</span>
<span class="c1"># 'example.settings.local.php' file, which sits next to this file.</span>
<span class="na">parameters</span><span class="pi">:</span>
  <span class="na">highway.road.use_key_value_cache</span><span class="pi">:</span> <span class="kc">false</span>
</code></pre></div></div><p>Note you can also pass strings in the form 'blah' surrounded by single quotes.</p><h3 id="passing-the-config-factory-to-our-service"> <a aria-labelledby="passing-the-config-factory-to-our-service" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#passing-the-config-factory-to-our-service"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Passing the config factory to our service</h3><p>As shown above, arguments use the "arguments" key, which can have an array of services, each preceeded by an @ symbol. Other values which are not services can also be passed. In the <code class="language-plaintext highlighter-rouge">module.services.yml</code> file below, we pass the <code class="language-plaintext highlighter-rouge">config.factory</code> service. You can find it in the <code class="language-plaintext highlighter-rouge">core.services.yml</code> file where you can see it maps to the <code class="language-plaintext highlighter-rouge">Drupal\Core\Config\ConfigFactory</code> class.</p><p>It looks like this in the <code class="language-plaintext highlighter-rouge">core.services.yml</code>:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">config.factory</span><span class="pi">:</span>
  <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\Core\Config\ConfigFactory</span>
  <span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="pi">{</span> <span class="nv">name</span><span class="pi">:</span> <span class="nv">event_subscriber</span> <span class="pi">}</span>
    <span class="pi">-</span> <span class="pi">{</span> <span class="nv">name</span><span class="pi">:</span> <span class="nv">service_collector</span><span class="pi">,</span> <span class="nv">tag</span><span class="pi">:</span> <span class="s1">'</span><span class="s">config.factory.override'</span><span class="pi">,</span> <span class="nv">call</span><span class="pi">:</span> <span class="nv">addOverride</span> <span class="pi">}</span>
  <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@config.storage'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@event_dispatcher'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">@config.typed'</span><span class="pi">]</span>
</code></pre></div></div><p>Here is how it looks in your <code class="language-plaintext highlighter-rouge">module.services.yml</code>:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
 <span class="na">hello_world.salutation</span><span class="pi">:</span>
   <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\hello_world\HelloWorldSalutation</span>
   <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@config.factory'</span><span class="pi">]</span>
</code></pre></div></div><h3 id="taxonomy-tree-custom-service"> <a aria-labelledby="taxonomy-tree-custom-service" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#taxonomy-tree-custom-service"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Taxonomy Tree Custom Service</h3><p>Here is an example where Daniel Sipos of <a href="https://www.webomelette.com">https://www.webomelette.com</a> creates a custom service to build a taxonomy tree. Read his article at <a href="https://www.webomelette.com/loading-taxonomy-terms-tree-drupal-8">https://www.webomelette.com/loading-taxonomy-terms-tree-drupal-8</a> . The repo is at <a href="https://github.com/upchuk/taxonomy_tree">https://github.com/upchuk/taxonomy_tree</a>. His code is reproduced below:</p><p>Here is the <code class="language-plaintext highlighter-rouge">taxonomy_tree.services.yml</code> file:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">taxonomy_tree.taxonomy_term_tree</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\taxonomy_tree\TaxonomyTermTree</span>
    <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@entity_type.manager'</span><span class="pi">]</span>
</code></pre></div></div><p>And the controller:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\taxonomy_tree</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Entity\EntityTypeManager</span><span class="p">;</span>

<span class="cd">/**
 * Loads taxonomy terms in a tree
 */</span>
<span class="kd">class</span> <span class="nc">TaxonomyTermTree</span> <span class="p">{</span>

  <span class="cd">/**
   * @var \Drupal\Core\Entity\EntityTypeManager
   */</span>
  <span class="k">protected</span> <span class="nv">$entityTypeManager</span><span class="p">;</span>

  <span class="cd">/**
   * TaxonomyTermTree constructor.
   *
   * @param \Drupal\Core\Entity\EntityTypeManager $entityTypeManager
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">EntityTypeManager</span> <span class="nv">$entityTypeManager</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span> <span class="o">=</span> <span class="nv">$entityTypeManager</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cd">/**
   * Loads the tree of a vocabulary.
   *
   * @param string $vocabulary
   *   Machine name
   *
   * @return array
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">load</span><span class="p">(</span><span class="nv">$vocabulary</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$terms</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'taxonomy_term'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">loadTree</span><span class="p">(</span><span class="nv">$vocabulary</span><span class="p">);</span>
    <span class="nv">$tree</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$terms</span> <span class="k">as</span> <span class="nv">$tree_object</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">buildTree</span><span class="p">(</span><span class="nv">$tree</span><span class="p">,</span> <span class="nv">$tree_object</span><span class="p">,</span> <span class="nv">$vocabulary</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$tree</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cd">/**
   * Populates a tree array given a taxonomy term tree object.
   *
   * @param $tree
   * @param $object
   * @param $vocabulary
   */</span>
  <span class="k">protected</span> <span class="k">function</span> <span class="n">buildTree</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$tree</span><span class="p">,</span> <span class="nv">$object</span><span class="p">,</span> <span class="nv">$vocabulary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$object</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$tree</span><span class="p">[</span><span class="nv">$object</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$object</span><span class="p">;</span>
    <span class="nv">$tree</span><span class="p">[</span><span class="nv">$object</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">children</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$object_children</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$tree</span><span class="p">[</span><span class="nv">$object</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">;</span>

    <span class="nv">$children</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'taxonomy_term'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">loadChildren</span><span class="p">(</span><span class="nv">$object</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$children</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$child_tree_objects</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityTypeManager</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'taxonomy_term'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">loadTree</span><span class="p">(</span><span class="nv">$vocabulary</span><span class="p">,</span> <span class="nv">$object</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$children</span> <span class="k">as</span> <span class="nv">$child</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$child_tree_objects</span> <span class="k">as</span> <span class="nv">$child_tree_object</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$child_tree_object</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">==</span> <span class="nv">$child</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">())</span> <span class="p">{</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">buildTree</span><span class="p">(</span><span class="nv">$object_children</span><span class="p">,</span> <span class="nv">$child_tree_object</span><span class="p">,</span> <span class="nv">$vocabulary</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="using-your-custom-service"> <a aria-labelledby="using-your-custom-service" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#using-your-custom-service"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Using your custom service</h2><p>This is identical to using a Drupal built in service. These are the steps:</p><ol><li><p>In your controller, make sure your controller extends <code class="language-plaintext highlighter-rouge">ControllerBase.</code></p><li><p>Add protected variable in your class to hold your service.</p><li><p>Add a <code class="language-plaintext highlighter-rouge">create()</code> function to get the service(s) from the service container</p><li><p>Add a constructor which stores a link to each service so you can call functions in those services.</p></li></li></li></li></ol><p>Note. Follow the slightly different steps for injecting services into blocks when using your service for blocks or plugins.</p><h2 id="dependency-injection"> <a aria-labelledby="dependency-injection" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#dependency-injection"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Dependency Injection</h2><h3 id="overview-1"> <a aria-labelledby="overview-1" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#overview-1"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Overview</h3><p>Dependency injection is the practice of "injecting" services. A service is any object managed by the Drupal <a href="https://selwynpolit.github.io/d9book/services#service-container">Service container</a>.</p><p>Drupal introduces the concept of services to decouple reusable functionality and makes these services pluggable and replaceable by registering them with a service container.</p><p>It is best practice to access any of the services provided by Drupal via the service container to ensure the decoupled nature of these systems is respected. </p><p>Services are used to perform operations like accessing the database or sending an e-mail. Rather than use PHP's native MySQL functions, we use the core-provided service via the service container to perform this operation so that our code can simply access the database without having to worry about whether the database is MySQL or SQLlite, or if the mechanism for sending e-mail is SMTP or something else.</p><p>From <a href="https://www.drupal.org/docs/drupal-apis/services-and-dependency-injection/services-and-dependency-injection-in-drupal-8">https://www.drupal.org/docs/drupal-apis/services-and-dependency-injection/services-and-dependency-injection-in-drupal-8</a>.</p><h3 id="service-container"> <a aria-labelledby="service-container" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#service-container"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Service Container</h3><p>The Service container is the PHP object which handles the instantiation of all required services. When you want to use a service, you ask the service container for one and then you can call methods on the service. The Drupal Service container is built on top of the <a href="https://symfony.com/doc/current/service_container.html">Symfony Service container</a>.</p><p>More at <a href="https://www.drupal.org/docs/drupal-apis/services-and-dependency-injection/services-and-dependency-injection-in-drupal-8">https://www.drupal.org/docs/drupal-apis/services-and-dependency-injection/services-and-dependency-injection-in-drupal-8</a>.</p><p>For example, in <code class="language-plaintext highlighter-rouge">core.services.yml</code>, you will find the <code class="language-plaintext highlighter-rouge">email.validator</code> service which references the <code class="language-plaintext highlighter-rouge">EmailValidator</code> class. This is what you will see in <code class="language-plaintext highlighter-rouge">core.services.yml</code>:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">email.validator</span><span class="pi">:</span>
  <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\Component\Utility\EmailValidator</span>
</code></pre></div></div><p>Looking in the EmailValidator.php file, there is an <code class="language-plaintext highlighter-rouge">isValid()</code> function which you can call to validate email addresses. E.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">emailValidator</span><span class="o">-&gt;</span><span class="nf">isValid</span><span class="p">()</span>
</code></pre></div></div><p>Similarly, in <code class="language-plaintext highlighter-rouge">core.services.yml</code> there is a <code class="language-plaintext highlighter-rouge">current_route_match</code> service which references the class <code class="language-plaintext highlighter-rouge">CurrentRouteMatch</code>:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">current_route_match</span><span class="pi">:</span>
  <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\Core\Routing\CurrentRouteMatch</span>
  <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@request_stack'</span><span class="pi">]</span>
</code></pre></div></div><p>Looking in <code class="language-plaintext highlighter-rouge">CurrentRouteMatch.php</code>, there is a <code class="language-plaintext highlighter-rouge">getRouteName()</code> function which can be used to get the current route name with a call like:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">currentRouteMatch</span><span class="o">-&gt;</span><span class="nf">getRouteName</span><span class="p">()</span>
</code></pre></div></div><p>Dig deeper in <code class="language-plaintext highlighter-rouge">core.services.yml</code> file for many more services.</p><h3 id="controller-example-1-1"> <a aria-labelledby="controller-example-1-1" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#controller-example-1-1"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Controller Example 1</h3><p>Here is a complete controller which uses the current_user service:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\di_examples\Controller</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Controller\ControllerBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Session\AccountProxyInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\DependencyInjection\ContainerInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">DiExamplesController</span> <span class="kd">extends</span> <span class="nc">ControllerBase</span> <span class="p">{</span>

  <span class="k">protected</span> <span class="kt">AccountProxyInterface</span> <span class="nv">$account</span><span class="p">;</span>

  <span class="cd">/**
   * Builds the response.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>

    <span class="nv">$account</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span><span class="o">-&gt;</span><span class="nf">getAccount</span><span class="p">();</span>
    <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">getAccountName</span><span class="p">();</span>
    <span class="nv">$uid</span> <span class="o">=</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>

    <span class="nv">$message</span> <span class="o">=</span> <span class="s2">"&lt;br&gt;Account info user id: "</span> <span class="mf">.</span> <span class="nv">$uid</span> <span class="mf">.</span> <span class="s2">" username: "</span> <span class="mf">.</span> <span class="nv">$username</span><span class="p">;</span>

    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="nv">$message</span><span class="p">),</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span><span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'current_user'</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">AccountProxyInterface</span> <span class="nv">$account</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nv">$account</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><h3 id="controller-example-2-1"> <a aria-labelledby="controller-example-2-1" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#controller-example-2-1"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Controller Example 2</h3><p>This controller uses 3 different services</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kn">namespace</span> <span class="nn">Drupal\di_examples\Controller</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Controller\ControllerBase</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Path\CurrentPathStack</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Path\PathValidatorInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Session\AccountProxyInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\DependencyInjection\ContainerInterface</span><span class="p">;</span>

<span class="cd">/**
 * Returns responses for DI Examples routes.
 */</span>
<span class="kd">class</span> <span class="nc">DiExamplesController</span> <span class="kd">extends</span> <span class="nc">ControllerBase</span> <span class="p">{</span>

  <span class="k">protected</span> <span class="kt">AccountProxyInterface</span> <span class="nv">$account</span><span class="p">;</span>
  <span class="k">protected</span> <span class="kt">CurrentPathStack</span> <span class="nv">$pathStack</span><span class="p">;</span>
  <span class="k">protected</span> <span class="kt">PathValidatorInterface</span> <span class="nv">$pathValidator</span><span class="p">;</span>

  <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">static</span><span class="p">(</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'current_user'</span><span class="p">),</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'path.current'</span><span class="p">),</span>
      <span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'path.validator'</span><span class="p">),</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">AccountProxyInterface</span> <span class="nv">$account</span><span class="p">,</span> <span class="kt">CurrentPathStack</span> <span class="nv">$path_stack</span><span class="p">,</span> <span class="kt">PathValidatorInterface</span> <span class="nv">$path_validator</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nv">$account</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pathStack</span> <span class="o">=</span> <span class="nv">$path_stack</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pathValidator</span> <span class="o">=</span> <span class="nv">$path_validator</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="cd">/**
   * Builds the response.
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="n">build</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Use the injected account.</span>
    <span class="nv">$account</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span><span class="o">-&gt;</span><span class="nf">getAccount</span><span class="p">();</span>

    <span class="c1">// Use the ControllerBase static version.</span>
    <span class="nv">$account</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">currentUser</span><span class="p">();</span>

    <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">getAccountName</span><span class="p">();</span>
    <span class="nv">$uid</span> <span class="o">=</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>

    <span class="nv">$message</span> <span class="o">=</span> <span class="s2">"&lt;br&gt;Account info user id: "</span> <span class="mf">.</span> <span class="nv">$uid</span> <span class="mf">.</span> <span class="s2">" username: "</span> <span class="mf">.</span> <span class="nv">$username</span><span class="p">;</span>

    <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'hello'</span><span class="p">;</span>

    <span class="c1">// Use the ControllerBase static version to create an entityQuery.</span>
    <span class="nv">$storage</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">entityTypeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getStorage</span><span class="p">(</span><span class="s1">'node'</span><span class="p">);</span>
    <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$storage</span><span class="o">-&gt;</span><span class="nf">getQuery</span><span class="p">();</span>
    <span class="nv">$query</span>
      <span class="o">-&gt;</span><span class="nf">accessCheck</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'article'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">condition</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nb">count</span><span class="p">();</span>
    <span class="nv">$count_nodes</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
    <span class="nv">$message</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt;Retrieved "</span> <span class="mf">.</span> <span class="nv">$count_nodes</span> <span class="mf">.</span> <span class="s2">" nodes"</span><span class="p">;</span>

    <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pathStack</span><span class="o">-&gt;</span><span class="nf">getPath</span><span class="p">();</span>
    <span class="nv">$message</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt; Path: "</span> <span class="mf">.</span> <span class="nv">$path</span><span class="p">;</span>

    <span class="nv">$test_path</span> <span class="o">=</span> <span class="s2">"/vote1"</span><span class="p">;</span>
    <span class="nv">$valid_path</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pathValidator</span><span class="o">-&gt;</span><span class="nf">isValid</span><span class="p">(</span><span class="nv">$test_path</span><span class="p">);</span>
    <span class="nv">$message</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"&lt;br&gt; Check for valid path: "</span> <span class="mf">.</span> <span class="nv">$test_path</span> <span class="mf">.</span> <span class="s2">" returned: "</span> <span class="mf">.</span> <span class="nv">$valid_path</span><span class="p">;</span>


    <span class="nv">$build</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'item'</span><span class="p">,</span>
      <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">t</span><span class="p">(</span><span class="nv">$message</span><span class="p">),</span>
    <span class="p">];</span>

    <span class="k">return</span> <span class="nv">$build</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><h3 id="blocks-and-other-plugins"> <a aria-labelledby="blocks-and-other-plugins" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#blocks-and-other-plugins"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Blocks and other plugins</h3><p>The process for a block (or plugin) is a little different:</p><p>Your block must implement <code class="language-plaintext highlighter-rouge">ContainerFactoryPluginInterface</code>. Plugins only get access to the service container if they implement the <code class="language-plaintext highlighter-rouge">ContainerFactoryPluginInterface</code> e.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TestBlock</span> <span class="kd">extends</span> <span class="nc">BlockBase</span> <span class="kd">implements</span>
<span class="nc">ContainerFactoryPluginInterface</span> <span class="p">{</span>
</code></pre></div></div><p>You must also add the extra parameters to the <code class="language-plaintext highlighter-rouge">create()</code> and <code class="language-plaintext highlighter-rouge">__construct()</code> function i.e. <code class="language-plaintext highlighter-rouge">$plugin_id</code> and <code class="language-plaintext highlighter-rouge">$plugin_definition</code> e.g.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span><span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">)</span>
</code></pre></div></div><p>Here is an example of a block constructor with the <code class="language-plaintext highlighter-rouge">AccountProxyInterface</code> parameter added as this is the service we want to inject:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">,</span> <span class="kt">AccountProxyInterface</span> <span class="nv">$account</span><span class="p">)</span> <span class="p">{</span>
<span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">(</span><span class="nv">$configuration</span><span class="p">,</span> <span class="nv">$plugin_id</span><span class="p">,</span> <span class="nv">$plugin_definition</span><span class="p">);</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nv">$account</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>See more about using dependency injection for blocks and other plugins at <a href="https://chromatichq.com/blog/dependency-injection-drupal-8-plugins">https://chromatichq.com/blog/dependency-injection-drupal-8-plugins</a></p><h2 id="procedural-to-class-based-dependency-injection"> <a aria-labelledby="procedural-to-class-based-dependency-injection" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#procedural-to-class-based-dependency-injection"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Procedural to Class-based dependency injection</h2><p>Here is the overview from the <code class="language-plaintext highlighter-rouge">Drupal.php</code> file for Drupal 9.5.0 of when and how to use dependency injection:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Static Service Container wrapper.
 *
 * Generally, code in Drupal should accept its dependencies via either
 * constructor injection or setter method injection. However, there are cases,
 * particularly in legacy procedural code, where that is infeasible. This
 * class acts as a unified global accessor to arbitrary services within the
 * system in order to ease the transition from procedural code to injected OO
 * code.
 *
 * The container is built by the kernel and passed in to this class which stores
 * it statically. The container always contains the services from
 * \Drupal\Core\CoreServiceProvider, the service providers of enabled modules and any other
 * service providers defined in $GLOBALS['conf']['container_service_providers'].
 *
 * This class exists only to support legacy code that cannot be dependency
 * injected. If your code needs it, consider refactoring it to be object
 * oriented, if possible. When this is not possible, for instance in the case of
 * hook implementations, and your code is more than a few non-reusable lines, it
 * is recommended to instantiate an object implementing the actual logic.
 *
 * @code
 *   // Legacy procedural code.
 *   function hook_do_stuff() {
 *     $lock = lock()-&gt;acquire('stuff_lock');
 *     // ...
 *   }
 *
 *   // Correct procedural code.
 *   function hook_do_stuff() {
 *     $lock = \Drupal::lock()-&gt;acquire('stuff_lock');
 *     // ...
 *   }
 *
 *   // The preferred way: dependency injected code.
 *   function hook_do_stuff() {
 *     // Move the actual implementation to a class and instantiate it.
 *     $instance = new StuffDoingClass(\Drupal::lock());
 *     $instance-&gt;doStuff();
 *
 *     // Or, even better, rely on the service container to avoid hard coding a
 *     // specific interface implementation, so that the actual logic can be
 *     // swapped. This might not always make sense, but in general it is a good
 *     // practice.
 *     \Drupal::service('stuff.doing')-&gt;doStuff();
 *   }
 *
 *   interface StuffDoingInterface {
 *     public function doStuff();
 *   }
 *
 *   class StuffDoingClass implements StuffDoingInterface {
 *     protected $lockBackend;
 *
 *     public function __construct(LockBackendInterface $lock_backend) {
 *       $this-&gt;lockBackend = $lock_backend;
 *     }
 *
 *     public function doStuff() {
 *       $lock = $this-&gt;lockBackend-&gt;acquire('stuff_lock');
 *       // ...
 *     }
 *   }
 * @endcode
 *
 * @see \Drupal\Core\DrupalKernel
 */</span>
</code></pre></div></div><h2 id="drush-services-commands"> <a aria-labelledby="drush-services-commands" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#drush-services-commands"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Drush services commands</h2><h3 id="list-all-services"> <a aria-labelledby="list-all-services" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#list-all-services"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> List all services</h3><p><code class="language-plaintext highlighter-rouge">drush devel:services</code> or <code class="language-plaintext highlighter-rouge">drush dcs</code> or</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">drush</span> <span class="k">eval</span> <span class="s2">"print_r(\Drupal::getContainer()-&gt;getServiceIds());"</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">drush dcs | grep "PART OF SERVICE NAME"</code> can find a service e.g. <code class="language-plaintext highlighter-rouge">drush dcs | grep "access"</code> will find all services with access in the name.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ drush devel:services
- access_arguments_resolver_factory
- access_check.contact_personal
- access_check.cron
- access_check.csrf
- access_check.custom
- access_check.db_update
- access_check.default
- access_check.entity
- access_check.entity_bundles
- access_check.entity_create
- access_check.entity_create_any
- access_check.entity_delete_multiple
- access_check.field_ui.form_mode
- access_check.field_ui.view_mode
- access_check.header.csrf
- access_check.node.add
- access_check.node.preview
- access_check.node.revision
- access_check.permission
- access_check.quickedit.entity_field
- access_check.theme
- access_check.update.manager_access
- access_check.user.login_status
- access_check.user.register
- access_check.user.role
- access_manager
- account_switcher
- admin_toolbar_tools.helper
- ajax_response.attachments_processor
- ajax_response.subscriber
…
</code></pre></div></div><h3 id="generate-custom-service"> <a aria-labelledby="generate-custom-service" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#generate-custom-service"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Generate custom service</h3><p>Drush provides a great starting point by generating some useful code that you can easily build on. Consider using this facility as you write your code.</p><p>From <a href="https://www.drush.org/latest/generators/service_custom">https://www.drush.org/latest/generators/service_custom</a></p><p><code class="language-plaintext highlighter-rouge">drush generate service:custom</code>. Generates a custom Drupal service</p><p>Also there are these gems:</p><p><code class="language-plaintext highlighter-rouge">drush generate service:logger</code>. Generates a logger service</p><p><code class="language-plaintext highlighter-rouge">drush generate service:breadcrumb-builder</code>. Generates a breadcrumb builder service</p><p><code class="language-plaintext highlighter-rouge">drush generate service:event-subscriber</code>. Generates an event subscriber</p><p><code class="language-plaintext highlighter-rouge">drush generate service:middleware</code>. Generates a middleware</p><p><code class="language-plaintext highlighter-rouge">drush generate service:param-converter</code>. Generates a param converter service</p><p><code class="language-plaintext highlighter-rouge">drush generate service:path-processor</code>. Generates a path processor service</p><p><code class="language-plaintext highlighter-rouge">drush generate service:request-policy</code>. Generates a request policy service</p><p><code class="language-plaintext highlighter-rouge">drush generate service:response-policy</code>. Generates a response policy service</p><p><code class="language-plaintext highlighter-rouge">drush generate service:route-subscriber</code>. Generates a route subscriber</p><p>etc.</p><h2 id="resources"> <a aria-labelledby="resources" class="anchor-heading" href="https://selwynpolit.github.io/d9book/services#resources"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Resources</h2><ul><li><a href="https://api.drupal.org/api/drupal/core%21core.api.php/group/container/10">Services and Dependency Injection in the Drupal.org API documentation</a><li><a href="https://code.tutsplus.com/tutorials/drupal-8-properly-injecting-dependencies-using-di--cms-26314">Drupal 8: Properly injecting dependencies using DI by Danny Sipos from May 2016</a><li><a href="https://chromatichq.com/insights/dependency-injection-drupal-8-plugins/">Dependency injection in Drupal 8 plugins (or blocks) by Märt Matoo from March 2017</a><li><a href="https://code.tutsplus.com/tutorials/drupal-8-properly-injecting-dependencies-using-di--cms-26314">Drupal 8: Properly Injecting Dependencies Using DI by Danny Sipos May 2016</a><li><a href="https://gist.github.com/jmolivas/ca258d7f2742d9e1aae4">Inject a service in Drupal 8 showing an example of injecting http_client (Guzzle) by J M Olivas July 2015</a></li></li></li></li></li></ul><hr/> <script async="" crossorigin="anonymous" data-category="Q&amp;A" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMjY2NDE4" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="selwynpolit/d9book" data-repo-id="MDEwOlJlcG9zaXRvcnkzMjUxNTQ1Nzg=" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js"> </script><hr/><footer><p><a href="https://selwynpolit.github.io/d9book/services#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0"><span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"> <a href="http://www.selwynpolit.github.io/d9book" property="dct:title" rel="cc:attributionURL">Drupal at your fingertips</a> by <a href="http://www.drupal.org/u/selwynpolit" property="cc:attributionName" rel="cc:attributionURL dct:creator">Selwyn Polit</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="license noopener noreferrer" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" style="height:16px!important;vertical-align:text-bottom;"/> <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" style="height:16px!important;vertical-align:text-bottom;"/> </a></span></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0 mr-2"> Page last modified: <span class="d-inline-block">Jul 23 2023</span>.</p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/selwynpolit/d9book/tree/gh-pages/book/services.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
</body></link></meta></meta></meta></head></html>