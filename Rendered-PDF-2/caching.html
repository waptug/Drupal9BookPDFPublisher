<!DOCTYPE html>
<html lang="en-US"><head><meta charset="utf-8"/><meta content="IE=Edge" http-equiv="X-UA-Compatible"/><link href="https://selwynpolit.github.io/d9book/assets/css/just-the-docs-default.css" rel="stylesheet"/> <script async="" src="https://www.googletagmanager.com/gtag/js?id=8V22RQEJ71"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '8V22RQEJ71', { 'anonymize_ip': true }); </script> <script src="https://selwynpolit.github.io/d9book/assets/js/vendor/lunr.min.js"></script> <script src="https://selwynpolit.github.io/d9book/assets/js/just-the-docs.js"></script><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://selwynpolit.github.io/d9book/assets/images/favicon.ico" rel="icon" type="image/x-icon"/><title>Caching | Drupal Book</title><meta content="Jekyll v4.3.2" name="generator"><meta content="Caching" property="og:title"><meta content="en_US" property="og:locale"><meta content="Drupal at your fingertips" name="description"/><meta content="Drupal at your fingertips" property="og:description"/><link href="https://selwynpolit.github.io/d9book/d9book/caching" rel="canonical"><meta content="https://selwynpolit.github.io/d9book/d9book/caching" property="og:url"/><meta content="Drupal Book" property="og:site_name"/><meta content="website" property="og:type"/><meta content="summary" name="twitter:card"/><meta content="Caching" property="twitter:title"/> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Drupal at your fingertips","headline":"Caching","url":"https://selwynpolit.github.io/d9book/d9book/caching"}</script><body> <a class="skip-to-main" href="https://selwynpolit.github.io/d9book/caching#main-content">Skip to main content</a> <svg class="d-none" xmlns="http://www.w3.org/2000/svg"> <symbol id="svg-link" viewbox="0 0 24 24"><title>Link</title><svg class="feather feather-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewbox="0 0 24 24"><title>Menu</title><svg class="feather feather-menu" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewbox="0 0 24 24"><title>Expand</title><svg class="feather feather-chevron-right" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol class="feather feather-external-link" fill="none" height="24" id="svg-external-link" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line> </symbol> <symbol id="svg-doc" viewbox="0 0 24 24"><title>Document</title><svg class="feather feather-file" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewbox="0 0 24 24"><title>Search</title><svg class="feather feather-search" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"> <circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewbox="0 0 16 16"><title>Copy</title><svg class="bi bi-clipboard" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"></path><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"></path> </svg> </symbol> <symbol id="svg-copied" viewbox="0 0 16 16"><title>Copied</title><svg class="bi bi-clipboard-check-fill" fill="currentColor" height="16" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"></path><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"></path> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a class="site-title lh-tight" href="https://selwynpolit.github.io/d9book/"> Drupal Book </a> <a class="site-button" href="https://selwynpolit.github.io/d9book/caching" id="menu-button"> <svg class="icon" viewbox="0 0 24 24"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" class="site-nav" id="site-nav"><ul class="nav-list"><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/">Home</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/actions">Actions</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/attribution">Attribution</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/bq">Batch and Queue</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/blocks">Blocks</a><li class="nav-list-item active"><a class="nav-list-link active" href="https://selwynpolit.github.io/d9book/caching">Caching</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/composer">Composer</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/config">Config</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/cron">Cron</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dates">Dates and Times</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/debugging">Debugging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/development">Development</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/drush">Drush</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/email">Email</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/entities">Entities</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/forms">Forms</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/general">General</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/off-island">Getting off the Island</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/hooks">Hooks</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/learn">Learning</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/links">Links</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/logging">Logging</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/menus">Menus</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/migrate">Migrate</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/modals">Modals</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/nodes-and-fields">Nodes and Fields</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/queries">Queries</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/redirects">Redirects</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/render">Render Arrays</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/routes">Routes</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/security">Security</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/services">Services</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/state">State</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/taxonomy">Taxonomy</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/dtt">Tests</a><li class="nav-list-item"><a class="nav-list-link" href="https://selwynpolit.github.io/d9book/twig">Twig</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><ul class="nav-list"><li class="nav-list-item external"> <a class="nav-list-link external" href="https://github.com/selwynpolit/d9book/fork"> Fork me on GitHub <svg aria-labelledby="svg-external-link-title" viewbox="0 0 24 24"><use xlink:href="#svg-external-link"></use></svg> </a></li></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div class="main-header" id="main-header"><div class="search"><div class="search-input-wrap"> <input aria-label="Search Drupal Book" autocomplete="off" class="search-input" id="search-input" placeholder="Search Drupal Book" tabindex="0" type="text"/> <label class="search-label" for="search-input"><svg class="search-icon" viewbox="0 0 24 24"><use xlink:href="#svg-search"></use></svg></label></div><div class="search-results" id="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a class="site-button" href="https://twitter.com/selwynpolit" rel="noopener noreferrer" target="_blank"> <img alt="Twitter logo" src="https://atuin.ru/demo/simple-icons/icons/twitter.svg" style="width: 30px; height: 30px;" title="Author in Twitter"/> </a><li class="aux-nav-list-item"> <a class="site-button" href="https://github.com/selwynpolit/d9book/tree/gh-pages" rel="noopener noreferrer" target="_blank"> <img alt="GitHub logo" src="https://atuin.ru/demo/simple-icons/icons/github.svg" style="width: 30px; height: 30px;" title="D9Book on GitHub"/> </a></li></li></ul></nav></div><div class="main-content-wrap" id="main-content-wrap"><div class="main-content" id="main-content" role="main"><h1 class="no_toc fw-500" id="caching-and-cache-tags"> <a aria-labelledby="caching-and-cache-tags" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#caching-and-cache-tags"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Caching and cache tags</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a aria-labelledby="table-of-contents" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#table-of-contents"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ul id="markdown-toc"><li><a href="https://selwynpolit.github.io/d9book/caching#how-to-uncache-a-particular-page-or-node" id="markdown-toc-how-to-uncache-a-particular-page-or-node">How to uncache a particular page or node</a><li><a href="https://selwynpolit.github.io/d9book/caching#dont-cache-data-returned-from-a-controller" id="markdown-toc-dont-cache-data-returned-from-a-controller">Don’t cache data returned from a controller</a><li><a href="https://selwynpolit.github.io/d9book/caching#disable-caching-for-a-content-type" id="markdown-toc-disable-caching-for-a-content-type">Disable caching for a content type</a><li><a href="https://selwynpolit.github.io/d9book/caching#considering-caching-when-retrieving-query-get-or-post-parameters" id="markdown-toc-considering-caching-when-retrieving-query-get-or-post-parameters">Considering caching when retrieving query, get or post parameters</a><li><a href="https://selwynpolit.github.io/d9book/caching#debugging-cache-tags" id="markdown-toc-debugging-cache-tags">Debugging Cache tags</a><li><a href="https://selwynpolit.github.io/d9book/caching#using-cache-tags" id="markdown-toc-using-cache-tags">Using cache tags</a><li><a href="https://selwynpolit.github.io/d9book/caching#setting-cache-keys-in-a-block" id="markdown-toc-setting-cache-keys-in-a-block">Setting cache keys in a block</a><li><a href="https://selwynpolit.github.io/d9book/caching#getting-cache-tags-and-contexts-for-a-block" id="markdown-toc-getting-cache-tags-and-contexts-for-a-block">Getting Cache Tags and Contexts for a block</a><li><a href="https://selwynpolit.github.io/d9book/caching#caching-rest-resources" id="markdown-toc-caching-rest-resources">Caching REST Resources</a><li><a href="https://selwynpolit.github.io/d9book/caching#caching-in-an-api-class-wrapper" id="markdown-toc-caching-in-an-api-class-wrapper">Caching in an API class wrapper</a><li><a href="https://selwynpolit.github.io/d9book/caching#caching-in-a-module-file" id="markdown-toc-caching-in-a-module-file">Caching in a .module file</a><li><a href="https://selwynpolit.github.io/d9book/caching#logic-for-caching-render-arrays" id="markdown-toc-logic-for-caching-render-arrays">Logic for caching render arrays</a><li><a href="https://selwynpolit.github.io/d9book/caching#development-setup" id="markdown-toc-development-setup">Development Setup</a><ul><li><a href="https://selwynpolit.github.io/d9book/caching#disable-caching-and-enable-twig-debugging" id="markdown-toc-disable-caching-and-enable-twig-debugging">Disable caching and enable TWIG debugging</a><li><a href="https://selwynpolit.github.io/d9book/caching#disable-cache-for-development" id="markdown-toc-disable-cache-for-development">Disable Cache for development</a></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/caching#how-to-specify-the-cache-backend" id="markdown-toc-how-to-specify-the-cache-backend">How to specify the cache backend</a><ul><li><a href="https://selwynpolit.github.io/d9book/caching#class-chainedfastbackend" id="markdown-toc-class-chainedfastbackend">class ChainedFastBackend</a><li><a href="https://selwynpolit.github.io/d9book/caching#apcu" id="markdown-toc-apcu">APCu</a></li></li></ul><li><a href="https://selwynpolit.github.io/d9book/caching#reference" id="markdown-toc-reference">Reference</a></li></li></li></li></li></li></li></li></li></li></li></li></li></li></li></ul><p><img alt="views" src="https://api.visitor.plantree.me/visitor-badge/pv?label=views&amp;color=informational&amp;namespace=d9book&amp;key=caching.md"/></p><hr/><h2 id="how-to-uncache-a-particular-page-or-node"> <a aria-labelledby="how-to-uncache-a-particular-page-or-node" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#how-to-uncache-a-particular-page-or-node"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> How to uncache a particular page or node</h2><p>This will cause Drupal to rebuild the page internally, but won’t stop browsers or CDN’s from caching.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'page_cache_kill_switch'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">trigger</span><span class="p">();</span>
</code></pre></div></div><p>Use this statement in node_preprocess, controller, etc.</p><p>Create a custom module to implement setting max-age to 0. For example in ddd.module file:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Entity\EntityInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Entity\Display\EntityViewDisplayInterface</span><span class="p">;</span>

<span class="k">function</span> <span class="n">ddd_node_view_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$build</span><span class="p">,</span> <span class="kt">EntityInterface</span> <span class="nv">$entity</span><span class="p">,</span> <span class="kt">EntityViewDisplayInterface</span> <span class="nv">$display</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$bundle</span> <span class="o">=</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">bundle</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$bundle</span> <span class="o">==</span> <span class="s1">'search_home'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'#cache'</span><span class="p">][</span><span class="s1">'max-age'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'page_cache_kill_switch'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">trigger</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="dont-cache-data-returned-from-a-controller"> <a aria-labelledby="dont-cache-data-returned-from-a-controller" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#dont-cache-data-returned-from-a-controller"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Don’t cache data returned from a controller</h2><p>From dev1/web/modules/custom/rsvp/src/Controller/ReportController.php</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// Don't cache this page.</span>
  <span class="nv">$content</span><span class="p">[</span><span class="s1">'#cache'</span><span class="p">][</span><span class="s1">'max-age'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Disable caching for a route in the module.routing.yml file.</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">requirements</span><span class="pi">:</span>
  <span class="na">_permission</span><span class="pi">:</span> <span class="s1">'</span><span class="s">access</span><span class="nv"> </span><span class="s">content'</span>
<span class="na">options</span><span class="pi">:</span>
  <span class="na">no_cache</span><span class="pi">:</span> <span class="s">TRUE</span>
</code></pre></div></div><h2 id="disable-caching-for-a-content-type"> <a aria-labelledby="disable-caching-for-a-content-type" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#disable-caching-for-a-content-type"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Disable caching for a content type</h2><p>If someone tries to view a node of content type <em>search_home</em> (i.e. an entity of bundle <em>search_home</em>) caching is disabled and Drupal and the browser will always re-render the page. This is necessary for a page that is retrieving data from a third party source and you almost always expect it to be different. It wouldn’t work for a search page to show results from a previous search.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Entity\EntityInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Drupal\Core\Entity\Display\EntityViewDisplayInterface</span><span class="p">;</span>

<span class="cd">/**
 * Implements hook_ENTITY_TYPE_view_alter().
 */</span>
<span class="k">function</span> <span class="n">ddd_node_view_alter</span><span class="p">(</span><span class="kt">array</span> <span class="o">&amp;</span><span class="nv">$build</span><span class="p">,</span> <span class="kt">EntityInterface</span> <span class="nv">$entity</span><span class="p">,</span> <span class="kt">EntityViewDisplayInterface</span> <span class="nv">$display</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$bundle</span> <span class="o">=</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="nf">bundle</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$bundle</span> <span class="o">==</span> <span class="s1">'search_home'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$build</span><span class="p">[</span><span class="s1">'#cache'</span><span class="p">][</span><span class="s1">'max-age'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">service</span><span class="p">(</span><span class="s1">'page_cache_kill_switch'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">trigger</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="considering-caching-when-retrieving-query-get-or-post-parameters"> <a aria-labelledby="considering-caching-when-retrieving-query-get-or-post-parameters" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#considering-caching-when-retrieving-query-get-or-post-parameters"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Considering caching when retrieving query, get or post parameters</h2><p>For get variables use:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$query</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">request</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">query</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
</code></pre></div></div><p>For post variables use:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$name</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">request</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
</code></pre></div></div><p>For all items in get:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$query</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">request</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">query</span><span class="o">-&gt;</span><span class="nf">all</span><span class="p">();</span>
<span class="nv">$search_term</span> <span class="o">=</span> <span class="nv">$query</span><span class="p">[</span><span class="s1">'query'</span><span class="p">];</span>
<span class="nv">$collection</span> <span class="o">=</span> <span class="nv">$query</span><span class="p">[</span><span class="s1">'collection'</span><span class="p">];</span>
</code></pre></div></div><p>Be wary about caching. From <a href="https://drupal.stackexchange.com/questions/231953/get-in-drupal-8/231954#231954">https://drupal.stackexchange.com/questions/231953/get-in-drupal-8/231954#231954</a> the code provided only works the first time so it is important to add a ‘#cache’ context in the markup.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">namespace</span> <span class="nn">Drupal\newday\Controller</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Drupal\Core\Controller\ControllerBase</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">NewdayController</span> <span class="kd">extends</span> <span class="nc">ControllerBase</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">new</span><span class="p">()</span> <span class="p">{</span>
      <span class="nv">$day</span><span class="o">=</span> <span class="p">[</span>
        <span class="s2">"#markup"</span> <span class="o">=&gt;</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">request</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">query</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'id'</span><span class="p">),</span>
       <span class="p">];</span>
      <span class="k">return</span> <span class="nv">$day</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>The request is being cached, you need to tell the system to vary by the query argument:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$day</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">request</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">query</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'id'</span><span class="p">),</span>
    <span class="s1">'#cache'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'contexts'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'url.query_args:id'</span><span class="p">],</span>
    <span class="p">],</span>
<span class="p">];</span>
</code></pre></div></div><p>More about caching render arrays at <a href="https://www.drupal.org/docs/8/api/render-api/cacheability-of-render-arrays">https://www.drupal.org/docs/8/api/render-api/cacheability-of-render-arrays</a></p><h2 id="debugging-cache-tags"> <a aria-labelledby="debugging-cache-tags" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#debugging-cache-tags"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Debugging Cache tags</h2><p>In <code class="language-plaintext highlighter-rouge">development.services.yml</code> set these parameters</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">parameters</span><span class="pi">:</span>
  <span class="na">http.response.debug_cacheability_headers</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre></div></div><p>in Chrome, the network tab, click on the doc and view the Headers. You will see the following two headers showing both the cache contexts and the cache tags</p><ol><li><strong>X-Drupal-Cache-Contexts:</strong></li></ol><blockquote><p>languages:language_interface route session theme timezone url.path url.query_args url.site user</p></blockquote><ol><li><strong>X-Drupal-Cache-Tags:</strong></li></ol><blockquote><p>block_view config:block.block.bartik_account_menu config:block.block.bartik_branding config:block.block.bartik_breadcrumbs config:block.block.bartik_content config:block.block.bartik_footer config:block.block.bartik_help config:block.block.bartik_local_actions config:block.block.bartik_local_tasks config:block.block.bartik_main_menu config:block.block.bartik_messages config:block.block.bartik_page_title config:block.block.bartik_powered config:block.block.bartik_search config:block.block.bartik_tools config:block.block.helloworldsalutation config:block.block.modalblock config:block.block.productimagegallery config:block.block.rsvpblock config:block.block.views_block__aquifer_listing_block_1 config:block.block.views_block__related_videos_block_1 config:block.block.views_block__user_guide_pages_referencing_a_product_block_1 config:block.block.views_block__workshop_count_proposed_workshop_block config:bloc</p></blockquote><h2 id="using-cache-tags"> <a aria-labelledby="using-cache-tags" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#using-cache-tags"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Using cache tags</h2><p>If you are generating a list of cached node teasers and you want to make sure your list is always accurate, use cache tags. To refresh the list every time a node is added, deleted or edited you could use a render array like this:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$build</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'markup'</span><span class="p">,</span>
  <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$sMarkup</span><span class="p">,</span>        
  <span class="s1">'#cache'</span> <span class="o">=&gt;</span> <span class="p">[</span>
    <span class="s1">'keys'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'home-all'</span><span class="p">,</span><span class="s1">'home'</span><span class="p">],</span>
    <span class="s1">'tags'</span><span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'node_list'</span><span class="p">],</span> <span class="c1">// invalidate cache when any node content is added/changed etc.</span>
    <span class="s1">'max-age'</span> <span class="o">=&gt;</span> <span class="s1">'36600'</span><span class="p">,</span> <span class="c1">// invalidate cache after 10h</span>
  <span class="p">],</span>
<span class="p">];</span>
</code></pre></div></div><p>It is possible to change this so the cache is invalidated only when a content type of <em>book</em> or <em>magazine</em> is changed in two possible ways:</p><ol><li><p>Include all node tags (node:{#id}), if doesn't matter if a new node of a particular type was added.</p><li><p>Create and control your own cache tag, and invalidate it when you want.</p></li></li></ol><p>If you want a block to be rebuilt every time that a term from a particular vocab_id is added, changed, or deleted you can cache the term list. If you need to cache a term list per vocab_id - i.e. every time that a term from a particular vocab_id is added, changed, or deleted the cache tag is invalided using <code class="language-plaintext highlighter-rouge">Cache::invalidateTags($tag_id)</code> then my block will be rebuild.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Drupal\Core\Cache\Cache</span><span class="p">;</span>

<span class="k">function</span> <span class="n">filters_invalidate_vocabulary_cache_tag</span><span class="p">(</span><span class="nv">$vocab_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nc">Cache</span><span class="o">::</span><span class="nf">invalidateTags</span><span class="p">([</span><span class="s1">'filters_vocabulary:'</span> <span class="mf">.</span> <span class="nv">$vocab_id</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div><p>If you want this to work for nodes, you may be able to just change <code class="language-plaintext highlighter-rouge">$vocab_id</code> for <code class="language-plaintext highlighter-rouge">$node_type</code>.</p><h2 id="setting-cache-keys-in-a-block"> <a aria-labelledby="setting-cache-keys-in-a-block" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#setting-cache-keys-in-a-block"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Setting cache keys in a block</h2><p>If you add some code to a block that includes the logged in user’s name, you may find that the username will not be displayed correctly – rather it may show the prior users name. This is because the cache context of user doesn’t bubble up to the display of the container (e.g. the node that is displayed along with your custom block.) Add this to bubble the cache contexts up.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">getCacheContexts</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">Return</span> <span class="nc">Cache</span><span class="o">::</span><span class="nf">mergeContexts</span><span class="p">(</span><span class="k">parent</span><span class="o">::</span><span class="nf">getCacheContexts</span><span class="p">(),[</span><span class="s1">'user'</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div><p>and scrolling down a bit at this link shows some more info about getting cache tags and merging them. <a href="https://drupal.stackexchange.com/questions/145823/how-do-i-get-the-current-node-id">https://drupal.stackexchange.com/questions/145823/how-do-i-get-the-current-node-id</a></p><h2 id="getting-cache-tags-and-contexts-for-a-block"> <a aria-labelledby="getting-cache-tags-and-contexts-for-a-block" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#getting-cache-tags-and-contexts-for-a-block"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Getting Cache Tags and Contexts for a block</h2><p>In this file /modules/custom/dart_pagination/src/Plugin/Block/VideoPaginationBlock.php I have a block that renders a form. The form queries some data from the database and will need to be updated depending on the node that I am on.</p><p>I added the following two functions:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">getCacheTags</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//When my node changes my block will rebuild</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">routeMatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getParameter</span><span class="p">(</span><span class="s1">'node'</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//if there is node add its cachetag</span>
    <span class="k">return</span> <span class="nc">Cache</span><span class="o">::</span><span class="nf">mergeTags</span><span class="p">(</span><span class="k">parent</span><span class="o">::</span><span class="nf">getCacheTags</span><span class="p">(),</span> <span class="p">[</span><span class="s1">'node:'</span> <span class="mf">.</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()]);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">//Return default tags instead.</span>
    <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="nf">getCacheTags</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">getCacheContexts</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//if you depend on \Drupal::routeMatch()</span>
  <span class="c1">//you must set context of this block with 'route' context tag.</span>
  <span class="c1">//Every new route this block will rebuild</span>
  <span class="k">return</span> <span class="nc">Cache</span><span class="o">::</span><span class="nf">mergeContexts</span><span class="p">(</span><span class="k">parent</span><span class="o">::</span><span class="nf">getCacheContexts</span><span class="p">(),</span> <span class="p">[</span><span class="s1">'route'</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="caching-rest-resources"> <a aria-labelledby="caching-rest-resources" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#caching-rest-resources"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Caching REST Resources</h2><p>Interesting article about caching REST resources at <a href="http://blog.dcycle.com/blog/2018-01-24/caching-drupal-8-rest-resource/">http://blog.dcycle.com/blog/2018-01-24/caching-drupal-8-rest-resource/</a></p><p>We can get Drupal to cache our rest resource e.g. in dev1 /custom/iai_wea/src/Plugin/rest/resource/WEAResource.php where we add this to our response:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$record</span><span class="p">))</span> <span class="p">{</span>
  <span class="nv">$response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ResourceResponse</span><span class="p">(</span><span class="nv">$record</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
  <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">addCacheableDependency</span><span class="p">(</span><span class="nv">$record</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="caching-in-an-api-class-wrapper"> <a aria-labelledby="caching-in-an-api-class-wrapper" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#caching-in-an-api-class-wrapper"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Caching in an API class wrapper</h2><p>From docroot/modules/custom/cm_api/src/CmAPIClient.php</p><p>Here a member is set up in the class</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Custom service to call APIs.
 *
 * @see \Drupal|cm_api|CmAPIClientInterface
 */</span>
<span class="kd">class</span> <span class="nc">CmAPIClient</span> <span class="kd">implements</span> <span class="nc">CmAPIClientInterface</span> <span class="p">{</span>
<span class="mf">...</span>
<span class="cd">/**
 * Internal static cache.
 *
 * @var array
 */</span>
<span class="k">protected</span> <span class="k">static</span> <span class="nv">$cache</span> <span class="o">=</span> <span class="p">[];</span>
</code></pre></div></div><p>The api call is made and the cache is checked. The index (or key) is built from the api call “getPolicy” and the next key is the policy number with the version number attached. So the <code class="language-plaintext highlighter-rouge">$response_data</code> is put in the cache with:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">self</span><span class="o">::</span><span class="nv">$cache</span><span class="p">[</span><span class="s1">'getPolicy'</span><span class="p">][</span><span class="nv">$policy_number</span> <span class="mf">.</span> <span class="nv">$version</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$response_data</span><span class="p">;</span>
</code></pre></div></div><p>and retrieved with:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$response_data</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nv">$cache</span><span class="p">[</span><span class="s1">'getPolicy'</span><span class="p">][</span><span class="nv">$policy_number</span> <span class="mf">.</span> <span class="nv">$version</span><span class="p">];</span>
</code></pre></div></div><p>This relieves the back end load by rather getting the data from the cache if is in the cache. (If the cache is warm.)</p><p>The entire function is shown below. It is from <code class="language-plaintext highlighter-rouge">docroot/modules/custom/cm_api/src/CmAPIClient.php</code>:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">getPolicy</span><span class="p">(</span><span class="nv">$policy_number</span><span class="p">,</span> <span class="nv">$version</span> <span class="o">=</span> <span class="s1">'v2'</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Api action type.</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="s1">'api_action'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Get policy'</span><span class="p">;</span>
  <span class="c1">// Add policy number to display in watchdog.</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="s1">'policynumber'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$policy_number</span><span class="p">;</span>
  <span class="nv">$base_api_url</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getBaseApiUrl</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$policy_number</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$policy_number</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'cm_api_get_policy'</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span><span class="s1">'Policy number must be a number.'</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nv">$endpoint_url</span> <span class="o">=</span> <span class="nv">$base_api_url</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nv">$version</span> <span class="mf">.</span> <span class="s1">'/Policies/group?policies='</span> <span class="mf">.</span> <span class="nv">$policy_number</span> <span class="mf">.</span> <span class="s1">'&amp;include_ref=false&amp;include_hist=true'</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="nv">$cache</span><span class="p">[</span><span class="s1">'getPolicy'</span><span class="p">][</span><span class="nv">$policy_number</span> <span class="mf">.</span> <span class="nv">$version</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$response_data</span> <span class="o">=</span> <span class="k">self</span><span class="o">::</span><span class="nv">$cache</span><span class="p">[</span><span class="s1">'getPolicy'</span><span class="p">][</span><span class="nv">$policy_number</span> <span class="mf">.</span> <span class="nv">$version</span><span class="p">];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$response_data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">performRequest</span><span class="p">(</span><span class="nv">$endpoint_url</span><span class="p">,</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">);</span>
    <span class="k">self</span><span class="o">::</span><span class="nv">$cache</span><span class="p">[</span><span class="s1">'getPolicy'</span><span class="p">][</span><span class="nv">$policy_number</span> <span class="mf">.</span> <span class="nv">$version</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$response_data</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$response_data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="caching-in-a-module-file"> <a aria-labelledby="caching-in-a-module-file" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#caching-in-a-module-file"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Caching in a .module file</h2><p>From <code class="language-plaintext highlighter-rouge">docroot/modules/custom/ncs_infoconnect/nzz_zzzzconnect.module</code>.</p><p>In the hook_preprocess_node function, we are calling an api to get some data.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Implements hook_preprocess_node().
 */</span>
<span class="k">function</span> <span class="n">nzz_zzzzconnect_preprocess_node</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$variables</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div><p>Notice the references to <code class="language-plaintext highlighter-rouge">\Drupal::cache()</code>. First we check if this is our kind of node to process. Then we derive the <code class="language-plaintext highlighter-rouge">$cid</code>. We check the cache with a call to <code class="language-plaintext highlighter-rouge">-&gt;get($cid)</code> and if it fails we:</p><ol><li><p>call the api with <code class="language-plaintext highlighter-rouge">$client-&gt;request('GET')</code></p><li><p>pull out the body with <code class="language-plaintext highlighter-rouge">$response-&gt;getBody()</code></p><li><p>set the whole body into the cache with:</p></li></li></li></ol><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">\Drupal</span><span class="o">::</span><span class="nf">cache</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="nv">$cid</span><span class="p">,</span> <span class="nv">$contents</span><span class="p">,</span> <span class="no">REQUEST_TIME</span> <span class="o">+</span> <span class="p">(</span><span class="mi">300</span><span class="p">));</span>
</code></pre></div></div><p>In future requests, we can just use the data from the cache.</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nv">$node_type</span> <span class="o">==</span> <span class="s1">'zzzzfeed'</span> <span class="o">&amp;&amp;</span> <span class="nv">$published</span><span class="p">)</span> <span class="p">{</span>

  <span class="nv">$uuid</span> <span class="o">=</span> <span class="nv">$variables</span><span class="p">[</span><span class="s1">'node'</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">field_uuid</span><span class="o">-&gt;</span><span class="nf">getValue</span><span class="p">();</span>
  <span class="nv">$nid</span> <span class="o">=</span> <span class="nv">$variables</span><span class="p">[</span><span class="s1">'node'</span><span class="p">]</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">();</span>

  <span class="nv">$nzz_auth_settings</span> <span class="o">=</span> <span class="nc">Settings</span><span class="o">::</span><span class="nf">get</span><span class="p">(</span><span class="s1">'nzz_api_auth'</span><span class="p">,</span> <span class="p">[]);</span>
  <span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$ncs_auth_settings</span><span class="p">[</span><span class="s1">'default'</span><span class="p">][</span><span class="s1">'server'</span><span class="p">]</span> <span class="mf">.</span> <span class="s1">':'</span> <span class="mf">.</span> <span class="nv">$ncs_auth_settings</span><span class="p">[</span><span class="s1">'default'</span><span class="p">][</span><span class="s1">'port'</span><span class="p">];</span>
  <span class="nv">$uri</span> <span class="mf">.</span><span class="o">=</span> <span class="s1">'/blahcontent/search'</span><span class="p">;</span>
  <span class="nv">$client</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">httpClient</span><span class="p">();</span>

  <span class="nv">$cid</span> <span class="o">=</span> <span class="s1">'zzzzfeed-'</span> <span class="mf">.</span> <span class="nv">$nid</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$cache</span> <span class="o">=</span> <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">cache</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$cid</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$cache</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="nf">request</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">'auth'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$nzz_auth_settings</span><span class="p">[</span><span class="s1">'default'</span><span class="p">][</span><span class="s1">'username'</span><span class="p">],</span> <span class="nv">$nzz_auth_settings</span><span class="p">[</span><span class="s1">'default'</span><span class="p">][</span><span class="s1">'password'</span><span class="p">]],</span>
        <span class="s1">'query'</span> <span class="o">=&gt;</span> <span class="p">[</span>
          <span class="s1">'uuid'</span> <span class="o">=&gt;</span> <span class="nv">$uuid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'value'</span><span class="p">],</span>
        <span class="p">],</span>
        <span class="s1">'timeout'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
      <span class="p">]);</span>
      <span class="nv">$contents</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="nf">getBody</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">getContents</span><span class="p">();</span>
      <span class="nc">\Drupal</span><span class="o">::</span><span class="nf">cache</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="nv">$cid</span><span class="p">,</span> <span class="nv">$contents</span><span class="p">,</span> <span class="no">REQUEST_TIME</span> <span class="o">+</span> <span class="p">(</span><span class="mi">300</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nc">RequestException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">watchdog_exception</span><span class="p">(</span><span class="s1">'nzz_zzzzconnect'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nc">ClientException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">watchdog_exception</span><span class="p">(</span><span class="s1">'nzz_zzzzconnect'</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$contents</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">);</span>
  <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$contents</span><span class="p">[</span><span class="s1">'hits'</span><span class="p">][</span><span class="s1">'hits'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'versions'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'properties'</span><span class="p">][</span><span class="s1">'Text'</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="nv">$variables</span><span class="p">[</span><span class="s1">'content'</span><span class="p">][</span><span class="s1">'body'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'#markup'</span> <span class="o">=&gt;</span> <span class="nv">$body</span><span class="p">,</span>
  <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div><h2 id="logic-for-caching-render-arrays"> <a aria-labelledby="logic-for-caching-render-arrays" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#logic-for-caching-render-arrays"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Logic for caching render arrays</h2><p>From <a href="https://www.drupal.org/docs/8/api/render-api/cacheability-of-render-arrays">https://www.drupal.org/docs/8/api/render-api/cacheability-of-render-arrays</a></p><p>Whenever you are generating a render array, use the following 5 steps:</p><ol><li><p>I’m rendering something. That means I must think of cacheability.</p><li><p>Is this something that's expensive to render, and therefore is worth caching? If the answer is yes, then what identifies this particular representation of the thing I’m rendering? Those are the cache keys.</p><li><p>Does the representation of the thing I’m rendering vary per combination of permissions, per URL, per interface language, per … something? Those are the cache contexts. Note: cache contexts are completely analogous to HTTP’s Vary header.</p><li><p>What causes the representation of the thing I’m rendering become outdated? I.e., which things does it depend upon, so that when those things change, so should my representation? Those are the cache tags.</p><li><p>When does the representation of the thing I’m rendering become outdated? I.e., is the data valid for a limited period of time only? That is the max-age (maximum age). It defaults to “permanently (forever) cacheable” (<code class="language-plaintext highlighter-rouge">Cache::PERMANENT</code>). When the representation is only valid for a limited time, set a <code class="language-plaintext highlighter-rouge">max-age</code>, expressed in seconds. Zero means that it’s not cacheable at all.</p></li></li></li></li></li></ol><p>Cache contexts, tags and max-age must always be set, because they affect the cacheability of the entire response. Therefore they “bubble” and parents automatically receive them.</p><p>Cache keys must only be set if the render array should be cached.</p><p>There are more details at the link above</p><h2 id="development-setup"> <a aria-labelledby="development-setup" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#development-setup"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Development Setup</h2><h3 id="disable-caching-and-enable-twig-debugging"> <a aria-labelledby="disable-caching-and-enable-twig-debugging" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#disable-caching-and-enable-twig-debugging"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Disable caching and enable TWIG debugging</h3><p>Generally I enable twig debugging and disable caching while developing a site.</p><p>To enable TWIG debugging output in source, in sites/default/development.services.yml set twig.config debug:true. See core.services.yml for lots of other items to change for development</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Local development services.</span>
<span class="c1">#</span>
<span class="c1"># To activate this feature, follow the instructions at the top of the</span>
<span class="c1"># 'example.settings.local.php' file, which sits next to this file.</span>
<span class="na">parameters</span><span class="pi">:</span>
  <span class="na">http.response.debug_cacheability_headers</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">dino.roar.use_key_value_cache</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">twig.config</span><span class="pi">:</span>
    <span class="na">debug</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">auto_reload</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">cache</span><span class="pi">:</span> <span class="kc">false</span>

<span class="c1"># To disable caching, you need this and a few other items</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">cache.backend.null</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\Core\Cache\NullBackendFactory</span>
</code></pre></div></div><p>to enable put this in settings.local.php:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Enable local development services.
 */</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'container_yamls'</span><span class="p">][]</span> <span class="o">=</span> <span class="no">DRUPAL_ROOT</span> <span class="mf">.</span> <span class="s1">'/sites/development.services.yml'</span><span class="p">;</span>
</code></pre></div></div><p>You also need to disable the render cache in settings.local.php with:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'render'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.null'</span><span class="p">;</span>
</code></pre></div></div><h3 id="disable-cache-for-development"> <a aria-labelledby="disable-cache-for-development" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#disable-cache-for-development"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Disable Cache for development</h3><p>From https://www.drupal.org/node/2598914</p><ol><li>Copy, rename, and move the <code class="language-plaintext highlighter-rouge">sites/example.settings.local.php</code> to <code class="language-plaintext highlighter-rouge">sites/default/settings.local.php</code> with:</li></ol><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cp </span>sites/example.settings.local.php sites/default/settings.local.php
</code></pre></div></div><ol><li>Edit <code class="language-plaintext highlighter-rouge">sites/default/settings.php</code> and uncomment these lines:</li></ol><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$app_root</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nv">$site_path</span> <span class="mf">.</span> <span class="s1">'/settings.local.php'</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">include</span> <span class="nv">$app_root</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nv">$site_path</span> <span class="mf">.</span> <span class="s1">'/settings.local.php'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>This will include the local settings file as part of Drupal’s settings file.</p><ol><li>In <code class="language-plaintext highlighter-rouge">settings.local.php</code> make sure <code class="language-plaintext highlighter-rouge">development.services.yml</code> is enabled with:</li></ol><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$settings</span><span class="p">[</span><span class="s1">'container_yamls'</span><span class="p">][]</span> <span class="o">=</span> <span class="no">DRUPAL_ROOT</span> <span class="mf">.</span> <span class="s1">'/sites/development.services.yml'</span><span class="p">;</span>
</code></pre></div></div><p>By default <code class="language-plaintext highlighter-rouge">development.services.yml</code> contains the settings to disable Drupal caching:</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">cache.backend.null</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\Core\Cache\NullBackendFactory</span>
</code></pre></div></div><p>NOTE: Do not create development.services.yml, it already exists under /sites. You can copy it from there.</p><ol><li>In <code class="language-plaintext highlighter-rouge">settings.local.php</code> change the following to be TRUE if you want to work with enabled css- and js-aggregation:</li></ol><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$config</span><span class="p">[</span><span class="s1">'system.performance'</span><span class="p">][</span><span class="s1">'css'</span><span class="p">][</span><span class="s1">'preprocess'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
<span class="nv">$config</span><span class="p">[</span><span class="s1">'system.performance'</span><span class="p">][</span><span class="s1">'js'</span><span class="p">][</span><span class="s1">'preprocess'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
</code></pre></div></div><ol><li>Uncomment these lines in <code class="language-plaintext highlighter-rouge">settings.local.php</code> to disable the render cache and disable dynamic page cache:</li></ol><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'render'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.null'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'dynamic_page_cache'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.null'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'page'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.null'</span><span class="p">;</span>
</code></pre></div></div><p>If you do not want to install test modules and themes, set the following to FALSE:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$settings</span><span class="p">[</span><span class="s1">'extension_discovery_scan_tests'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">;</span>
</code></pre></div></div><ol><li>In <code class="language-plaintext highlighter-rouge">sites/development.services.yml</code> add the following block to disable the twig cache:</li></ol><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">parameters</span><span class="pi">:</span>
  <span class="na">twig.config</span><span class="pi">:</span>
    <span class="na">debug</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">auto_reload</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">cache</span><span class="pi">:</span> <span class="kc">false</span>
</code></pre></div></div><p>NOTE: If the parameters block is already present in the yml file, append the twig.config block to it.</p><p>Afterwards rebuild the Drupal cache with <code class="language-plaintext highlighter-rouge">drush cr</code> otherwise your website will encounter an unexpected error on page reload.</p><h2 id="how-to-specify-the-cache-backend"> <a aria-labelledby="how-to-specify-the-cache-backend" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#how-to-specify-the-cache-backend"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> How to specify the cache backend</h2><p>This information is relevant for using <a href="https://www.drupal.org/project/memcache">Memcache</a>, <a href="https://www.drupal.org/project/redis">Redis</a> and also <a href="https://www.php.net/manual/en/book.apcu.php">APCu</a>. By default, Drupal caches information in the database. Tables includes cache_default, cache_render, cache_page, cache_config etc. By using the configuration below, Drupal can instead store this info in memory to increase performance.</p><p><strong>Summary</strong></p><p>Drupal will no longer automatically use the custom global cache backend specified in <code class="language-plaintext highlighter-rouge">$settings['cache']['default']</code> in settings.php on certain specific cache bins that define their own default_backend in their service definition. In order to override the default backend, a line must be added explicitly to settings.php for each specific bin that provides a default_backend. This change has no effect for users that do not use a custom cache backend configuration like Redis or Memcache, and makes it possible to remove workarounds that were previously necessary to keep using the default fast chained backend for some cache bins defined in Drupal core.</p><p><strong>Detailed description with examples</strong></p><p>In Drupal 8 there are several ways to specify which cache backend is used for a certain cache bin (e.g. the discovery cache bin or the render cache bin).</p><p>In Drupal, cache bins are defined as services and are tagged with name: cache.bin. Additionally, some cache bins specify a <code class="language-plaintext highlighter-rouge">default_backend</code> service within the tags. For example, the discovery cache bin from Drupal core defines a fast chained default backend:</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">cache.discovery</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\Core\Cache\CacheBackendInterface</span>
    <span class="na">tags</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="pi">{</span> <span class="nv">name</span><span class="pi">:</span> <span class="nv">cache.bin</span><span class="pi">,</span> <span class="nv">default_backend</span><span class="pi">:</span> <span class="nv">cache.backend.chainedfast</span> <span class="pi">}</span>
    <span class="na">factory</span><span class="pi">:</span> <span class="s">cache_factory:get</span>
    <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">discovery</span><span class="pi">]</span>
</code></pre></div></div><p>Independent of this, the $settings array can be used in <code class="language-plaintext highlighter-rouge">settings.php</code> to assign cache backends to cache bins. For example:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'discovery'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.memory'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'default'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.redis'</span><span class="p">;</span>
</code></pre></div></div><p>Before Drupal 8.2.0, the order of steps through which the backend was selected for a given cache bin was as follows:</p><ul><li>First look for a specific bin definition in settings. E.g., <code class="language-plaintext highlighter-rouge">$settings['cache']['bins']['discovery']</code><li>If not found, then use the global default defined in settings. I.e., <code class="language-plaintext highlighter-rouge">$settings['cache']['default']</code><li>If a global default is not defined in settings, then use the default_backend from the tag in the service definition.</li></li></li></ul><p>This was changed to:</p><ul><li>First look for a specific bin definition in settings. E.g., <code class="language-plaintext highlighter-rouge">$settings['cache']['bins']['discovery']</code><li>If not found, then use the the <code class="language-plaintext highlighter-rouge">default_backend</code> from the tag in the service definition.<li>If no <code class="language-plaintext highlighter-rouge">default_backend</code> for the specific bin was provided, then use the global default defined in settings. I.e., <code class="language-plaintext highlighter-rouge">$settings['cache']['default']</code> The old order resulted in unexpected behaviors, for example, the fast chained backend was no longer used when an alternative cache backend was set as default.</li></li></li></ul><p>The order has been changed, so that the cache bin services that explicitly set <code class="language-plaintext highlighter-rouge">default_backends</code> are always used unless explicitly overridden with a per-bin configuration. In core, this means, fast chained backend will be used for <code class="language-plaintext highlighter-rouge">bootstrap</code>, <code class="language-plaintext highlighter-rouge">config</code>, and <code class="language-plaintext highlighter-rouge">discovery</code> cache bins and <code class="language-plaintext highlighter-rouge">memory</code> backend will be used for the <code class="language-plaintext highlighter-rouge">static</code> cache bin, unless they are explicitly overridden in settings.</p><p>For example, to ensure Redis is used for all cache bins, before 8.2.0, the following configuration would have been enough:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'default'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.redis'</span><span class="p">;</span>
</code></pre></div></div><p>However, now the following configuration in settings.php would be required to achieve the same exact behavior:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'bootstrap'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.redis'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'discovery'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.redis'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'config'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.redis'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'static'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.redis'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'default'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.redis'</span><span class="p">;</span>
</code></pre></div></div><p>Before proceeding to override the cache bins that define fast cached default backends blindly, please also read why they exist, particularly when using multiple webserver nodes. See <a href="http://api.drupal.org/ChainedFastBackend">ChainedFastBackend on api.drupal.org</a>.</p><p>The above information is from <a href="https://www.drupal.org/node/2754947">https://www.drupal.org/node/2754947</a></p><p>Fabian Franz in his article at <a href="https://drupalsun.com/fabianx/2015/12/01/day-1-tweak-drupal-8-performance-use-apcu-24-days-performance-goodies">https://drupalsun.com/fabianx/2015/12/01/day-1-tweak-drupal-8-performance-use-apcu-24-days-performance-goodies</a> suggests that we can configure APCu to be used for caches with the following:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'default'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.apcu'</span><span class="p">;</span>
 <span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'bootstrap'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.apcu'</span><span class="p">;</span>
 <span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'config'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.apcu'</span><span class="p">;</span>
 <span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'discovery'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.apcu'</span><span class="p">;</span>
</code></pre></div></div><p class="warning">Proceed with caution with the above as it seems that APCu may only suitable for single server setups. TODO: I couldn’t find any references to using APCu with multi-server setups so I’m not sure if that is a safe configuration.</p><p>Pantheon docs ask in their FAQ Can APCu be used as a cache backend on Pantheon? Yes, APCu can be used as a cache backend or a “key-value store”; however, this is not recommended. APCu lacks the ability to span multiple application containers. Instead, Pantheon provides a Redis-based Object Cache as a caching backend for Drupal and WordPress, which has coherence across multiple application containers. This was from <a href="https://docs.pantheon.io/apcu">Pantheon docs</a> FAQ’s:</p><p>Drupal 8 has a so-called <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Cache%21ChainedFastBackend.php/class/ChainedFastBackend/9">fast-chained backend</a> as the default cache backend, which allows to store data directly on the web server while ensuring it is correctly synchronized across multiple servers. APCu is the user cache portion of APC (Advanced PHP Cache), which has served us well till PHP 5.5 got its own zend opcache. You can think of it as a key-value store that is stored in memory and the basic operations are apc_store($key, $data), apc_fetch($keys) and apc_delete($keys). For windows the equivalent on IIS would be WinCache (http://drupal.org/project/wincache).</p><h3 id="class-chainedfastbackend"> <a aria-labelledby="class-chainedfastbackend" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#class-chainedfastbackend"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> class ChainedFastBackend</h3><p>Defines a backend with a fast and a consistent backend chain.</p><p>In order to mitigate a network roundtrip for each cache get operation, this cache allows a fast backend to be put in front of a slow(er) backend. Typically the fast backend will be something like APCu, and be bound to a single web node, and will not require a network round trip to fetch a cache item. The fast backend will also typically be inconsistent (will only see changes from one web node). The slower backend will be something like Mysql, Memcached or Redis, and will be used by all web nodes, thus making it consistent, but also require a network round trip for each cache get.</p><p>In addition to being useful for sites running on multiple web nodes, this backend can also be useful for sites running on a single web node where the fast backend (e.g., APCu) isn’t shareable between the web and CLI processes. Single-node configurations that don’t have that limitation can just use the fast cache backend directly.</p><p>We always use the fast backend when reading (get()) entries from cache, but check whether they were created before the last write (set()) to this (chained) cache backend. Those cache entries that were created before the last write are discarded, but we use their cache IDs to then read them from the consistent (slower) cache backend instead; at the same time we update the fast cache backend so that the next read will hit the faster backend again. Hence we can guarantee that the cache entries we return are all up-to-date, and maximally exploit the faster cache backend. This cache backend uses and maintains a “last write timestamp” to determine which cache entries should be discarded.</p><p>Because this backend will mark all the cache entries in a bin as out-dated for each write to a bin, it is best suited to bins with fewer changes.</p><p>Note that this is designed specifically for combining a fast inconsistent cache backend with a slower consistent cache back-end. To still function correctly, it needs to do a consistency check (see the “last write timestamp” logic). This contrasts with \Drupal\Core\Cache\BackendChain, which assumes both chained cache backends are consistent, thus a consistency check being pointless. This information is from <a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Cache%21ChainedFastBackend.php/class/ChainedFastBackend/9">https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Cache%21ChainedFastBackend.php/class/ChainedFastBackend/9</a></p><h3 id="apcu"> <a aria-labelledby="apcu" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#apcu"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> APCu</h3><p>APCu is the official replacement for the outdated APC extension. APC provided both opcode caching (opcache) and object caching. As PHP versions 5.5 and above include their own opcache, APC was no longer compatible, and its opcache functionality became useless. The developers of APC then created APCu, which offers only the object caching (read “in memory data caching”) functionality (they removed the outdated opcache). Read more at <a href="https://www.php.net/manual/en/book.apcu.php">https://www.php.net/manual/en/book.apcu.php</a></p><p class="note">APCu is not the same as apc!</p><p>APCu support is built into Drupal Core. From this <a href="https://www.drupal.org/node/2327507">Change record Sep 2014</a>:</p><p>In order to improve cache performance, Drupal 8 now has:</p><p>A cache.backend.apcu service that site administrators can assign as the backend of a cache bin via $settings[‘cache’] in settings.php for sites running on a single server, with a PHP installation that has APCu enabled, and that do not use Drush or other command line scripts.</p><p class="warning">This references single-server sites not needing Drush. TODO: I couldn’t find any references to using APCu with multi-server setups so I’m not sure if that is a safe configuration.</p><p>A cache.backend.chainedfast service that combines APCu availability detection, APCu front caching, and cross-server / cross-process consistency management via chaining to a secondary backend (either the database or whatever is configured for $settings[‘cache’][‘default’]).</p><p>A <code class="language-plaintext highlighter-rouge">default_backend</code> service tag (the value of which can be set to a backend service name, such as cache.backend.chainedfast) that module developers can assign to cache bin services to identify bins that are good candidates for specialized cache backends.</p><p>The above tag assigned to the <code class="language-plaintext highlighter-rouge">cache.bootstrap</code>, <code class="language-plaintext highlighter-rouge">cache.config</code>, and <code class="language-plaintext highlighter-rouge">cache.discovery</code> bin services.</p><p>This means that by default (on a site with nothing set for $settings[‘cache’] in settings.php), the bootstrap, config, and discovery cache bins automatically benefit from APCu caching if APCu is available, and this is compatible with Drush usage (e.g., Drush can be used to clear caches and the web process receives that cache clear) and multi-server deployments.</p><p>APCu will act as a very fast local cache for all requests. Other cache backends can act as bigger, more general cache backend that is consistent across processes or servers.</p><p><strong>For module developers creating custom cache bins</strong></p><p>If you are defining a cache bin that is:</p><ul><li>relatively small (likely to have few enough entries to fit within APCu memory), and<li>high-read (many cache gets per request, so reducing traffic to the database or other networked backend is worthwhile), and<li>low-write (because every write to the bin will invalidate the entire APCu cache of that bin)</li></li></li></ul><p>then, you can add the default_backend tag to your bin, like so:</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#example.services.yml</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">cache.example</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\Core\Cache\CacheBackendInterface</span>
    <span class="na">tags</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="pi">{</span> <span class="nv">name</span><span class="pi">:</span> <span class="nv">cache.bin</span><span class="pi">,</span> <span class="nv">default_backend</span><span class="pi">:</span> <span class="nv">cache.backend.chainedfast</span> <span class="pi">}</span>
    <span class="na">factory_method</span><span class="pi">:</span> <span class="s">get</span>
    <span class="na">factory_service</span><span class="pi">:</span> <span class="s">cache_factory</span>
    <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">example</span><span class="pi">]</span>
</code></pre></div></div><p><strong>For site administrators customizing $settings[‘cache’]</strong> Any entry for $settings[‘cache’][‘default’] takes precedence over the default_backend service tag values, so you can disable all APCu caching by setting $settings[‘cache’][‘default’] = ‘cache.backend.database’. If you have $settings[‘cache’][‘default’] set to some alternate backend (e.g., memcache), but would still like to benefit from APCu front caching of some bins, you can add those assignments, like so:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'default'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.memcache'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'bootstrap'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.chainedfast'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'config'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.chainedfast'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'discovery'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.chainedfast'</span><span class="p">;</span>
<span class="c1">// ...</span>
</code></pre></div></div><p>The bins set to use cache.backend.chainedfast will use APCu as the front cache to the default backend (e.g., memcache in the above example).</p><p><strong>For site administrators of single-server sites that don’t need Drush or other CLI access</strong></p><p class="warning">This references single-server sites not needing Drush. TODO: I couldn’t find any references to using APCu with multi-server setups so I’m not sure if that is a safe configuration.</p><p>Pantheon docs ask in their FAQ Can APCu be used as a cache backend on Pantheon? Yes, APCu can be used as a cache backend or a “key-value store”; however, this is not recommended. APCu lacks the ability to span multiple application containers. Instead, Pantheon provides a Redis-based Object Cache as a caching backend for Drupal and WordPress, which has coherence across multiple application containers. This was from <a href="https://docs.pantheon.io/apcu">Pantheon docs</a> FAQ’s:</p><p>You can optimize further by using APCu exclusively for certain bins, like so:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'bootstrap'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.apcu'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'config'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.apcu'</span><span class="p">;</span>
<span class="nv">$settings</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">][</span><span class="s1">'bins'</span><span class="p">][</span><span class="s1">'discovery'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cache.backend.apcu'</span><span class="p">;</span>
</code></pre></div></div><p><strong>For site administrators wanting a different front cache than APCu</strong></p><p>You can copy the cache.backend.chainedfast service definition from core.services.yml to sites/default/services.yml and add arguments to it. For example:</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#services.yml</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">cache.backend.chainedfast</span><span class="pi">:</span>
    <span class="na">class</span><span class="pi">:</span> <span class="s">Drupal\Core\Cache\ChainedFastBackendFactory</span>
    <span class="na">arguments</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@settings'</span><span class="pi">,</span> <span class="pi">,</span> <span class="s1">'</span><span class="s">cache.backend.eaccelerator'</span><span class="pi">]</span>
    <span class="na">calls</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="pi">[</span><span class="nv">setContainer</span><span class="pi">,</span> <span class="pi">[</span><span class="s1">'</span><span class="s">@service_container'</span><span class="pi">]]</span>
</code></pre></div></div><h2 id="reference"> <a aria-labelledby="reference" class="anchor-heading" href="https://selwynpolit.github.io/d9book/caching#reference"><svg aria-hidden="true" viewbox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a> Reference</h2><ul><li>Drupal: cache tags for all, regardles of your backend From Matt Glaman 22, August 2022 <a href="https://mglaman.dev/blog/drupal-cache-tags-all-regardless-your-backend">https://mglaman.dev/blog/drupal-cache-tags-all-regardless-your-backend</a><li>Debugging your render cacheable metadata in Drupal From Matt Glaman 14, February 2023 <a href="https://mglaman.dev/blog/debugging-your-render-cacheable-metadata-drupal">https://mglaman.dev/blog/debugging-your-render-cacheable-metadata-drupal</a><li>Cache contexts overview on drupal.org <a href="https://www.drupal.org/docs/drupal-apis/cache-api/cache-contexts">https://www.drupal.org/docs/drupal-apis/cache-api/cache-contexts</a><li>Caching in Drupal 8 a quick overview of Cache tags, cache context and cache max-age with simple examples <a href="https://zu.com/articles/caching-drupal-8">https://zu.com/articles/caching-drupal-8</a><li>Nedcamp video on caching by Kelly Lucas from November 2018 <a href="https://www.youtube.com/watch?v=QCZe2K13bd0&amp;list=PLgfWMnl57dv5KmHaK4AngrQAryjO_ylaM&amp;t=0s&amp;index=16">https://www.youtube.com/watch?v=QCZe2K13bd0&amp;list=PLgfWMnl57dv5KmHaK4AngrQAryjO_ylaM&amp;t=0s&amp;index=16</a><li>#! code: Drupal 9: Debugging Cache Problems With The Cache Review Module, September 2022 <a href="https://www.hashbangcode.com/article/drupal-9-debugging-cache-problems-cache-review-module">https://www.hashbangcode.com/article/drupal-9-debugging-cache-problems-cache-review-module</a><li>#! code: Drupal 9: Using The Caching API To Store Data, April 2022 <a href="https://www.hashbangcode.com/article/drupal-9-using-caching-api-store-data">https://www.hashbangcode.com/article/drupal-9-using-caching-api-store-data</a><li>#! code: Drupal 8: Custom Cache Bin, September 2019 <a href="https://www.hashbangcode.com/article/drupal-8-custom-cache-bins">https://www.hashbangcode.com/article/drupal-8-custom-cache-bins</a><li>New cache backend configuration order, per-bin default before default configuration (How to specify cache backend), June 2016 <a href="https://www.drupal.org/node/2754947">https://www.drupal.org/node/2754947</a><li><a href="https://api.drupal.org/api/drupal/core!core.api.php/group/cache/10.1.x">Cache API Drupal Core</a></li></li></li></li></li></li></li></li></li></li></ul><hr/> <script async="" crossorigin="anonymous" data-category="Q&amp;A" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMjY2NDE4" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="selwynpolit/d9book" data-repo-id="MDEwOlJlcG9zaXRvcnkzMjUxNTQ1Nzg=" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js"> </script><hr/><footer><p><a href="https://selwynpolit.github.io/d9book/caching#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0"><span xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"> <a href="http://www.selwynpolit.github.io/d9book" property="dct:title" rel="cc:attributionURL">Drupal at your fingertips</a> by <a href="http://www.drupal.org/u/selwynpolit" property="cc:attributionName" rel="cc:attributionURL dct:creator">Selwyn Polit</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="license noopener noreferrer" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" style="height:16px!important;vertical-align:text-bottom;"/> <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" style="height:16px!important;vertical-align:text-bottom;"/> </a></span></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0 mr-2"> Page last modified: <span class="d-inline-block">May 31 2023</span>.</p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/selwynpolit/d9book/tree/gh-pages/book/caching.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
</body></link></meta></meta></meta></head></html>